/*================================================================================
  This is Nucleo.js [1.0]

  Nucleo is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation version 3.

  Nucleo is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with Nucleo.  If not, see http://www.gnu.org/licenses/.

  WELCOME
                                                  ,     ,
                                                 (\____/)             [ ]
                                                  (_oo_)             (   )
                                                    (-)               |>|
                                                  __||__    \)     __/===\__
                                               []/______\[] /     //| o=o |\\
                                               / \______/ \/    <]  | o=o |  [>
                                              /    /__\             \=====/
                                             (\   /____\            / / | \ \

                                                   /--\           <_________>

================================================================================*/var define={Camera:{AXIS:{RIGHT:[1,0,0],UP:[0,1,0],NORMAL:[0,0,1]},FRUSTUM:{FOV:30,NEAR:0.1,FAR:10000},TRACKING:{DEFAULT:"DEFAULT",ROTATIONAL:"ROTATIONAL",TRANSLATIONAL:"TRANSLATIONAL",CINEMATIC:"CINEMATIC"},TYPE:{ORBITING:"ORBITING",TRACKING:"TRACKING",EXPLORING:"EXPLORING"}},View:{BACKGROUND:[0.3,0.3,0.3]},ViewInteractor:{TASK:{NONE:0,PAN:1,ROTATE:2,DOLLY:3,ROLL:4}},Actor:{MODE:{TEXTURED:"TEXTURED",SOLID:"SOLID",WIREFRAME:"WIREFRAME",POINTS:"POINTS",LINES:"LINES",BOUNDING_BOX:"BOUNDING_BOX",BB_AND_SOLID:"BBANDSOLID",WIRED_AND_SOLID:"WIRED_AND_SOLID",FLAT:"FLAT"},CULL:{BACK:"BACK",FRONT:"FRONT",NONE:"NONE"},PICKING:{DISABLED:"DISABLED",CELL:"CELL",OBJECT:"OBJECT"}},Model:{LOADING_MODE:{LIVE:"LIVE",LATER:"LATER",DETACHED:"DETACHED"},MAX_NUM_INDICES:65535,TYPE:{SIMPLE:"SIMPLE",MESH:"MESH",BIG_DATA:"BIG DATA"},BoundingBox:{vertices:[],wireframe:[0,1,1,2,2,3,3,0,0,4,4,5,5,6,6,7,7,4,1,5,2,6,3,7],color:[1,1,1,1],shading:false},Floor:{vertices:[],indices:[],color:[0.6,0.6,0.6,1],shading:false},Axis:{vertices:[-1,0,0,1,0,0,0,-2,0,0,2,0,0,0,-1,0,0,1],wireframe:[0,1,2,3,4,5],colors:[1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1],shading:false}},Renderable:{TASK:{CREATE:"CREATE",UPDATE_GEOMETRY:"UPDATE_GEOMETRY",UPDATE_COLORS:"UPDATE_COLORS"}},Renderer:{MODE:{TIMER:"TIMER",ANIMFRAME:"ANIMFRAME",ON_DEMAND:"ON_DEMAND"},RATE:{SLOW:10000,NORMAL:500}},Texture:{FILTER:{NEAREST:"NEAREST",LINEAR:"LINEAR",NEAREST_MIPMAP_NEAREST:"NEAREST_MIPMAP_NEAREST",LINEAR_MIPMAP_NEAREST:"LINEAR_MIPMAP_NEAREST",NEAREST_MIPMAP_LINEAR:"NEAREST_MIPMAP_LINEAR",LINEAR_MIPMAP_LINEAR:"LINEAR_MIPMAP_LINEAR"}},Material:{DIFFUSE:[0.8,0.8,0.8,1],AMBIENT:[0,0,0,1],SPECULAR:[0,0,0,1],SHININESS:0,OPACITY:1,SHADING:true},LookupTable:{list:["default","aal","autumn","blackbody","bone","brodmann","cardiac","copper","cortex","cte","french","fs","ge_color","gold","gooch","hot","hotiron","hsv","jet","nih","nih_fire","nih_ice","pink","rainramp","spectrum","surface","x_hot","x_rain"],main:"default"},};
var ESSL={VERTEX_SHADER:"VERTEX_SHADER",FRAGMENT_SHADER:"FRAGMENT_SHADER",MODEL_VIEW_MATRIX:"mModelView",NORMAL_MATRIX:"mNormal",PERSPECTIVE_MATRIX:"mPerspective",MVP_MATRIX:"mModelViewPerspective",VERTEX_ATTRIBUTE:"aVertexPosition",NORMAL_ATTRIBUTE:"aVertexNormal",COLOR_ATTRIBUTE:"aVertexColor",TEXCOORD_ATTRIBUTE:"aVertexTextureCoords"};var EVENTS={DEFAULT_LUT_LOADED:"define.EVENTS.DEFAULT_LUT_LOADED",SCENE_UPDATED:"define.EVENTS.SCENE_UPDATED",MODELS_LOADING:"define.EVENTS.MODELS_LOADING",MODEL_NEW:"define.EVENTS.MODEL_NEW",MODELS_LOADED:"define.EVENTS.MODELS_LOADED",ACTOR_MOVED:"define.EVENTS.ACTOR_MOVED",ACTOR_SCALED:"define.EVENTS.ACTOR_SCALED",ACTOR_ROTATED:"define.EVENTS.ACTOR_ROTATED",ACTOR_CHANGED_COLOR:"define.EVENTS.ACTOR_CHANGED_COLOR",ACTOR_CHANGED_SHADING:"define.EVENTS.ACTOR_CHANGED_SHADING",VIEW_NEW:"define.EVENTS.VIEW_NEW",SCENE_NEW:"define.EVENTS.SCENE_NEW",READER_DONE:"define.EVENTS.READER_DONE"};
function Notifier(){this.targetList={};this.sourceList={}}Notifier.prototype.subscribe=function(d,c){if(typeof(d)=="string"){this._addTarget(d,c)}else{if(d instanceof Array){for(var a=0;a<d.length;a+=1){this._addTarget(d[a],c)}}else{throw"Notifier.receives: this method receives a string or a list of strings"}}};Notifier.prototype.publish=function(d,c){if(typeof(d)=="string"){this._addSource(d,c)}else{if(d instanceof Array){for(var a=0;a<d.length;a+=1){this._addSource(d[a],c)}}else{throw"Notifier.sends: this method receives a string or a list of strings"
}}};Notifier.prototype._addTarget=function(a,c){util.console("Notifier: adding target for event "+a);var d=this.targetList;if(d[a]==undefined){d[a]=[]}d[a].push(c)};Notifier.prototype._addSource=function(c,e){util.console("Notifier: adding source for event "+c);var d=this.targetList;var a=this.sourceList;if(a[c]==undefined){a[c]=[]}if(d[c]==undefined){d[c]=[]}a[c].push(e)};Notifier.prototype.fire=function(d,e){if(this.targetList[d].length==0){return}var a=this;function c(){var l=a.targetList;var f=a.sourceList[d].indexOf(e);
if(f==-1){throw"The source "+e+" is not registered to trigger the event "+d+". Did you use Notifier.publish?"}util.console("Notifier: firing "+d);var h=a.targetList[d];for(var k=0;k<h.length;k++){if(typeof(h[k])=="object"){h[k].handleEvent(d,e)}else{if(typeof(h[k]=="function")){h[k](d,e)}}}}setTimeout(function(){c()},0)};Notifier.prototype.getEvents=function(){var c=[];for(var a in this.sourceList){c.push(a)}return c};Notifier.prototype.getTargetsFor=function(d){var a=this.targetList[d];var e=[];
for(var c=0;c<a.length;c++){e.push(a[c])}return e};notifierInstance=new Notifier();(function(c){var a={};if(typeof(exports)==="undefined"){if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){a.exports={};define(function(){return a.exports})}else{a.exports=typeof(window)!=="undefined"?window:c}}else{a.exports=exports}(function(o){if(!v){var v=0.000001}if(!f){var f=(typeof Float32Array!=="undefined")?Float32Array:Array}if(!m){var m=Math.random}var h={};h.setMatrixArrayType=function(w){f=w
};if(typeof(o)!=="undefined"){o.glMatrix=h}var n=Math.PI/180;h.toRadian=function(w){return w*n};var t={};t.create=function(){var w=new f(2);w[0]=0;w[1]=0;return w};t.clone=function(w){var x=new f(2);x[0]=w[0];x[1]=w[1];return x};t.fromValues=function(w,A){var z=new f(2);z[0]=w;z[1]=A;return z};t.copy=function(x,w){x[0]=w[0];x[1]=w[1];return x};t.set=function(z,w,A){z[0]=w;z[1]=A;return z};t.add=function(y,x,w){y[0]=x[0]+w[0];y[1]=x[1]+w[1];return y};t.subtract=function(y,x,w){y[0]=x[0]-w[0];y[1]=x[1]-w[1];
return y};t.sub=t.subtract;t.multiply=function(y,x,w){y[0]=x[0]*w[0];y[1]=x[1]*w[1];return y};t.mul=t.multiply;t.divide=function(y,x,w){y[0]=x[0]/w[0];y[1]=x[1]/w[1];return y};t.div=t.divide;t.min=function(y,x,w){y[0]=Math.min(x[0],w[0]);y[1]=Math.min(x[1],w[1]);return y};t.max=function(y,x,w){y[0]=Math.max(x[0],w[0]);y[1]=Math.max(x[1],w[1]);return y};t.scale=function(y,x,w){y[0]=x[0]*w;y[1]=x[1]*w;return y};t.scaleAndAdd=function(y,x,w,z){y[0]=x[0]+(w[0]*z);y[1]=x[1]+(w[1]*z);return y};t.distance=function(A,z){var w=z[0]-A[0],B=z[1]-A[1];
return Math.sqrt(w*w+B*B)};t.dist=t.distance;t.squaredDistance=function(A,z){var w=z[0]-A[0],B=z[1]-A[1];return w*w+B*B};t.sqrDist=t.squaredDistance;t.length=function(z){var w=z[0],A=z[1];return Math.sqrt(w*w+A*A)};t.len=t.length;t.squaredLength=function(z){var w=z[0],A=z[1];return w*w+A*A};t.sqrLen=t.squaredLength;t.negate=function(x,w){x[0]=-w[0];x[1]=-w[1];return x};t.normalize=function(B,A){var z=A[0],C=A[1];var w=z*z+C*C;if(w>0){w=1/Math.sqrt(w);B[0]=A[0]*w;B[1]=A[1]*w}return B};t.dot=function(x,w){return x[0]*w[0]+x[1]*w[1]
};t.cross=function(y,x,w){var A=x[0]*w[1]-x[1]*w[0];y[0]=y[1]=0;y[2]=A;return y};t.lerp=function(y,x,w,z){var B=x[0],A=x[1];y[0]=B+z*(w[0]-B);y[1]=A+z*(w[1]-A);return y};t.random=function(w,y){y=y||1;var x=m()*2*Math.PI;w[0]=Math.cos(x)*y;w[1]=Math.sin(x)*y;return w};t.transformMat2=function(B,A,z){var w=A[0],C=A[1];B[0]=z[0]*w+z[2]*C;B[1]=z[1]*w+z[3]*C;return B};t.transformMat2d=function(B,A,z){var w=A[0],C=A[1];B[0]=z[0]*w+z[2]*C+z[4];B[1]=z[1]*w+z[3]*C+z[5];return B};t.transformMat3=function(B,A,z){var w=A[0],C=A[1];
B[0]=z[0]*w+z[3]*C+z[6];B[1]=z[1]*w+z[4]*C+z[7];return B};t.transformMat4=function(B,A,z){var w=A[0],C=A[1];B[0]=z[0]*w+z[4]*C+z[12];B[1]=z[1]*w+z[5]*C+z[13];return B};t.forEach=(function(){var w=t.create();return function(z,D,E,C,B,x){var A,y;if(!D){D=2}if(!E){E=0}if(C){y=Math.min((C*D)+E,z.length)}else{y=z.length}for(A=E;A<y;A+=D){w[0]=z[A];w[1]=z[A+1];B(w,w,x);z[A]=w[0];z[A+1]=w[1]}return z}})();t.str=function(w){return"vec2("+w[0]+", "+w[1]+")"};if(typeof(o)!=="undefined"){o.vec2=t}var s={};s.create=function(){var w=new f(3);
w[0]=0;w[1]=0;w[2]=0;return w};s.clone=function(w){var x=new f(3);x[0]=w[0];x[1]=w[1];x[2]=w[2];return x};s.fromValues=function(w,C,B){var A=new f(3);A[0]=w;A[1]=C;A[2]=B;return A};s.copy=function(x,w){x[0]=w[0];x[1]=w[1];x[2]=w[2];return x};s.set=function(A,w,C,B){A[0]=w;A[1]=C;A[2]=B;return A};s.add=function(y,x,w){y[0]=x[0]+w[0];y[1]=x[1]+w[1];y[2]=x[2]+w[2];return y};s.subtract=function(y,x,w){y[0]=x[0]-w[0];y[1]=x[1]-w[1];y[2]=x[2]-w[2];return y};s.sub=s.subtract;s.multiply=function(y,x,w){y[0]=x[0]*w[0];
y[1]=x[1]*w[1];y[2]=x[2]*w[2];return y};s.mul=s.multiply;s.divide=function(y,x,w){y[0]=x[0]/w[0];y[1]=x[1]/w[1];y[2]=x[2]/w[2];return y};s.div=s.divide;s.min=function(y,x,w){y[0]=Math.min(x[0],w[0]);y[1]=Math.min(x[1],w[1]);y[2]=Math.min(x[2],w[2]);return y};s.max=function(y,x,w){y[0]=Math.max(x[0],w[0]);y[1]=Math.max(x[1],w[1]);y[2]=Math.max(x[2],w[2]);return y};s.scale=function(y,x,w){y[0]=x[0]*w;y[1]=x[1]*w;y[2]=x[2]*w;return y};s.scaleAndAdd=function(y,x,w,z){y[0]=x[0]+(w[0]*z);y[1]=x[1]+(w[1]*z);
y[2]=x[2]+(w[2]*z);return y};s.distance=function(B,A){var w=A[0]-B[0],D=A[1]-B[1],C=A[2]-B[2];return Math.sqrt(w*w+D*D+C*C)};s.dist=s.distance;s.squaredDistance=function(B,A){var w=A[0]-B[0],D=A[1]-B[1],C=A[2]-B[2];return w*w+D*D+C*C};s.sqrDist=s.squaredDistance;s.length=function(A){var w=A[0],C=A[1],B=A[2];return Math.sqrt(w*w+C*C+B*B)};s.len=s.length;s.squaredLength=function(A){var w=A[0],C=A[1],B=A[2];return w*w+C*C+B*B};s.sqrLen=s.squaredLength;s.negate=function(x,w){x[0]=-w[0];x[1]=-w[1];x[2]=-w[2];
return x};s.normalize=function(C,B){var A=B[0],E=B[1],D=B[2];var w=A*A+E*E+D*D;if(w>0){w=1/Math.sqrt(w);C[0]=B[0]*w;C[1]=B[1]*w;C[2]=B[2]*w}return C};s.dot=function(x,w){return x[0]*w[0]+x[1]*w[1]+x[2]*w[2]};s.cross=function(x,C,B){var w=C[0],E=C[1],D=C[2],A=B[0],z=B[1],y=B[2];x[0]=E*y-D*z;x[1]=D*A-w*y;x[2]=w*z-E*A;return x};s.lerp=function(y,x,w,z){var C=x[0],B=x[1],A=x[2];y[0]=C+z*(w[0]-C);y[1]=B+z*(w[1]-B);y[2]=A+z*(w[2]-A);return y};s.random=function(w,B){B=B||1;var y=m()*2*Math.PI;var A=(m()*2)-1;
var x=Math.sqrt(1-A*A)*B;w[0]=Math.cos(y)*x;w[1]=Math.sin(y)*x;w[2]=A*B;return w};s.transformMat4=function(C,B,A){var w=B[0],E=B[1],D=B[2];C[0]=A[0]*w+A[4]*E+A[8]*D+A[12];C[1]=A[1]*w+A[5]*E+A[9]*D+A[13];C[2]=A[2]*w+A[6]*E+A[10]*D+A[14];return C};s.transformMat3=function(C,B,A){var w=B[0],E=B[1],D=B[2];C[0]=w*A[0]+E*A[3]+D*A[6];C[1]=w*A[1]+E*A[4]+D*A[7];C[2]=w*A[2]+E*A[5]+D*A[8];return C};s.transformQuat=function(F,L,w){var M=L[0],K=L[1],J=L[2],H=w[0],G=w[1],E=w[2],I=w[3],C=I*M+G*J-E*K,B=I*K+E*M-H*J,A=I*J+H*K-G*M,D=-H*M-G*K-E*J;
F[0]=C*I+D*-H+B*-E-A*-G;F[1]=B*I+D*-G+A*-H-C*-E;F[2]=A*I+D*-E+C*-G-B*-H;return F};s.rotateX=function(y,x,w,B){var A=[],z=[];A[0]=x[0]-w[0];A[1]=x[1]-w[1];A[2]=x[2]-w[2];z[0]=A[0];z[1]=A[1]*Math.cos(B)-A[2]*Math.sin(B);z[2]=A[1]*Math.sin(B)+A[2]*Math.cos(B);y[0]=z[0]+w[0];y[1]=z[1]+w[1];y[2]=z[2]+w[2];return y};s.rotateY=function(y,x,w,B){var A=[],z=[];A[0]=x[0]-w[0];A[1]=x[1]-w[1];A[2]=x[2]-w[2];z[0]=A[2]*Math.sin(B)+A[0]*Math.cos(B);z[1]=A[1];z[2]=A[2]*Math.cos(B)-A[0]*Math.sin(B);y[0]=z[0]+w[0];
y[1]=z[1]+w[1];y[2]=z[2]+w[2];return y};s.rotateZ=function(y,x,w,B){var A=[],z=[];A[0]=x[0]-w[0];A[1]=x[1]-w[1];A[2]=x[2]-w[2];z[0]=A[0]*Math.cos(B)-A[1]*Math.sin(B);z[1]=A[0]*Math.sin(B)+A[1]*Math.cos(B);z[2]=A[2];y[0]=z[0]+w[0];y[1]=z[1]+w[1];y[2]=z[2]+w[2];return y};s.forEach=(function(){var w=s.create();return function(z,D,E,C,B,x){var A,y;if(!D){D=3}if(!E){E=0}if(C){y=Math.min((C*D)+E,z.length)}else{y=z.length}for(A=E;A<y;A+=D){w[0]=z[A];w[1]=z[A+1];w[2]=z[A+2];B(w,w,x);z[A]=w[0];z[A+1]=w[1];
z[A+2]=w[2]}return z}})();s.str=function(w){return"vec3("+w[0]+", "+w[1]+", "+w[2]+")"};if(typeof(o)!=="undefined"){o.vec3=s}var q={};q.create=function(){var w=new f(4);w[0]=0;w[1]=0;w[2]=0;w[3]=0;return w};q.clone=function(w){var x=new f(4);x[0]=w[0];x[1]=w[1];x[2]=w[2];x[3]=w[3];return x};q.fromValues=function(A,E,D,B){var C=new f(4);C[0]=A;C[1]=E;C[2]=D;C[3]=B;return C};q.copy=function(x,w){x[0]=w[0];x[1]=w[1];x[2]=w[2];x[3]=w[3];return x};q.set=function(C,A,E,D,B){C[0]=A;C[1]=E;C[2]=D;C[3]=B;
return C};q.add=function(y,x,w){y[0]=x[0]+w[0];y[1]=x[1]+w[1];y[2]=x[2]+w[2];y[3]=x[3]+w[3];return y};q.subtract=function(y,x,w){y[0]=x[0]-w[0];y[1]=x[1]-w[1];y[2]=x[2]-w[2];y[3]=x[3]-w[3];return y};q.sub=q.subtract;q.multiply=function(y,x,w){y[0]=x[0]*w[0];y[1]=x[1]*w[1];y[2]=x[2]*w[2];y[3]=x[3]*w[3];return y};q.mul=q.multiply;q.divide=function(y,x,w){y[0]=x[0]/w[0];y[1]=x[1]/w[1];y[2]=x[2]/w[2];y[3]=x[3]/w[3];return y};q.div=q.divide;q.min=function(y,x,w){y[0]=Math.min(x[0],w[0]);y[1]=Math.min(x[1],w[1]);
y[2]=Math.min(x[2],w[2]);y[3]=Math.min(x[3],w[3]);return y};q.max=function(y,x,w){y[0]=Math.max(x[0],w[0]);y[1]=Math.max(x[1],w[1]);y[2]=Math.max(x[2],w[2]);y[3]=Math.max(x[3],w[3]);return y};q.scale=function(y,x,w){y[0]=x[0]*w;y[1]=x[1]*w;y[2]=x[2]*w;y[3]=x[3]*w;return y};q.scaleAndAdd=function(y,x,w,z){y[0]=x[0]+(w[0]*z);y[1]=x[1]+(w[1]*z);y[2]=x[2]+(w[2]*z);y[3]=x[3]+(w[3]*z);return y};q.distance=function(D,B){var A=B[0]-D[0],F=B[1]-D[1],E=B[2]-D[2],C=B[3]-D[3];return Math.sqrt(A*A+F*F+E*E+C*C)
};q.dist=q.distance;q.squaredDistance=function(D,B){var A=B[0]-D[0],F=B[1]-D[1],E=B[2]-D[2],C=B[3]-D[3];return A*A+F*F+E*E+C*C};q.sqrDist=q.squaredDistance;q.length=function(C){var A=C[0],E=C[1],D=C[2],B=C[3];return Math.sqrt(A*A+E*E+D*D+B*B)};q.len=q.length;q.squaredLength=function(C){var A=C[0],E=C[1],D=C[2],B=C[3];return A*A+E*E+D*D+B*B};q.sqrLen=q.squaredLength;q.negate=function(x,w){x[0]=-w[0];x[1]=-w[1];x[2]=-w[2];x[3]=-w[3];return x};q.normalize=function(E,D){var B=D[0],G=D[1],F=D[2],C=D[3];
var A=B*B+G*G+F*F+C*C;if(A>0){A=1/Math.sqrt(A);E[0]=D[0]*A;E[1]=D[1]*A;E[2]=D[2]*A;E[3]=D[3]*A}return E};q.dot=function(x,w){return x[0]*w[0]+x[1]*w[1]+x[2]*w[2]+x[3]*w[3]};q.lerp=function(y,x,w,z){var C=x[0],B=x[1],A=x[2],D=x[3];y[0]=C+z*(w[0]-C);y[1]=B+z*(w[1]-B);y[2]=A+z*(w[2]-A);y[3]=D+z*(w[3]-D);return y};q.random=function(w,x){x=x||1;w[0]=m();w[1]=m();w[2]=m();w[3]=m();q.normalize(w,w);q.scale(w,w,x);return w};q.transformMat4=function(E,D,B){var A=D[0],G=D[1],F=D[2],C=D[3];E[0]=B[0]*A+B[4]*G+B[8]*F+B[12]*C;
E[1]=B[1]*A+B[5]*G+B[9]*F+B[13]*C;E[2]=B[2]*A+B[6]*G+B[10]*F+B[14]*C;E[3]=B[3]*A+B[7]*G+B[11]*F+B[15]*C;return E};q.transformQuat=function(F,L,w){var M=L[0],K=L[1],J=L[2],H=w[0],G=w[1],E=w[2],I=w[3],C=I*M+G*J-E*K,B=I*K+E*M-H*J,A=I*J+H*K-G*M,D=-H*M-G*K-E*J;F[0]=C*I+D*-H+B*-E-A*-G;F[1]=B*I+D*-G+A*-H-C*-E;F[2]=A*I+D*-E+C*-G-B*-H;return F};q.forEach=(function(){var w=q.create();return function(z,D,E,C,B,x){var A,y;if(!D){D=4}if(!E){E=0}if(C){y=Math.min((C*D)+E,z.length)}else{y=z.length}for(A=E;A<y;A+=D){w[0]=z[A];
w[1]=z[A+1];w[2]=z[A+2];w[3]=z[A+3];B(w,w,x);z[A]=w[0];z[A+1]=w[1];z[A+2]=w[2];z[A+3]=w[3]}return z}})();q.str=function(w){return"vec4("+w[0]+", "+w[1]+", "+w[2]+", "+w[3]+")"};if(typeof(o)!=="undefined"){o.vec4=q}var k={};k.create=function(){var w=new f(4);w[0]=1;w[1]=0;w[2]=0;w[3]=1;return w};k.clone=function(w){var x=new f(4);x[0]=w[0];x[1]=w[1];x[2]=w[2];x[3]=w[3];return x};k.copy=function(x,w){x[0]=w[0];x[1]=w[1];x[2]=w[2];x[3]=w[3];return x};k.identity=function(w){w[0]=1;w[1]=0;w[2]=0;w[3]=1;
return w};k.transpose=function(y,x){if(y===x){var w=x[1];y[1]=x[2];y[2]=w}else{y[0]=x[0];y[1]=x[2];y[2]=x[1];y[3]=x[3]}return y};k.invert=function(A,y){var z=y[0],x=y[1],w=y[2],C=y[3],B=z*C-w*x;if(!B){return null}B=1/B;A[0]=C*B;A[1]=-x*B;A[2]=-w*B;A[3]=z*B;return A};k.adjoint=function(y,w){var x=w[0];y[0]=w[3];y[1]=-w[1];y[2]=-w[2];y[3]=x;return y};k.determinant=function(w){return w[0]*w[3]-w[2]*w[1]};k.multiply=function(A,F,D){var z=F[0],y=F[1],x=F[2],w=F[3];var G=D[0],E=D[1],C=D[2],B=D[3];A[0]=z*G+x*E;
A[1]=y*G+w*E;A[2]=z*C+x*B;A[3]=y*C+w*B;return A};k.mul=k.multiply;k.rotate=function(A,D,C){var z=D[0],y=D[1],x=D[2],w=D[3],E=Math.sin(C),B=Math.cos(C);A[0]=z*B+x*E;A[1]=y*B+w*E;A[2]=z*-E+x*B;A[3]=y*-E+w*B;return A};k.scale=function(A,B,D){var z=B[0],y=B[1],x=B[2],w=B[3],E=D[0],C=D[1];A[0]=z*E;A[1]=y*E;A[2]=x*C;A[3]=w*C;return A};k.str=function(w){return"mat2("+w[0]+", "+w[1]+", "+w[2]+", "+w[3]+")"};k.frob=function(w){return(Math.sqrt(Math.pow(w[0],2)+Math.pow(w[1],2)+Math.pow(w[2],2)+Math.pow(w[3],2)))
};k.LDU=function(w,z,y,x){w[2]=x[2]/x[0];y[0]=x[0];y[1]=x[1];y[3]=x[3]-w[2]*y[1];return[w,z,y]};if(typeof(o)!=="undefined"){o.mat2=k}var u={};u.create=function(){var w=new f(6);w[0]=1;w[1]=0;w[2]=0;w[3]=1;w[4]=0;w[5]=0;return w};u.clone=function(w){var x=new f(6);x[0]=w[0];x[1]=w[1];x[2]=w[2];x[3]=w[3];x[4]=w[4];x[5]=w[5];return x};u.copy=function(x,w){x[0]=w[0];x[1]=w[1];x[2]=w[2];x[3]=w[3];x[4]=w[4];x[5]=w[5];return x};u.identity=function(w){w[0]=1;w[1]=0;w[2]=0;w[3]=1;w[4]=0;w[5]=0;return w};u.invert=function(x,B){var w=B[0],E=B[1],D=B[2],C=B[3],z=B[4],y=B[5];
var A=w*C-E*D;if(!A){return null}A=1/A;x[0]=C*A;x[1]=-E*A;x[2]=-D*A;x[3]=w*A;x[4]=(D*y-C*z)*A;x[5]=(E*z-w*y)*A;return x};u.determinant=function(w){return w[0]*w[3]-w[1]*w[2]};u.multiply=function(A,H,F){var z=H[0],y=H[1],x=H[2],w=H[3],K=H[4],J=H[5],I=F[0],G=F[1],E=F[2],D=F[3],C=F[4],B=F[5];A[0]=z*I+x*G;A[1]=y*I+w*G;A[2]=z*E+x*D;A[3]=y*E+w*D;A[4]=z*C+x*B+K;A[5]=y*C+w*B+J;return A};u.mul=u.multiply;u.rotate=function(A,D,C){var z=D[0],y=D[1],x=D[2],w=D[3],G=D[4],E=D[5],F=Math.sin(C),B=Math.cos(C);A[0]=z*B+x*F;
A[1]=y*B+w*F;A[2]=z*-F+x*B;A[3]=y*-F+w*B;A[4]=G;A[5]=E;return A};u.scale=function(A,B,E){var z=B[0],y=B[1],x=B[2],w=B[3],G=B[4],F=B[5],D=E[0],C=E[1];A[0]=z*D;A[1]=y*D;A[2]=x*C;A[3]=w*C;A[4]=G;A[5]=F;return A};u.translate=function(A,B,E){var z=B[0],y=B[1],x=B[2],w=B[3],G=B[4],F=B[5],D=E[0],C=E[1];A[0]=z;A[1]=y;A[2]=x;A[3]=w;A[4]=z*D+x*C+G;A[5]=y*D+w*C+F;return A};u.str=function(w){return"mat2d("+w[0]+", "+w[1]+", "+w[2]+", "+w[3]+", "+w[4]+", "+w[5]+")"};u.frob=function(w){return(Math.sqrt(Math.pow(w[0],2)+Math.pow(w[1],2)+Math.pow(w[2],2)+Math.pow(w[3],2)+Math.pow(w[4],2)+Math.pow(w[5],2)+1))
};if(typeof(o)!=="undefined"){o.mat2d=u}var e={};e.create=function(){var w=new f(9);w[0]=1;w[1]=0;w[2]=0;w[3]=0;w[4]=1;w[5]=0;w[6]=0;w[7]=0;w[8]=1;return w};e.fromMat4=function(x,w){x[0]=w[0];x[1]=w[1];x[2]=w[2];x[3]=w[4];x[4]=w[5];x[5]=w[6];x[6]=w[8];x[7]=w[9];x[8]=w[10];return x};e.clone=function(w){var x=new f(9);x[0]=w[0];x[1]=w[1];x[2]=w[2];x[3]=w[3];x[4]=w[4];x[5]=w[5];x[6]=w[6];x[7]=w[7];x[8]=w[8];return x};e.copy=function(x,w){x[0]=w[0];x[1]=w[1];x[2]=w[2];x[3]=w[3];x[4]=w[4];x[5]=w[5];x[6]=w[6];
x[7]=w[7];x[8]=w[8];return x};e.identity=function(w){w[0]=1;w[1]=0;w[2]=0;w[3]=0;w[4]=1;w[5]=0;w[6]=0;w[7]=0;w[8]=1;return w};e.transpose=function(y,x){if(y===x){var A=x[1],z=x[2],w=x[5];y[1]=x[3];y[2]=x[6];y[3]=A;y[5]=x[7];y[6]=z;y[7]=w}else{y[0]=x[0];y[1]=x[3];y[2]=x[6];y[3]=x[1];y[4]=x[4];y[5]=x[7];y[6]=x[2];y[7]=x[5];y[8]=x[8]}return y};e.invert=function(A,H){var z=H[0],y=H[1],x=H[2],K=H[3],J=H[4],I=H[5],F=H[6],E=H[7],C=H[8],B=C*J-I*E,w=-C*K+I*F,G=E*K-J*F,D=z*B+y*w+x*G;if(!D){return null}D=1/D;
A[0]=B*D;A[1]=(-C*y+x*E)*D;A[2]=(I*y-x*J)*D;A[3]=w*D;A[4]=(C*z-x*F)*D;A[5]=(-I*z+x*K)*D;A[6]=G*D;A[7]=(-E*z+y*F)*D;A[8]=(J*z-y*K)*D;return A};e.adjoint=function(z,D){var y=D[0],x=D[1],w=D[2],G=D[3],F=D[4],E=D[5],C=D[6],B=D[7],A=D[8];z[0]=(F*A-E*B);z[1]=(w*B-x*A);z[2]=(x*E-w*F);z[3]=(E*C-G*A);z[4]=(y*A-w*C);z[5]=(w*G-y*E);z[6]=(G*B-F*C);z[7]=(x*C-y*B);z[8]=(y*F-x*G);return z};e.determinant=function(C){var y=C[0],x=C[1],w=C[2],F=C[3],E=C[4],D=C[5],B=C[6],A=C[7],z=C[8];return y*(z*E-D*A)+x*(-z*F+D*B)+w*(A*F-E*B)
};e.multiply=function(I,N,M){var Q=N[0],P=N[1],O=N[2],B=N[3],A=N[4],z=N[5],H=N[6],G=N[7],F=N[8],E=M[0],D=M[1],C=M[2],L=M[3],K=M[4],J=M[5],y=M[6],x=M[7],w=M[8];I[0]=E*Q+D*B+C*H;I[1]=E*P+D*A+C*G;I[2]=E*O+D*z+C*F;I[3]=L*Q+K*B+J*H;I[4]=L*P+K*A+J*G;I[5]=L*O+K*z+J*F;I[6]=y*Q+x*B+w*H;I[7]=y*P+x*A+w*G;I[8]=y*O+x*z+w*F;return I};e.mul=e.multiply;e.translate=function(B,H,J){var A=H[0],z=H[1],w=H[2],L=H[3],K=H[4],I=H[5],E=H[6],D=H[7],C=H[8],G=J[0],F=J[1];B[0]=A;B[1]=z;B[2]=w;B[3]=L;B[4]=K;B[5]=I;B[6]=G*A+F*L+E;
B[7]=G*z+F*K+D;B[8]=G*w+F*I+C;return B};e.rotate=function(z,F,E){var y=F[0],x=F[1],w=F[2],I=F[3],H=F[4],G=F[5],C=F[6],B=F[7],A=F[8],J=Math.sin(E),D=Math.cos(E);z[0]=D*y+J*I;z[1]=D*x+J*H;z[2]=D*w+J*G;z[3]=D*I-J*y;z[4]=D*H-J*x;z[5]=D*G-J*w;z[6]=C;z[7]=B;z[8]=A;return z};e.scale=function(B,z,A){var w=A[0],C=A[1];B[0]=w*z[0];B[1]=w*z[1];B[2]=w*z[2];B[3]=C*z[3];B[4]=C*z[4];B[5]=C*z[5];B[6]=z[6];B[7]=z[7];B[8]=z[8];return B};e.fromMat2d=function(x,w){x[0]=w[0];x[1]=w[1];x[2]=0;x[3]=w[2];x[4]=w[3];x[5]=0;
x[6]=w[4];x[7]=w[5];x[8]=1;return x};e.fromQuat=function(K,H){var E=H[0],D=H[1],C=H[2],F=H[3],L=E+E,A=D+D,G=C+C,B=E*L,J=D*L,I=D*A,R=C*L,Q=C*A,O=C*G,P=F*L,N=F*A,M=F*G;K[0]=1-I-O;K[3]=J-M;K[6]=R+N;K[1]=J+M;K[4]=1-B-O;K[7]=Q-P;K[2]=R-N;K[5]=Q+P;K[8]=1-B-I;return K};e.normalFromMat4=function(P,U){var Y=U[0],W=U[1],V=U[2],S=U[3],A=U[4],z=U[5],y=U[6],x=U[7],O=U[8],N=U[9],M=U[10],L=U[11],aa=U[12],Z=U[13],X=U[14],T=U[15],K=Y*z-W*A,J=Y*y-V*A,I=Y*x-S*A,H=W*y-V*z,G=W*x-S*z,F=V*x-S*y,E=O*Z-N*aa,D=O*X-M*aa,C=O*T-L*aa,B=N*X-M*Z,R=N*T-L*Z,Q=M*T-L*X,w=K*Q-J*R+I*B+H*C-G*D+F*E;
if(!w){return null}w=1/w;P[0]=(z*Q-y*R+x*B)*w;P[1]=(y*C-A*Q-x*D)*w;P[2]=(A*R-z*C+x*E)*w;P[3]=(V*R-W*Q-S*B)*w;P[4]=(Y*Q-V*C+S*D)*w;P[5]=(W*C-Y*R-S*E)*w;P[6]=(Z*F-X*G+T*H)*w;P[7]=(X*I-aa*F-T*J)*w;P[8]=(aa*G-Z*I+T*K)*w;return P};e.str=function(w){return"mat3("+w[0]+", "+w[1]+", "+w[2]+", "+w[3]+", "+w[4]+", "+w[5]+", "+w[6]+", "+w[7]+", "+w[8]+")"};e.frob=function(w){return(Math.sqrt(Math.pow(w[0],2)+Math.pow(w[1],2)+Math.pow(w[2],2)+Math.pow(w[3],2)+Math.pow(w[4],2)+Math.pow(w[5],2)+Math.pow(w[6],2)+Math.pow(w[7],2)+Math.pow(w[8],2)))
};if(typeof(o)!=="undefined"){o.mat3=e}var d={};d.create=function(){var w=new f(16);w[0]=1;w[1]=0;w[2]=0;w[3]=0;w[4]=0;w[5]=1;w[6]=0;w[7]=0;w[8]=0;w[9]=0;w[10]=1;w[11]=0;w[12]=0;w[13]=0;w[14]=0;w[15]=1;return w};d.clone=function(w){var x=new f(16);x[0]=w[0];x[1]=w[1];x[2]=w[2];x[3]=w[3];x[4]=w[4];x[5]=w[5];x[6]=w[6];x[7]=w[7];x[8]=w[8];x[9]=w[9];x[10]=w[10];x[11]=w[11];x[12]=w[12];x[13]=w[13];x[14]=w[14];x[15]=w[15];return x};d.copy=function(x,w){x[0]=w[0];x[1]=w[1];x[2]=w[2];x[3]=w[3];x[4]=w[4];
x[5]=w[5];x[6]=w[6];x[7]=w[7];x[8]=w[8];x[9]=w[9];x[10]=w[10];x[11]=w[11];x[12]=w[12];x[13]=w[13];x[14]=w[14];x[15]=w[15];return x};d.identity=function(w){w[0]=1;w[1]=0;w[2]=0;w[3]=0;w[4]=0;w[5]=1;w[6]=0;w[7]=0;w[8]=0;w[9]=0;w[10]=1;w[11]=0;w[12]=0;w[13]=0;w[14]=0;w[15]=1;return w};d.transpose=function(z,y){if(z===y){var D=y[1],B=y[2],A=y[3],w=y[6],C=y[7],x=y[11];z[1]=y[4];z[2]=y[8];z[3]=y[12];z[4]=D;z[6]=y[9];z[7]=y[13];z[8]=B;z[9]=w;z[11]=y[14];z[12]=A;z[13]=C;z[14]=x}else{z[0]=y[0];z[1]=y[4];z[2]=y[8];
z[3]=y[12];z[4]=y[1];z[5]=y[5];z[6]=y[9];z[7]=y[13];z[8]=y[2];z[9]=y[6];z[10]=y[10];z[11]=y[14];z[12]=y[3];z[13]=y[7];z[14]=y[11];z[15]=y[15]}return z};d.invert=function(P,U){var Y=U[0],W=U[1],V=U[2],S=U[3],A=U[4],z=U[5],y=U[6],x=U[7],O=U[8],N=U[9],M=U[10],L=U[11],aa=U[12],Z=U[13],X=U[14],T=U[15],K=Y*z-W*A,J=Y*y-V*A,I=Y*x-S*A,H=W*y-V*z,G=W*x-S*z,F=V*x-S*y,E=O*Z-N*aa,D=O*X-M*aa,C=O*T-L*aa,B=N*X-M*Z,R=N*T-L*Z,Q=M*T-L*X,w=K*Q-J*R+I*B+H*C-G*D+F*E;if(!w){return null}w=1/w;P[0]=(z*Q-y*R+x*B)*w;P[1]=(V*R-W*Q-S*B)*w;
P[2]=(Z*F-X*G+T*H)*w;P[3]=(M*G-N*F-L*H)*w;P[4]=(y*C-A*Q-x*D)*w;P[5]=(Y*Q-V*C+S*D)*w;P[6]=(X*I-aa*F-T*J)*w;P[7]=(O*F-M*I+L*J)*w;P[8]=(A*R-z*C+x*E)*w;P[9]=(W*C-Y*R-S*E)*w;P[10]=(aa*G-Z*I+T*K)*w;P[11]=(N*I-O*G-L*K)*w;P[12]=(z*D-A*B-y*E)*w;P[13]=(Y*B-W*D+V*E)*w;P[14]=(Z*J-aa*H-X*K)*w;P[15]=(O*H-N*J+M*K)*w;return P};d.adjoint=function(E,H){var L=H[0],J=H[1],I=H[2],F=H[3],z=H[4],y=H[5],x=H[6],w=H[7],D=H[8],C=H[9],B=H[10],A=H[11],N=H[12],M=H[13],K=H[14],G=H[15];E[0]=(y*(B*G-A*K)-C*(x*G-w*K)+M*(x*A-w*B));
E[1]=-(J*(B*G-A*K)-C*(I*G-F*K)+M*(I*A-F*B));E[2]=(J*(x*G-w*K)-y*(I*G-F*K)+M*(I*w-F*x));E[3]=-(J*(x*A-w*B)-y*(I*A-F*B)+C*(I*w-F*x));E[4]=-(z*(B*G-A*K)-D*(x*G-w*K)+N*(x*A-w*B));E[5]=(L*(B*G-A*K)-D*(I*G-F*K)+N*(I*A-F*B));E[6]=-(L*(x*G-w*K)-z*(I*G-F*K)+N*(I*w-F*x));E[7]=(L*(x*A-w*B)-z*(I*A-F*B)+D*(I*w-F*x));E[8]=(z*(C*G-A*M)-D*(y*G-w*M)+N*(y*A-w*C));E[9]=-(L*(C*G-A*M)-D*(J*G-F*M)+N*(J*A-F*C));E[10]=(L*(y*G-w*M)-z*(J*G-F*M)+N*(J*w-F*y));E[11]=-(L*(y*A-w*C)-z*(J*A-F*C)+D*(J*w-F*y));E[12]=-(z*(C*K-B*M)-D*(y*K-x*M)+N*(y*B-x*C));
E[13]=(L*(C*K-B*M)-D*(J*K-I*M)+N*(J*B-I*C));E[14]=-(L*(y*K-x*M)-z*(J*K-I*M)+N*(J*x-I*y));E[15]=(L*(y*B-x*C)-z*(J*B-I*C)+D*(J*x-I*y));return E};d.determinant=function(R){var W=R[0],U=R[1],S=R[2],Q=R[3],z=R[4],y=R[5],x=R[6],w=R[7],N=R[8],M=R[9],L=R[10],K=R[11],Y=R[12],X=R[13],V=R[14],T=R[15],J=W*y-U*z,I=W*x-S*z,H=W*w-Q*z,G=U*x-S*y,F=U*w-Q*y,E=S*w-Q*x,D=N*X-M*Y,C=N*V-L*Y,B=N*T-K*Y,A=M*V-L*X,P=M*T-K*X,O=L*T-K*V;return J*O-I*P+H*A+G*B-F*C+E*D};d.multiply=function(I,M,J){var Q=M[0],P=M[1],N=M[2],K=M[3],C=M[4],A=M[5],y=M[6],w=M[7],H=M[8],G=M[9],F=M[10],E=M[11],S=M[12],R=M[13],O=M[14],L=M[15];
var D=J[0],B=J[1],z=J[2],x=J[3];I[0]=D*Q+B*C+z*H+x*S;I[1]=D*P+B*A+z*G+x*R;I[2]=D*N+B*y+z*F+x*O;I[3]=D*K+B*w+z*E+x*L;D=J[4];B=J[5];z=J[6];x=J[7];I[4]=D*Q+B*C+z*H+x*S;I[5]=D*P+B*A+z*G+x*R;I[6]=D*N+B*y+z*F+x*O;I[7]=D*K+B*w+z*E+x*L;D=J[8];B=J[9];z=J[10];x=J[11];I[8]=D*Q+B*C+z*H+x*S;I[9]=D*P+B*A+z*G+x*R;I[10]=D*N+B*y+z*F+x*O;I[11]=D*K+B*w+z*E+x*L;D=J[12];B=J[13];z=J[14];x=J[15];I[12]=D*Q+B*C+z*H+x*S;I[13]=D*P+B*A+z*G+x*R;I[14]=D*N+B*y+z*F+x*O;I[15]=D*K+B*w+z*E+x*L;return I};d.mul=d.multiply;d.translate=function(L,N,G){var F=G[0],E=G[1],D=G[2],Q,P,O,M,C,B,A,w,K,J,I,H;
if(N===L){L[12]=N[0]*F+N[4]*E+N[8]*D+N[12];L[13]=N[1]*F+N[5]*E+N[9]*D+N[13];L[14]=N[2]*F+N[6]*E+N[10]*D+N[14];L[15]=N[3]*F+N[7]*E+N[11]*D+N[15]}else{Q=N[0];P=N[1];O=N[2];M=N[3];C=N[4];B=N[5];A=N[6];w=N[7];K=N[8];J=N[9];I=N[10];H=N[11];L[0]=Q;L[1]=P;L[2]=O;L[3]=M;L[4]=C;L[5]=B;L[6]=A;L[7]=w;L[8]=K;L[9]=J;L[10]=I;L[11]=H;L[12]=Q*F+C*E+K*D+N[12];L[13]=P*F+B*E+J*D+N[13];L[14]=O*F+A*E+I*D+N[14];L[15]=M*F+w*E+H*D+N[15]}return L};d.scale=function(C,A,B){var w=B[0],E=B[1],D=B[2];C[0]=A[0]*w;C[1]=A[1]*w;C[2]=A[2]*w;
C[3]=A[3]*w;C[4]=A[4]*E;C[5]=A[5]*E;C[6]=A[6]*E;C[7]=A[7]*E;C[8]=A[8]*D;C[9]=A[9]*D;C[10]=A[10]*D;C[11]=A[11]*D;C[12]=A[12];C[13]=A[13];C[14]=A[14];C[15]=A[15];return C};d.rotate=function(T,aa,ac,w){var J=w[0],I=w[1],H=w[2],U=Math.sqrt(J*J+I*I+H*H),O,Y,N,ae,ad,ab,Z,G,F,E,D,S,R,Q,P,M,L,K,X,W,V,C,B,A;if(Math.abs(U)<v){return null}U=1/U;J*=U;I*=U;H*=U;O=Math.sin(ac);Y=Math.cos(ac);N=1-Y;ae=aa[0];ad=aa[1];ab=aa[2];Z=aa[3];G=aa[4];F=aa[5];E=aa[6];D=aa[7];S=aa[8];R=aa[9];Q=aa[10];P=aa[11];M=J*J*N+Y;L=I*J*N+H*O;
K=H*J*N-I*O;X=J*I*N-H*O;W=I*I*N+Y;V=H*I*N+J*O;C=J*H*N+I*O;B=I*H*N-J*O;A=H*H*N+Y;T[0]=ae*M+G*L+S*K;T[1]=ad*M+F*L+R*K;T[2]=ab*M+E*L+Q*K;T[3]=Z*M+D*L+P*K;T[4]=ae*X+G*W+S*V;T[5]=ad*X+F*W+R*V;T[6]=ab*X+E*W+Q*V;T[7]=Z*X+D*W+P*V;T[8]=ae*C+G*B+S*A;T[9]=ad*C+F*B+R*A;T[10]=ab*C+E*B+Q*A;T[11]=Z*C+D*B+P*A;if(aa!==T){T[12]=aa[12];T[13]=aa[13];T[14]=aa[14];T[15]=aa[15]}return T};d.rotateX=function(w,D,C){var I=Math.sin(C),B=Math.cos(C),H=D[4],G=D[5],F=D[6],E=D[7],A=D[8],z=D[9],y=D[10],x=D[11];if(D!==w){w[0]=D[0];
w[1]=D[1];w[2]=D[2];w[3]=D[3];w[12]=D[12];w[13]=D[13];w[14]=D[14];w[15]=D[15]}w[4]=H*B+A*I;w[5]=G*B+z*I;w[6]=F*B+y*I;w[7]=E*B+x*I;w[8]=A*B-H*I;w[9]=z*B-G*I;w[10]=y*B-F*I;w[11]=x*B-E*I;return w};d.rotateY=function(A,H,G){var I=Math.sin(G),F=Math.cos(G),z=H[0],y=H[1],x=H[2],w=H[3],E=H[8],D=H[9],C=H[10],B=H[11];if(H!==A){A[4]=H[4];A[5]=H[5];A[6]=H[6];A[7]=H[7];A[12]=H[12];A[13]=H[13];A[14]=H[14];A[15]=H[15]}A[0]=z*F-E*I;A[1]=y*F-D*I;A[2]=x*F-C*I;A[3]=w*F-B*I;A[8]=z*I+E*F;A[9]=y*I+D*F;A[10]=x*I+C*F;A[11]=w*I+B*F;
return A};d.rotateZ=function(A,D,C){var I=Math.sin(C),B=Math.cos(C),z=D[0],y=D[1],x=D[2],w=D[3],H=D[4],G=D[5],F=D[6],E=D[7];if(D!==A){A[8]=D[8];A[9]=D[9];A[10]=D[10];A[11]=D[11];A[12]=D[12];A[13]=D[13];A[14]=D[14];A[15]=D[15]}A[0]=z*B+H*I;A[1]=y*B+G*I;A[2]=x*B+F*I;A[3]=w*B+E*I;A[4]=H*B-z*I;A[5]=G*B-y*I;A[6]=F*B-x*I;A[7]=E*B-w*I;return A};d.fromRotationTranslation=function(N,L,J){var G=L[0],F=L[1],E=L[2],H=L[3],O=G+G,A=F+F,I=E+E,D=G*O,C=G*A,B=G*I,M=F*A,K=F*I,R=E*I,S=H*O,Q=H*A,P=H*I;N[0]=1-(M+R);N[1]=C+P;
N[2]=B-Q;N[3]=0;N[4]=C-P;N[5]=1-(D+R);N[6]=K+S;N[7]=0;N[8]=B+Q;N[9]=K-S;N[10]=1-(D+M);N[11]=0;N[12]=J[0];N[13]=J[1];N[14]=J[2];N[15]=1;return N};d.fromQuat=function(K,H){var E=H[0],D=H[1],C=H[2],F=H[3],L=E+E,A=D+D,G=C+C,B=E*L,J=D*L,I=D*A,R=C*L,Q=C*A,O=C*G,P=F*L,N=F*A,M=F*G;K[0]=1-I-O;K[1]=J+M;K[2]=R-N;K[3]=0;K[4]=J-M;K[5]=1-B-O;K[6]=Q+P;K[7]=0;K[8]=R+N;K[9]=Q-P;K[10]=1-B-I;K[11]=0;K[12]=0;K[13]=0;K[14]=0;K[15]=1;return K};d.frustum=function(A,x,F,w,E,C,B){var D=1/(F-x),z=1/(E-w),y=1/(C-B);A[0]=(C*2)*D;
A[1]=0;A[2]=0;A[3]=0;A[4]=0;A[5]=(C*2)*z;A[6]=0;A[7]=0;A[8]=(F+x)*D;A[9]=(E+w)*z;A[10]=(B+C)*y;A[11]=-1;A[12]=0;A[13]=0;A[14]=(B*C*2)*y;A[15]=0;return A};d.perspective=function(z,y,x,A,w){var C=1/Math.tan(y/2),B=1/(A-w);z[0]=C/x;z[1]=0;z[2]=0;z[3]=0;z[4]=0;z[5]=C;z[6]=0;z[7]=0;z[8]=0;z[9]=0;z[10]=(w+A)*B;z[11]=-1;z[12]=0;z[13]=0;z[14]=(2*w*A)*B;z[15]=0;return z};d.ortho=function(z,x,F,w,D,C,B){var A=1/(x-F),E=1/(w-D),y=1/(C-B);z[0]=-2*A;z[1]=0;z[2]=0;z[3]=0;z[4]=0;z[5]=-2*E;z[6]=0;z[7]=0;z[8]=0;z[9]=0;
z[10]=2*y;z[11]=0;z[12]=(x+F)*A;z[13]=(D+w)*E;z[14]=(B+C)*y;z[15]=1;return z};d.lookAt=function(K,R,S,C){var Q,P,N,y,x,w,F,E,D,L,O=R[0],M=R[1],J=R[2],B=C[0],A=C[1],z=C[2],I=S[0],H=S[1],G=S[2];if(Math.abs(O-I)<v&&Math.abs(M-H)<v&&Math.abs(J-G)<v){return d.identity(K)}F=O-I;E=M-H;D=J-G;L=1/Math.sqrt(F*F+E*E+D*D);F*=L;E*=L;D*=L;Q=A*D-z*E;P=z*F-B*D;N=B*E-A*F;L=Math.sqrt(Q*Q+P*P+N*N);if(!L){Q=0;P=0;N=0}else{L=1/L;Q*=L;P*=L;N*=L}y=E*N-D*P;x=D*Q-F*N;w=F*P-E*Q;L=Math.sqrt(y*y+x*x+w*w);if(!L){y=0;x=0;w=0}else{L=1/L;
y*=L;x*=L;w*=L}K[0]=Q;K[1]=y;K[2]=F;K[3]=0;K[4]=P;K[5]=x;K[6]=E;K[7]=0;K[8]=N;K[9]=w;K[10]=D;K[11]=0;K[12]=-(Q*O+P*M+N*J);K[13]=-(y*O+x*M+w*J);K[14]=-(F*O+E*M+D*J);K[15]=1;return K};d.str=function(w){return"mat4("+w[0]+", "+w[1]+", "+w[2]+", "+w[3]+", "+w[4]+", "+w[5]+", "+w[6]+", "+w[7]+", "+w[8]+", "+w[9]+", "+w[10]+", "+w[11]+", "+w[12]+", "+w[13]+", "+w[14]+", "+w[15]+")"};d.frob=function(w){return(Math.sqrt(Math.pow(w[0],2)+Math.pow(w[1],2)+Math.pow(w[2],2)+Math.pow(w[3],2)+Math.pow(w[4],2)+Math.pow(w[5],2)+Math.pow(w[6],2)+Math.pow(w[6],2)+Math.pow(w[7],2)+Math.pow(w[8],2)+Math.pow(w[9],2)+Math.pow(w[10],2)+Math.pow(w[11],2)+Math.pow(w[12],2)+Math.pow(w[13],2)+Math.pow(w[14],2)+Math.pow(w[15],2)))
};if(typeof(o)!=="undefined"){o.mat4=d}var l={};l.create=function(){var w=new f(4);w[0]=0;w[1]=0;w[2]=0;w[3]=1;return w};l.rotationTo=(function(){var w=s.create();var x=s.fromValues(1,0,0);var y=s.fromValues(0,1,0);return function(C,A,z){var B=s.dot(A,z);if(B<-0.999999){s.cross(w,x,A);if(s.length(w)<0.000001){s.cross(w,y,A)}s.normalize(w,w);l.setAxisAngle(C,w,Math.PI);return C}else{if(B>0.999999){C[0]=0;C[1]=0;C[2]=0;C[3]=1;return C}else{s.cross(w,A,z);C[0]=w[0];C[1]=w[1];C[2]=w[2];C[3]=1+B;return l.normalize(C,C)
}}}})();l.setAxes=(function(){var w=e.create();return function(z,y,A,x){w[0]=A[0];w[3]=A[1];w[6]=A[2];w[1]=x[0];w[4]=x[1];w[7]=x[2];w[2]=-y[0];w[5]=-y[1];w[8]=-y[2];return l.normalize(z,l.fromMat3(z,w))}})();l.clone=q.clone;l.fromValues=q.fromValues;l.copy=q.copy;l.set=q.set;l.identity=function(w){w[0]=0;w[1]=0;w[2]=0;w[3]=1;return w};l.setAxisAngle=function(x,z,w){w=w*0.5;var y=Math.sin(w);x[0]=y*z[0];x[1]=y*z[1];x[2]=y*z[2];x[3]=Math.cos(w);return x};l.add=q.add;l.multiply=function(y,E,D){var w=E[0],G=E[1],F=E[2],x=E[3],B=D[0],A=D[1],z=D[2],C=D[3];
y[0]=w*C+x*B+G*z-F*A;y[1]=G*C+x*A+F*B-w*z;y[2]=F*C+x*z+w*A-G*B;y[3]=x*C-w*B-G*A-F*z;return y};l.mul=l.multiply;l.scale=q.scale;l.rotateX=function(y,C,A){A*=0.5;var w=C[0],E=C[1],D=C[2],x=C[3],z=Math.sin(A),B=Math.cos(A);y[0]=w*B+x*z;y[1]=E*B+D*z;y[2]=D*B-E*z;y[3]=x*B-w*z;return y};l.rotateY=function(y,C,A){A*=0.5;var w=C[0],E=C[1],D=C[2],x=C[3],z=Math.sin(A),B=Math.cos(A);y[0]=w*B-D*z;y[1]=E*B+x*z;y[2]=D*B+w*z;y[3]=x*B-E*z;return y};l.rotateZ=function(y,C,A){A*=0.5;var w=C[0],E=C[1],D=C[2],x=C[3],z=Math.sin(A),B=Math.cos(A);
y[0]=w*B+E*z;y[1]=E*B-w*z;y[2]=D*B+x*z;y[3]=x*B-D*z;return y};l.calculateW=function(B,A){var w=A[0],D=A[1],C=A[2];B[0]=w;B[1]=D;B[2]=C;B[3]=-Math.sqrt(Math.abs(1-w*w-D*D-C*C));return B};l.dot=q.dot;l.lerp=q.lerp;l.slerp=function(A,I,H,L){var w=I[0],M=I[1],K=I[2],y=I[3],F=H[0],E=H[1],D=H[2],G=H[3];var J,x,z,C,B;x=w*F+M*E+K*D+y*G;if(x<0){x=-x;F=-F;E=-E;D=-D;G=-G}if((1-x)>0.000001){J=Math.acos(x);z=Math.sin(J);C=Math.sin((1-L)*J)/z;B=Math.sin(L*J)/z}else{C=1-L;B=L}A[0]=C*w+B*F;A[1]=C*M+B*E;A[2]=C*K+B*D;
A[3]=C*y+B*G;return A};l.invert=function(C,y){var A=y[0],x=y[1],w=y[2],D=y[3],z=A*A+x*x+w*w+D*D,B=z?1/z:0;C[0]=-A*B;C[1]=-x*B;C[2]=-w*B;C[3]=D*B;return C};l.conjugate=function(x,w){x[0]=-w[0];x[1]=-w[1];x[2]=-w[2];x[3]=w[3];return x};l.length=q.length;l.len=l.length;l.squaredLength=q.squaredLength;l.sqrLen=l.squaredLength;l.normalize=q.normalize;l.fromMat3=function(A,w){var x=w[0]+w[4]+w[8];var C;if(x>0){C=Math.sqrt(x+1);A[3]=0.5*C;C=0.5/C;A[0]=(w[7]-w[5])*C;A[1]=(w[2]-w[6])*C;A[2]=(w[3]-w[1])*C}else{var B=0;
if(w[4]>w[0]){B=1}if(w[8]>w[B*3+B]){B=2}var z=(B+1)%3;var y=(B+2)%3;C=Math.sqrt(w[B*3+B]-w[z*3+z]-w[y*3+y]+1);A[B]=0.5*C;C=0.5/C;A[3]=(w[y*3+z]-w[z*3+y])*C;A[z]=(w[z*3+B]+w[B*3+z])*C;A[y]=(w[y*3+B]+w[B*3+y])*C}return A};l.str=function(w){return"quat("+w[0]+", "+w[1]+", "+w[2]+", "+w[3]+")"};if(typeof(o)!=="undefined"){o.quat=l}})(a.exports)})(this);function Landmark(a,d){if(!(d instanceof Camera)){alert("Landmark needs a Camera as argument");return null}this.name=a;var e=d;this._matrix=mat4.clone(e._matrix);
this._right=vec3.clone(e._right);this._up=vec3.clone(e._up);this._forward=vec3.clone(e._forward);this._position=vec3.clone(e._position);this._focalPoint=vec3.clone(e._focalPoint);this._distanceVector=vec3.clone(e._distanceVector);this._azimuth=e._azimuth;this._elevation=e._elevation;this._roll=e._roll;this._relAzimuth=e._relAzimuth;this._relElevation=e._relElevation;this._relRoll=e._relRoll;this._dollyingStep=e._dollyngStep;this._distance=e._distance}Landmark.prototype.retrieve=function(a){var d=a;
d._matrix=mat4.copy(d._matrix,this._matrix);d._right=vec3.copy(d._right,this._right);d._up=vec3.copy(d._up,this._up);d._forward=vec3.copy(d._forward,this._forward);d._position=vec3.copy(d._position,this._position);d._focalPoint=vec3.copy(d._focalPoint,this._focalPoint);d._distanceVector=vec3.copy(d._distanceVector,this._distanceVector);d._azimuth=this._azimuth;d._elevation=this._elevation;d._roll=this._roll;d._relAzimuth=this._relAzimuth;d._relElevation=this._relElevation;d._relRoll=this._relRoll;
d._dollyingStep=this._dollyngStep;d._distance=this._distance;d.refresh()};function Camera(c,a){this.UID=util.generateUID();this.view=c;this._matrix=mat4.create();this._right=vec3.fromValues(1,0,0);this._up=vec3.fromValues(0,1,0);this._forward=vec3.fromValues(0,0,1);this._position=vec3.fromValues(0,0,1);this._focalPoint=vec3.fromValues(0,0,0);this._distanceVector=vec3.fromValues(0,0,0);this._azimuth=0;this._elevation=0;this._roll=0;this._relAzimuth=0;this._relElevation=0;this._relRoll=0;this._dollyingStep=0;
this._distance=1;this._rotate_world=false;this._fov=define.Camera.FOV;this._near=define.Camera.NEAR;this._far=define.Camera.FAR;this._aspect=undefined;this._perspective=mat4.create();this.updatePerspective();this._following=undefined;this._trackingMode=define.Camera.TRACKING.DEFAULT;this.landmarks=[];this._lmarkAnimationID=undefined;if(a==undefined){this.setType(define.Camera.TYPE.EXPLORING)}else{this.setType(a)}}Camera.TYPE=define.Camera.TYPE;Camera.TRACKING=define.Camera.TRACKING;Camera.FRUSTUM=define.Camera.FRUSTUM;
Camera.AXIS=define.Camera.AXIS;Camera.prototype.setWorldRotation=function(a){this._rotate_world=a;this._getAngles();return this};Camera.prototype.setType=function(c,a){var d=Camera.TYPE;if(c!=d.ORBITING&&c!=d.TRACKING&&c!=d.EXPLORING){console.warn("Camera.setType WARNING type ["+c+"] unknown. Setting camera to EXPLORING type.");this.type=d.EXPLORING;this.setWorldRotation(true)}else{this.type=c;if(this.type==d.EXPLORING){this.setWorldRotation(true)}else{this.setWorldRotation(false)}this._getAngles()
}if(this.type==Camera.TYPE.TRACKING&&a!=undefined){this.setTrackingMode(a)}return this};Camera.prototype.setTrackingMode=function(a){if(this.type!=Camera.TYPE.TRACKING){alert("Impossible to set a tracking mode if the camera is not of tracking type");throw ("Impossible to set a tracking mode if the camera is not of tracking type")}if(a==undefined){return}this._trackingMode=a};Camera.prototype.follow=function(a,c){this.setType(Camera.TYPE.TRACKING,c);if(a instanceof Actor){instance=a}else{if(typeof(a)=="string"){instance=this.view.scene.getActorByName(a)
}}if(instance==undefined){console.error("Camera.follow ERROR: The actor "+a+" does not exist")}else{this._following=instance;instance.addTrackingCamera(this)}return this};Camera.prototype.unfollow=function(){this._following.removeTrackingCamera(this);this._following=undefined;return this};Camera.prototype.updateWithActor=function(a){if(this._following!=a){return}switch(this._trackingMode){case Camera.TRACKING.DEFAULT:break;case Camera.TRACKING.ROTATIONAL:case Camera.TRACKING.CINEMATIC:this.setFocalPoint(a._position);
break;case Camera.TRACKING.TRANSLATIONAL:this.translate(a._translation);this.setFocalPoint(a._position);break}};Camera.prototype.setPosition=function(a,d,c){this._setPosition(a,d,c);this.setFocalPoint(this._focalPoint);return this};Camera.prototype.setFocalPoint=function(n,l,k){var f=vec3.fromValues(0,1,0);this._focalPoint=util.createVec3(n,l,k);if(this._trackingMode==Camera.TRACKING.CINEMATIC){var h=vec3.subtract(vec3.create(),this._focalPoint,this._position);var n=h[0],l=h[1],k=h[2],a=vec3.length(h);
var c=Math.asin(l/a)*nucleo.def.rad2deg;var o=90+Math.atan2(k,n)*nucleo.def.rad2deg;var e=mat4.create();mat4.rotateY(e,e,o*nucleo.def.deg2rad);mat4.rotateX(e,e,c*nucleo.def.deg2rad);f=vec3.transformMat4(vec3.create(),[0,1,0],e)}mat4.invert(this._matrix,mat4.lookAt(mat4.create(),this._position,this._focalPoint,f));this._getAxes();this._getDistance();this._getAngles();return this};Camera.prototype.setDistance=function(c){if(this._distance==c||c<0){return}this._distance=c;if(this._distance<0.0002){this._distance=0.0002;
console.warn("Cameraa.setDistance WARN: Distance is set to minimum (0.0002)")}this._dollyingStep=this._distance/100;var h=vec3.create();var c=this._distance;var e=this._forward;var a=this._focalPoint;h[0]=c*e[0]+a[0];h[1]=c*e[1]+a[1];h[2]=c*e[2]+a[2];this._setPosition(h);return this};Camera.prototype.changeAzimuth=function(a){this.setAzimuth(this._azimuth+a);return this};Camera.prototype.changeElevation=function(a){this.setElevation(this._elevation+a);return this};Camera.prototype.changeRoll=function(a){this.setRoll(this._roll+a);
return this};Camera.prototype.setAzimuth=function(a){this._azimuth=this._getAngle(a);this._computeMatrix();this._getAxes();if(this.type==Camera.TYPE.ORBITING||this.type==Camera.TYPE.EXPLORING){this._getPosition()}else{if(this.type==Camera.TYPE.TRACKING){this._getFocalPoint()}}return this};Camera.prototype.setElevation=function(a){this._elevation=this._getAngle(a);this._computeMatrix();this._getAxes();if(this.type==Camera.TYPE.ORBITING||this.type==Camera.TYPE.EXPLORING){this._getPosition()}else{if(this.type==Camera.TYPE.TRACKING){this._getFocalPoint()
}}return this};Camera.prototype.setRoll=function(a){this._roll=this._getAngle(a);this._computeMatrix();this._getAxes();if(this.type==Camera.TYPE.ORBITING||this.type==Camera.TYPE.EXPLORING){this._getPosition()}else{if(this.type==Camera.TYPE.TRACKING){this._getFocalPoint()}}return this};Camera.prototype.rotate=function(l,k,d){if(this.type==Camera.TYPE.EXPLORING){l=this._getAngle(l);k=this._getAngle(k);d=this._getAngle(d);var h=quat.setAxisAngle(quat.create(),[1,0,0],-k*nucleo.def.deg2rad);var f=quat.setAxisAngle(quat.create(),[0,1,0],-l*nucleo.def.deg2rad);
if(this._rotate_world){h=quat.setAxisAngle(quat.create(),[1,0,0],k*nucleo.def.deg2rad);f=quat.setAxisAngle(quat.create(),[0,1,0],l*nucleo.def.deg2rad)}var e=quat.setAxisAngle(quat.create(),[0,0,1],d*nucleo.def.deg2rad);var c=quat.multiply(quat.create(),f,h);c=quat.multiply(quat.create(),c,e);var a=mat4.fromQuat(mat4.create(),c);mat4.translate(this._matrix,this._matrix,[0,0,-this._distance]);mat4.multiply(this._matrix,this._matrix,a);mat4.translate(this._matrix,this._matrix,[0,0,this._distance])}else{if(Math.abs(this._elevation+k)>90){return
}this._relElevation=this._getAngle(k);this._relAzimuth=this._getAngle(l);this._relRoll=this._getAngle(d);this._elevation+=this._relElevation;this._azimuth+=this._relAzimuth;this._roll+=this._relRoll;this._computeMatrix()}this._getAxes();if(this.type==Camera.TYPE.ORBITING||this.type==Camera.TYPE.EXPLORING){this._getPosition()}else{if(this.type==Camera.TYPE.TRACKING){this._getFocalPoint()}}this._update();return this};Camera.prototype.dolly=function(c){var e=this._forward;var d=vec3.clone(this._position);
var a=c*this._dollyingStep;d[0]+=a*e[0];d[1]+=a*e[1];d[2]+=a*e[2];this._setPosition(d);if(this.type==Camera.TYPE.ORBITING||this.type==Camera.TYPE.EXPLORING){this._getDistance()}else{if(this.type==Camera.TYPE.TRACKING){vec3.add(this._focalPoint,d,this._distanceVector)}}return this};Camera.prototype.pan=function(c,a){var d=util.createVec3(c,a,0);var e=vec3.clone(this._position);vec3.add(e,e,vec3.scale(vec3.create(),this._right,d[0]));vec3.add(e,e,vec3.scale(vec3.create(),this._up,d[1]));this._setPosition(e);
return this};Camera.prototype.translate=function(a,f,d){var c=util.createVec3(a,f,d);var e=vec3.clone(this._position);vec3.add(e,e,c);this._setPosition(e);return this};Camera.prototype.refresh=function(){this.view.refresh();return this};Camera.prototype.lookAt=function(a){if(a instanceof Actor){this.setFocalPoint(a._position)}else{if(typeof(a)=="string"){var a=this.view.scene.getActorByName(a);if(a==undefined){throw"Camera.lookAt ERROR: The actor "+actorName+" does not exist"}else{this.setFocalPoint(a._position)
}}}return this};Camera.prototype.closeUp=function(a){if(a instanceof Actor){this._shot(a._bb)}else{if(typeof(a)=="string"){var a=this.view.scene.getActorByName(a);if(a==undefined){throw"Camera.lookAt ERROR: The actor "+actorName+" does not exist"}else{this._shot(a._bb)}}}return this};Camera.prototype.longShot=function(){this.view.scene.computeBoundingBox();this._shot(this.view.scene.bb);return this};Camera.prototype.setFieldOfView=function(a){this._fov=a;return this};Camera.prototype.createLandmark=function(h,a,e,f){var k=new Camera(this.view,this.type);
k.setPosition(a);k.setFocalPoint(e);if(f!=undefined){k.setRoll(f)}var d=new Landmark(h,k);this.landmarks.push(d);return this};Camera.prototype.setLandmark=function(c){var a=new Landmark(c,this);this.landmarks.push(a);return this};Camera.prototype.gotoLandmark=function(a,e,f){var m=undefined;var k=this.landmarks.length;while(k--){if(this.landmarks[k].name==a){m=this.landmarks[k];break}}if(m==undefined){console.warn("Camera.goTo: landmark with name: "+a+", was not found");return}if(e==undefined||e==0){m.retrieve(this);
return}if(this._lmarkAnimationID!=undefined){window.clearTimeout(this._lmarkAnimationID)}var n=this;var o=m._position;var h=m._focalPoint;var l=m._roll;if(e==undefined){e=1000}if(f==undefined){f==20}var d=this.view.interactor;d.disconnectFromView();function c(v,s){var q=(v/100)*(s/10),w=v/q,u=0,x=new Date().getTime();function t(){var y=vec3.create();var A=vec3.create();var C=0;if(u++!=q){percent=u/q;percent2=(1-Math.cos(percent*Math.PI))/2;y=vec3.lerp(y,n._focalPoint,h,percent2);A=vec3.lerp(A,n._position,o,percent2);
C=n._roll*(1-percent2)+l*(percent2);n.setFocalPoint(y);n.setPosition(A);n.setRoll(C);n.refresh();var B=vec3.dist(y,h)+vec3.dist(A,o);if(B>0.01){var z=(new Date().getTime()-x)-(u*w);n._lmarkAnimationID=window.setTimeout(t,(w-z))}else{n.setFocalPoint(h);n.setPosition(o);n.setRoll(l);n.refresh();d.connectView(this.view)}return}}n._lmarkAnimationID=window.setTimeout(t,w)}c(e,f);return this};Camera.prototype.doLandmarkAnimation=function(a){var d=a.slice(0);var c=this;function e(){if(d.length==0){return
}if(c._stop_lmark_animation){c._stop_lmark_animation=false;util.console("Landmark Animation Stopped",true);return}step=d.splice(0,1)[0];lmark=step[0];duration=step[1];fps=step[2];c.gotoLandmark(lmark,duration,fps);window.setTimeout(e,duration)}e();return this};Camera.prototype.stopLandmarkAnimation=function(){this._stop_lmark_animation=true};Camera.prototype.getLandmarks=function(){var c=[];var a=this.landmarks.length;while(a--){c.push(this.landmarks[a].name)}return c};Camera.prototype._shot=function(e){this.setElevation(0);
this.setAzimuth(0);this.setRoll(0);var c=Math.max(e[3]-e[0],e[4]-e[1]);cc=[0,0,0];cc[0]=(e[3]+e[0])/2;cc[1]=(e[4]+e[1])/2;cc[2]=(e[5]+e[2])/2;cc[0]=Math.round(cc[0]*1000)/1000;cc[1]=Math.round(cc[1]*1000)/1000;cc[2]=Math.round(cc[2]*1000)/1000;if(c!=0){var a=1.5*c/(Math.tan(this._fov*Math.PI/180));this.setPosition([cc[0],cc[1],cc[2]+a])}this.setFocalPoint(cc);this.refresh()};Camera.prototype.setAspectRatio=function(a){this._aspect=a};Camera.prototype.setPerspective=function(f,e,c,h){var a=this.view;
this._fov=c;this._near=f;this._far=e;this._aspect=h;var d=util.deg2rad(c);if(this._aspect==undefined){mat4.perspective(this._perspective,d,a.width/a.height,this._near,this._far)}else{mat4.perspective(this._perspective,d,this._aspect,this._near,this._far)}};Camera.prototype.updatePerspective=function(){var a=this.view;var c=util.deg2rad(this._fov);if(this._aspect==undefined){mat4.perspective(this._perspective,c,a.width/a.height,this._near,this._far)}else{mat4.perspective(this._perspective,c,this._aspect,this._near,this._far)
}};Camera.prototype.status=function(){console.info("------------- Camera Status -------------");console.info("       type: "+this.type);console.info("      right: "+util.format(this._right,2));console.info("         up: "+util.format(this._up,2));console.info("    forward: "+util.format(this._forward,2));console.info("   position: "+util.format(this._position,2));console.info("focal point: "+util.format(this._focalPoint,2));console.info("    azimuth: "+util.format(this._azimuth,2));console.info("  elevation: "+util.format(this._elevation,2));
console.info("       roll: "+util.format(this._roll,2));console.info("   distance: "+util.format(this._distance,2));console.info("   d vector: "+util.format(this._distanceVector,2))};Camera.prototype.getViewTransform=function(){return mat4.invert(mat4.create(),this._matrix)};Camera.prototype.setMatrix=function(a){this._matrix=a;this._update()};Camera.prototype._computeMatrix=function(){mat4.identity(this._matrix);var d=quat.setAxisAngle(quat.create(),[0,0,1],this._roll*nucleo.def.deg2rad);var f=undefined;
var e=undefined;if(this.type==Camera.TYPE.TRACKING){f=quat.setAxisAngle(quat.create(),[1,0,0],this._elevation*nucleo.def.deg2rad);e=quat.setAxisAngle(quat.create(),[0,1,0],this._azimuth*nucleo.def.deg2rad)}else{if(this._rotate_world){f=quat.setAxisAngle(quat.create(),[1,0,0],this._elevation*nucleo.def.deg2rad);e=quat.setAxisAngle(quat.create(),[0,1,0],this._azimuth*nucleo.def.deg2rad)}else{f=quat.setAxisAngle(quat.create(),[1,0,0],-this._elevation*nucleo.def.deg2rad);e=quat.setAxisAngle(quat.create(),[0,1,0],-this._azimuth*nucleo.def.deg2rad)
}}var c=quat.multiply(quat.create(),e,f);c=quat.multiply(quat.create(),c,d);var a=mat4.fromQuat(mat4.create(),c);if(this.type==Camera.TYPE.ORBITING||this.type==Camera.TYPE.EXPLORING){mat4.translate(this._matrix,this._matrix,this._focalPoint);mat4.multiply(this._matrix,this._matrix,a);mat4.translate(this._matrix,this._matrix,[0,0,this._distance])}else{if(this.type==Camera.TYPE.TRACKING){mat4.translate(this._matrix,this._matrix,this._position);mat4.multiply(this._matrix,this._matrix,a)}}};Camera.prototype._setPosition=function(c,e,d){this._position=util.createVec3(c,e,d);
var a=this._matrix;a[12]=this._position[0];a[13]=this._position[1];a[14]=this._position[2];a[15]=1};Camera.prototype._getAxes=function(){var a=this._matrix;vec3.copy(this._right,vec4.transformMat4(vec4.create(),[1,0,0,0],a));vec3.copy(this._up,vec4.transformMat4(vec4.create(),[0,1,0,0],a));vec3.copy(this._forward,vec4.transformMat4(vec4.create(),[0,0,1,0],a));vec3.normalize(this._right,this._right);vec3.normalize(this._up,this._up);vec3.normalize(this._forward,this._forward)};Camera.prototype._getPosition=function(){var a=this._matrix;
vec3.copy(this._position,vec4.transformMat4(vec4.create(),[0,0,0,1],a));this._getDistance()};Camera.prototype._getFocalPoint=function(){vec3.transformMat3(this._distanceVector,[0,0,-this._distance],mat3.fromMat4(mat3.create(),this._matrix));vec3.add(this._focalPoint,this._position,this._distanceVector);this._getDistance()};Camera.prototype._getDistance=function(){this._distanceVector=vec3.subtract(vec3.create(),this._focalPoint,this._position);this._distance=vec3.length(this._distanceVector);this._dollyingStep=this._distance/100
};Camera.prototype._getAngles=function(){var a=this._distanceVector[0],e=this._distanceVector[1],d=this._distanceVector[2];var c=vec3.length(this._distanceVector);if(c==0){this._elevation=0;this._azimuth=0;return}if(this.type==Camera.TYPE.TRACKING){this._elevation=Math.asin(e/c)*nucleo.def.rad2deg;this._azimuth=Math.atan2(-a,-d)*nucleo.def.rad2deg}else{if(this._rotate_world){this._elevation=Math.asin(e/c)*nucleo.def.rad2deg;this._azimuth=Math.atan2(-a,-d)*nucleo.def.rad2deg}else{this._elevation=-1*Math.asin(e/c)*nucleo.def.rad2deg;
this._azimuth=-1*Math.atan2(-a,-d)*nucleo.def.rad2deg}}};Camera.prototype._update=function(){this._getAxes();this._getPosition();this._getDistance();this._getAngles()};Camera.prototype._calculateAngles=function(){var h=mat4.toMat3(this._matrix);var e=mat3.toQuat4(h);var l=e[0],k=e[1],f=e[2],m=e[3];var c=Math.atan2(2*(m*l+k*f),1-2*(l*l+k*k))*nucleo.def.rad2deg;var a=Math.asin(2*(m*k-f*k))*nucleo.def.rad2deg;var d=Math.atan2(2*(m*f+l*k),1-2*(k*k+f*f))*nucleo.def.rad2deg;console.info(" roll :"+util.format(c,2));
console.info("pitch :"+util.format(a,2));console.info("  yaw :"+util.format(d,2))};Camera.prototype._getAngle=function(a){if(a==undefined){return 0}else{if(a>360||a<-360){return a%360}else{return a}}};function CameraManager(a){this.view=a;this.cameras=[];this.active=this.create(Camera.TYPE.EXPLORING);if(nucleo.c.camera==undefined){nucleo.c.camera=this.active}}CameraManager.prototype.reset=function(a){this.cameras=[];this.interactors=[];this.active=this.create(a)};CameraManager.prototype.create=function(c){var a=new Camera(this.view,c);
this.cameras.push(a);return a};CameraManager.prototype.remove=function(a){if(this.cameras.length==1){throw ("CameraManager.remove ERROR: the camera manager must not eliminate the last camera standing. Operation cancelled")}else{this.cameras.splice(a,1)}};CameraManager.prototype.get=function(a){this._checkBoundary(a);return this.cameras[a]};CameraManager.prototype.switchTo=function(a){var c=this.view;this._checkBoundary(a);this.active=this.cameras[a];if(c.interactor!=undefined){c.interactor.connectCamera(this.active)
}else{throw ("CameraManager.switchTo ERROR: switching to camera ["+a+"] while the view "+c.name+" does not have an interactor set")}nucleo.c.camera=this.active;return this.active};CameraManager.prototype._checkBoundary=function(a){if(a<0||a>=this.cameras.length){throw ("The camera "+a+" does not exist")}};function ViewInteractor(){this.view=undefined;this.camera=undefined;this.UID=util.generateUID();this.keymap={};this.keysEnabled=true}ViewInteractor.prototype.getType=function(){return"ViewInteractor"
};ViewInteractor.prototype.disconnectFromView=function(){canvas=this.view.canvas;canvas.onmousedown=null;canvas.onmouseup=null;canvas.onmousemove=null;canvas.ondragover=null;canvas.ondragleave=null;canvas.ondrop=null;window.onkeydown=null;window.onkeyup=null;canvas.ondblclick=null};ViewInteractor.prototype.connectView=function(a){if(!(a instanceof View)){throw"ViewInteractor.connectView: the parameter is not a View"}var d=this;var c=a.canvas;this.view=a;this.camera=a.cameraman.active;c.onmousedown=function(e){d.onMouseDown(e)
};c.onmouseup=function(e){d.onMouseUp(e)};c.onmousemove=function(e){d.onMouseMove(e)};c.ondragover=function(e){d.onDragOver(e)};c.ondragleave=function(e){d.onDragLeave(e)};c.ondrop=function(e){d.onDrop(e)};window.onkeydown=function(e){d.onKeyDown(e)};window.onkeyup=function(e){d.onKeyUp(e)};c.ondblclick=function(e){d.onDoubleClick(e)}};ViewInteractor.prototype.connectCamera=function(a){if(a instanceof Camera){this.camera=a;this.camera.interactor=this}else{throw ("ViewInteractor.connectCamera: The object "+a+" is not a valid camera")
}};ViewInteractor.prototype.addKeyAction=function(c,d){var a=c.charCodeAt(0);this.keymap[a]=d};ViewInteractor.prototype.removeKeyAction=function(c){var a=c.charCodeAt(0);delete this.keymap[a]};ViewInteractor.prototype.fireKeyAction=function(a){if(!this.keysEnabled){return}if(this.keymap[a]){this.keymap[a](this.view,this.camera)}};ViewInteractor.prototype.enableKeyActions=function(a){this.keysEnabled=a};TrackerInteractor.prototype=new ViewInteractor();TrackerInteractor.prototype.constructor=ViewInteractor;
function TrackerInteractor(){ViewInteractor.call(this);this.MOTION_FACTOR=10;this.task=nucleo.def.interactor.task.NONE;this._x=0;this._y=0;this._lastX=0;this._lastY=0;this._lastClickedX=0;this._lastClickedY=0;this._ctrl_key=false;this._alt_key=false;this._shift_key=false;this._key=0;this._button=-1;this._dragging=false;this._dragndrop=false;this._is_mac=util.isMac();this.addKeyAction("F",function(a,c){a.fullscreen(true)});this.addKeyAction("X",function(a,c){a.fullscreen(false)})}TrackerInteractor.prototype.getType=function(){return"TrackerInteractor"
};TrackerInteractor.prototype.onKeyDown=function(e){this._key=e.keyCode;this._alt_key=e.altKey;this._shift_key=e.shiftKey;var d=this.camera;if(!this._alt_key&&!this._shift_key){switch(this._key){case 38:d.changeElevation(10);break;case 40:d.changeElevation(-10);break;case 37:d.changeAzimuth(-10);break;case 39:d.changeAzimuth(10);break;default:this.fireKeyAction(this._key)}}else{if(this._shift_key&&this._key!=17){var c=0;var a=0;switch(this._key){case 38:a=10;break;case 40:a=-10;break;case 37:c=-10;
break;case 39:c=10;break;default:this.fireKeyAction(this._key)}if(c!=0||a!=0){this.pan(c,a)}}}this.camera.refresh()};TrackerInteractor.prototype.onKeyUp=function(a){if(a.keyCode==17){this._ctrl_key=false}};TrackerInteractor.prototype.onMouseUp=function(a){task=nucleo.def.interactor.task.NONE;this._dragging=false};TrackerInteractor.prototype.onMouseDown=function(a){this._x=a.clientX;this._y=a.clientY;this._lastClickedX=this._x;this._lastClickedY=this._y;this._button=a.button;this._dragging=true};TrackerInteractor.prototype.onMouseMove=function(a){this._lastX=this._x;
this._lastY=this._y;this._x=a.clientX;this._y=a.clientY;if(!this._dragging){return}if(this._button!=0){return}this._ctrl_key=a.ctrlKey;if(this._is_mac&&a.metaKey){this._ctrl_key=true}this._alt_key=a.altKey;this._shift_key=a.shiftKey;var d=this._x-this._lastX;var c=this._y-this._lastY;if(this._ctrl_key&&!this._shift_key){this.dolly(c)}else{if(this._shift_key&&!this._ctrl_key){this.pan(d,c)}else{if(this._ctrl_key&&this._shift_key){this.roll(c)}else{this.rotate(d,c)}}}this.camera.refresh()};TrackerInteractor.prototype.onDragOver=function(a){a.stopPropagation();
a.preventDefault();if(this.view._dragndrop){if(!this._dragndrop){this.bgcolor=this.view.backgroundColor.slice(0);this._dragndrop=true}a.dataTransfer.dropEffect="copy";this.view.setBackgroundColor(0,0.514,0.678)}};TrackerInteractor.prototype.onDragLeave=function(a){a.stopPropagation();a.preventDefault();if(this.view._dragndrop){a.dataTransfer.dropEffect="copy";this.view.setBackgroundColor(this.bgcolor);this._dragndrop=false}};TrackerInteractor.prototype.onDrop=function(d){d.stopPropagation();d.preventDefault();
if(!this.view._dragndrop){return}this._dragndrop=false;this.view.setBackgroundColor(this.bgcolor);var c=d.dataTransfer.files;var a=new VTKReader(this.view.scene);if(a.isSupported()){a.readFile(c[0])}else{throw"TrackerInteractor.drop: File API is not supported on this browser"}};TrackerInteractor.prototype.onDoubleClick=function(a){this.camera.longShot()};TrackerInteractor.prototype.dolly=function(a){this.task=nucleo.def.interactor.task.DOLLY;this.camera.dolly(a)};TrackerInteractor.prototype.roll=function(e){this.task=nucleo.def.interactor.task.ROLL;
var c=this.camera.view.canvas;var a=-20/c.width;var d=e*a*this.MOTION_FACTOR;this.camera.rotate(0,0,d)};TrackerInteractor.prototype.rotate=function(d,a){this.task=nucleo.def.interactor.task.ROTATE;var h=this.camera.view.canvas;var m=-20/h.height;var l=-20/h.width;var e=this.MOTION_FACTOR;var c=this.MOTION_FACTOR;if(d*d>2*a*a){c*=0.5}else{if(a*a>2*d*d){e*=0.5}}var k=d*m*e;var f=a*l*c;this.camera.rotate(k,f)};TrackerInteractor.prototype.pan=function(o,n){this.task=nucleo.def.interactor.task.PAN;var f=this.camera;
var a=f.view.canvas;var e=f.view.scene;this._dragndrop=false;var m=Math.max(a.width,a.height);var d=1/m;var c=1/m;var h=e.bb.max();var l=o*d*this.MOTION_FACTOR*h/2;var k=-n*c*this.MOTION_FACTOR*h/2;f.pan(l,k)};PickerInteractor.prototype=new TrackerInteractor();PickerInteractor.prototype.constructor=PickerInteractor;function PickerInteractor(){TrackerInteractor.call(this);this.timerID=-1;this.list=[];this.rate=50;this._actors=[];this._picking_list=[];this._picking_mode=false;this._cellpicking=false
}PickerInteractor.prototype.setCellPicking=function(a){this._cellpicking=a};PickerInteractor.prototype.getType=function(){return"PickerInteractor"};PickerInteractor.prototype._getCoords=function(d){var a,k,h=0,f=0,e=this.view.canvas;var c=e.getBoundingClientRect();a=d.clientX-c.left;k=nucleo.c.view.canvas.height-(d.clientY-c.top);return[a,k]};PickerInteractor.prototype._getActorAt=function(a,h){var e,d,c;var f=this.view.scene;c=this.view.renderer.readOffscreenPixel(a,h);if(c[0]==0&&c[1]==0&&c[2]==0&&c[3]==0){return null
}d=nucleo.go.picker.query(c);if(d==null){return null}e=f.getActorByCellUID(d.uid);if(e==null){e=f.getActorByUID(d.uid)}if(e!=null&&e.isPickable()){return e}return null};PickerInteractor.prototype.onMouseDown=function(d){TrackerInteractor.prototype.onMouseDown.call(this,d);d.preventDefault();this.view.canvas.style.cursor="crosshair";coords=this._getCoords(d);var c=this._getActorAt(coords[0],coords[1]);if(c==null){this._endPicking();return}var a=this._picking_list.indexOf(c.UID);if(a==-1){if(c._pick_callback!=undefined){c._pick_callback(c,c.UID)
}this._picking_list.push(c.UID);this._actors.push(c)}else{this._picking_list.splice(a,1);this._actors.splice(a,1);if(c._unpick_callback){c._unpick_callback(c,c.UID)}}};PickerInteractor.prototype.onMouseUp=function(a){TrackerInteractor.prototype.onMouseUp.call(this,a);if(!a.shiftKey){this.view.canvas.style.cursor="default";this._endPicking()}};PickerInteractor.prototype.onMouseMove=function(a){a.preventDefault();TrackerInteractor.prototype.onMouseMove.call(this,a)};PickerInteractor.prototype.setCallback=function(a){this.callback=a
};PickerInteractor.prototype._endPicking=function(){if(this.callback){this.callback(this._actors)}var a=this._actors.length;while(a--){if(this._actors[a]._unpick_callback){this._actors[a]._unpick_callback(this._actors[a],this._actors[a].UID)}}this._actors=[];this._picking_list=[]};CellPickerInteractor.prototype=new ViewInteractor();CellPickerInteractor.prototype.constructor=CellPickerInteractor;function CellPickerInteractor(){TrackerInteractor.call(this);this.timerID=-1;this.list=[];this.rate=5}CellPickerInteractor.prototype.getType=function(){return"CellPickerInteractor"
};CellPickerInteractor.prototype.get2DCoords=function(d){var a,k,h=0,f=0,e=this.view.canvas;var c=e.getBoundingClientRect();a=d.clientX-c.left;k=nucleo.c.view.canvas.height-(d.clientY-c.top);return[a,k]};CellPickerInteractor.prototype.onMouseUp=function(a){TrackerInteractor.prototype.onMouseUp.call(this,a);this.view.canvas.style.cursor="default";if(this.timerID!=-1){clearInterval(this.timerID)}};CellPickerInteractor.prototype.onMouseDown=function(a){TrackerInteractor.prototype.onMouseDown.call(this,a);
a.preventDefault();this.view.canvas.style.cursor="crosshair";this.list.push(this.get2DCoords(a));this._doWork();if(this.timerID!=-1){clearInterval(this.timerID)}this.timerID=setInterval((function(c){return function(){c._doWork()}})(this),this.rate)};CellPickerInteractor.prototype.onMouseMove=function(a){a.preventDefault();if(this._dragging){this.list.push(this.get2DCoords(a))}};CellPickerInteractor.prototype._doWork=function(){var d=this.list.length;var h=this.view.renderer;var k=this.view.scene;
while(d--){var f=this.list.pop();var a=h.readOffscreenPixel(f[0],f[1]);if(a[0]==0&&a[1]==0&&a[2]==0&&a[3]==0){continue}var c=nucleo.go.picker.query(a);if(c==null){continue}var e=k.getActorByCellUID(c.uid);if(e==null){e=k.getActorByUID(c.uid)}if(e!=null&&e.isPickable()&&e._pick_callback!=undefined){e._pick_callback(e,c.uid)}}};CellPickerInteractor.prototype.onKeyDown=function(a){};CellPickerInteractor.prototype.onKeyUp=function(a){};CellPickerInteractor.prototype.onDragOver=function(a){};CellPickerInteractor.prototype.onDragLeave=function(a){};
CellPickerInteractor.prototype.onDrop=function(a){};CellPickerInteractor.prototype.onDoubleClick=function(a){};function Transforms(a){this._stack=[];this.view=a;this.model_view=mat4.create();this.projection=mat4.create();this.camera=mat4.create();this.normal=mat4.create();this.projection_model_view=mat4.create()}Transforms.prototype.calculateModelView=function(){this.model_view=mat4.copy(this.model_view,this.view.cameraman.active.getViewTransform())};Transforms.prototype.calculateCamera=function(){this.camera=mat4.inverse(this.camera,this.model_view)
};Transforms.prototype.calculateNormal=function(){this.normal=mat4.clone(this.model_view);this.normal=mat4.invert(mat4.create(),this.normal);this.normal=mat4.transpose(this.normal,this.normal)};Transforms.prototype.calculateProjection=function(){var a=this.view.cameraman.active;a.updatePerspective();this.projection=a._perspective};Transforms.prototype.calculateProjectionModelView=function(){mat4.multiply(this.projection_model_view,this.projection,this.model_view)};Transforms.prototype.update=function(){this.calculateModelView();
this.calculateProjection();this.calculateNormal();this.calculateProjectionModelView()};Transforms.prototype.push=function(){var a=mat4.create();mat4.copy(a,this.model_view);this._stack.push(a)};Transforms.prototype.pop=function(){if(this._stack.length==0){return}this.model_view=this._stack.pop();this.calculatePerspective();this.calculateNormal();this.calculateProjectionModelView()};function Program(){this.ID=undefined;this.ATTRIBUTES=[];this.UNIFORMS=[];this.VERTEX_SHADER="";this.FRAGMENT_SHADER="";
this.DEFAULTS={}}Program.prototype.copy=function(a){this.ID=a.ID;this.ATTRIBUTES=a.ATTRIBUTES;this.UNIFORMS=a.UNIFORMS;this.VERTEX_SHADER=a.VERTEX_SHADER;this.FRAGMENT_SHADER=a.FRAGMENT_SHADER;this.DEFAULTS=a.DEFAULTS};Program.prototype.introspect=function(){this.ATTRIBUTES=[];this.UNIFORMS=[];var e=this.VERTEX_SHADER.concat(this.FRAGMENT_SHADER);e=e.replace(/(\r\n|\n\r|\n)/gm,"");var a=e.match(/(uniform)\s*\w*\s*\w*/g);var c=e.match(/(attribute)\s*\w*\s*\w*/g);if(a.length==0){throw new vxlProgramException("The code for the program "+this.ID+" does not contain any valid uniforms")
}if(c.length==0){throw new vxlProgramException("The code for the program "+this.ID+" does not contain any valid attributes")}for(var d=0,f=a.length;d<f;d+=1){this.UNIFORMS.push(a[d].substr(a[d].lastIndexOf(" ")+1,a[d].length))}for(var d=0,f=c.length;d<f;d+=1){this.ATTRIBUTES.push(c[d].substr(c[d].lastIndexOf(" ")+1,c[d].length))}};Program.createFromDOM=function(h,c,a){var d=new Program();d.ID=h;var f=document.getElementById(c);var e=document.getElementById(a);if(f==null||e==null){throw new vxlProgramException("shaders don't exist")
}d.VERTEX_SHADER=f.innerHTML;d.FRAGMENT_SHADER=e.innerHTML;d.introspect();return d};Program.createFromJSON=function(a){var c=new Program();if(a.ID){c.ID=a.ID}c.VERTEX_SHADER=a.VERTEX_SHADER;c.FRAGMENT_SHADER=a.FRAGMENT_SHADER;c.DEFAULTS=a.DEFAULTS;c.introspect();return c};Program.createFromTextURL=function(d,c,a){};function vxlProgramException(a){this.message="vxlProgramException:"+a}LambertProgram.prototype=new Program();LambertProgram.prototype.constructor=LambertProgram;function LambertProgram(){this.copy(Program.createFromJSON({ID:"lambert",VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec2 aVertexTextureCoords;","uniform float uPointSize;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mNormal;","uniform vec3 uLightDirection;","uniform vec4 uLightAmbient;","uniform vec4 uLightDiffuse;","uniform vec4 uMaterialDiffuse;","uniform bool uUseShading;","uniform bool uUseVertexColors;","uniform bool uUseLightTranslation;","uniform bool uUseTextures;","varying vec4 vFinalColor;","varying vec2 vTextureCoords;","void main(void) {","   gl_Position = mPerspective * mModelView * vec4(aVertexPosition, 1.0);","   gl_PointSize = uPointSize;","   if (uUseVertexColors) {","       vFinalColor = vec4(aVertexColor,uMaterialDiffuse.a);","   }","   else {","       vFinalColor = uMaterialDiffuse;","   }","   if (uUseShading){","       vec3 N = normalize(vec3(mNormal * vec4(aVertexNormal, 1.0)));","       vec3 L = normalize(uLightDirection);","       if (uUseLightTranslation){ L = vec3(mNormal * vec4(L,1.0));}","       float lambertTerm = max(dot(N,-L),0.4);","       vec4 Ia = uLightAmbient;","       vec4 Id = vFinalColor * uLightDiffuse * lambertTerm;","       vFinalColor = Ia + Id;","       vFinalColor.a = uMaterialDiffuse.a;","   }","   if (uUseTextures){","       vTextureCoords = aVertexTextureCoords;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","varying vec4      vFinalColor;","varying vec2      vTextureCoords;","uniform bool      uUseTextures;","uniform sampler2D uSampler;","void main(void)  {","   if (uUseTextures){","       gl_FragColor = texture2D(uSampler, vTextureCoords);","   }","   else{","       gl_FragColor = vFinalColor;","   }","}"].join("\n"),DEFAULTS:{uLightDirection:[0,0,-1],uLightAmbient:[0,0,0,1],uLightDiffuse:[1,1,1,1],uMaterialDiffuse:[0.9,0.9,0.9,1],uPointSize:1,uUseLightTranslation:false}}))
}nucleo.go.essl.lambert=new LambertProgram();PhongProgram.prototype=new Program();PhongProgram.prototype.constructor=PhongProgram;function PhongProgram(){this.copy(Program.createFromJSON({ID:"phong",VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec2 aVertexTextureCoords;","uniform float uPointSize;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mModelViewPerspective;","uniform mat4 mNormal;","uniform bool uUseVertexColors;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2 vTextureCoords;","uniform bool uUseTextures;","void main(void) {","  gl_Position = mPerspective * mModelView * vec4(aVertexPosition, 1.0);","  gl_PointSize = uPointSize;","   if(uUseVertexColors) {","       vFinalColor = vec4(aVertexColor,1.0);","       return;","   }","   vec4 vertex = mModelView * vec4(aVertexPosition, 1.0);","   vNormal = vec3(mNormal * vec4(aVertexNormal, 1.0));","   vEyeVec = -vec3(vertex.xyz);","   if (uUseTextures){","       vTextureCoords = aVertexTextureCoords;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","uniform bool uUseShading;","uniform bool uUseVertexColors;","uniform float uShininess;      ","uniform vec3 uLightDirection;  ","uniform vec4 uLightAmbient;    ","uniform vec4 uLightDiffuse;    ","uniform vec4 uLightSpecular;   ","uniform vec4 uMaterialAmbient; ","uniform vec4 uMaterialDiffuse; ","uniform vec4 uMaterialSpecular;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2      vTextureCoords;","uniform bool      uUseTextures;","uniform sampler2D uSampler;","void main(void)","{","  vec4 finalColor = vec4(0.0);","  vec3 L = normalize(uLightDirection);","  vec3 N = normalize(vNormal);","  float lambertTerm = dot(N,-L);","  vec4 Ia = uLightAmbient * uMaterialAmbient;","  vec4 Id = vec4(0.0,0.0,0.0,1.0);","  vec4 Is = vec4(0.0,0.0,0.0,1.0);","  vec4 varMaterialDiffuse = uMaterialDiffuse;","  if(uUseVertexColors) {","        varMaterialDiffuse = vFinalColor;","   }","  if(uUseShading){  ","      if(lambertTerm > 0.0)","      {","          Id = uLightDiffuse * varMaterialDiffuse * lambertTerm;","          vec3 E = normalize(vEyeVec);","          vec3 R = reflect(L, N);","          float specular = pow( max(dot(R, E), 0.0), uShininess);","          Is = uLightSpecular * uMaterialSpecular * specular;","      }","      finalColor = Ia + Id + Is;","      finalColor.a = uMaterialDiffuse.a;","  } ","  else {","      finalColor = varMaterialDiffuse; ","  }","   if (uUseTextures){","       finalColor =  texture2D(uSampler, vec2(vTextureCoords.s, vTextureCoords.t));","   }","   gl_FragColor = finalColor;","}"].join("\n"),DEFAULTS:{uShininess:230,uLightDirection:[0,-1,-1],uLightAmbient:[0.03,0.03,0.03,1],uLightDiffuse:[1,1,1,1],uLightSpecular:[1,1,1,1],uMaterialAmbient:[1,1,1,1],uMaterialDiffuse:[0.8,0.8,0.8,1],uMaterialSpecular:[1,1,1,1]}}))
}nucleo.go.essl.phong=new PhongProgram();BakeProgram.prototype=new Program();BakeProgram.prototype.constructor=BakeProgram;function BakeProgram(){this.copy(Program.createFromJSON({ID:"bake",VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec3 aPosition;","attribute vec3 aScale;","attribute float aShading;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mNormal;","uniform mat4 mModelViewPerspective;","uniform vec3 uLightDirection;","uniform vec4 uLightAmbient;","uniform vec4 uLightDiffuse;","uniform bool uUseLightTranslation;","varying vec4 vFinalColor;","void main(void) {","   vec3 position = (aVertexPosition * aScale) + aPosition;","   gl_Position = mModelViewPerspective * vec4(position, 1.0);","   vFinalColor = vec4(aVertexColor,1.0);","   if (aShading == 1.0){","      vec3 N = vec3(mNormal * vec4(aVertexNormal, 1.0));","      vec3 L = normalize(uLightDirection);","      if (uUseLightTranslation) { L = vec3(mNormal * vec4(L,1.0));}","      float lambertTerm = max(dot(N,-L),0.4);","      vec4 Ia = uLightAmbient;","      vec4 Id = vFinalColor * uLightDiffuse * lambertTerm;","      vFinalColor = Ia + Id;","      vFinalColor.a = 1.0;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","varying vec4  vFinalColor;","void main(void)  {","       gl_FragColor = vFinalColor;","}"].join("\n"),DEFAULTS:{uLightDirection:[0,0,-1],uLightAmbient:[0,0,0,1],uLightDiffuse:[1,1,1,1],uUseLightTranslation:false}}))
}nucleo.go.essl.bake=new BakeProgram();DashProgram.prototype=new Program();DashProgram.prototype.constructor=DashProgram;function DashProgram(){this.copy(Program.createFromJSON({ID:"dash",VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec2 aVertexTextureCoords;","attribute mat4 aActorMatrix;","uniform float uPointSize;","uniform bool uUseTextures;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mModelViewPerspective;","uniform mat4 mNormal;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2 vTextureCoords;","void main(void) {","  mat4 matrix = aActorMatrix; ","  gl_Position =  mPerspective * mModelView * matrix * vec4(aVertexPosition, 1.0);","  gl_PointSize = uPointSize;","  vFinalColor = vec4(aVertexColor,1.0);","  vec4 vertex = mModelView * vec4(aVertexPosition, 1.0);","  vNormal = vec3(mNormal * vec4(aVertexNormal, 1.0));","  vEyeVec = -vec3(vertex.xyz);","  if (uUseTextures){","       vTextureCoords = aVertexTextureCoords;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","uniform bool uUseShading;","uniform float uShininess;      ","uniform vec3 uLightDirection;  ","uniform vec4 uLightAmbient;    ","uniform vec4 uLightDiffuse;    ","uniform vec4 uLightSpecular;   ","uniform vec4 uMaterialAmbient; ","uniform vec4 uMaterialDiffuse; ","uniform vec4 uMaterialSpecular;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2      vTextureCoords;","uniform bool      uUseTextures;","uniform sampler2D uSampler;","void main(void)","{","  vec4 finalColor = vec4(0.0);","  vec3 L = normalize(uLightDirection);","  vec3 N = normalize(vNormal);","  float lambertTerm = dot(N,-L);","  vec4 Ia = uLightAmbient * uMaterialAmbient;","  vec4 Id = vec4(0.0,0.0,0.0,1.0);","  vec4 Is = vec4(0.0,0.0,0.0,1.0);","  vec4 varMaterialDiffuse = vFinalColor;","  if(uUseShading){  ","      if(lambertTerm > 0.0)","      {","          Id = uLightDiffuse * varMaterialDiffuse * lambertTerm;","          vec3 E = normalize(vEyeVec);","          vec3 R = reflect(L, N);","          float specular = pow( max(dot(R, E), 0.0), uShininess);","          Is = uLightSpecular * uMaterialSpecular * specular;","      }","      finalColor = Ia + Id + Is;","      finalColor.a = uMaterialDiffuse.a;","  } ","  else {","      finalColor = varMaterialDiffuse; ","  }","   if (uUseTextures){","       finalColor =  texture2D(uSampler, vec2(vTextureCoords.s, vTextureCoords.t));","   }","   gl_FragColor = finalColor;","}"].join("\n"),DEFAULTS:{uUseTextures:false,uShininess:230,uLightDirection:[0,-1,-1],uLightAmbient:[0.03,0.03,0.03,1],uLightDiffuse:[1,1,1,1],uLightSpecular:[1,1,1,1],uMaterialAmbient:[1,1,1,1],uMaterialDiffuse:[0.8,0.8,0.8,1],uMaterialSpecular:[1,1,1,1]}}))
}nucleo.go.essl.dash=new DashProgram();function ProgramManager(a){this._gl=a;this._registered_programs={};this._programs={};this._uniform_map={};this._uniform_types={};this._current_program_object=null;this._current_program_ID=undefined;this._curr_uniform_loc_map={};this._curr_uniform_cache={};this._curr_attribute_loc_map={};this._enabled_attribute_list=[];this._defaults=[];this._one_time_warning=false;this._program_enforced=false}ProgramManager.prototype._isProgramRegistered=function(a){return(this._registered_programs[a]!=undefined)
};ProgramManager.prototype._registerProgram=function(a){util.console("Registering program "+a.ID);this._registered_programs[a.ID]=a};ProgramManager.prototype._isProgramCreated=function(a){return(this._programs[a]!=undefined)};ProgramManager.prototype._createProgramObject=function(c){if(this._isProgramCreated(c)){return}var f=this._registered_programs[c];if(f==undefined){var e="ProgramManager.loadProgram ERROR:  The program "+c+" must be registered first!";console.error(e);return}var k=this._gl;var d=k.createProgram();
var h=nucleo.def.essl;if(f.VERTEX_SHADER){var l=this._createShader(h.VERTEX_SHADER,f.VERTEX_SHADER);k.attachShader(d,l)}if(f.FRAGMENT_SHADER){var a=this._createShader(h.FRAGMENT_SHADER,f.FRAGMENT_SHADER);k.attachShader(d,a)}k.bindAttribLocation(d,0,h.VERTEX_ATTRIBUTE);k.linkProgram(d);if(!k.getProgramParameter(d,k.LINK_STATUS)){alert(c+":\n\n "+k.getProgramInfoLog(d));throw ("Error linking program "+c+":\n\n "+k.getProgramInfoLog(d))}this._programs[c]=d};ProgramManager.prototype.useProgram=function(a){var d=this._gl;
var c=this._programs[a];if(c!=undefined&&c!=null){if(c==this._current_program_object){return}d.useProgram(c);this._current_program_object=c;this._current_program_ID=a;this._parseUniforms();this._one_time_warning=false}else{alert("Program: the program "+a+" has NOT been loaded")}};ProgramManager.prototype.releaseProgram=function(){this._enforce=false};ProgramManager.prototype.setProgram=function(c,e){var a=undefined;if(typeof c=="function"){a=new c()}else{if(typeof c=="object"){a=c}else{console.error("ProgramManager.setProgram ERROR: "+c+" is not an engine");
return}}if(this._enforce&&a.ID!=this._current_program_id){var d="ProgramManager.setProgram WARN: Unable to set the program "+a.ID+".\nThe current program ["+a.ID+"] is being enforced\nPlease use releaseProgram first.";console.warn(d);return}this._program_enforced=(e!=undefined&&e==true);if(!this._isProgramRegistered(a.ID)){this._registerProgram(a)}if(!this._isProgramCreated(a.ID)){this._createProgramObject(a.ID)}this.useProgram(a.ID);this.clearCache();this.loadDefaults()};ProgramManager.prototype.clearCache=function(){this._curr_uniform_cache={};
this._curr_uniform_loc_map={};this._curr_attribute_loc_map={}};ProgramManager.prototype.loadDefaults=function(){var c=this._registered_programs[this._current_program_ID];if("DEFAULTS" in c){var d=c.DEFAULTS;for(var a in d){this.setUniform(a,d[a])}}var d=this._defaults[this._current_program_ID];if(d!=undefined){for(var a in d){this.setUniform(a,d[a])}}};ProgramManager.prototype.setDefault=function(c,a,d){if(this._defaults[c]==undefined){this._defaults[c]={}}this._defaults[c][a]=d;if(c==this._current_program_ID){this.setUniform(a,d)
}};ProgramManager.prototype.getDefault=function(c,a){if(this._defaults[c]==undefined){return undefined}return this._defaults[c][a]};ProgramManager.prototype.setUniforms=function(a){for(key in a){this.setUniform(key,a[key])}};ProgramManager.prototype.setUniform=function(o,m,e){var f=this._gl;var c=this._current_program_object;var n=this._uniform_map[this._current_program_ID];var a=this._curr_uniform_loc_map;var d=this._curr_uniform_cache;var q=this._uniform_types[this._current_program_ID];var k=undefined;
var h=false;if(n.indexOf(o)==-1){console.warn("ProgramManager.setUniform: the uniform "+o+" is not defined for the program "+this._current_program_ID);return}k=a[o];if(k==undefined){k=f.getUniformLocation(c,o);a[o]=k}var s=d[o];var l=q[o];if(s==undefined){h=true}else{switch(l){case"sampler2D":case"float":case"int":case"bool":h=(s!==m);break;case"mat4":h=((m[0]!==s[0])||(m[1]!==s[1])||(m[2]!==s[2])||(m[3]!==s[3])||(m[4]!==s[4])||(m[5]!==s[5])||(m[6]!==s[6])||(m[7]!==s[7])||(m[8]!==s[8])||(m[9]!==s[9])||(m[10]!==s[10])||(m[11]!==s[11])||(m[12]!==s[12])||(m[13]!==s[13])||(m[14]!==s[14])||(m[15]!==s[15]));
break;case"vec3":h=((m[0]!==s[0])||(m[1]!==s[1])||(m[2]!==s[2]));break;case"vec4":h=((m[0]!==s[0])||(m[1]!==s[1])||(m[2]!==s[2])||(m[3]!==s[3]));break;default:h=true}}if(h){switch(l){case"float":case"int":case"bool":d[o]=m;break;case"mat4":d[o]=mat4.clone(m);break;case"mat3":d[o]=mat3.clone(m);break;case"vec4":d[o]=vec4.clone(m);break;case"vec3":d[o]=vec3.clone(m);break;case"vec2":d[o]=vec2.clone(m);break;case"sampler2D":d[o]=m;break;default:alert("error: type unknown cannot update uniform cache")
}this._setPolymorphicUniform(o,k,m,e)}};ProgramManager.prototype.getUniform=function(a){return this._curr_uniform_cache[a]};ProgramManager.prototype.setAttributePointer=function(e,c,h,f,k,l){var d=this._getAttributeLocation(e);this._gl.vertexAttribPointer(d,c,h,f,k,l)};ProgramManager.prototype.enableAttribute=function(d){if(this._enabled_attribute_list.indexOf(d)!=-1){return}var c=this._getAttributeLocation(d);this._gl.enableVertexAttribArray(c);this._enabled_attribute_list.push(d)};ProgramManager.prototype.disableAttribute=function(c){if(c==undefined){return
}var a=this._enabled_attribute_list.indexOf(c);if(a>=0){var d=this._getAttributeLocation(c);this._gl.disableVertexAttribArray(d);this._enabled_attribute_list.splice(a,1)}};ProgramManager.prototype._createShader=function(a,d){var e=this._gl;var c=null;if(a==nucleo.def.essl.VERTEX_SHADER){c=e.createShader(e.VERTEX_SHADER)}else{if(a==nucleo.def.essl.FRAGMENT_SHADER){c=e.createShader(e.FRAGMENT_SHADER)}}if(d==undefined||d==null){alert("Error getting the code for shader of type "+a)}e.shaderSource(c,d);
e.compileShader(c);if(!e.getShaderParameter(c,e.COMPILE_STATUS)){alert(a+":\n\n "+e.getShaderInfoLog(c));throw ("Error compiling shader "+a+":\n\n "+e.getShaderInfoLog(c))}return c};ProgramManager.prototype._parseUniforms=function(e){vs=this._registered_programs[this._current_program_ID].VERTEX_SHADER;fs=this._registered_programs[this._current_program_ID].FRAGMENT_SHADER;uNames=this._registered_programs[this._current_program_ID].UNIFORMS;uTypes={};for(var a=0;a<uNames.length;a++){var c=uNames[a];
var d=new RegExp("uniform\\s+\\w+\\s"+c,"g");if(vs.search(d)!=-1){uTypes[c]=vs.substring(vs.search(d),vs.length).substring(0,vs.indexOf(";")).split(" ")[1]}else{if(fs.search(d)!=1){uTypes[c]=fs.substring(fs.search(d),fs.length).substring(0,fs.indexOf(";")).split(" ")[1]}else{alert("Program: In the program "+this._current_program_ID+" the uniform "+c+" is listed but not used")}}}this._uniform_map[this._current_program_ID]=uNames;this._uniform_types[this._current_program_ID]=uTypes};ProgramManager.prototype._getAttributeLocation=function(a){var c=this._curr_attribute_loc_map[a];
if(c!=undefined){return c}c=this._gl.getAttribLocation(this._current_program_object,a);if(c==-1){console.error("ProgramManager._getAttributeLocation ERROR: the attribute "+a+"could not be located");c=undefined}else{this._curr_attribute_loc_map[a]=c}return c};ProgramManager.prototype._setPolymorphicUniform=function(e,c,d,h){var f=this._gl;var a=this._uniform_types[this._current_program_ID][e];if(a=="bool"){f.uniform1i(c,d);return}else{if(a=="float"){f.uniform1f(c,d);return}else{if(a=="int"||a=="sampler2D"){f.uniform1i(c,d);
return}else{if(a=="mat4"){f.uniformMatrix4fv(c,false,d);return}else{if(d instanceof Array||d instanceof Float32Array){if(d.length==3&&a=="vec4"){d[3]=1;if(!this._one_time_warning){alert("The uniform "+e+" has only 3 components but Nucleo needs 4. This is a one time warning");this._one_time_warning=true}}if(h=="int"){switch(d.length){case 1:f.uniform1iv(c,d);break;case 2:f.uniform2iv(c,d);break;case 3:f.uniform3iv(c,d);break;case 4:f.uniform4iv(c,d);break;default:alert("ERROR")}}else{switch(d.length){case 1:f.uniform1fv(c,d);
break;case 2:f.uniform2fv(c,d);break;case 3:f.uniform3fv(c,d);break;case 4:f.uniform4fv(c,d);break;default:alert("ERROR")}}}else{alert("Program: ERROR. The uniform  "+e+" could not be mapped")}}}}}};function Renderer(a){this.view=a;this.renderRate=nucleo.def.renderer.rate.NORMAL;this.mode=nucleo.def.renderer.mode.TIMER;this.fps=0;this.engine=undefined;this._time=0;this._startDate=0;this._running=false;this.setEngine(RenderEngine);this.setProgram(nucleo.go.essl.lambert)}Renderer.prototype.setEngine=function(c){var a=undefined;
if(typeof c=="function"){a=new c()}else{if(typeof c=="object"){a=c}else{console.warn("Renderer.setEngine WARN: "+c+" is not an engine");console.warn("Renderer.setEngine WARN: using RenderEngine by default");a=new RenderEngine()}}a.init(this);this.engine=a;nucleo.c.engine=this.engine};Renderer.prototype.setProgram=function(a,c){this.engine.setProgram(a,c)};Renderer.prototype.releaseProgram=function(){this.engine.releaseProgram()};Renderer.prototype.clear=function(){this.engine.clear()};Renderer.prototype.clearColor=function(d,c,a){this.engine.clearColor(d,c,a)
};Renderer.prototype.clearDepth=function(a){this.engine.clearDepth(a)};Renderer.prototype.reallocate=function(){this.engine.allocate(this.view.scene)};Renderer.prototype.disableOffscreen=function(){this.engine.disableOffscreen()};Renderer.prototype.enableOffscreen=function(){this.engine.enableOffscreen()};Renderer.prototype.isOffscreenEnabled=function(){return this.engine.isOffscreenEnabled()};Renderer.prototype.readOffscreenPixel=function(a,c){return this.engine.readOffscreenPixel(a,c)};Renderer.prototype.setMode=function(a){if(this._running){this.stop();
this.mode=a;this.start()}else{this.mode=a}};Renderer.prototype.start=function(){this._running=true;this._startDate=new Date().getTime();this._time=0;switch(this.mode){case nucleo.def.renderer.mode.TIMER:util.console("Renderer [TIMER]: starting rendering for view ["+this.view.name+"] at "+this.renderRate+"ms");this._timeUp();break;case nucleo.def.renderer.mode.ANIMFRAME:util.console("Renderer [ANIMFRAME]: starting request animation frame procedure",true);var a=this;function c(){this.render();window.requestAnimFrame(c.bind(a))
}c.bind(this)();break;case nucleo.def.renderer.mode.ON_DEMAND:util.console("Renderer [ON_DEMAND]: waiting for rendering requests",true);this.clear();break}};Renderer.prototype.doBeforeRendering=function(a){this._do_before_rendering=a};Renderer.prototype.doAfterRendering=function(a){this._do_after_rendering=a};Renderer.prototype._timeUp=function(){if(!this._running||this.mode==nucleo.def.renderer.mode.ANIMFRAME){return}this.render();if(this._time==this.renderRate*100){this._time=0;this._startDate=new Date().getTime()
}this._time+=this.renderRate;var a=(new Date().getTime()-this._startDate)-this._time;if(a>this.renderRate){a=0}setTimeout((function(c){return function(){c._timeUp()}})(this),this.renderRate-a)};Renderer.prototype.stop=function(){if(this.mode==nucleo.def.renderer.mode.TIMER){this._running=false}else{if(this.mode==nucleo.def.renderer.mode.ANIMFRAME){nucleo.go.renderman.cancel()}}};Renderer.prototype.setRenderRate=function(a){if(a==undefined||a<=0){throw"Renderer.setRenderRate: the rate cannot be zero or undefined"
}if(this.mode==nucleo.def.renderer.mode.ANIMFRAME){throw"Renderer.setRenderRate: if the mode is ANIMFRAME render rate is irrelevant"}this.stop();this.renderRate=a;this.start();util.console("Renderer: view["+this.view.name+"], render rate = "+a,true)};Renderer.prototype.render=function(){var c=this.engine,d=this.view.scene,e=undefined,a=undefined;if(this._do_before_rendering){this._do_before_rendering()}this.clear();c.allocate(d);e=new Date().getTime();c.render(d);a=new Date().getTime()-e;c.deallocate(d);
if(a>0){this.fps=Math.round((this.fps*0.8+(1000/a)*0.2)*100)/100}if(this._do_after_rendering){this._do_after_rendering()}};function vxlRendererException(a){this.message=a}function RenderTarget(a){this.canvas=a._view.canvas;this.texture=null;this.framebuffer=null;this.renderbuffer=null;this.gl=a.gl;this.configure()}RenderTarget.prototype.configure=function(){var c=this.canvas.width;var a=this.canvas.height;var d=this.gl;this.texture=d.createTexture();d.bindTexture(d.TEXTURE_2D,this.texture);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,c,a,0,d.RGBA,d.UNSIGNED_BYTE,null);
this.renderbuffer=d.createRenderbuffer();d.bindRenderbuffer(d.RENDERBUFFER,this.renderbuffer);d.renderbufferStorage(d.RENDERBUFFER,d.DEPTH_COMPONENT16,c,a);this.framebuffer=d.createFramebuffer();d.bindFramebuffer(d.FRAMEBUFFER,this.framebuffer);d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,this.texture,0);d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_ATTACHMENT,d.RENDERBUFFER,this.renderbuffer);d.bindTexture(d.TEXTURE_2D,null);d.bindRenderbuffer(d.RENDERBUFFER,null);d.bindFramebuffer(d.FRAMEBUFFER,null)
};RenderTarget.prototype.update=function(){var d=this.gl;var c=this.canvas.width;var a=this.canvas.height;d.bindTexture(d.TEXTURE_2D,this.texture);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,c,a,0,d.RGBA,d.UNSIGNED_BYTE,null);d.bindRenderbuffer(d.RENDERBUFFER,this.renderbuffer);d.renderbufferStorage(d.RENDERBUFFER,d.DEPTH_COMPONENT16,c,a)};RenderTarget.prototype.readPixel=function(a,e){var d=this.gl;var c=new Uint8Array(1*1*4);d.bindFramebuffer(d.FRAMEBUFFER,this.framebuffer);d.readPixels(a,e,1,1,d.RGBA,d.UNSIGNED_BYTE,c);
d.bindFramebuffer(d.FRAMEBUFFER,null);return c};function Model(a,c){this.UID=util.generateUID();this.name=a;this.indices=[];this.vertices=[];this.scalars=undefined;this.diffuse=undefined;this.ambient=undefined;this.specular=undefined;this.shininness=undefined;this.normals=undefined;this.wireframe=undefined;this.bb=[0,0,0,0,0,0];this.centre=[0,0,0,0,0,0];this.mode=nucleo.def.actor.mode.SOLID;this.image=undefined;this.uri=undefined;this.colors=undefined;this.type=define.Model.TYPE.SIMPLE;this.renderable=undefined;
if(c!=undefined){this.load(this.name,c)}this.setType(this.type)}Model.LOADING_MODE=define.Model.LOADING_MODE;Model.MAX_NUM_INDICES=define.Model.MAX_NUM_INDICES;Model.TYPE=define.Model.TYPE;Model.prototype.setType=function(a){if(this.indices.max()<Model.MAX_NUM_INDICES&&a==define.Model.TYPE.BIG_DATA){throw ("The model is not big enough to be of BIG_DATA type. Max index found: "+this.indices.max())}this.type=a};Model.BB_INDICES=[0,1,1,2,2,3,3,0,0,4,4,5,5,6,6,7,7,4,1,5,2,6,3,7];Model.prototype.load=function(a,c){if(a==undefined){throw"Model.load ERROR: the object must have a name"
}this.name=a.replace(/\.[^/.]+$/,"");if(c.name!=null){this.name=c.name}for(i in c){this[i]=c[i]}this.update()};Model.prototype.update=function(){if(this.vertices==undefined){alert("The model "+this.name+" does not have vertices. Impossible to render!")}if(this.normals==undefined&&this.indices!=undefined&&this.mode!=nucleo.def.actor.mode.LINES){this.computeNormals()}if(this.wireframe==undefined){this.computeWireframeIndices()}if(this.mode==undefined){this.mode=nucleo.def.actor.mode.SOLID}if(this.texture!=undefined){this.mode=nucleo.def.actor.mode.TEXTURED
}this.computeBoundingBox();if(this.type==define.Model.TYPE.SIMPLE&&this.indices.max()>Model.MAX_NUM_INDICES){this.setType(define.Model.TYPE.BIG_DATA);console.info("the model "+this.name+" type is BIG_DATA")}};Model.prototype.computeNormals=function(){var q=this.vertices;var a=this.indices;var m=0;var h=1;var f=2;var k=[];for(var c=0;c<q.length;c=c+3){k[c+m]=0;k[c+h]=0;k[c+f]=0}for(var c=0;c<a.length;c=c+3){var n=[];var l=[];var e=[];n[m]=q[3*a[c+2]+m]-q[3*a[c+1]+m];n[h]=q[3*a[c+2]+h]-q[3*a[c+1]+h];
n[f]=q[3*a[c+2]+f]-q[3*a[c+1]+f];l[m]=q[3*a[c]+m]-q[3*a[c+1]+m];l[h]=q[3*a[c]+h]-q[3*a[c+1]+h];l[f]=q[3*a[c]+f]-q[3*a[c+1]+f];e[m]=n[h]*l[f]-n[f]*l[h];e[h]=n[f]*l[m]-n[m]*l[f];e[f]=n[m]*l[h]-n[h]*l[m];for(j=0;j<3;j++){k[3*a[c+j]+m]=k[3*a[c+j]+m]+e[m];k[3*a[c+j]+h]=k[3*a[c+j]+h]+e[h];k[3*a[c+j]+f]=k[3*a[c+j]+f]+e[f]}}for(var c=0;c<q.length;c=c+3){var o=[];o[m]=k[c+m];o[h]=k[c+h];o[f]=k[c+f];var d=Math.sqrt((o[m]*o[m])+(o[h]*o[h])+(o[f]*o[f]));if(d==0){d=1}o[m]=o[m]/d;o[h]=o[h]/d;o[f]=o[f]/d;k[c+m]=o[m];
k[c+h]=o[h];k[c+f]=o[f]}this.normals=k};Model.prototype.flipNormals=function(){var c=this.normals;if(c==undefined){return}for(var a=0;a<c.length;a+=1){c[a]=-c[a]}};Model.prototype.computeWireframeIndices=function(){var e=this.indices;var d=[];var a=0;for(var c=0;c<e.length;c=c+3){d[a]=e[c];d[a+1]=e[c+1];d[a+2]=e[c+1];d[a+3]=e[c+2];d[a+4]=e[c+2];d[a+5]=e[c];a=a+6}this.wireframe=d};Model.prototype.computeBoundingBox=function(){if(this.vertices.length==0){this.bb=[0,0,0,0,0,0];this.centre=[0,0,0,0,0,0];
return}var h=this.vertices;var a=[h[0],h[1],h[2],h[0],h[1],h[2]];var d=h.length;for(var d=0,e=h.length;d<e;d=d+3){a[0]=Math.min(a[0],h[d]);a[1]=Math.min(a[1],h[d+1]);a[2]=Math.min(a[2],h[d+2]);a[3]=Math.max(a[3],h[d]);a[4]=Math.max(a[4],h[d+1]);a[5]=Math.max(a[5],h[d+2])}var f=[0,0,0];f[0]=(a[3]+a[0])/2;f[1]=(a[4]+a[1])/2;f[2]=(a[5]+a[2])/2;this.bb=a;this.centre=f};Model.prototype.getBoundingBoxVertices=function(){var a=this.bb;return[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5],a[3],a[1],a[5]]
};function Cell(e,d,c,a){this.UID=util.generateUID();this.mesh=e;this.index=d;this.vertices=c;this.color=a==undefined?[0.8,0.8,0.8]:a;this.normal=[0,0,0];this.position=[0,0,0];this._calculatePosition();this._calculateNormal();this._pickingColor=nucleo.go.picker.getColorFor(this)}Cell.prototype._calculatePosition=function(){this.position[0]=(this.vertices[0][0]+this.vertices[1][0]+this.vertices[2][0])/3;this.position[1]=(this.vertices[0][1]+this.vertices[1][1]+this.vertices[2][1])/3;this.position[2]=(this.vertices[0][2]+this.vertices[1][2]+this.vertices[2][2])/3
};Cell.prototype._calculateNormal=function(){var c=vec3.subtract(vec3.create(),this.vertices[1],this.vertices[0]);var a=vec3.subtract(vec3.create(),this.vertices[2],this.vertices[0]);this.normal=vec3.normalize(this.normal,vec3.cross(this.normal,c,a))};Cell.prototype.getFlattenVertices=function(){var a=this.vertices;return[a[0][0],a[0][1],a[0][2],a[1][0],a[1][1],a[1][2],a[2][0],a[2][1],a[2][2]]};Cell.prototype.setColor=function(d,c,a){this.color=util.createArr3(d,c,a);this.mesh._updateCellColor(this.index)
};function Mesh(a){if(a==undefined){throw ("Mesh: the model passed as parameter cannot be undefined")}this.name=a.name+"-mesh";this.cells=[];this.color=[0.8,0.8,0.8];this.actor=a;this.model=undefined;this._createMesh(a)}Mesh.prototype.setColor=function(a){this.color=a;this._setModelColor(this.color)};Mesh.prototype.scalarsToCellColors=function(a,c){};Mesh.prototype.updateColor=function(){var c=this.model;c.colors=[];c.pickingColors=[];for(var d=0,e=this.cells.length;d<e;d+=1){for(var a=0;a<3;a+=1){c.colors.push.apply(c.colors,this.cells[d].color);
c.pickingColors.push.apply(c.pickingColors,this.cells[d]._pickingColor)}}this.actor.updateRenderable()};Mesh.prototype.hasCell=function(a){var c=this.cells.length;while(c--){if(this.cells[c].UID==a){return true}}return false};Mesh.prototype.getCell=function(a){var c=this.cells.length;while(c--){if(this.cells[c].UID==a){return this.cells[c]}}return null};Mesh.prototype.removeCell=function(c){var a=-1;var d=this.cells.length;while(d--){if(this.cells[d].UID==c){a=d;break}}if(a!=-1){this.cells.splice(a,1);
this._createModel()}};Mesh.prototype.intersect=function(c,d){var a=c._forward;selection=[];return selection};Mesh.prototype._createMesh=function(d){var e=d.model;var a=e.vertices;var f=e.indices;var c=this;this.cells=[];function h(){var k=new Date().getTime();var q=0;var n=[c.color[0],c.color[1],c.color[2]];for(var l=0,s=f.length;l<s;l+=3){v=f[l];var m=[],u,t,o,v;u=a[v*3];t=a[v*3+1];o=a[v*3+2];m.push([u,t,o]);v=f[l+1];u=a[v*3];t=a[v*3+1];o=a[v*3+2];m.push([u,t,o]);v=f[l+2];u=a[v*3];t=a[v*3+1];o=a[v*3+2];
m.push([u,t,o]);c.cells.push(new Cell(c,q,m,n));q+=1}c._createModel();var w=new Date().getTime()-k;console.info("Mesh ["+c.name+"] generated in "+w+" ms")}setTimeout(function(){h()},0)};Mesh.prototype._createModel=function(){var c=new Model(this.name+"-model");c.colors=[];c.pickingColors=[];for(var d=0,e=this.cells.length;d<e;d+=1){c.indices.push.apply(c.indices,[d*3,d*3+1,d*3+2]);c.vertices.push.apply(c.vertices,this.cells[d].getFlattenVertices());for(var a=0;a<3;a+=1){c.colors.push.apply(c.colors,this.cells[d].color);
c.pickingColors.push.apply(c.pickingColors,this.cells[d]._pickingColor)}}c.computeNormals();c.setType(define.Model.TYPE.MESH);this.model=c;this.actor.updateRenderable(Renderable.TASK.CREATE)};Mesh.prototype._setModelColor=function(a){if(this.model==undefined){return}var d=this.model;d.colors=[];for(var e=0,f=this.cells.length;e<f;e+=1){this.cells[e].color=[a[0],a[1],a[2]];for(var c=0;c<3;c+=1){d.colors.push.apply(d.colors,this.cells[e].color)}}this.actor.updateRenderable(Renderable.TASK.CREATE)};
Mesh.prototype._updateCellColor=function(c){var a=this.cells[c].color;for(var d=c*9,e=c*9+9;d<e;d+=3){this.model.colors[d]=a[0];this.model.colors[d+1]=a[1];this.model.colors[d+2]=a[2]}this.actor.updateRenderable(Renderable.TASK.UPDATE_COLORS)};function Actor(a){this._bb=[0,0,0,0,0,0];this._position=vec3.fromValues(0,0,0);this._translation=vec3.fromValues(0,0,0);this._centre=vec3.fromValues(0,0,0);this._scale=vec3.fromValues(1,1,1);this._rotation=vec3.fromValues(0,0,0);this._matrix=mat4.create();this._matrix_world=mat4.create();
this._matrix_normal=mat4.create();this._matrix_pmv=mat4.create();this._dirty=false;this._picking=nucleo.define.Actor.PICKING.DISABLED;this._pickCallback=undefined;this._unpickCallback=undefined;this._pickingColor=undefined;this._trackingCameras=[];this.UID=util.generateUID();this.scene=undefined;this.clones=0;this.mode=nucleo.def.actor.mode.SOLID;this.cull=nucleo.def.actor.cull.NONE;this.visible=true;this.mesh=undefined;this.renderable=undefined;this._bb_disabled=false;if(a){this.model=a;this.name=a.name;
this.mode=a.mode;this._bb=a.bb.slice(0);this._centre=vec3.clone(a.centre);if(a.type==define.Model.TYPE.BIG_DATA){this.renderable=new Renderable(this)}var c=new Material();this.setMaterial(c.getFrom(a))}else{this.model=undefined;this.material=undefined}var d=define.EVENTS;notifierInstance.publish([d.ACTOR_MOVED,d.ACTOR_SCALED,d.ACTOR_ROTATED,d.ACTOR_CHANGED_COLOR,d.ACTOR_CHANGED_SHADING,],this)}Actor.prototype.setScene=function(a){this.scene=a};Actor.prototype.setPosition=function(c,f,e){var d=util.createVec3(c,f,e);
vec3.subtract(this._translation,d,this._position);this._position=d;var a=this._matrix;a[12]=this._position[0];a[13]=this._position[1];a[14]=this._position[2];a[15]=1;if(!this._bb_disabled){this._computeBoundingBox()}this._notifyTrackingCameras();notifierInstance.fire(define.EVENTS.ACTOR_MOVED,this);return this};Actor.prototype.translate=function(c,e,d){this._translation=util.createVec3(c,e,d);var a=this._matrix;mat4.translate(a,a,this._translation);this._position=vec3.fromValues(a[12],a[13],a[14]);
if(!this._bb_disabled){this._computeBoundingBox()}this._notifyTrackingCameras();notifierInstance.fire(define.EVENTS.ACTOR_MOVED,this);return this};Actor.prototype.rotateX=function(e){var c=this._matrix;var d=util.deg2rad(util.getAngle(e));mat4.rotateX(c,c,d);if(!this._bb_disabled){this._computeBoundingBox()}notifierInstance.fire(define.EVENTS.ACTOR_ROTATED,this);return this};Actor.prototype.rotateY=function(e){var c=this._matrix;var d=util.deg2rad(util.getAngle(e));mat4.rotateY(c,c,d);if(!this._bb_disabled){this._computeBoundingBox()
}notifierInstance.fire(define.EVENTS.ACTOR_ROTATED,this);return this};Actor.prototype.rotateZ=function(e){var c=this._matrix;var d=util.deg2rad(util.getAngle(e));mat4.rotateZ(c,c,d);if(!this._bb_disabled){this._computeBoundingBox()}notifierInstance.fire(define.EVENTS.ACTOR_ROTATED,this);return this};Actor.prototype.setScale=function(f,e,d){if(f==0&&e==undefined&&d==undefined){return}if(typeof(f)=="number"&&e==undefined&&d==undefined){this._scale=util.createVec3(f,f,f)}else{this._scale=util.createVec3(f,e,d)
}var c=this._matrix;mat4.scale(c,c,this._scale);if(!this._bb_disabled){this._computeBoundingBox()}notifierInstance.fire(define.EVENTS.ACTOR_SCALED,this);return this};Actor.prototype.addTrackingCamera=function(a){if(a instanceof Camera&&a.type!=Camera.TYPE.TRACKING){throw"Actor._addTrackingCamera ERROR: the selected camera is not set to tracking"}else{if(a instanceof Camera){this._trackingCameras.push(a)}else{throw"Actor._addTrackingCamera ERROR: the object passed as a parameter is not a Camera"}}};
Actor.prototype.removeTrackingCamera=function(c){var a=this._trackingCameras.indexOf(c);this._trackingCameras.splice(a,1)};Actor.prototype._notifyTrackingCameras=function(){for(var a=0,c=this._trackingCameras.length;a<c;a+=1){this._trackingCameras[a].updateWithActor(this)}};Actor.prototype._computeBoundingBox=function(){var h=this.model.vertices;var e=[];var d=this._matrix;for(var f=0;f<h.length;f=f+3){var a=util.createVec3(h[f],h[f+1],h[f+2]);vec3.transformMat4(a,a,d);e.push(a[0],a[1],a[2])}var c=[e[0],e[1],e[2],e[0],e[1],e[2]];
for(var f=0;f<e.length;f=f+3){c[0]=Math.min(c[0],e[f]);c[1]=Math.min(c[1],e[f+1]);c[2]=Math.min(c[2],e[f+2]);c[3]=Math.max(c[3],e[f]);c[4]=Math.max(c[4],e[f+1]);c[5]=Math.max(c[5],e[f+2])}this._bb=c};Actor.prototype.getBoundingBoxVertices=function(){var a=this._bb;return[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5],a[3],a[1],a[5]]};Actor.prototype.getBoundingBox=function(){return this._bb.slice[0]};Actor.prototype.getHeight=function(){var a=this._bb;
return a[4]-a[1]};Actor.prototype.setMaterial=function(a){this.material=a;if(this.material.texture){this._new_texture=true}};Actor.prototype.setColor=function(d,c,a){this.material.diffuse=util.createVec3(d,c,a);if(this.mesh){this.mesh.setColor(this.material.diffuse)}notifierInstance.fire(define.EVENTS.ACTOR_CHANGED_COLOR,this);return this};Actor.prototype.setOpacity=function(a){if(a>=0&&a<=1){this.material.opacity=a}else{throw"The opacity value is not valid"}return this};Actor.prototype.setShininess=function(a){this.material.shininess=a;
return this};Actor.prototype.setTexture=function(c){var a=undefined;if(typeof(c)=="string"){a=new Texture(c)}else{a=c}this.material.texture=a;this._new_texture=true;return this};Actor.prototype.setProperty=function(d,c,a){if(a==nucleo.def.actor||a==undefined||a==null){switch(d){case"position":this.setPosition(c);break;case"scale":this.setScale(c);break;case"color":this.setColor(c);break;case"shading":this.setShading(c);break;case"texture":this.setTexture(c);break;case"opacity":this.setOpacity(c);
break;case"shininess":this.setShininess(c);break;default:this[d]=c;break}util.console("Actor: The actor "+this.name+" has been updated. ["+d+" = "+c+"]")}else{if(a==nucleo.def.model){this.model[d]=c;util.console("Actor: The model "+this.model.namname+" has been updated. ["+d+" = "+c+"]")}else{throw ("Actor.setProperty. Scope:"+a+" is not valid")}}return this};Actor.prototype.setShading=function(a){this.material.shading=a;notifierInstance.fire(define.EVENTS.ACTOR_CHANGED_SHADING,this);return this};
Actor.prototype.getProperty=function(a){if(a=="color"){return this.materia.diffuse}else{if(this.hasOwnProperty(a)){return this[a]}else{if(this.material.hasOwnProperty(a)){return this.material[a]}else{if(this.model.hasOwnProperty(a)){return this.model[a]}else{return undefined}}}}};Actor.prototype.computePosition=function(){bb=this._bb;var a=vec3.create();a[0]=(bb[3]+bb[0])/2;a[1]=(bb[4]+bb[1])/2;a[2]=(bb[5]+bb[2])/2;a[0]=Math.round(a[0]*1000)/1000;a[1]=Math.round(a[1]*1000)/1000;a[2]=Math.round(a[2]*1000)/1000;
return vec3.clone(a)};Actor.prototype.setVisualizationMode=function(a){this.mode=a;this._dirty=true;return this};Actor.prototype.cullFace=function(a){this.cull=a;return this};Actor.prototype.setLookupTable=function(f,d,a){if(this.model.scalars==undefined){return}var c=this;function e(h){var k=nucleo.go.lookupTableManager.get(f);c.material.colors=k.getColors(c.model.scalars,d,a);if(c.model.type==define.Model.TYPE.BIG_DATA){c.renderable.update()}}setTimeout(function(){e()},0);return this};Actor.prototype.flipNormals=function(){this.model.flipNormals();
return this};Actor.prototype.setVisible=function(a){this.visible=a;return this};Actor.prototype.isVisible=function(){return this.visible};Actor.prototype.clone=function(){this.clones++;var a=new Actor(this.model);a.name+="-"+this.clones;a.material=this.material.clone();return a};Actor.prototype.setPicking=function(e,d,a){this._picking=e;switch(e){case nucleo.define.Actor.PICKING.DISABLED:this._pick_callback=undefined;this._unpick_callback=undefined;this.mesh=undefined;this.renderable=undefined;this.setVisualizationMode(nucleo.def.actor.mode.SOLID);
break;case nucleo.define.Actor.PICKING.CELL:if(this.mesh==undefined){this.mesh=new Mesh(this);this.mesh.setColor(this.material.diffuse);this.renderable=new Renderable(this);this.setVisualizationMode(nucleo.def.actor.mode.FLAT)}this._pick_callback=d;this._unpick_callback=a;break;case nucleo.define.Actor.PICKING.OBJECT:this._pickingColor=nucleo.go.picker.getColorFor(this);this._pick_callback=d;this._unpick_callback=a;break}if(this._picking!=nucleo.define.Actor.PICKING.DISABLED){var c=this.scene.views.length;
while(c--){var f=this.scene.views[c].renderer;if(!f.isOffscreenEnabled()){f.enableOffscreen()}}}return this};Actor.prototype.isPickable=function(){return(this._picking!=nucleo.define.Actor.PICKING.DISABLED)};Actor.prototype.getPickingType=function(){return this._picking};Actor.prototype.updateRenderable=function(a){this.renderable.update(a)};Actor.prototype.reallocate=function(){this._dirty=true};function Picker(){this._objects={};this._colors={}}Picker.RESOLUTION=1/255;Picker.prototype._hex2rgb=function(d){var c=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;
hex=d.replace(c,function(f,k,h,e){return k+k+h+h+e+e});var a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return a?[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]:null};Picker.prototype._rgb2hex=function(e,d,a){var f=util.createArr3(e,d,a);return"#"+((1<<24)+(f[0]<<16)+(f[1]<<8)+f[2]).toString(16).slice(1)};Picker.prototype._getColor=function(){function a(){var c=Math.floor(Math.random()*255);if(c==0){return a()}else{return c}}return[a(),a(),a()]};Picker.prototype.color2decimal=function(a){r=a[0]*Picker.RESOLUTION;
g=a[1]*Picker.RESOLUTION;b=a[2]*Picker.RESOLUTION;return[r,g,b]};Picker.prototype.getColorFor=function(e){var d=e.UID;if(d==null||d==undefined){alert("Picker.getColor: invalid object");return}var a,c;if(!this._objects[d]){do{a=this._getColor();c=this._rgb2hex(a)}while(c in this._colors);this._objects[d]=a;this._colors[c]=d}a=this._objects[d];return this.color2decimal(a)};Picker.prototype.query=function(e){var h=100;var f=undefined;var d={};var a=e.slice(0,3);var c=this._rgb2hex(a);if(this._colors[c]){d.uid=this._colors[c];
d.color=a;return d}return null};nucleo.go.picker=new Picker();function Engine(){this.gl=undefined;this.pm=undefined;this._view=undefined;this._clear_color=undefined;this._transforms=undefined}Engine.prototype.allocate=function(a){};Engine.prototype.render=function(a){};Engine.prototype.deallocate=function(a){};Engine.prototype.reallocate=function(a){};Engine.prototype.disableOffscreen=function(){};Engine.prototype.enableOffscreen=function(){};Engine.prototype.isOffscreenEnabled=function(){};Engine.prototype.readOffscreenPixel=function(a,c){};
Engine.prototype.init=function(a){this._getGL(a);this.pm=new ProgramManager(this.gl);this._view=a.view;this._clear_color=this._view.backgroundColor;this._transforms=new Transforms(a.view);this.configure()};Engine.prototype._getGL=function(c){var a=undefined;var d=c.view.canvas;var k=["webgl","experimental-webgl","webkit-3d","moz-webgl"];this.gl=undefined;for(var f=0;f<k.length;++f){try{a=d.getContext(k[f])}catch(h){}if(a){break}}if(a==null){alert("Sorry: WebGL is not available on this browser. Have you tried the newest version of Firefox, Chrome or Safari?");
return undefined}else{this.gl=a}};Engine.prototype.configure=function(){var a=this.gl;a.enable(a.DEPTH_TEST);a.enable(a.BLEND);a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);a.depthFunc(a.LESS);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,true)};Engine.prototype.clear=function(){var e=this.gl;var c=this._view.canvas;var d=c.width;var a=c.height;var f=this._clear_color;e.clearColor(f[0],f[1],f[2],1);e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);e.viewport(0,0,d,a);this._transforms.calculateProjection()};Engine.prototype.clearColor=function(d,c,a){var e=util.createArr3(d,c,a);
this._clear_color=e;this.gl.clearColor(e[0],e[1],e[2],1)};Engine.prototype.clearDepth=function(a){this.gl.clearDepth(a)};Engine.prototype.releaseProgram=function(){this.pm.releaseProgram()};Engine.prototype.setProgram=function(a,c){this.pm.setProgram(a,c)};ExternalEngine.prototype=new Engine();ExternalEngine.prototype.constructor=ExternalEngine;function ExternalEngine(d,e,c,a){Engine.call(this);this.renderer=d;this.allocateCallback=e;this.renderCallback=c;this.deallocateCallback=a}ExternalEngine.prototype.allocate=function(a){this.allocateCallback(this.renderer,a)
};ExternalEngine.prototype.render=function(a){this.renderCallback(this.renderer,a)};ExternalEngine.prototype.deallocate=function(a){this.deallocateCallback(this.renderer,a)};RenderEngine.prototype=new Engine();RenderEngine.prototype.constructor=RenderEngine;function RenderEngine(){Engine.call(this);this._gl_buffers={};this._gl_textures={};this._offscreen=false;this._target=undefined;this._onPickingBuffer=false;this._debug_picking_flag=false}RenderEngine.prototype.configure=function(){Engine.prototype.configure.call(this);
var a=this.gl;a.clearDepth(1);a.disable(a.CULL_FACE)};RenderEngine.prototype.allocate=function(d){var c=d._actors.concat(d.toys.list);var a=c.length;while(a--){this._allocateActor(c[a])}};RenderEngine.prototype.deallocate=function(a){};RenderEngine.prototype._allocateActor=function(d){var e=this.gl;var c=d.model;var a={};if(!(c.UID in this._gl_buffers)||d._dirty){this._reallocateActor(d);d._dirty=false}};RenderEngine.prototype._reallocateActor=function(e){var k=this.gl;var d=e.model;var a=this._gl_buffers[d.UID]||{};
var f=nucleo.def.actor.mode;if(a.vertex==undefined){a.vertex=k.createBuffer()}var c=undefined;switch(e.mode){case f.BOUNDING_BOX:c=e.getBoundingBoxVertices();break;default:c=d.vertices}k.bindBuffer(k.ARRAY_BUFFER,a.vertex);k.bufferData(k.ARRAY_BUFFER,new Float32Array(c),k.STATIC_DRAW);if(d.normals){if(a.normal==undefined){a.normal=k.createBuffer()}k.bindBuffer(k.ARRAY_BUFFER,a.normal);k.bufferData(k.ARRAY_BUFFER,new Float32Array(d.normals),k.STATIC_DRAW)}if(d.scalars!=undefined||d.colors!=undefined){if(a.color==undefined){a.color=k.createBuffer()
}}if(d.indices!=undefined){if(a.index==undefined){a.index=k.createBuffer()}var h=undefined;switch(e.mode){case f.SOLID:h=d.indices;break;case f.WIREFRAME:h=d.wireframe;break;case f.POINTS:h=d.indices;break;case f.LINES:h=d.indices;break;case f.BOUNDING_BOX:h=Model.BB_INDICES;break;case f.BB_AND_SOLID:h=d.indices;break;case f.WIRED_AND_SOLID:h=d.indices;break;case f.FLAT:h=d.indices;break;case f.TEXTURED:h=d.indices;break;default:throw ("There was a problem while rendering the actor ["+e.name+"].The visualization mode: "+e.mode+" is not valid.")
}k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,a.index);k.bufferData(k.ELEMENT_ARRAY_BUFFER,new Uint16Array(h),k.STATIC_DRAW)}if(e.mode==f.FLAT||e.model.type==define.Model.TYPE.BIG_DATA){if(a.vertex_parts==undefined){a.vertex_parts=k.createBuffer()}if(a.normal_parts==undefined){a.normal_parts=k.createBuffer()}if(a.color_parts==undefined){a.color_parts=k.createBuffer()}if(a.index_parts==undefined){a.index_parts=k.createBuffer()}}else{if(a.vertex_parts!=undefined){k.deleteBuffer(a.vertex_parts);a.vertex_parts=null;
delete a.vertex_parts}if(a.normal_parts!=undefined){k.deleteBuffer(a.normal_parts);a.normal_parts=null;delete a.normal_parts}if(a.color_parts!=undefined){k.deleteBuffer(a.color_parts);a.color_parts=null;delete a.color_parts}if(a.index_parts!=undefined){k.deleteBuffer(a.index_parts);a.index_parts=null;delete a.index_parts}}if(e.mode==f.WIRED_AND_SOLID){a.index_ws=k.createBuffer();k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,a.index_ws);k.bufferData(k.ELEMENT_ARRAY_BUFFER,new Uint16Array(d.wireframe),k.STATIC_DRAW);
k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,null)}else{if(a.index_ws!=undefined){k.deleteBuffer(a.index_ws);a.index_ws=null;delete a.index_ws}}if(e.mode==f.BB_AND_SOLID){a.vertex_bs=k.createBuffer();k.bindBuffer(k.ARRAY_BUFFER,a.vertex_bs);k.bufferData(k.ARRAY_BUFFER,new Float32Array(e.getBoundingBoxVertices()),k.STATIC_DRAW);k.bindBuffer(k.ARRAY_BUFFER,null);a.index_bs=k.createBuffer();k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,a.index_bs);k.bufferData(k.ELEMENT_ARRAY_BUFFER,new Uint16Array(Model.BB_INDICES),k.STATIC_DRAW);
k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,null)}else{if(a.vertex_bs!=undefined){k.deleteBuffer(a.vertex_bs);a.vertex_bs=null;delete a.vertex_bs}if(a.index_bs!=undefined){k.deleteBuffer(a.index_bs);a.index_bs=null;delete a.index_bs}}if(d.texcoords&&e.material.texture){a.texcoords=k.createBuffer();k.bindBuffer(k.ARRAY_BUFFER,a.texcoords);k.bufferData(k.ARRAY_BUFFER,new Float32Array(d.texcoords),k.STATIC_DRAW);this._gl_textures[e.UID]=k.createTexture();k.bindTexture(k.TEXTURE_2D,this._gl_textures[e.UID]);
k.texImage2D(k.TEXTURE_2D,0,k.RGBA,k.RGBA,k.UNSIGNED_BYTE,e.material.texture.image);k.generateMipmap(k.TEXTURE_2D);k.bindTexture(k.TEXTURE_2D,null)}k.bindBuffer(k.ARRAY_BUFFER,null);k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,null);this._gl_buffers[d.UID]=a};RenderEngine.prototype._setNormals=function(e){var c=e.model;var h=this.gl;var d=this.pm;var a=this._gl_buffers[c.UID];var f=nucleo.def.essl;if(c.normals&&e.material.shading){h.bindBuffer(h.ARRAY_BUFFER,a.normal);d.enableAttribute(f.NORMAL_ATTRIBUTE);
d.setAttributePointer(f.NORMAL_ATTRIBUTE,3,h.FLOAT,false,0,0)}};RenderEngine.prototype._setColors=function(e){var c=e.model;var h=this.gl;var d=this.pm;var a=this._gl_buffers[c.UID];var f=nucleo.def.essl;if(e.material.colors&&e.material.colors.length==e.model.vertices.length){d.setUniform("uUseVertexColors",true);h.bindBuffer(h.ARRAY_BUFFER,a.color);h.bufferData(h.ARRAY_BUFFER,new Float32Array(e.material.colors),h.STATIC_DRAW);d.enableAttribute(f.COLOR_ATTRIBUTE);d.setAttributePointer(f.COLOR_ATTRIBUTE,3,h.FLOAT,false,0,0)
}};RenderEngine.prototype._setRenderableVertices=function(e,c){var h=this.gl;var d=this.pm;var a=this._gl_buffers[e.model.UID];var f=nucleo.def.essl;h.bindBuffer(h.ARRAY_BUFFER,a.vertex_parts);h.bufferData(h.ARRAY_BUFFER,new Float32Array(c.vertices),h.STATIC_DRAW);d.setAttributePointer(f.VERTEX_ATTRIBUTE,3,h.FLOAT,false,0,0)};RenderEngine.prototype._setRenderableNormals=function(e,c){var h=this.gl;var d=this.pm;var a=this._gl_buffers[e.model.UID];var f=nucleo.def.essl;if(c.normals!=undefined&&c.normals.length>0){h.bindBuffer(h.ARRAY_BUFFER,a.normal_parts);
h.bufferData(h.ARRAY_BUFFER,new Float32Array(c.normals),h.STATIC_DRAW);d.enableAttribute(f.NORMAL_ATTRIBUTE);d.setAttributePointer(f.NORMAL_ATTRIBUTE,3,h.FLOAT,false,0,0)}};RenderEngine.prototype._setRenderableColors=function(e,c){var h=this.gl;var d=this.pm;var a=this._gl_buffers[e.model.UID];var f=nucleo.def.essl;if(c.colors!=undefined&&c.colors.length>0){d.setUniform("uUseVertexColors",true);h.bindBuffer(h.ARRAY_BUFFER,a.color_parts);h.bufferData(h.ARRAY_BUFFER,new Float32Array(c.colors),h.STATIC_DRAW);
d.enableAttribute(f.COLOR_ATTRIBUTE);d.setAttributePointer(f.COLOR_ATTRIBUTE,3,h.FLOAT,false,0,0)}};RenderEngine.prototype._updateActorTransforms=function(f){var d=this._transforms;var e=f._actors.concat(f.toys.list);var h=e.length;var c=undefined;d.calculateModelView();for(var a=0;a<h;a+=1){c=e[a];if(c.visible==false&&f.frameAnimation==undefined){continue}c._matrix_world=mat4.multiply(c._matrix_world,d.model_view,c._matrix);c._matrix_normal=mat4.copy(c._matrix_normal,c._matrix_world);c._matrix_normal=mat4.invert(mat4.create(),c._matrix_normal);
c._matrix_normal=mat4.transpose(c._matrix_normal,c._matrix_normal)}};RenderEngine.prototype.render=function(h){var d=this._transforms,c=this.pm,k=this.gl,f=nucleo.def.essl;this._updateActorTransforms(h);c.setUniform(f.PERSPECTIVE_MATRIX,d.projection);if(h.frameAnimation!=undefined){h.frameAnimation.update()}this._renderPicking(h._actors);var e=h._actors.concat(h.toys.list);var a=e.length;while(a--){this._renderActor(e[a])}};RenderEngine.prototype._renderPicking=function(c){if(this._target==undefined){return
}if(this._offscreen){var d=this.gl;this._onPickingBuffer=true;d.bindFramebuffer(d.FRAMEBUFFER,this._target.framebuffer);d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT);var a=c.length;while(a--){if(c[a].isPickable()){this._renderActor(c[a])}}this._onPickingBuffer=false;d.bindFramebuffer(d.FRAMEBUFFER,null)}if(this._debug_picking_flag){d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT)}};RenderEngine.prototype._renderActor=function(d){if(!d.visible){return}var f=d.model;
var n=this._gl_buffers[f.UID];var k=this._gl_textures[d.UID];var e=this.gl;var a=this.pm;var m=nucleo.def.essl;var c=this._transforms;var l=[d.material.diffuse[0],d.material.diffuse[1],d.material.diffuse[2],d.material.opacity];if(d.mode==nucleo.def.actor.mode.FLAT){this.setProgram(nucleo.go.essl.lambert)}else{}a.disableAttribute(m.TEXCOORD_ATTRIBUTE);a.disableAttribute(m.COLOR_ATTRIBUTE);a.disableAttribute(m.NORMAL_ATTRIBUTE);a.disableAttribute(m.PICKING_COLOR_ATTRIBUTE);a.enableAttribute(m.VERTEX_ATTRIBUTE);
a.setUniform("uUseVertexColors",false);a.setUniform("uUseTextures",false);a.setUniform("uUseShading",d.material.shading);a.setUniform("uMaterialDiffuse",l);a.setUniform(m.MODEL_VIEW_MATRIX,d._matrix_world);a.setUniform(m.NORMAL_MATRIX,d._matrix_normal);this._handleCulling(d);if(this._onPickingBuffer||this._debug_picking_flag){this._renderPickingBuffer(d);return}e.bindBuffer(e.ARRAY_BUFFER,n.vertex);a.setAttributePointer(m.VERTEX_ATTRIBUTE,3,e.FLOAT,false,0,0);var h=nucleo.def.actor.mode;switch(d.mode){case h.SOLID:this._renderSolid(d);
break;case h.WIREFRAME:this._renderWireframe(d);break;case h.POINTS:this._renderPoints(d);break;case h.LINES:this._renderLines(d);break;case h.BOUNDING_BOX:this._renderBoundingBox(d);break;case h.BB_AND_SOLID:this._renderBoundingBoxAndSolid(d);break;case h.WIRED_AND_SOLID:this._renderWiredAndSolid(d);break;case h.FLAT:this._renderFlat(d);break;case h.TEXTURED:this._renderTextured(d);break;default:throw ("There was a problem while rendering the actor ["+d.name+"]. The visualization mode: "+d.mode+" is not valid.")
}e.bindBuffer(e.ARRAY_BUFFER,null);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)};RenderEngine.prototype._renderSolid=function(f){var a=this._gl_buffers[f.model.UID];var k=this.gl;var e=this.pm;var h=nucleo.def.essl;if(f.model.type!=define.Model.TYPE.SIMPLE){if(f.renderable==undefined){alert("the actor does not have a renderable object");throw"the actor does not have a renderable object"}parts=f.renderable.parts;var d=parts.length;while(d--){var c=parts[d];this._setRenderableVertices(f,c);this._setRenderableNormals(f,c);
this._setRenderableColors(f,c);k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,a.index_parts);k.bufferData(k.ELEMENT_ARRAY_BUFFER,new Uint16Array(c.indices),k.STATIC_DRAW);k.drawElements(k.TRIANGLES,c.indices.length,k.UNSIGNED_SHORT,0)}}else{this._setNormals(f);this._setColors(f);k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,a.index);k.drawElements(k.TRIANGLES,f.model.indices.length,k.UNSIGNED_SHORT,0)}};RenderEngine.prototype._renderWireframe=function(d){var a=this._gl_buffers[d.model.UID];var f=this.gl;var c=this.pm;
var e=nucleo.def.essl;if(!d.toy){this._setNormals(d)}this._setColors(d);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,a.index);f.drawElements(f.LINES,d.model.wireframe.length,f.UNSIGNED_SHORT,0)};RenderEngine.prototype._renderPoints=function(d){var a=d.model;var e=this.gl;var c=this.pm;c.setUniform("uUseShading",false);c.setUniform("uPointSize",5);this._setColors(d);e.drawArrays(e.POINTS,0,a.vertices.length/3)};RenderEngine.prototype._renderLines=function(h){var a=this._gl_buffers[h.model.UID];var l=this.gl;
var f=this.pm;var k=nucleo.def.essl;f.setUniform("uUseShading",false);if(h.model.type==define.Model.TYPE.BIG_DATA){if(h.renderable==undefined){alert("the actor does not have a renderable object");throw"the actor does not have a renderable object"}parts=h.renderable.parts;var e=parts.length;for(var d=0;d<e;d++){var c=parts[d];this._setRenderableVertices(h,c);this._setRenderableColors(h,c);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,a.index_parts);l.bufferData(l.ELEMENT_ARRAY_BUFFER,new Uint16Array(c.indices),l.STATIC_DRAW);
l.drawElements(l.LINES,c.indices.length,l.UNSIGNED_SHORT,0)}}else{this._setColors(h);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,a.index);l.drawElements(l.LINES,h.model.indices.length,l.UNSIGNED_SHORT,0)}};RenderEngine.prototype._renderBoundingBox=function(d){var a=this._gl_buffers[d.model.UID];var f=this.gl;var c=this.pm;var e=nucleo.def.essl;c.disableAttribute(e.NORMAL_ATTRIBUTE);c.setUniform("uUseShading",false);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,a.index);f.drawElements(f.LINES,Model.BB_INDICES.length,f.UNSIGNED_SHORT,0)
};RenderEngine.prototype._renderBoundingBoxAndSolid=function(e){var c=e.model;var a=this._gl_buffers[c.UID];var k=this.gl;var d=this.pm;var h=nucleo.def.essl;var f=this._transforms;this._renderSolid(e);f.calculateModelView();f.calculateNormal();d.setUniform(h.MODEL_VIEW_MATRIX,f.model_view);d.setUniform(h.NORMAL_MATRIX,f.normal);d.disableAttribute(h.NORMAL_ATTRIBUTE);d.setUniform("uUseShading",false);k.bindBuffer(k.ARRAY_BUFFER,a.vertex_bs);d.setAttributePointer(h.VERTEX_ATTRIBUTE,3,k.FLOAT,false,0,0);
k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,a.index_bs);k.drawElements(k.LINES,Model.BB_INDICES.length,k.UNSIGNED_SHORT,0)};RenderEngine.prototype._renderWiredAndSolid=function(e){var c=e.model;var a=this._gl_buffers[c.UID];var h=this.gl;var d=this.pm;var f=nucleo.def.essl;this._renderSolid(e);d.setUniform("uUseShading",false);d.setUniform("uMaterialDiffuse",[0.9,0.9,0.9,1]);d.disableAttribute(f.NORMAL_ATTRIBUTE);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,a.index_ws);h.drawElements(h.LINES,c.wireframe.length,h.UNSIGNED_SHORT,0)
};RenderEngine.prototype._renderFlat=function(e){var k=e.model;var n=this._gl_buffers[k.UID];var l=this._gl_textures[e.UID];var h=this.gl;var c=this.pm;var m=nucleo.def.essl;if(e.mesh==undefined){e.mesh=new Mesh(e);e.renderable=new Renderable(e)}if(e.mesh.model==undefined){var k=e.model;h.bindBuffer(h.ARRAY_BUFFER,n.vertex);c.setAttributePointer(m.VERTEX_ATTRIBUTE,3,h.FLOAT,false,0,0);h.bindBuffer(h.ARRAY_BUFFER,n.normal);c.setAttributePointer(m.NORMAL_ATTRIBUTE,3,h.FLOAT,false,0,0);h.bindBuffer(h.ARRAY_BUFFER,null);
c.enableAttribute(m.NORMAL_ATTRIBUTE);c.setUniform("uUseShading",e.material.shading);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,n.index);h.bufferData(h.ELEMENT_ARRAY_BUFFER,new Uint16Array(k.wireframe),h.STATIC_DRAW);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);this._renderWireframe(e);return}c.setUniform("uUseShading",true);c.enableAttribute(m.NORMAL_ATTRIBUTE);var d=e.renderable.parts;var f=d.length;while(f--){var a=d[f];h.bindBuffer(h.ARRAY_BUFFER,n.vertex_parts);h.bufferData(h.ARRAY_BUFFER,new Float32Array(a.vertices),h.STATIC_DRAW);
c.setAttributePointer(m.VERTEX_ATTRIBUTE,3,h.FLOAT,false,0,0);h.bindBuffer(h.ARRAY_BUFFER,n.normal_parts);h.bufferData(h.ARRAY_BUFFER,new Float32Array(a.normals),h.STATIC_DRAW);c.setAttributePointer(m.NORMAL_ATTRIBUTE,3,h.FLOAT,false,0,0);if(a.colors&&a.colors.length>0){c.enableAttribute(m.COLOR_ATTRIBUTE);c.setUniform("uUseVertexColors",true);h.bindBuffer(h.ARRAY_BUFFER,n.color_parts);h.bufferData(h.ARRAY_BUFFER,new Float32Array(a.colors),h.STATIC_DRAW);c.setAttributePointer(m.COLOR_ATTRIBUTE,3,h.FLOAT,false,0,0)
}h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,n.index_parts);h.bufferData(h.ELEMENT_ARRAY_BUFFER,new Uint16Array(a.indices),h.STATIC_DRAW);h.drawElements(h.TRIANGLES,a.indices.length,h.UNSIGNED_SHORT,0)}};RenderEngine.prototype._renderPickingBuffer=function(e){var k=e.model;var m=this._gl_buffers[k.UID];var h=this.gl;var c=this.pm;var l=nucleo.def.essl;if(e._picking==nucleo.define.Actor.PICKING.DISABLED){return}c.setUniform("uUseShading",false);if(e._picking==nucleo.define.Actor.PICKING.CELL){if(e.mesh==undefined||e.mesh.model==undefined){return
}if(m.picking_parts==undefined){m.picking_parts=h.createBuffer();m.picking_colors=h.createBuffer();m.picking_index=h.createBuffer()}c.setUniform("uUseVertexColors",true);c.enableAttribute(l.COLOR_ATTRIBUTE);var d=e.renderable.parts;var f=d.length;while(f--){var a=d[f];h.bindBuffer(h.ARRAY_BUFFER,m.picking_parts);h.bufferData(h.ARRAY_BUFFER,new Float32Array(a.vertices),h.STATIC_DRAW);c.setAttributePointer(l.VERTEX_ATTRIBUTE,3,h.FLOAT,false,0,0);if(a.pickingColors&&a.pickingColors.length==a.vertices.length){h.bindBuffer(h.ARRAY_BUFFER,m.picking_colors);
h.bufferData(h.ARRAY_BUFFER,new Float32Array(a.pickingColors),h.STATIC_DRAW);c.setAttributePointer(l.COLOR_ATTRIBUTE,3,h.FLOAT,false,0,0)}else{alert("The object "+a.name+" does not have picking colors assigned.");throw ("The object "+a.name+" does not have picking colors assigned.")}h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,m.picking_index);h.bufferData(h.ELEMENT_ARRAY_BUFFER,new Uint16Array(a.indices),h.STATIC_DRAW);h.drawElements(h.TRIANGLES,a.indices.length,h.UNSIGNED_SHORT,0)}}else{if(e._picking==nucleo.define.Actor.PICKING.OBJECT){c.setUniform("uMaterialDiffuse",e._pickingColor.concat(1));
h.bindBuffer(h.ARRAY_BUFFER,m.vertex);c.setAttributePointer(l.VERTEX_ATTRIBUTE,3,h.FLOAT,false,0,0);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,m.index);h.drawElements(h.TRIANGLES,k.indices.length,h.UNSIGNED_SHORT,0)}}h.bindBuffer(h.ARRAY_BUFFER,null);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null)};RenderEngine.prototype._renderTextured=function(e){var c=e.model;var a=this._gl_buffers[c.UID];var f=this._gl_textures[e.UID];var k=this.gl;var d=this.pm;var h=nucleo.def.essl;if(!e.material.texture.loaded){this._renderSolid(e);
return}if(e._new_texture){e.reallocate();e._new_texture=false;return}if(c.texcoords){d.setUniform("uUseTextures",true);k.bindBuffer(k.ARRAY_BUFFER,a.texcoords);d.setAttributePointer(h.TEXCOORD_ATTRIBUTE,2,k.FLOAT,false,0,0);d.enableAttribute(h.TEXCOORD_ATTRIBUTE)}else{throw ("error")}k.activeTexture(k.TEXTURE0);k.bindTexture(k.TEXTURE_2D,f);k.texParameteri(k.TEXTURE_2D,k.TEXTURE_WRAP_S,k.CLAMP_TO_EDGE);k.texParameteri(k.TEXTURE_2D,k.TEXTURE_WRAP_T,k.CLAMP_TO_EDGE);k.texParameteri(k.TEXTURE_2D,k.TEXTURE_MAG_FILTER,e.material.texture.getMagFilter(k));
k.texParameteri(k.TEXTURE_2D,k.TEXTURE_MIN_FILTER,e.material.texture.getMinFilter(k));d.setUniform("uSampler",0);k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,a.index);k.drawElements(k.TRIANGLES,c.indices.length,k.UNSIGNED_SHORT,0)};RenderEngine.prototype._handleCulling=function(a){var c=this.gl;c.disable(c.CULL_FACE);if(a.cull!=nucleo.def.actor.cull.NONE){c.enable(c.CULL_FACE);switch(a.cull){case nucleo.def.actor.cull.BACK:c.cullFace(c.BACK);break;case nucleo.def.actor.cull.FRONT:c.cullFace(c.FRONT);break
}}};RenderEngine.prototype.enableOffscreen=function(){this._offscreen=true;this._target=new RenderTarget(this)};RenderEngine.prototype.disableOffscreen=function(){this._offscreen=false;delete this._target;this._target=undefined};RenderEngine.prototype.isOffscreenEnabled=function(){return(this._target!=undefined)};RenderEngine.prototype.readOffscreenPixel=function(a,d){var c=this._target.readPixel(a,d);value=Array.apply([],c);value.constructor===Array;return value};function BakeEngine(a){this.renderer=a;
var c=a.gl;this._calls={};this._gl_buffers={index:c.createBuffer(),baked:c.createBuffer(),position:c.createBuffer(),scale:c.createBuffer(),shading:c.createBuffer()};this._data={index:[],baked:[],position:[],scale:[],shading:[]};this._allocated=[];this._offsets={position:{},scale:{},shading:{},baked:{}};this.glsl=util.extend(nucleo.def.essl,{POSITION:"aPosition",SCALE:"aScale",SHADING:"aShading"})}BakeEngine.prototype._populate=function(h,f){var c=[];for(var e=0;e<f;e+=1){if(h instanceof Array||h instanceof Float32Array){for(var d=0;
d<h.length;d+=1){c.push(h[d])}}else{c.push(h)}}return c};BakeEngine.prototype._computeRequiredCalls=function(h){var f=h._actors;var a=f.length;var c=0;var e=1;for(var d=0;d<a;d+=1){c+=f[d].model.indices.length;if(c>65000){c=0;e++}}return e};BakeEngine.prototype._allocateActor=function(h){if(this._allocated.indexOf(h.UID)!=-1){return}var l=this._data;var e=this._offsets;var m=this.renderer.gl;var n=h.model;var a=n.vertices.length;var f=[],o=[];if(h.material.diffuse){f=this._populate(h.material.diffuse,a/3)
}else{f=this._populate([0.7,0.7,0.7],a/3)}if(n.normals){o=n.normals}else{o=this._populate(0,a)}e.baked[h.UID]=l.baked.length;for(var k=0;k<a;k+=3){l.baked.push(n.vertices[k]);l.baked.push(n.vertices[k+1]);l.baked.push(n.vertices[k+2]);l.baked.push(o[k]);l.baked.push(o[k+1]);l.baked.push(o[k+2]);l.baked.push(f[k]);l.baked.push(f[k+1]);l.baked.push(f[k+2])}e.position[h.UID]=l.position.length;e.scale[h.UID]=l.scale.length;e.shading[h.UID]=l.shading.length;l.position=l.position.concat(this._populate(h._position,a/3));
l.scale=l.scale.concat(this._populate(h._scale,a/3));l.shading=l.shading.concat(this._populate(h.material.opacity,a/3));var c=n.indices.slice(0);if(l.index.length>0){var q=l.index.max()+1;var d=n.indices.length;for(var k=0;k<d;k+=1){c[k]+=q}l.index=l.index.concat(c)}else{l.index=c}this._allocated.push(h.UID)};BakeEngine.prototype._updateActorPosition=function(c){var d=this._data;var f=this._offsets.position[c.UID];if(f==undefined){return}var e=c.model.vertices.length+f;for(var a=f;a<e;a+=3){d.position[a]=c._position[0];
d.position[a+1]=c._position[1];d.position[a+2]=c._position[2]}};BakeEngine.prototype._updateActorScale=function(c){var d=this._data;var f=this._offsets.scale[c.UID];if(f==undefined){return}var e=c.model.vertices.length+f;for(var a=f;a<e;a+=3){d.scale[a]=c._scale[0];d.scale[a+1]=c._scale[1];d.scale[a+2]=c._scale[2]}};BakeEngine.prototype._updateActorColor=function(c){var d=this._data;var f=this._offsets.baked[c.UID];if(f==undefined){return}var e=(c.model.vertices.length*3)+f;for(var a=f;a<e;a+=9){d.baked[a+6]=c.material.diffuse[0];
d.baked[a+7]=c.material.diffuse[1];d.baked[a+8]=c.material.diffuse[2]}};BakeEngine.prototype._updateActorShading=function(c){var d=this._data;var h=this._offsets.shading[c.UID];if(h==undefined){return}var e=(c.model.vertices.length/3)+h;var f=0;if(c.material.opacity){f=1}for(var a=h;a<e;a+=1){d.shading[a]=f}};BakeEngine.prototype.deallocate=function(a){};BakeEngine.prototype.allocate=function(l){if(this._computeRequiredCalls(l)>1){throw"Not renderable yet. Working on it. The number of indices exceeds the 65K limit"
}var a=l._actors;var d=a.length;var c=this.renderer;var o=this._gl_buffers;var h=this._data;var e=c.pm;var k=c.gl;var n=this.glsl;var m=k.STATIC_DRAW;for(var f=0;f<d;f+=1){this._allocateActor(a[f])}e.enableAttribute(n.VERTEX_ATTRIBUTE);e.enableAttribute(n.NORMAL_ATTRIBUTE);e.enableAttribute(n.COLOR_ATTRIBUTE);e.enableAttribute(n.POSITION);e.enableAttribute(n.SCALE);e.enableAttribute(n.SHADING);k.bindBuffer(k.ARRAY_BUFFER,o.baked);k.bufferData(k.ARRAY_BUFFER,new Float32Array(h.baked),m);e.setAttributePointer(n.VERTEX_ATTRIBUTE,3,k.FLOAT,false,36,0);
e.setAttributePointer(n.NORMAL_ATTRIBUTE,3,k.FLOAT,false,36,12);e.setAttributePointer(n.COLOR_ATTRIBUTE,3,k.FLOAT,false,36,24);k.bindBuffer(k.ARRAY_BUFFER,o.position);k.bufferData(k.ARRAY_BUFFER,new Float32Array(h.position),m);e.setAttributePointer(n.POSITION,3,k.FLOAT,false,12,0);k.bindBuffer(k.ARRAY_BUFFER,o.scale);k.bufferData(k.ARRAY_BUFFER,new Float32Array(h.scale),m);e.setAttributePointer(n.SCALE,3,k.FLOAT,false,12,0);k.bindBuffer(k.ARRAY_BUFFER,o.shading);k.bufferData(k.ARRAY_BUFFER,new Float32Array(h.shading),m);
e.setAttributePointer(n.SHADING,1,k.FLOAT,false,4,0);k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,o.index);k.bufferData(k.ELEMENT_ARRAY_BUFFER,new Uint16Array(h.index),m)};BakeEngine.prototype.render=function(l){var a=this.renderer;var d=a.transforms;var c=a.pm;var k=a.gl;var n=nucleo.def.essl;var f=this._data;d.update();c.setUniform(n.PERSPECTIVE_MATRIX,d.pMatrix);c.setUniform(n.MODEL_VIEW_MATRIX,d.mvMatrix);c.setUniform(n.NORMAL_MATRIX,d.nMatrix);c.setUniform(n.MVP_MATRIX,d.mvpMatrix);for(var h=0,m=l._actors.length;
h<m;h+=1){var e=l._actors[h];this._updateActorPosition(e);this._updateActorScale(e);this._updateActorShading(e);this._updateActorColor(e)}k.drawElements(k.TRIANGLES,f.index.length,k.UNSIGNED_SHORT,0);k.bindBuffer(k.ARRAY_BUFFER,null);k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,null)};function Scene(){this.views=[];this._actors=[];this._groups=[];this.toys=new SceneToys(this);this.loadingMode=define.Model.LOADING_MODE.LIVE;this.normalsFlipped=false;this.lutID=null;this.timerID=null;this.scalarMIN=Number.MAX_VALUE;
this.scalarMAX=Number.MIN_VALUE;this.bb=[0,0,0,0,0,0];this.centre=[0,0,0];this.frameAnimation=null;this.UID=util.generateUID();var c=notifierInstance;var a=define.EVENTS;c.publish([a.SCENE_NEW,a.SCENE_UPDATED],this);c.subscribe([a.MODELS_LOADED,a.DEFAULT_LUT_LOADED],this);c.fire(a.SCENE_NEW,this)}Scene.prototype.handleEvent=function(a,c){if(a==define.EVENTS.MODELS_LOADED){this.updateScalarRange();if(this.lutID!=null){this.setLookupTable(this.lutID)}}else{if(a==define.EVENTS.DEFAULT_LUT_LOADED){this.lutID="default";
this.setLookupTable(this.lutID)}}};Scene.prototype.setLoadingMode=function(c){var a=Model.loadingMode;if(c==undefined||c==null||(c!=a.LIVE&&c!=a.LATER&&c!=a.DETACHED)){throw ("the mode "+c+"is not a valid loading mode")}this.loadingMode=c};Scene.prototype._updateBoundingBoxWith=function(c){var a=c._bb;util.console("Scene: updating metrics with ("+a[0]+","+a[1]+","+a[2]+") - ("+a[3]+","+a[4]+","+a[5]+")");if(this._actors.length==1){this.bb=this._actors[0]._bb.slice(0);this.toys.update();return}var d=this.bb;
var e=this.centre;d[0]=Math.min(d[0],a[0]);d[1]=Math.min(d[1],a[1]);d[2]=Math.min(d[2],a[2]);d[3]=Math.max(d[3],a[3]);d[4]=Math.max(d[4],a[4]);d[5]=Math.max(d[5],a[5]);e[0]=(d[3]+d[0])/2;e[1]=(d[4]+d[1])/2;e[2]=(d[5]+d[2])/2;e[0]=Math.round(e[0]*1000)/1000;e[1]=Math.round(e[1]*1000)/1000;e[2]=Math.round(e[2]*1000)/1000;this.toys.update()};Scene.prototype.computeBoundingBox=function(){if(this._actors.length>0){this.bb=this._actors[0]._bb.slice(0)}else{this.bb=[0,0,0,0,0,0]}this.centre=[0,0,0];var a=this._actors.length;
while(a--){this._updateBoundingBoxWith(this._actors[a])}};Scene.prototype.createActor=function(a){var c=new Actor(a);this.addActor(c);return c};Scene.prototype.createActors=function(c){var a=c.length;while(a--){this.createActor(c[a])}};Scene.prototype.addActor=function(a){a.setScene(this);if(this.normalsFlipped){a.flipNormals(true)}if(this.lutID!=null){a.setLookupTable(this.lutID,this.scalarMIN,this.scalarMAX)}this._actors.push(a);this._updateBoundingBoxWith(a);util.console("Scene: Actor for model "+a.model.name+" added");
if(this._actors.length==1){nucleo.c.actor=a}else{nucleo.c.actor=undefined}notifierInstance.fire(define.EVENTS.SCENE_UPDATED,this)};Scene.prototype.updateActor=function(c){if(!this.hasActor(c)){return}c.dirty=true;var a=this.views.length;while(a--){this.views[a].renderer.reallocate()}c.dirty=false};Scene.prototype.removeActor=function(c){var a=this._actors.indexOf(c);var c=this._actors.splice(a,1);c=null;this.computeBoundingBox()};Scene.prototype.hasActor=function(c){if(c instanceof Actor){return(this._actors.indexOf(c)!=-1)
}else{if(typeof(c)=="string"){var a=this.getActorByName(c);return(a!=undefined)}else{return false}}};Scene.prototype.setPropertyForAll=function(d,c){var a=this._actors.length;while(a--){this._actors[a].setProperty(d,c)}};Scene.prototype.setPropertyFor=function(f,e,d){var a=f.length;while(a--){if(this.hasActor(f[a])){var c=undefined;if(typeof(f[a])=="string"){c=this.getActorByName(f[a])}else{if(f[a] instanceof Actor){f[a].setProperty(e,d)}else{throw"Scene.setPropertyFor: ERROR, the list of actors is invalid"
}}}}};Scene.prototype.updateScalarRange=function(){var a=this._actors.length;while(a--){var c=this._actors[a];if(c.model.scalars&&c.model.scalars.max()>this.scalarMAX){this.scalarMAX=c.model.scalars.max()}if(c.model.scalars&&c.model.scalars.min()<this.scalarMIN){this.scalarMIN=c.model.scalars.min()}}};Scene.prototype.setLookupTable=function(c){this.lutID=c;var a=this._actors.length;while(a--){this._actors[a].setLookupTable(c,this.scalarMIN,this.scalarMAX)}};Scene.prototype.reset=function(){var a=this._actors.length;
while(a--){this._actors[a]=null}this._actors=[];nucleo.c.actor=null;this.computeBoundingBox()};Scene.prototype.getActorByName=function(a){a=a.replace(/\.[^/.]+$/,"");var c=this._actors.length;while(c--){if(this._actors[c].name==a){return this._actors[c]}}return null};Scene.prototype.getActorByUID=function(a){var c=this._actors.length;while(c--){if(this._actors[c].UID==a){return this._actors[c]}}return null};Scene.prototype.getActor=function(c){var a=this.getActorByName(c);if(a==null){a=this.getActorByUID(c)
}return a};Scene.prototype.getActorsThat=function(f){var a=[];var e=this._actors.length;while(e--){if(f(this._actors[e])){a.push(e)}}var d=[];var c=a.length;while(c--){d.push(this._actors[a[c]])}return d};Scene.prototype.setOpacity=function(e,a){if(a==null){var c=this._actors.length;while(c--){this._actors[c].setOpacity(e)}}else{var d=this.getActorByName(a);d.setOpacity(e)}};Scene.prototype.flipNormals=function(){var a=this._actors.length;while(a--){this._actors[a].flipNormals()}};Scene.prototype.setVisualizationMode=function(c){if(c==null||c==undefined){return
}var a=this._actors.length;while(a--){this._actors[a].setVisualizationMode(c)}};Scene.prototype.setAnimation=function(c){if(c instanceof FrameAnimation){this.frameAnimation=c;this.frameAnimation.scene=this;var a=this.views.length;while(a--){this.views[a].renderer.setMode(nucleo.def.renderer.mode.ANIMFRAME)}util.console("Scene: animation added")}};Scene.prototype.clearAnimation=function(){if(this.frameAnimation){this.frameAnimation.scene=null;this.frameAnimation=null}};Scene.prototype.getActorNames=function(){var c=[];
var a=this._actors.length;while(a--){c.push(this._actors[a].name)}return c};Scene.prototype.getPickableActors=function(){function a(c){return c.isPickable()}return this.getActorsThat(a)};Scene.prototype.getActorByCellUID=function(a){var e=[];var c=this._actors.length;while(c--){var d=this._actors[c];if(d.mesh!=undefined&&d.mesh.hasCell(a)){return d}}return null};Scene.prototype.createActorGroup=function(a,d){var e=undefined;if(this.getActorGroup(a)!=undefined){alert("Scene.createActorGroup: an actor group with the name "+a+" already exists");
throw ("Scene.createActorGroup: an actor group with the name "+a+" already exists")}try{e=new ActorGroup(this,a,d);this._groups.push(e)}catch(c){if(c instanceof vxlActorGroupException){alert(c.messages)}}finally{return e}};Scene.prototype.getActorGroup=function(a){var c=this._groups.length;while(c--){if(this._groups[c].name==a){return this._groups[c]}}return undefined};function SceneToys(a){this.scene=a;this.list=[];this.axis=new Axis();this.boundingbox=new BoundingBox();this.floor=new Floor();this.list.push(this.axis);
this.list.push(this.boundingbox);this.list.push(this.floor)}SceneToys.prototype.update=function(){this.axis.setCentre(this.scene.centre);this.boundingbox.setBoundingBox(this.scene.bb)};function LookupTable(){this.ID=null;this.map=null;this.max=Number.MIN_VALUE;this.min=Number.MAX_VALUE}LookupTable.prototype.load=function(a,d){this.ID=a;this.map=d;for(var c in this.map){var e=Number(c);if(e<this.min){this.min=e}else{if(e>=this.max){this.max=e}}}};LookupTable.prototype._scale=function(d,c,a){return d*this.max/a
};LookupTable.prototype.getColor=function(k,f,a){var h=this._scale(k,f,a);var d=this;var e=Math.round(h);if(e>=d.min&&e<=d.max){var m=[d.map[e][0],d.map[e][1],d.map[e][2]];return m}else{if(e<d.min){return[d.map[d.min][0],d.map[d.min][1],d.map[d.min][2]]}else{if(e>d.max){return[d.map[d.max][0],d.map[d.max][1],d.map[d.max][2]]}else{alert("assertion error in getColor routine");return[d.map[d.min][0],d.map[d.min][1],d.map[d.min][2]]}}}};LookupTable.prototype.getColors=function(f,e,a){var k=[];for(var d=0;
d<f.length;d++){var h=this.getColor(f[d],e,a);k.push(h[0]);k.push(h[1]);k.push(h[2])}return k};function LookupTableManager(){this._hashmap={};this._location="";notifierInstance.publish(define.EVENTS.DEFAULT_LUT_LOADED,this)}LookupTableManager.prototype.setLocation=function(a){this._location=a};LookupTableManager.prototype.load=function(d){if(this.isLoaded(d)){return}var e=this;var h=this._location+"/"+d+".lut";var k=h+"?nocache="+(new Date()).getTime();var c=function(m,l){return function(n,o){m._handle(l,n)
}};var a=function(l){return function(o,m,n){if(n.code=1012){alert("The file "+l+" could not be accessed. \n\nPlease make sure that the path is correct and that you have the right pemissions")}else{alert("There was a problem loading the file "+l+". HTTP error code:"+o.status)}}};var f=$.ajax({url:k,type:"GET",dataType:"json",mimeType:"text/plain",success:c(e,d),error:a(h)})};LookupTableManager.prototype._handle=function(a,d){var c=new LookupTable();c.load(a,d);this._hashmap[a]=c;if(c.ID==nucleo.def.lut.main){notifierInstance.fire(define.EVENTS.DEFAULT_LUT_LOADED,this)
}};LookupTableManager.prototype.isLoaded=function(a){return this._hashmap[a]!=undefined};LookupTableManager.prototype.get=function(a){return this._hashmap[a]};LookupTableManager.prototype.getAllLoaded=function(){var a=[];for(lut in this._hashmap){a.push(this._hashmap[lut].ID)}return a};LookupTableManager.prototype.allLoaded=function(){var a=0;for(lut in this._hashmap){a++}return(nucleo.def.lut.list.length==a)};LookupTableManager.prototype.loadAll=function(){for(var a=0;a<nucleo.def.lut.list.length;
a++){this.load(nucleo.def.lut.list[a])}};nucleo.go.lookupTableManager=new LookupTableManager();BoundingBox.prototype=new Actor();BoundingBox.prototype.constructor=BoundingBox;function BoundingBox(){var a=new Model();a.load("bounding box",define.Model.BoundingBox);Actor.call(this,a);this.bb=this.setBoundingBox([-1,-1,-1,1,1,1]);this.mode=Actor.MODE.WIREFRAME;this.visible=false;this.toy=true}BoundingBox.prototype.setBoundingBox=function(a){this.bb=[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5],a[3],a[1],a[5]];
this.model.vertices=this.bb;this.reallocate()};Axis.prototype=new Actor();Axis.prototype.constructor=Axis;function Axis(){var a=new Model();a.load("axis",define.Model.Axis);Actor.call(this,a);this.centre=[0,0,0];this.mode=Actor.MODE.WIREFRAME;this.visible=false;this.toy=true}Axis.prototype.setCentre=function(d){var c=d[0];var f=d[1];var e=d[2];this.centre[0]=c;this.centre[1]=f;this.centre[2]=e;var a=this.model.vertices;a[0]=c-1;a[1]=f;a[2]=e;a[3]=c+1;a[4]=f;a[5]=e;a[6]=c;a[7]=f-2;a[8]=e;a[9]=c;a[10]=f+2;
a[11]=e;a[12]=c;a[13]=f;a[14]=e-1;a[15]=c;a[16]=f;a[17]=e+1};Floor.prototype=new Actor();Floor.prototype.constructor=Floor;function Floor(){var a=new Model();a.load("floor",define.Model.Floor);Actor.call(this,a);this.mode=Actor.MODE.WIREFRAME;this.visible=false;this.toy=true}Floor.prototype.setGrid=function(k,m){var h=k;var c=2*h/m;var f=2*h/c;var d=[];var e=[];for(var a=0;a<=c;a++){d[6*a]=-h;d[6*a+1]=0;d[6*a+2]=-h+(a*f);d[6*a+3]=h;d[6*a+4]=0;d[6*a+5]=-h+(a*f);d[6*(c+1)+6*a]=-h+(a*f);d[6*(c+1)+6*a+1]=0;
d[6*(c+1)+6*a+2]=-h;d[6*(c+1)+6*a+3]=-h+(a*f);d[6*(c+1)+6*a+4]=0;d[6*(c+1)+6*a+5]=h;e[2*a]=2*a;e[2*a+1]=2*a+1;e[2*(c+1)+2*a]=2*(c+1)+2*a;e[2*(c+1)+2*a+1]=2*(c+1)+2*a+1}this.model.vertices=d.slice(0);this.model.wireframe=e.slice(0);this.visible=true;this.reallocate()};function View(f,d,h){this.canvas=document.getElementById(f);if(this.canvas==null){alert("View: the canvas "+f+" does not exist.");throw ("View: the canvas "+f+" does not exist.")}this.name=f;this.width=this.canvas.width;this.height=this.canvas.height;
this.clearDepth=1;this.backgroundColor=define.View.BACKGROUND.slice(0);this._dragndrop=false;this.renderer=new Renderer(this);this.setBackgroundColor(this.backgroundColor);this.setClearDepth(this.clearDepth);this.cameraman=new CameraManager(this);this.interactor=new TrackerInteractor();this.interactor.connectView(this);if(d!=null&&d instanceof Scene){this.scene=d}else{this.scene=new Scene()}this.scene.views.push(this);if(h==undefined){h=true}this.setAutoResize(h);this._fullscreenFlag=true;this.UID=util.generateUID();
var c=notifierInstance;var a=define.EVENTS;c.publish(a.VIEW_NEW,this);c.subscribe(a.DEFAULT_LUT_LOADED,this);c.fire(a.VIEW_NEW,this);util.console("View: the view "+this.name+" has been created")}View.BACKGROUND=define.View.BACKGROUND;View.prototype.handleEvent=function(a,c){util.console("View ["+this.name+"]: receiving event "+a);if(a==define.EVENTS.DEFAULT_LUT_LOADED){this.scene.setLookupTable(nucleo.def.lut.main)}};View.prototype.clear=function(){this.renderer.clear()};View.prototype._wrapDiv=function(){$(this.canvas).css({position:"absolute",height:"auto",bottom:0,top:0,left:0,right:0,margin:"5px"});
$(this.canvas).wrap("<div id="+this.name+"-wrapper />");$("#"+this.name+"-wrapper").css({width:"100%",height:"100%"});this.canvas.focus()};View.prototype.resize=function(){var a=this.canvas.parentNode;this.width=$(a).width()-5;this.height=$(a).height()-5;if(this.width>window.innerWidth-5){this.width=window.innerWidth-5}if(this.height>window.innerHeight-5){this.height=window.innerHeight-5}$(this.canvas).attr("width",this.width);$(this.canvas).attr("height",this.height)};View.prototype.setAutoResize=function(a){if(a){this._wrapDiv();
this.resize();$(window).resize((function(c){return function(){c.resize()}})(this))}else{$(window).unbind("resize")}};View.prototype._runPrefixMethod=function(e,h){var f=["webkit","moz","ms","o",""];var d=0,a,c;while(d<f.length&&!e[a]){a=h;if(f[d]==""){a=a.substr(0,1).toLowerCase()+a.substr(1)}a=f[d]+a;c=typeof e[a];if(c!="undefined"){f=[f[d]];return(c=="function"?e[a]():e[a])}d++}};View.prototype.fullscreen=function(a){if(!this._fullscreenFlag){return}if(a==true){var c=navigator.userAgent.toLowerCase().indexOf("chrome")>-1;
if(c){this._runPrefixMethod(this.canvas,"RequestFullscreen")}else{this._runPrefixMethod(this.canvas,"RequestFullScreen")}}else{if(document.cancelFullScreen){document.cancelFullScreen()}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else{if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}}}}};View.prototype.disableFullScreen=function(){this._fullscreenFlag=false};View.prototype.enableFullScreen=function(){this._fullscreenFlag=true};View.prototype.start=function(){this.renderer.start();
this.refresh()};View.prototype.stop=function(){this.renderer.stop()};View.prototype.reset=function(){this.stop();this.scene.reset();this.cameraman.reset();this.start()};View.prototype.setBackgroundColor=function(d,c,a){this.backgroundColor=util.createColor(d,c,a);this.renderer.clearColor(this.backgroundColor)};View.prototype.setClearDepth=function(a){this.renderer.clearDepth(a)};View.prototype.refresh=function(){if(this.renderer.mode!=nucleo.def.renderer.mode.ANIMFRAME){this.renderer.render()}};View.prototype.setInteractor=function(a){this.interactor=a;
this.interactor.connectView(this)};View.prototype.setDragAndDrop=function(a){this._dragndrop=a};View.prototype.getFPS=function(){return this.renderer.fps};View.prototype.getCurrentCamera=function(){return this.cameraman.active};View.prototype.load=function(d,f,h){var c=[];var e=util.getPath(f);if(typeof(d)=="string"||d instanceof String){c.push(e+d)}else{if((d instanceof Array)){for(var a=0;a<d.length;a++){c.push(e+d[a])}}else{throw Exception("not a valid argument")}}if(h!=undefined&&h!=null){this.scene.setLoadingMode(h)
}modelManagerInstance.loadList(c,scene)};function ModelManager(){this.toLoad=[];this.models=[];var a=define.EVENTS;notifierInstance.publish([a.MODELS_LOADING,a.MODEL_NEW,a.MODELS_LOADED],this);notifierInstance.subscribe(a.READER_DONE,this)}ModelManager.prototype.handleEvent=function(d,e){var a=e;var c=a.getModel();this.add(c,a.scene)};ModelManager.prototype.load=function(d,k){var f=this;var a=d.replace(/^.*[\\\/]/,"");var e=a.split(".")[0];var n=a.split(".")[1];var o="json";var c="application/json";
if(f.isModelLoaded(e)){return}if(n=="vtk"){o="text";c="text/plain"}else{if(n=="json"){o="json"}else{alert("vxlManager.load ERROR: Unknown filetype ["+n+"]");throw ("vxlManager.load ERROR: Unknown filetype ["+n+"]")}}nocacheuri=d+"?nocache="+(new Date()).getTime();util.console("ModelManager.load: Requesting "+d+"...");notifierInstance.fire(define.EVENTS.MODELS_LOADING,this);var m=function(s,q,t){switch(n){case"json":return function(u,v){u.uri=a;u.path=util.getPath(d);u.name=q;s.add(u,t)};break;case"vtk":return function(u){reader=new VTKReader(t);
reader.readText(q,u)}}};var l=function(q){return function(u,s,t){if(t.code=1012){alert("The file "+q+" could not be accessed. \n\nPlease make sure that the path is correct and that you have the right pemissions")}else{alert("There was a problem loading the file "+q+". HTTP error code:"+u.status)}}};var h=$.ajax({url:nocacheuri,type:"GET",dataType:o,mimeType:c,success:m(f,e,k),error:l(d)})};ModelManager.prototype.loadList=function(c,d){this.toLoad=c.slice(0);util.console("ModelManager.loadList: models to load ->"+this.toLoad.length);
for(var a=0;a<this.toLoad.length;a++){this.load(this.toLoad[a],d)}};ModelManager.prototype.add=function(f,a){var d=this;var e=undefined;if(f instanceof Model){e=f}else{e=new Model(f.name,f)}function c(){e.loaded=true;d.models.push(e);d.toLoad.splice(name,1);util.console("ModelManager: model "+e.name+" created.");if(a!=undefined&&a instanceof Scene){util.console("ModelManager: notifying the scene...");if(a.loadingMode==Model.loadingMode.LIVE){a.createActor(e)}else{if(a.loadingMode==Model.loadingMode.LATER){if(d.allLoaded()){a.createActors(d.models)
}}else{if(a.loadingMode==Model.loadingMode.DETACHED){}}}}if(d.allLoaded()){notifierInstance.fire(define.EVENTS.MODELS_LOADED,d)}else{notifierInstance.fire(define.EVENTS.MODEL_NEW,d)}}setTimeout(function(){c()},0)};ModelManager.prototype.reset=function(){this.firstLoadedModel=false;for(var a=0;a<this.models.length;a++){this.models[a]=null}this.models=[];this.toLoad=[]};ModelManager.prototype.isModelLoaded=function(a){for(var c=0;c<this.models.length;c++){if(this.models[c].name==a){return true}}return false
};ModelManager.prototype.allLoaded=function(){return(this.toLoad.length==0)};ModelManager.prototype.getModelByName=function(c){for(var d=0,a=this.models.length;d<a;d+=1){if(this.models[d].name==c){return this.models[d]}}return null};modelManagerInstance=new ModelManager();function FrameAnimation(a){this.scene=null;this.actorByFrameMap=[];this.activeFrame=1;this.mark=1;this._running=false;this.frameCount=0;this.renderRate=500;this._startDate=undefined;this._time=0;this._setup(a);if(nucleo.c.animation==null){nucleo.c.animation=this
}}FrameAnimation.prototype.addActorToFrame=function(c,a){if(typeof(this.actorByFrameMap[c])=="undefined"){this.actorByFrameMap[c]=new Array()}if(this.actorByFrameMap[c].indexOf(a)==-1){this.actorByFrameMap[c].push(a)}if(c>this.frameCount){this.frameCount=c}};FrameAnimation.prototype._setup=function(h){this.activeFrame=1;for(var e in h){var c=h[e];var k=parseInt(e.substr(5,e.length));for(var d=0,a=c.length;d<a;d+=1){this.addActorToFrame(k,c[d])}}util.console("FrameAnimation: Setup finished.")};FrameAnimation.prototype.start=function(a){if(this.scene==null){throw"FrameAnimation: the animation is not associated with any scene. Please use scene.setFrameAnimation method"
}this._startDate=new Date().getTime();this._time=0;this._running=true;if(a!=undefined&&a>=0){this.renderRate=a}this._timeUp()};FrameAnimation.prototype._timeUp=function(){if(!this._running){return}this.nextFrame();if(this._time==this.renderRate*100){this._time=0;this._startDate=new Date().getTime()}this._time+=this.renderRate;var a=(new Date().getTime()-this._startDate)-this._time;if(a>this.renderRate){a=0}setTimeout((function(c){return function(){c._timeUp()}})(this),this.renderRate-a)};FrameAnimation.prototype.stop=function(){this._running=false
};FrameAnimation.prototype.setFrameRate=function(a){if(a<=0){return}this.stop();this.renderRate=a;this.start()};FrameAnimation.prototype.update=function(){if(this.scene==null){throw"FrameAnimation: the animation is not associated with any scene. Please use scene.setFrameAnimation method"}this.scene.setPropertyForAll("visible",false);var d=this.actorByFrameMap[this.activeFrame];var a=d.length;for(var c=0;c<a;c++){var e=this.scene.getActorByName(d[c]);if(e!=null){e.setVisible(true)}}};FrameAnimation.prototype.isValidFrame=function(a){return(a>=1&&a<=this.frameCount)
};FrameAnimation.prototype.nextFrame=function(){if(this.activeFrame<this.frameCount){this.activeFrame++}else{this.activeFrame=1}};FrameAnimation.prototype.getNextFrames=function(h){var e=[];var f=this.activeFrame;if(h>this.frameCount){h=this.frameCount}for(var a=1;a<=h;a++){var d=f+a;if(this.isValidFrame(d)){e.push(d)}else{e.push(d-this.frameCount)}}util.console("Animation: next frames: "+e);return e};FrameAnimation.prototype.getPreviousFrames=function(h){var e=[];var f=this.activeFrame;if(h>this.frameCount){h=this.frameCount
}for(var a=1;a<=h;a++){var d=f-a;if(this.isValidFrame(d)){e.push(d)}else{e.push(this.frameCount+d)}}util.console("Animation: previous frames: "+e);return e};FrameAnimation.prototype.setFrame=function(a){if(a>=1&&a<=this.frameCount){this.activeFrame=a;this.render()}};function VTKReader(a){this.scene=a;notifierInstance.publish(define.EVENTS.READER_DONE,this)}VTKReader.prototype.isSupported=function(){return(window.File&&window.FileReader&&window.FileList&&window.Blob)};VTKReader.prototype.readFile=function(e){var a=this;
var d=e.name;if(d.length-4!==d.indexOf(".vtk")){throw"VTKReader.read: the file "+e+" is not a VTK file"}modelname=d.replace(/\.[^/.]+$/,"");var c=new FileReader();c.onload=function(k){document.body.style.cursor="default";var h=k.target.result.trim();var f=h.split(/\r\n|\r|\n/);a._parse(modelname,f);notifierInstance.fire(define.EVENTS.READER_DONE,a)};document.body.style.cursor="wait";c.readAsText(e)};VTKReader.prototype.readText=function(c,d){document.body.style.cursor="wait";var a=d.split(/\r\n|\r|\n/);
this._parse(c,a);notifierInstance.fire(define.EVENTS.READER_DONE,this);document.body.style.cursor="default"};VTKReader.prototype._parse=function(D,d){var f=65536*3;var A="";var e=0;var c="NOWHERE";var k=0;var o=[];var m=[];var y=[];var h=[];var s=[];var w="SOLID";var x={NOWHERE:0,POINTS:1,LINES:2,POLYGONS:3,POINT_DATA:4,NORMALS:5,CELL_DATA:6,TEXTURE_COORDINATES:7,SCALARS:8,LOOKUP_TABLE:9,COLOR_SCALARS:10};this.json={name:D};function q(n){var F=n.length-1;if(F!=n[0]){throw"Assertion Error. Inconsistent line"
}var v=n.splice(1,F);for(var E=0;E<F-1;E+=1){m.push(parseInt(v[E]));m.push(parseInt(v[E+1]))}}for(var k=0;k<d.length;k++){try{if(d[k].indexOf("POINTS")==0){console.log(d[k]);c=x.POINTS;continue}else{if(d[k].indexOf("LINES")==0){console.log(d[k]);c=x.LINES;w="LINES";continue}else{if(d[k].indexOf("TRIANGLE_STRIPS")==0){console.log(d[k]);alert("vxlVTKParser ERROR: \nTriangle Strips Not Supported. Please triangulate first");throw ("Triangle Strips Not Supported. Please triangulate first")}else{if(d[k].indexOf("POLYGONS")==0){console.log(d[k]);
c=x.POLYGONS;continue}else{if(d[k].indexOf("POINT_DATA")==0){c=x.POINT_DATA;continue}else{if(d[k].indexOf("NORMALS")==0){console.log(d[k]);c=x.NORMALS;continue}else{if(d[k].indexOf("CELL_DATA")==0){console.log(d[k]);c=x.CELL_DATA;continue}else{if(d[k].indexOf("TEXTURE_COORDINATES")==0){console.log(d[k]);c=x.TEXTURE_COORDINATES;continue}else{if(d[k].indexOf("SCALARS")==0){console.log(d[k]);c=x.SCALARS;continue}else{if(d[k].indexOf("LOOKUP_TABLE")==0){console.log(d[k]);c=x.LOOKUP_TABLE;continue}else{if(d[k].indexOf("COLOR_SCALARS")==0){console.log(d[k]);
c=x.COLOR_SCALARS;continue}else{if(c==x.POINTS){var t=d[k].trim().split(" ");if(t==""){continue}for(var B=0;B<t.length;B++){o.push(parseFloat(t[B]))}}else{if(c==x.LINES){var u=d[k].trim().split(" ");if(u==""){continue}q(u)}else{if(c==x.POLYGONS){var a=d[k].trim().split(" ");if(a==""){continue}if(a.length>0&&a[0]!="3"){throw"Error: please make sure your vtk file contains triangles instead of polygons (triangulate first)"}for(var B=1;B<a.length;B++){m.push(parseInt(a[B]))}}else{if(c==x.LOOKUP_TABLE){if(d[k].indexOf("LOOKUP_TABLE")==0){continue
}else{var C=d[k].trim().split(" ");if(C==""){continue}for(var B=0;B<C.length;B++){h.push(parseFloat(C[B]))}}}else{if(c==x.COLOR_SCALARS){var z=d[k].trim().split(" ");if(z==""){continue}for(var B=0;B<z.length;B++){s.push(parseFloat(z[B]))}}else{if(c==x.NORMALS){var z=d[k].trim().split(" ");if(z==""){continue}for(var B=0;B<z.length;B++){y.push(parseFloat(z[B]))}}}}}}}}}}}}}}}}}}}catch(l){console.log("Error while processing line "+k.toString());throw l}}this.json.vertices=o;this.json.mode=w;if(m.length>0){this.json.indices=m
}if(y.length>0){this.json.normals=y}if(s.length>0){this.json.colors=s}if(h.length>0){this.json.scalars=h}};VTKReader.prototype.getModel=function(){var a=new Model(this.json.name,this.json);this.json=null;delete this.json;return a};function Texture(c){var a=this;this.image=new Image();this.image.onload=function(){a._onLoad()};this.image.onError=function(){a._onError()};this.uri=c;if(this.uri!=undefined){this.load(this.uri)}this.mag=nucleo.def.texture.filter.LINEAR;this.min=nucleo.def.texture.filter.LINEAR_MIPMAP_LINEAR;
this.loaded=false}Texture.prototype.setMagFilter=function(a){this.mag=a};Texture.prototype.setMinFilter=function(a){this.min=a};Texture.prototype.load=function(a){this.image.src=a};Texture.prototype._onError=function(){console.info("Texture: the texture "+this.uri+" could not be found.");this.loaded=false};Texture.prototype._onLoad=function(){this.loaded=true};Texture.prototype.getMagFilter=function(c){var a=nucleo.def.texture.filter;switch(this.mag){case a.LINEAR:return c.LINEAR;break;case a.NEAREST:return c.NEAREST;
break;default:return c.NEAREST}};Texture.prototype.getMinFilter=function(c){var a=nucleo.def.texture.filter;switch(this.min){case a.LINEAR:return c.LINEAR;break;case a.NEAREST:return c.NEAREST;break;case a.LINEAR_MIPMAP_LINEAR:return c.LINEAR_MIPMAP_LINEAR;break;case a.LINEAR_MIPMAP_NEAREST:return c.LINEAR_MIPMAP_NEAREST;break;case a.NEAREST_MIPMAP_LINEAR:return c.NEAREST_MIPMAP_LINEAR;break;case a.NEAREST_MIPMAP_NEAREST:return c.NEAREST_MIPMAP_NEAREST;break;default:return c.NEAREST}};function Material(a){this.ambient=nucleo.def.material.ambient;
this.diffuse=nucleo.def.material.diffuse;this.specular=nucleo.def.material.specular;this.shininess=nucleo.def.material.shininess;this.opacity=nucleo.def.material.opacity;this.shading=nucleo.def.material.shading;this.texture=undefined;this.colors=undefined;if(a){this.getFrom(a)}}Material.prototype.getFrom=function(a){if(a.ambient!=undefined){this.ambient=a.ambient.slice(0)}if(a.diffuse!=undefined){this.diffuse=a.diffuse.slice(0)}if(a.specular!=undefined){this.specular=a.specular.slice(0)}if(a.color!=undefined){this.diffuse=a.color.slice(0)
}if(a.shininess!=undefined){this.shininess=a.shininess}if(a.opacity!=undefined){this.opacity=a.opacity}if(a.shading!=undefined){this.shading=a.shading}if(a.texture!=undefined){this.texture=new Texture(a.path+a.texture)}if(a.colors!=undefined){this.colors=a.colors}return this};Material.prototype.clone=function(){var d=new Material();var a=this;for(var c in a){if(a.hasOwnProperty(c)){if(a[c] instanceof Array){d[c]=a[c].slice(0)}else{d[c]=a[c]}}}return d};function Renderable(a){if(a==undefined){throw ("Renderable: the actor can not be undefined")
}this.actor=a;this.parts=[];this.update(define.Renderable.TASK.CREATE)}Renderable.prototype.update=function(a){if(a==undefined){throw ("Renderable.update: Please specify a task")}var c=this._getModel();if(c==undefined){return}switch(c.type){case define.Model.TYPE.MESH:this._processMesh(c,a);break;case define.Model.TYPE.BIG_DATA:this._processBigData(c,a);break}};Renderable.prototype._getModel=function(){var a=this.actor;if(a.mesh&&a.mesh.model){return a.mesh.model}else{if(a.model.type==define.Model.TYPE.BIG_DATA){return a.model
}else{return undefined}}};Renderable.prototype._processMesh=function(l,d){var o=Model.MAX_NUM_INDICES;var m=Math.floor(l.indices.length/o),f=l.indices.length%o;if(d==Renderable.TASK.CREATE){this.parts=[];for(var h=0;h<=m;h+=1){var c=new Model(l.name+"-renderable-part-"+h);var n=h*o;var k=n+o;var a=h*o*3;var e=a+o*3;if(h==m){n=m*o;k=n+f;a=m*o*3;e=a+f*3;if(f==0){break}}c.indices=this._reindex(l.indices.slice(n,k));c.vertices=l.vertices.slice(a,e);if(l.normals&&l.normals.length>0){c.normals=l.normals.slice(a,e)
}if(l.colors&&l.colors.length>0){c.colors=l.colors.slice(a,e)}if(l.pickingColors){c.pickingColors=l.pickingColors.slice(a,e)}c.update();this.parts.push(c)}}else{if(d==Renderable.TASK.UPDATE_COLORS){for(var h=0;h<=m;h+=1){var c=this.parts[h];var a=h*o*3;var e=a+o*3;if(h==m){a=m*o*3;e=a+f*3;if(f==0){break}}if(l.colors&&l.colors.length>0){c.colors=l.colors.slice(a,e)}}}}};Renderable.prototype._reindex=function(d){var c=d.min();var a=d.length;while(a--){d[a]=d[a]-c}return d};Renderable.prototype._processBigData=function(f,m){var n=f.indices;
var s=Model.MAX_NUM_INDICES;if(f.mode==nucleo.def.actor.mode.LINES){s=s-1}var o=n.length;var e=n.max();var l=this.actor.material;var k=(l.colors&&l.colors.length>0);var c=(f.normals&&f.normals.length>0);var q=(f.scalars&&f.scalars.length>0);var h=f.mode;data={vertices:[],indices:[],mode:h};if(k){data.colors=[]}if(c){data.normals=[]}if(q){data.scalars=[]}index_map={};part_number=1;new_index=0;progress=0;for(var d=0;d<o;d+=1){index=n[d];if(index_map[index]==undefined){index_map[index]=new_index;vertex=this._getVertexData(index);
data.vertices.push.apply(data.vertices,vertex.coords);if(c){data.normals.push.apply(data.normals,vertex.normal)}if(k){data.colors.push.apply(data.colors,vertex.color)}if(q){data.scalars.push(vertex.scalar)}new_index+=1}data.indices.push(index_map[index]);if((new_index==s+1)||(d==o-1)){var a=new Model(f.name+"-renderable-part-"+part_number,data);a.update();util.console("Creating part "+a.name+" ["+part_number+"]",true);this.parts.push(a);new_index=0;part_number+=1;a={vertices:[],indices:[],mode:h};
index_map={};data={vertices:[],indices:[],mode:h};if(k){data.colors=[]}if(c){data.normals=[]}if(q){data.scalars=[]}}}};Renderable.prototype._getVertexData=function(c){var d=this.actor.material;var a=this.actor.model;var e={};e.coords=a.vertices.slice(c*3,c*3+3);if(a.normals){e.normal=a.normals.slice(c*3,c*3+3)}if(d.colors){e.color=d.colors.slice(c*3,c*3+3)}if(a.scalars){e.scalar=a.scalars[c]}return e};function ActorGroup(d,a,c){this.scene=d;this.name=a;this.list=[];this.addList(c)}ActorGroup.prototype.addList=function(f){var e=[];
for(var c=0,h=f.length;c<h;c+=1){var d=f[c];if(d instanceof Actor&&d.scene==this.scene){this.list.push(d)}else{if(typeof(d)=="string"){var a=this.scene.getActor(d);if(a!=null){this.list.push(a)}else{e.push("Could not find actor: "+d)}}else{e.push("The object "+d+" is not of the expected type (Actor, string)")}}}if(e.length!=0){this.list=[];throw new vxlActorGroupException(e)}};ActorGroup.prototype.add=function(c){var d=[];if(c instanceof Actor&&c.scene==this.scene){this.list.push(c)}else{if(typeof(c)=="string"){var a=this.scene.getActor(c);
if(a!=null){this.list.push(a)}else{d.push("Could not find actor: "+c)}}else{d.push("The object "+c+" is not of the expected type (Actor, string)")}}if(d.length!=0){this.list=[];throw new vxlActorGroupException(d)}};ActorGroup.prototype.hasActor=function(c){if(c instanceof Actor){return(this.list.indexOf(c)!=-1)}else{if(typeof(c)=="string"){var a=this.scene.getActor(c);return(a!=null)}else{return false}}};ActorGroup.prototype.remove=function(c){var a=-1;if(c instanceof Actor){a=this.list.indexOf(c)
}else{if(typeof(c)=="string"){actorObject=this.scene.getActor(c);a=this.list.indexOf(actorObject)}}if(a!=1){this.list.splice(a,1)}else{throw new vxlActorGroupException(["the actor "+c+" was not found in the group "+this.name])}};ActorGroup.prototype.reset=function(a){this.list=[];if(a!=undefined&&a instanceof Array){this.addList(a)}};ActorGroup.prototype.size=function(){return this.list.length};ActorGroup.prototype.setProperty=function(d,c){for(var a=0,e=this.list.length;a<e;a+=1){this.list[a].setProperty(d,c,nucleo.def.actor)
}return this};ActorGroup.prototype._apply=function(a,d){for(var c=0,e=this.list.length;c<e;c+=1){a.apply(this.list[c],d)}return this};ActorGroup.prototype.flipNormals=function(){return this._apply(Actor.prototype.flipNormals)};ActorGroup.prototype.rotateX=function(a){return this._apply(Actor.prototype.rotateX,[a])};ActorGroup.prototype.rotateY=function(a){return this._apply(Actor.prototype.rotateY,[a])};ActorGroup.prototype.rotateZ=function(a){return this._apply(Actor.prototype.rotateZ,[a])};ActorGroup.prototype.translate=function(a,d,c){return this._apply(Actor.prototype.translate,[a,d,c])
};ActorGroup.prototype.setColor=function(a){return this.setProperty("color",a)};ActorGroup.prototype.setLookupTable=function(d,c,a){return this._apply(Actor.prototype.setLookupTable,[d,c,a])};ActorGroup.prototype.setOpacity=function(a){return this.setProperty("opacity",a)};ActorGroup.prototype.setPicker=function(a,c){return this._apply(Actor.prototype.setPicker,[a,c])};ActorGroup.prototype.setPosition=function(a,d,c){return this._apply(Actor.prototype.setPosition,[a,d,c])};ActorGroup.prototype.setScale=function(a,d,c){return this._apply(Actor.prototype.setScale,[a,d,c])
};ActorGroup.prototype.setShininess=function(a){return this.setProperty("shininess",a)};ActorGroup.prototype.setVisible=function(a){return this.setProperty("visible",a)};ActorGroup.prototype.setShading=function(a){return this.setProperty("shading",a)};ActorGroup.prototype.setVisualizationMode=function(a){return this._apply(Actor.prototype.setVisualizationMode,[a])};function vxlActorGroupException(a){this.messages=a}function Silo(a){this._mode=a;this._actors=[];this.data={};this.cached={};this.added={};
this.prepare()}Silo.prototype.populate=function(d){var e=d.length;for(var a=0;a<e;a+=1){var c=d[a];if(this.cached[c.UID]==undefined&&c.mode==this._mode){this._actors.push(c);this.cached[c.UID]=c}}};Silo.prototype.prepare=function(){var a={mixin:[],index:[],matrix:[[],[],[],[]]};this.data=a};Silo.prototype.process=function(){var d=this._actors.length;for(var a=0;a<d;a+=1){var c=this._actors[a];if(this.added[c.UID]==undefined){this.processActor(this._actors[a]);this.added[c.UID]=c}}};Silo.prototype.processActor=function(f){var k=f.model;
var n=f.material;var q=this.data.mixin;var m=this.data.index;var o=this.data.matrix;var a=k.vertices.length;var e=k.indices.length;var l=Array.prototype.slice.call(f._matrix);if(n.colors!=undefined){}else{for(var h=0;h<a;h+=3){q=q.concat([k.vertices[h],k.vertices[h+1],k.vertices[h+2],k.normals[h],k.normals[h+1],k.normals[h+2],n.diffuse[0],n.diffuse[1],n.diffuse[2]]);o[0]=o[0].concat(l.slice(0,4));o[1]=o[1].concat(l.slice(4,8));o[2]=o[2].concat(l.slice(8,12));o[3]=o[3].concat(l.slice(12,16))}}var c=k.indices.slice(0);
if(m.length>0){var d=m.max()+1;for(var h=0;h<e;h+=1){c[h]+=d}m=m.concat(c)}else{m=c}this.data.mixin=q;this.data.index=m;this.data.matrix=o};DashEngine.prototype=new Engine();DashEngine.prototype.constructor=DashEngine;function DashEngine(a){Engine.call(this);this.silos={};this._createSilos();this._gl_buffers={};this._createGLBuffers();this.essl=util.extend(nucleo.def.essl,{ACTOR_MATRIX:"aActorMatrix"})}RenderEngine.prototype.configure=function(){Engine.prototype.configure.call(this);var a=this.gl;
a.clearDepth(1);a.disable(a.CULL_FACE)};DashEngine.prototype._createSilos=function(){for(key in nucleo.def.actor.mode){this.silos[key]={};this.silos[key]=new Silo(key)}};DashEngine.prototype._createGLBuffers=function(){var a=this.renderer.gl;for(key in nucleo.def.actor.mode){this._gl_buffers[key]={};this._gl_buffers[key].mixin=a.createBuffer();this._gl_buffers[key].index=a.createBuffer();this._gl_buffers[key].matrix=a.createBuffer()}};DashEngine.prototype.allocate=function(c){var a=c._actors;for(key in this.silos){this.silos[key].populate(a);
this.silos[key].process()}};DashEngine.prototype.render=function(f){var d=this.renderer;var c=d.transforms;var a=d.pm;var h=d.gl;var e=this.essl;if(f._actors.length==0){return}c.update();a.setUniform(e.PERSPECTIVE_MATRIX,c.pMatrix);a.setUniform(e.MODEL_VIEW_MATRIX,c.mvMatrix);a.setUniform(e.NORMAL_MATRIX,c.nMatrix);a.setUniform(e.MVP_MATRIX,c.mvpMatrix);this._renderSolid()};DashEngine.prototype.deallocate=function(a){};DashEngine.prototype.enableMatrixAttribute=function(c){var a=this.renderer;var n=a.gl;
var d=a.pm._essl;var e=nucleo.def.actor.mode;var k=this.silos[e.SOLID];var l=k.data;var q=n.getAttribLocation(d,c);n.enableVertexAttribArray(q);n.enableVertexAttribArray(q+1);n.enableVertexAttribArray(q+2);n.enableVertexAttribArray(q+3);var s=n.createBuffer();var o=n.createBuffer();var h=n.createBuffer();var f=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,s);n.bufferData(n.ARRAY_BUFFER,new Float32Array(l.matrix[0]),n.STATIC_DRAW);n.vertexAttribPointer(q,4,n.FLOAT,false,0,0);n.bindBuffer(n.ARRAY_BUFFER,o);
n.bufferData(n.ARRAY_BUFFER,new Float32Array(l.matrix[1]),n.STATIC_DRAW);n.vertexAttribPointer(q+1,4,n.FLOAT,false,0,0);n.bindBuffer(n.ARRAY_BUFFER,h);n.bufferData(n.ARRAY_BUFFER,new Float32Array(l.matrix[2]),n.STATIC_DRAW);n.vertexAttribPointer(q+2,4,n.FLOAT,false,0,0);n.bindBuffer(n.ARRAY_BUFFER,f);n.bufferData(n.ARRAY_BUFFER,new Float32Array(l.matrix[3]),n.STATIC_DRAW);n.vertexAttribPointer(q+3,4,n.FLOAT,false,0,0)};DashEngine.prototype._renderSolid=function(){var c=nucleo.def.actor.mode;var f=this.silos[c.SOLID];
var h=f.data;var a=this.renderer;var e=a.transforms;var d=a.pm;var k=a.gl;var o=this.essl;d.setUniform("uUseShading",true);d.enableAttribute(o.VERTEX_ATTRIBUTE);d.enableAttribute(o.NORMAL_ATTRIBUTE);d.enableAttribute(o.COLOR_ATTRIBUTE);this.enableMatrixAttribute(o.ACTOR_MATRIX);var n=this._gl_buffers[c.SOLID].mixin;k.bindBuffer(k.ARRAY_BUFFER,n);k.bufferData(k.ARRAY_BUFFER,new Float32Array(h.mixin),k.STATIC_DRAW);d.setAttributePointer(o.VERTEX_ATTRIBUTE,3,k.FLOAT,false,36,0);d.setAttributePointer(o.NORMAL_ATTRIBUTE,3,k.FLOAT,false,36,12);
d.setAttributePointer(o.COLOR_ATTRIBUTE,3,k.FLOAT,false,36,24);var l=this._gl_buffers[c.SOLID].index;k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,l);k.bufferData(k.ELEMENT_ARRAY_BUFFER,new Uint16Array(h.index),k.STATIC_DRAW);k.drawElements(k.TRIANGLES,h.index.length,k.UNSIGNED_SHORT,0)};var util={piOver2:Math.PI/2,deg2rad:Math.PI/180,rad2deg:180/Math.PI,isMac:function(){return navigator.platform.toUpperCase().indexOf("MAC")!=-1},int2rgb:function(a){return[((a>>16)&255)/256,((a>>8)&255)/256,(a&255)/256]},frac2rgb:function(e,d,a){var f=util.createArr3(e,d,a);
f[0]=Math.round(255*f[0]);f[1]=Math.round(255*f[1]);f[2]=Math.round(255*f[2]);return f},rgb2frac:function(e,d,a){var f=util.createArr3(e,d,a);f[0]=Math.round(f[0]/255);f[1]=Math.round(f[1]/255);f[2]=Math.round(f[2]/255);return f},rgb2hex:function(e,d,a){var f=util.createArr3(e,d,a);return"#"+((1<<24)+(f[0]<<16)+(f[1]<<8)+f[2]).toString(16).slice(1)},hex2rgb:function(d){var c=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;d=d.replace(c,function(f,k,h,e){return k+k+h+h+e+e});var a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(d);
return a?[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]:null},rgb2decimal:function(a){if(a==null||a==undefined){return null}return[a[0]/255,a[1]/255,a[2]/255]},createColor:function(f,e,a){var d=[];if(f==undefined){return null}if(f instanceof Array){var h=f.slice(0);f=h[0];e=h[1];a=h[2]}if(typeof(f)=="string"){d=this.rgb2decimal(this.hex2rgb(f))}else{if(typeof(f)=="number"){if(f<0||e==undefined||a==undefined||e<0||a<0){return null}else{if(f>1||e>1||a>1){d=this.rgb2decimal([f,e,a])}else{d=[f,e,a]
}}}}return d},format:function(c,e){var f=Math.pow(10,e);if(typeof(c)=="object"){var a="[";for(var d=0;d<c.length-1;d+=1){a+=Math.round(c[d]*f)/f+", "}a+=Math.round(c[c.length-1]*f)/f+"]"}else{if(typeof(c)=="number"){a="["+Math.round(c*f)/f+"]"}}return a},createVec3:function(a,e,d){var c=vec3.create();if(a instanceof Array||a instanceof Float32Array){c=vec3.clone(a)}else{c=vec3.fromValues(a,e,d)}return c},createArr3:function(a,e,d){var c=[];if(a instanceof Array||a instanceof Float32Array){c[0]=a[0];
c[1]=a[1];c[2]=a[2]}else{c[0]=a;c[1]=e;c[2]=d}return c},generateUID:function(){function a(){return(((1+Math.random())*65536)|0).toString(16).substring(1)}return(a()+"-"+a()+"-"+a()+"-"+a())},extend:function(){var c={};var a=arguments.length;for(var d=0;d<a;d++){for(p in arguments[d]){if(arguments[d].hasOwnProperty(p)){c[p]=arguments[d][p]}}}return c},getPath:function(a){if(a==undefined||a==null){return""}else{if(a.length-1==a.lastIndexOf("/")){return a}else{if(a.lastIndexOf(".")>a.lastIndexOf("/")){return a.substring(0,a.lastIndexOf("/")+1)
}else{return a+"/"}}}},getAngle:function(a){if(a>360||a<-360){return a%360}else{return a}},deg2rad:function(a){return a*Math.PI/180},doTimer:function(c,f,m,e){var k=(c/100)*(f/10),d=c/k,h=0,a=new Date().getTime();function l(){if(h++==k){e(k,h)}else{m(k,h);var n=(new Date().getTime()-a)-(h*d);window.setTimeout(l,(d-n))}}window.setTimeout(l,d)},console:function(a,c){if(this.debug==true||c){console.info(a)}}};Array.prototype.max=function(){if(this.length>65535){var a=this[0];for(var c=0,d=this.length;
c<d;c+=1){if(this[c]>a){a=this[c]}}return a}else{return Math.max.apply(null,this)}};Array.prototype.min=function(){if(this.length>65535){var c=this[0];for(var a=0,d=this.length;a<d;a+=1){if(this[a]<c){c=this[a]}}return c}else{return Math.min.apply(null,this)}};Array.prototype.hasObject=(!Array.indexOf?function(c){var a=this.length+1;while(a-=1){if(this[a-1]===c){return true}}return false}:function(a){return(this.indexOf(a)!==-1)});window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(c,a){return window.setTimeout(c,1000/60)
}})();window.cancelRequestAnimFrame=(function(){return window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout})();