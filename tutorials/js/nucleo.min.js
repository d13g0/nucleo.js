/*================================================================================
  This is Nucleo.js [1.0]

  Nucleo is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation version 3.

  Nucleo is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with Nucleo.  If not, see http://www.gnu.org/licenses/.

  WELCOME
                                                  ,     ,
                                                 (\____/)             [ ]
                                                  (_oo_)             (   )
                                                    (-)               |>|
                                                  __||__    \)     __/===\__
                                               []/______\[] /     //| o=o |\\
                                               / \______/ \/    <]  | o=o |  [>
                                              /    /__\             \=====/
                                             (\   /____\            / / | \ \

                                                   /--\           <_________>

================================================================================*/var nucleo=nucleo||{};nucleo.define={Camera:{AXIS:{RIGHT:[1,0,0],UP:[0,1,0],NORMAL:[0,0,1]},FRUSTUM:{FOV:30,NEAR:0.1,FAR:10000},TRACKING:{DEFAULT:"DEFAULT",ROTATIONAL:"ROTATIONAL",TRANSLATIONAL:"TRANSLATIONAL",CINEMATIC:"CINEMATIC"},TYPE:{ORBITING:"ORBITING",TRACKING:"TRACKING",EXPLORING:"EXPLORING"}},View:{BACKGROUND:[0.3,0.3,0.3]},ViewInteractor:{TASK:{NONE:0,PAN:1,ROTATE:2,DOLLY:3,ROLL:4}},Actor:{MODE:{TEXTURED:"TEXTURED",SOLID:"SOLID",WIREFRAME:"WIREFRAME",POINTS:"POINTS",LINES:"LINES",BOUNDING_BOX:"BOUNDING_BOX",BB_AND_SOLID:"BBANDSOLID",WIRED_AND_SOLID:"WIRED_AND_SOLID",FLAT:"FLAT"},CULL:{BACK:"BACK",FRONT:"FRONT",NONE:"NONE"},PICKING:{DISABLED:"DISABLED",CELL:"CELL",OBJECT:"OBJECT"}},Model:{LOADING_MODE:{LIVE:"LIVE",LATER:"LATER",DETACHED:"DETACHED"},MAX_NUM_INDICES:65535,TYPE:{SIMPLE:"SIMPLE",MESH:"MESH",BIG_DATA:"BIG DATA"},BoundingBox:{vertices:[],wireframe:[0,1,1,2,2,3,3,0,0,4,4,5,5,6,6,7,7,4,1,5,2,6,3,7],color:[1,1,1,1],shading:false},Floor:{vertices:[],indices:[],color:[0.6,0.6,0.6,1],shading:false},Axis:{vertices:[-1,0,0,1,0,0,0,-2,0,0,2,0,0,0,-1,0,0,1],wireframe:[0,1,2,3,4,5],colors:[1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1],shading:false}},Renderable:{TASK:{CREATE:"CREATE",UPDATE_GEOMETRY:"UPDATE_GEOMETRY",UPDATE_COLORS:"UPDATE_COLORS"}},Renderer:{MODE:{TIMER:"TIMER",ANIMFRAME:"ANIMFRAME",ON_DEMAND:"ON_DEMAND"},RATE:{SLOW:10000,NORMAL:500}},Texture:{FILTER:{NEAREST:"NEAREST",LINEAR:"LINEAR",NEAREST_MIPMAP_NEAREST:"NEAREST_MIPMAP_NEAREST",LINEAR_MIPMAP_NEAREST:"LINEAR_MIPMAP_NEAREST",NEAREST_MIPMAP_LINEAR:"NEAREST_MIPMAP_LINEAR",LINEAR_MIPMAP_LINEAR:"LINEAR_MIPMAP_LINEAR"}},Material:{DIFFUSE:[0.8,0.8,0.8,1],AMBIENT:[0,0,0,1],SPECULAR:[0,0,0,1],SHININESS:0,OPACITY:1,SHADING:true},LookupTable:{list:["default","aal","autumn","blackbody","bone","brodmann","cardiac","copper","cortex","cte","french","fs","ge_color","gold","gooch","hot","hotiron","hsv","jet","nih","nih_fire","nih_ice","pink","rainramp","spectrum","surface","x_hot","x_rain"],main:"default"},PI_OVER_2:Math.PI/2,DEG_2_RAD:Math.PI/180,RAD_2_DEG:180/Math.PI};
nucleo.ESSL={VERTEX_SHADER:"VERTEX_SHADER",FRAGMENT_SHADER:"FRAGMENT_SHADER",MODEL_VIEW_MATRIX:"mModelView",NORMAL_MATRIX:"mNormal",PERSPECTIVE_MATRIX:"mPerspective",MVP_MATRIX:"mModelViewPerspective",VERTEX_ATTRIBUTE:"aVertexPosition",NORMAL_ATTRIBUTE:"aVertexNormal",COLOR_ATTRIBUTE:"aVertexColor",TEXCOORD_ATTRIBUTE:"aVertexTextureCoords"};nucleo.EVENTS={DEFAULT_LUT_LOADED:"nucleo.EVENTS.DEFAULT_LUT_LOADED",SCENE_UPDATED:"nucleo.EVENTS.SCENE_UPDATED",MODELS_LOADING:"nucleo.EVENTS.MODELS_LOADING",MODEL_NEW:"nucleo.EVENTS.MODEL_NEW",MODELS_LOADED:"nucleo.EVENTS.MODELS_LOADED",ACTOR_MOVED:"nucleo.EVENTS.ACTOR_MOVED",ACTOR_SCALED:"nucleo.EVENTS.ACTOR_SCALED",ACTOR_ROTATED:"nucleo.EVENTS.ACTOR_ROTATED",ACTOR_CHANGED_COLOR:"nucleo.EVENTS.ACTOR_CHANGED_COLOR",ACTOR_CHANGED_SHADING:"nucleo.EVENTS.ACTOR_CHANGED_SHADING",VIEW_NEW:"nucleo.EVENTS.VIEW_NEW",SCENE_NEW:"nucleo.EVENTS.SCENE_NEW",READER_DONE:"nucleo.EVENTS.READER_DONE"};
nucleo.DEBUG=true;nucleo.util={piOver2:Math.PI/2,deg2rad:Math.PI/180,rad2deg:180/Math.PI,isMac:function(){return navigator.platform.toUpperCase().indexOf("MAC")!=-1},int2rgb:function(a){return[((a>>16)&255)/256,((a>>8)&255)/256,(a&255)/256]},frac2rgb:function(e,d,a){var f=nucleo.util.createArr3(e,d,a);f[0]=Math.round(255*f[0]);f[1]=Math.round(255*f[1]);f[2]=Math.round(255*f[2]);return f},rgb2frac:function(e,d,a){var f=nucleo.util.createArr3(e,d,a);f[0]=Math.round(f[0]/255);f[1]=Math.round(f[1]/255);
f[2]=Math.round(f[2]/255);return f},rgb2hex:function(e,d,a){var f=nucleo.util.createArr3(e,d,a);return"#"+((1<<24)+(f[0]<<16)+(f[1]<<8)+f[2]).toString(16).slice(1)},hex2rgb:function(d){var c=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;d=d.replace(c,function(f,j,h,e){return j+j+h+h+e+e});var a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(d);return a?[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]:null},rgb2decimal:function(a){if(a==null||a==undefined){return null}return[a[0]/255,a[1]/255,a[2]/255]
},createColor:function(f,e,a){var d=[];if(f==undefined){return null}if(f instanceof Array){var h=f.slice(0);f=h[0];e=h[1];a=h[2]}if(typeof(f)=="string"){d=this.rgb2decimal(this.hex2rgb(f))}else{if(typeof(f)=="number"){if(f<0||e==undefined||a==undefined||e<0||a<0){return null}else{if(f>1||e>1||a>1){d=this.rgb2decimal([f,e,a])}else{d=[f,e,a]}}}}return d},format:function(c,e){var f=Math.pow(10,e);if(typeof(c)=="object"){var a="[";for(var d=0;d<c.length-1;d+=1){a+=Math.round(c[d]*f)/f+", "}a+=Math.round(c[c.length-1]*f)/f+"]"
}else{if(typeof(c)=="number"){a="["+Math.round(c*f)/f+"]"}}return a},createVec3:function(a,e,d){var c=vec3.create();if(a instanceof Array||a instanceof Float32Array){c=vec3.clone(a)}else{c=vec3.fromValues(a,e,d)}return c},createArr3:function(a,e,d){var c=[];if(a instanceof Array||a instanceof Float32Array){c[0]=a[0];c[1]=a[1];c[2]=a[2]}else{c[0]=a;c[1]=e;c[2]=d}return c},generateUID:function(){function a(){return(((1+Math.random())*65536)|0).toString(16).substring(1)}return(a()+"-"+a()+"-"+a()+"-"+a())
},extend:function(){var c={};var a=arguments.length;for(var d=0;d<a;d++){for(p in arguments[d]){if(arguments[d].hasOwnProperty(p)){c[p]=arguments[d][p]}}}return c},getPath:function(a){if(a==undefined||a==null){return""}else{if(a.length-1==a.lastIndexOf("/")){return a}else{if(a.lastIndexOf(".")>a.lastIndexOf("/")){return a.substring(0,a.lastIndexOf("/")+1)}else{return a+"/"}}}},getAngle:function(a){if(a>360||a<-360){return a%360}else{return a}},deg2rad:function(a){return a*Math.PI/180},doTimer:function(c,f,l,e){var j=(c/100)*(f/10),d=c/j,h=0,a=new Date().getTime();
function k(){if(h++==j){e(j,h)}else{l(j,h);var m=(new Date().getTime()-a)-(h*d);window.setTimeout(k,(d-m))}}window.setTimeout(k,d)},console:function(a,c){if(nucleo.DEBUG==true||c){console.info(a)}}};Array.prototype.max=function(){if(this.length>65535){var a=this[0];for(var c=0,d=this.length;c<d;c+=1){if(this[c]>a){a=this[c]}}return a}else{return Math.max.apply(null,this)}};Array.prototype.min=function(){if(this.length>65535){var c=this[0];for(var a=0,d=this.length;a<d;a+=1){if(this[a]<c){c=this[a]
}}return c}else{return Math.min.apply(null,this)}};Array.prototype.hasObject=(!Array.indexOf?function(c){var a=this.length+1;while(a-=1){if(this[a-1]===c){return true}}return false}:function(a){return(this.indexOf(a)!==-1)});window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(c,a){return window.setTimeout(c,1000/60)}})();window.cancelRequestAnimFrame=(function(){return window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout
})();if(typeof(jQuery)=="undefined"){nucleo.jquery=false;console.warn("JQuery is not available")}else{nucleo.jquery=true;console.info("JQuery is available")}nucleo.ajax=function(c){var a=new XMLHttpRequest()};nucleo.Notifier=function(){this.targetList={};this.sourceList={}};nucleo.Notifier.prototype.subscribe=function(d,c){if(typeof(d)=="string"){this._addTarget(d,c)}else{if(d instanceof Array){for(var a=0;a<d.length;a+=1){this._addTarget(d[a],c)}}else{throw"Notifier.receives: this method receives a string or a list of strings"
}}};nucleo.Notifier.prototype.publish=function(d,c){if(typeof(d)=="string"){this._addSource(d,c)}else{if(d instanceof Array){for(var a=0;a<d.length;a+=1){this._addSource(d[a],c)}}else{throw"Notifier.sends: this method receives a string or a list of strings"}}};nucleo.Notifier.prototype._addTarget=function(a,c){nucleo.util.console("Notifier: adding target for event "+a);var d=this.targetList;if(d[a]==undefined){d[a]=[]}d[a].push(c)};nucleo.Notifier.prototype._addSource=function(c,e){nucleo.util.console("Notifier: adding source for event "+c);
var d=this.targetList;var a=this.sourceList;if(a[c]==undefined){a[c]=[]}if(d[c]==undefined){d[c]=[]}a[c].push(e)};nucleo.Notifier.prototype.fire=function(d,e){if(this.targetList[d].length==0){return}var a=this;function c(){var k=a.targetList;var f=a.sourceList[d].indexOf(e);if(f==-1){throw"The source "+e+" is not registered to trigger the event "+d+". Did you use Notifier.publish?"}nucleo.util.console("Notifier: firing "+d);var h=a.targetList[d];for(var j=0;j<h.length;j++){if(typeof(h[j])=="object"){h[j].handleEvent(d,e)
}else{if(typeof(h[j]=="function")){h[j](d,e)}}}}setTimeout(function(){c()},0)};nucleo.Notifier.prototype.getEvents=function(){var c=[];for(var a in this.sourceList){c.push(a)}return c};nucleo.Notifier.prototype.getTargetsFor=function(d){var a=this.targetList[d];var e=[];for(var c=0;c<a.length;c++){e.push(a[c])}return e};nucleo.Notifier.instance=new nucleo.Notifier();(function(c){var a={};if(typeof(exports)==="undefined"){if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){a.exports={};
define(function(){return a.exports})}else{a.exports=typeof(window)!=="undefined"?window:c}}else{a.exports=exports}(function(n){if(!u){var u=0.000001}if(!f){var f=(typeof Float32Array!=="undefined")?Float32Array:Array}if(!l){var l=Math.random}var h={};h.setMatrixArrayType=function(v){f=v};if(typeof(n)!=="undefined"){n.glMatrix=h}var m=Math.PI/180;h.toRadian=function(v){return v*m};var s={};s.create=function(){var v=new f(2);v[0]=0;v[1]=0;return v};s.clone=function(v){var w=new f(2);w[0]=v[0];w[1]=v[1];
return w};s.fromValues=function(v,z){var w=new f(2);w[0]=v;w[1]=z;return w};s.copy=function(w,v){w[0]=v[0];w[1]=v[1];return w};s.set=function(w,v,z){w[0]=v;w[1]=z;return w};s.add=function(x,w,v){x[0]=w[0]+v[0];x[1]=w[1]+v[1];return x};s.subtract=function(x,w,v){x[0]=w[0]-v[0];x[1]=w[1]-v[1];return x};s.sub=s.subtract;s.multiply=function(x,w,v){x[0]=w[0]*v[0];x[1]=w[1]*v[1];return x};s.mul=s.multiply;s.divide=function(x,w,v){x[0]=w[0]/v[0];x[1]=w[1]/v[1];return x};s.div=s.divide;s.min=function(x,w,v){x[0]=Math.min(w[0],v[0]);
x[1]=Math.min(w[1],v[1]);return x};s.max=function(x,w,v){x[0]=Math.max(w[0],v[0]);x[1]=Math.max(w[1],v[1]);return x};s.scale=function(x,w,v){x[0]=w[0]*v;x[1]=w[1]*v;return x};s.scaleAndAdd=function(x,w,v,y){x[0]=w[0]+(v[0]*y);x[1]=w[1]+(v[1]*y);return x};s.distance=function(z,w){var v=w[0]-z[0],A=w[1]-z[1];return Math.sqrt(v*v+A*A)};s.dist=s.distance;s.squaredDistance=function(z,w){var v=w[0]-z[0],A=w[1]-z[1];return v*v+A*A};s.sqrDist=s.squaredDistance;s.length=function(w){var v=w[0],z=w[1];return Math.sqrt(v*v+z*z)
};s.len=s.length;s.squaredLength=function(w){var v=w[0],z=w[1];return v*v+z*z};s.sqrLen=s.squaredLength;s.negate=function(w,v){w[0]=-v[0];w[1]=-v[1];return w};s.normalize=function(A,z){var w=z[0],B=z[1];var v=w*w+B*B;if(v>0){v=1/Math.sqrt(v);A[0]=z[0]*v;A[1]=z[1]*v}return A};s.dot=function(w,v){return w[0]*v[0]+w[1]*v[1]};s.cross=function(x,w,v){var y=w[0]*v[1]-w[1]*v[0];x[0]=x[1]=0;x[2]=y;return x};s.lerp=function(x,w,v,y){var A=w[0],z=w[1];x[0]=A+y*(v[0]-A);x[1]=z+y*(v[1]-z);return x};s.random=function(v,x){x=x||1;
var w=l()*2*Math.PI;v[0]=Math.cos(w)*x;v[1]=Math.sin(w)*x;return v};s.transformMat2=function(A,z,w){var v=z[0],B=z[1];A[0]=w[0]*v+w[2]*B;A[1]=w[1]*v+w[3]*B;return A};s.transformMat2d=function(A,z,w){var v=z[0],B=z[1];A[0]=w[0]*v+w[2]*B+w[4];A[1]=w[1]*v+w[3]*B+w[5];return A};s.transformMat3=function(A,z,w){var v=z[0],B=z[1];A[0]=w[0]*v+w[3]*B+w[6];A[1]=w[1]*v+w[4]*B+w[7];return A};s.transformMat4=function(A,z,w){var v=z[0],B=z[1];A[0]=w[0]*v+w[4]*B+w[12];A[1]=w[1]*v+w[5]*B+w[13];return A};s.forEach=(function(){var v=s.create();
return function(y,C,D,B,A,w){var z,x;if(!C){C=2}if(!D){D=0}if(B){x=Math.min((B*C)+D,y.length)}else{x=y.length}for(z=D;z<x;z+=C){v[0]=y[z];v[1]=y[z+1];A(v,v,w);y[z]=v[0];y[z+1]=v[1]}return y}})();s.str=function(v){return"vec2("+v[0]+", "+v[1]+")"};if(typeof(n)!=="undefined"){n.vec2=s}var q={};q.create=function(){var v=new f(3);v[0]=0;v[1]=0;v[2]=0;return v};q.clone=function(v){var w=new f(3);w[0]=v[0];w[1]=v[1];w[2]=v[2];return w};q.fromValues=function(v,B,A){var w=new f(3);w[0]=v;w[1]=B;w[2]=A;return w
};q.copy=function(w,v){w[0]=v[0];w[1]=v[1];w[2]=v[2];return w};q.set=function(w,v,B,A){w[0]=v;w[1]=B;w[2]=A;return w};q.add=function(x,w,v){x[0]=w[0]+v[0];x[1]=w[1]+v[1];x[2]=w[2]+v[2];return x};q.subtract=function(x,w,v){x[0]=w[0]-v[0];x[1]=w[1]-v[1];x[2]=w[2]-v[2];return x};q.sub=q.subtract;q.multiply=function(x,w,v){x[0]=w[0]*v[0];x[1]=w[1]*v[1];x[2]=w[2]*v[2];return x};q.mul=q.multiply;q.divide=function(x,w,v){x[0]=w[0]/v[0];x[1]=w[1]/v[1];x[2]=w[2]/v[2];return x};q.div=q.divide;q.min=function(x,w,v){x[0]=Math.min(w[0],v[0]);
x[1]=Math.min(w[1],v[1]);x[2]=Math.min(w[2],v[2]);return x};q.max=function(x,w,v){x[0]=Math.max(w[0],v[0]);x[1]=Math.max(w[1],v[1]);x[2]=Math.max(w[2],v[2]);return x};q.scale=function(x,w,v){x[0]=w[0]*v;x[1]=w[1]*v;x[2]=w[2]*v;return x};q.scaleAndAdd=function(x,w,v,y){x[0]=w[0]+(v[0]*y);x[1]=w[1]+(v[1]*y);x[2]=w[2]+(v[2]*y);return x};q.distance=function(A,w){var v=w[0]-A[0],C=w[1]-A[1],B=w[2]-A[2];return Math.sqrt(v*v+C*C+B*B)};q.dist=q.distance;q.squaredDistance=function(A,w){var v=w[0]-A[0],C=w[1]-A[1],B=w[2]-A[2];
return v*v+C*C+B*B};q.sqrDist=q.squaredDistance;q.length=function(w){var v=w[0],B=w[1],A=w[2];return Math.sqrt(v*v+B*B+A*A)};q.len=q.length;q.squaredLength=function(w){var v=w[0],B=w[1],A=w[2];return v*v+B*B+A*A};q.sqrLen=q.squaredLength;q.negate=function(w,v){w[0]=-v[0];w[1]=-v[1];w[2]=-v[2];return w};q.normalize=function(B,A){var w=A[0],D=A[1],C=A[2];var v=w*w+D*D+C*C;if(v>0){v=1/Math.sqrt(v);B[0]=A[0]*v;B[1]=A[1]*v;B[2]=A[2]*v}return B};q.dot=function(w,v){return w[0]*v[0]+w[1]*v[1]+w[2]*v[2]};
q.cross=function(w,B,A){var v=B[0],D=B[1],C=B[2],z=A[0],y=A[1],x=A[2];w[0]=D*x-C*y;w[1]=C*z-v*x;w[2]=v*y-D*z;return w};q.lerp=function(x,w,v,y){var B=w[0],A=w[1],z=w[2];x[0]=B+y*(v[0]-B);x[1]=A+y*(v[1]-A);x[2]=z+y*(v[2]-z);return x};q.random=function(v,A){A=A||1;var x=l()*2*Math.PI;var y=(l()*2)-1;var w=Math.sqrt(1-y*y)*A;v[0]=Math.cos(x)*w;v[1]=Math.sin(x)*w;v[2]=y*A;return v};q.transformMat4=function(B,A,w){var v=A[0],D=A[1],C=A[2];B[0]=w[0]*v+w[4]*D+w[8]*C+w[12];B[1]=w[1]*v+w[5]*D+w[9]*C+w[13];
B[2]=w[2]*v+w[6]*D+w[10]*C+w[14];return B};q.transformMat3=function(B,A,w){var v=A[0],D=A[1],C=A[2];B[0]=v*w[0]+D*w[3]+C*w[6];B[1]=v*w[1]+D*w[4]+C*w[7];B[2]=v*w[2]+D*w[5]+C*w[8];return B};q.transformQuat=function(E,K,v){var L=K[0],J=K[1],I=K[2],G=v[0],F=v[1],D=v[2],H=v[3],B=H*L+F*I-D*J,A=H*J+D*L-G*I,w=H*I+G*J-F*L,C=-G*L-F*J-D*I;E[0]=B*H+C*-G+A*-D-w*-F;E[1]=A*H+C*-F+w*-G-B*-D;E[2]=w*H+C*-D+B*-F-A*-G;return E};q.rotateX=function(x,w,v,A){var z=[],y=[];z[0]=w[0]-v[0];z[1]=w[1]-v[1];z[2]=w[2]-v[2];y[0]=z[0];
y[1]=z[1]*Math.cos(A)-z[2]*Math.sin(A);y[2]=z[1]*Math.sin(A)+z[2]*Math.cos(A);x[0]=y[0]+v[0];x[1]=y[1]+v[1];x[2]=y[2]+v[2];return x};q.rotateY=function(x,w,v,A){var z=[],y=[];z[0]=w[0]-v[0];z[1]=w[1]-v[1];z[2]=w[2]-v[2];y[0]=z[2]*Math.sin(A)+z[0]*Math.cos(A);y[1]=z[1];y[2]=z[2]*Math.cos(A)-z[0]*Math.sin(A);x[0]=y[0]+v[0];x[1]=y[1]+v[1];x[2]=y[2]+v[2];return x};q.rotateZ=function(x,w,v,A){var z=[],y=[];z[0]=w[0]-v[0];z[1]=w[1]-v[1];z[2]=w[2]-v[2];y[0]=z[0]*Math.cos(A)-z[1]*Math.sin(A);y[1]=z[0]*Math.sin(A)+z[1]*Math.cos(A);
y[2]=z[2];x[0]=y[0]+v[0];x[1]=y[1]+v[1];x[2]=y[2]+v[2];return x};q.forEach=(function(){var v=q.create();return function(y,C,D,B,A,w){var z,x;if(!C){C=3}if(!D){D=0}if(B){x=Math.min((B*C)+D,y.length)}else{x=y.length}for(z=D;z<x;z+=C){v[0]=y[z];v[1]=y[z+1];v[2]=y[z+2];A(v,v,w);y[z]=v[0];y[z+1]=v[1];y[z+2]=v[2]}return y}})();q.str=function(v){return"vec3("+v[0]+", "+v[1]+", "+v[2]+")"};if(typeof(n)!=="undefined"){n.vec3=q}var o={};o.create=function(){var v=new f(4);v[0]=0;v[1]=0;v[2]=0;v[3]=0;return v
};o.clone=function(v){var w=new f(4);w[0]=v[0];w[1]=v[1];w[2]=v[2];w[3]=v[3];return w};o.fromValues=function(v,D,C,A){var B=new f(4);B[0]=v;B[1]=D;B[2]=C;B[3]=A;return B};o.copy=function(w,v){w[0]=v[0];w[1]=v[1];w[2]=v[2];w[3]=v[3];return w};o.set=function(B,v,D,C,A){B[0]=v;B[1]=D;B[2]=C;B[3]=A;return B};o.add=function(x,w,v){x[0]=w[0]+v[0];x[1]=w[1]+v[1];x[2]=w[2]+v[2];x[3]=w[3]+v[3];return x};o.subtract=function(x,w,v){x[0]=w[0]-v[0];x[1]=w[1]-v[1];x[2]=w[2]-v[2];x[3]=w[3]-v[3];return x};o.sub=o.subtract;
o.multiply=function(x,w,v){x[0]=w[0]*v[0];x[1]=w[1]*v[1];x[2]=w[2]*v[2];x[3]=w[3]*v[3];return x};o.mul=o.multiply;o.divide=function(x,w,v){x[0]=w[0]/v[0];x[1]=w[1]/v[1];x[2]=w[2]/v[2];x[3]=w[3]/v[3];return x};o.div=o.divide;o.min=function(x,w,v){x[0]=Math.min(w[0],v[0]);x[1]=Math.min(w[1],v[1]);x[2]=Math.min(w[2],v[2]);x[3]=Math.min(w[3],v[3]);return x};o.max=function(x,w,v){x[0]=Math.max(w[0],v[0]);x[1]=Math.max(w[1],v[1]);x[2]=Math.max(w[2],v[2]);x[3]=Math.max(w[3],v[3]);return x};o.scale=function(x,w,v){x[0]=w[0]*v;
x[1]=w[1]*v;x[2]=w[2]*v;x[3]=w[3]*v;return x};o.scaleAndAdd=function(x,w,v,y){x[0]=w[0]+(v[0]*y);x[1]=w[1]+(v[1]*y);x[2]=w[2]+(v[2]*y);x[3]=w[3]+(v[3]*y);return x};o.distance=function(C,A){var v=A[0]-C[0],E=A[1]-C[1],D=A[2]-C[2],B=A[3]-C[3];return Math.sqrt(v*v+E*E+D*D+B*B)};o.dist=o.distance;o.squaredDistance=function(C,A){var v=A[0]-C[0],E=A[1]-C[1],D=A[2]-C[2],B=A[3]-C[3];return v*v+E*E+D*D+B*B};o.sqrDist=o.squaredDistance;o.length=function(B){var v=B[0],D=B[1],C=B[2],A=B[3];return Math.sqrt(v*v+D*D+C*C+A*A)
};o.len=o.length;o.squaredLength=function(B){var v=B[0],D=B[1],C=B[2],A=B[3];return v*v+D*D+C*C+A*A};o.sqrLen=o.squaredLength;o.negate=function(w,v){w[0]=-v[0];w[1]=-v[1];w[2]=-v[2];w[3]=-v[3];return w};o.normalize=function(D,C){var A=C[0],F=C[1],E=C[2],B=C[3];var v=A*A+F*F+E*E+B*B;if(v>0){v=1/Math.sqrt(v);D[0]=C[0]*v;D[1]=C[1]*v;D[2]=C[2]*v;D[3]=C[3]*v}return D};o.dot=function(w,v){return w[0]*v[0]+w[1]*v[1]+w[2]*v[2]+w[3]*v[3]};o.lerp=function(x,w,v,y){var B=w[0],A=w[1],z=w[2],C=w[3];x[0]=B+y*(v[0]-B);
x[1]=A+y*(v[1]-A);x[2]=z+y*(v[2]-z);x[3]=C+y*(v[3]-C);return x};o.random=function(v,w){w=w||1;v[0]=l();v[1]=l();v[2]=l();v[3]=l();o.normalize(v,v);o.scale(v,v,w);return v};o.transformMat4=function(D,C,A){var v=C[0],F=C[1],E=C[2],B=C[3];D[0]=A[0]*v+A[4]*F+A[8]*E+A[12]*B;D[1]=A[1]*v+A[5]*F+A[9]*E+A[13]*B;D[2]=A[2]*v+A[6]*F+A[10]*E+A[14]*B;D[3]=A[3]*v+A[7]*F+A[11]*E+A[15]*B;return D};o.transformQuat=function(E,K,v){var L=K[0],J=K[1],I=K[2],G=v[0],F=v[1],D=v[2],H=v[3],B=H*L+F*I-D*J,A=H*J+D*L-G*I,w=H*I+G*J-F*L,C=-G*L-F*J-D*I;
E[0]=B*H+C*-G+A*-D-w*-F;E[1]=A*H+C*-F+w*-G-B*-D;E[2]=w*H+C*-D+B*-F-A*-G;return E};o.forEach=(function(){var v=o.create();return function(y,C,D,B,A,w){var z,x;if(!C){C=4}if(!D){D=0}if(B){x=Math.min((B*C)+D,y.length)}else{x=y.length}for(z=D;z<x;z+=C){v[0]=y[z];v[1]=y[z+1];v[2]=y[z+2];v[3]=y[z+3];A(v,v,w);y[z]=v[0];y[z+1]=v[1];y[z+2]=v[2];y[z+3]=v[3]}return y}})();o.str=function(v){return"vec4("+v[0]+", "+v[1]+", "+v[2]+", "+v[3]+")"};if(typeof(n)!=="undefined"){n.vec4=o}var j={};j.create=function(){var v=new f(4);
v[0]=1;v[1]=0;v[2]=0;v[3]=1;return v};j.clone=function(v){var w=new f(4);w[0]=v[0];w[1]=v[1];w[2]=v[2];w[3]=v[3];return w};j.copy=function(w,v){w[0]=v[0];w[1]=v[1];w[2]=v[2];w[3]=v[3];return w};j.identity=function(v){v[0]=1;v[1]=0;v[2]=0;v[3]=1;return v};j.transpose=function(x,w){if(x===w){var v=w[1];x[1]=w[2];x[2]=v}else{x[0]=w[0];x[1]=w[2];x[2]=w[1];x[3]=w[3]}return x};j.invert=function(z,x){var y=x[0],w=x[1],v=x[2],B=x[3],A=y*B-v*w;if(!A){return null}A=1/A;z[0]=B*A;z[1]=-w*A;z[2]=-v*A;z[3]=y*A;
return z};j.adjoint=function(x,v){var w=v[0];x[0]=v[3];x[1]=-v[1];x[2]=-v[2];x[3]=w;return x};j.determinant=function(v){return v[0]*v[3]-v[2]*v[1]};j.multiply=function(z,E,C){var y=E[0],x=E[1],w=E[2],v=E[3];var F=C[0],D=C[1],B=C[2],A=C[3];z[0]=y*F+w*D;z[1]=x*F+v*D;z[2]=y*B+w*A;z[3]=x*B+v*A;return z};j.mul=j.multiply;j.rotate=function(z,C,B){var y=C[0],x=C[1],w=C[2],v=C[3],D=Math.sin(B),A=Math.cos(B);z[0]=y*A+w*D;z[1]=x*A+v*D;z[2]=y*-D+w*A;z[3]=x*-D+v*A;return z};j.scale=function(A,B,D){var z=B[0],y=B[1],x=B[2],w=B[3],E=D[0],C=D[1];
A[0]=z*E;A[1]=y*E;A[2]=x*C;A[3]=w*C;return A};j.str=function(v){return"mat2("+v[0]+", "+v[1]+", "+v[2]+", "+v[3]+")"};j.frob=function(v){return(Math.sqrt(Math.pow(v[0],2)+Math.pow(v[1],2)+Math.pow(v[2],2)+Math.pow(v[3],2)))};j.LDU=function(v,y,x,w){v[2]=w[2]/w[0];x[0]=w[0];x[1]=w[1];x[3]=w[3]-v[2]*x[1];return[v,y,x]};if(typeof(n)!=="undefined"){n.mat2=j}var t={};t.create=function(){var v=new f(6);v[0]=1;v[1]=0;v[2]=0;v[3]=1;v[4]=0;v[5]=0;return v};t.clone=function(v){var w=new f(6);w[0]=v[0];w[1]=v[1];
w[2]=v[2];w[3]=v[3];w[4]=v[4];w[5]=v[5];return w};t.copy=function(w,v){w[0]=v[0];w[1]=v[1];w[2]=v[2];w[3]=v[3];w[4]=v[4];w[5]=v[5];return w};t.identity=function(v){v[0]=1;v[1]=0;v[2]=0;v[3]=1;v[4]=0;v[5]=0;return v};t.invert=function(w,A){var v=A[0],D=A[1],C=A[2],B=A[3],y=A[4],x=A[5];var z=v*B-D*C;if(!z){return null}z=1/z;w[0]=B*z;w[1]=-D*z;w[2]=-C*z;w[3]=v*z;w[4]=(C*x-B*y)*z;w[5]=(D*y-v*x)*z;return w};t.determinant=function(v){return v[0]*v[3]-v[1]*v[2]};t.multiply=function(z,G,E){var y=G[0],x=G[1],w=G[2],v=G[3],J=G[4],I=G[5],H=E[0],F=E[1],D=E[2],C=E[3],B=E[4],A=E[5];
z[0]=y*H+w*F;z[1]=x*H+v*F;z[2]=y*D+w*C;z[3]=x*D+v*C;z[4]=y*B+w*A+J;z[5]=x*B+v*A+I;return z};t.mul=t.multiply;t.rotate=function(z,C,B){var y=C[0],x=C[1],w=C[2],v=C[3],F=C[4],D=C[5],E=Math.sin(B),A=Math.cos(B);z[0]=y*A+w*E;z[1]=x*A+v*E;z[2]=y*-E+w*A;z[3]=x*-E+v*A;z[4]=F;z[5]=D;return z};t.scale=function(A,B,E){var z=B[0],y=B[1],x=B[2],w=B[3],G=B[4],F=B[5],D=E[0],C=E[1];A[0]=z*D;A[1]=y*D;A[2]=x*C;A[3]=w*C;A[4]=G;A[5]=F;return A};t.translate=function(A,B,E){var z=B[0],y=B[1],x=B[2],w=B[3],G=B[4],F=B[5],D=E[0],C=E[1];
A[0]=z;A[1]=y;A[2]=x;A[3]=w;A[4]=z*D+x*C+G;A[5]=y*D+w*C+F;return A};t.str=function(v){return"mat2d("+v[0]+", "+v[1]+", "+v[2]+", "+v[3]+", "+v[4]+", "+v[5]+")"};t.frob=function(v){return(Math.sqrt(Math.pow(v[0],2)+Math.pow(v[1],2)+Math.pow(v[2],2)+Math.pow(v[3],2)+Math.pow(v[4],2)+Math.pow(v[5],2)+1))};if(typeof(n)!=="undefined"){n.mat2d=t}var e={};e.create=function(){var v=new f(9);v[0]=1;v[1]=0;v[2]=0;v[3]=0;v[4]=1;v[5]=0;v[6]=0;v[7]=0;v[8]=1;return v};e.fromMat4=function(w,v){w[0]=v[0];w[1]=v[1];
w[2]=v[2];w[3]=v[4];w[4]=v[5];w[5]=v[6];w[6]=v[8];w[7]=v[9];w[8]=v[10];return w};e.clone=function(v){var w=new f(9);w[0]=v[0];w[1]=v[1];w[2]=v[2];w[3]=v[3];w[4]=v[4];w[5]=v[5];w[6]=v[6];w[7]=v[7];w[8]=v[8];return w};e.copy=function(w,v){w[0]=v[0];w[1]=v[1];w[2]=v[2];w[3]=v[3];w[4]=v[4];w[5]=v[5];w[6]=v[6];w[7]=v[7];w[8]=v[8];return w};e.identity=function(v){v[0]=1;v[1]=0;v[2]=0;v[3]=0;v[4]=1;v[5]=0;v[6]=0;v[7]=0;v[8]=1;return v};e.transpose=function(x,w){if(x===w){var z=w[1],y=w[2],v=w[5];x[1]=w[3];
x[2]=w[6];x[3]=z;x[5]=w[7];x[6]=y;x[7]=v}else{x[0]=w[0];x[1]=w[3];x[2]=w[6];x[3]=w[1];x[4]=w[4];x[5]=w[7];x[6]=w[2];x[7]=w[5];x[8]=w[8]}return x};e.invert=function(z,G){var y=G[0],x=G[1],w=G[2],J=G[3],I=G[4],H=G[5],E=G[6],D=G[7],B=G[8],A=B*I-H*D,v=-B*J+H*E,F=D*J-I*E,C=y*A+x*v+w*F;if(!C){return null}C=1/C;z[0]=A*C;z[1]=(-B*x+w*D)*C;z[2]=(H*x-w*I)*C;z[3]=v*C;z[4]=(B*y-w*E)*C;z[5]=(-H*y+w*J)*C;z[6]=F*C;z[7]=(-D*y+x*E)*C;z[8]=(I*y-x*J)*C;return z};e.adjoint=function(y,C){var x=C[0],w=C[1],v=C[2],F=C[3],E=C[4],D=C[5],B=C[6],A=C[7],z=C[8];
y[0]=(E*z-D*A);y[1]=(v*A-w*z);y[2]=(w*D-v*E);y[3]=(D*B-F*z);y[4]=(x*z-v*B);y[5]=(v*F-x*D);y[6]=(F*A-E*B);y[7]=(w*B-x*A);y[8]=(x*E-w*F);return y};e.determinant=function(B){var x=B[0],w=B[1],v=B[2],E=B[3],D=B[4],C=B[5],A=B[6],z=B[7],y=B[8];return x*(y*D-C*z)+w*(-y*E+C*A)+v*(z*E-D*A)};e.multiply=function(H,M,L){var Q=M[0],P=M[1],O=M[2],A=M[3],z=M[4],y=M[5],G=M[6],F=M[7],E=M[8],D=L[0],C=L[1],B=L[2],K=L[3],J=L[4],I=L[5],x=L[6],w=L[7],v=L[8];H[0]=D*Q+C*A+B*G;H[1]=D*P+C*z+B*F;H[2]=D*O+C*y+B*E;H[3]=K*Q+J*A+I*G;
H[4]=K*P+J*z+I*F;H[5]=K*O+J*y+I*E;H[6]=x*Q+w*A+v*G;H[7]=x*P+w*z+v*F;H[8]=x*O+w*y+v*E;return H};e.mul=e.multiply;e.translate=function(B,H,J){var A=H[0],z=H[1],w=H[2],L=H[3],K=H[4],I=H[5],E=H[6],D=H[7],C=H[8],G=J[0],F=J[1];B[0]=A;B[1]=z;B[2]=w;B[3]=L;B[4]=K;B[5]=I;B[6]=G*A+F*L+E;B[7]=G*z+F*K+D;B[8]=G*w+F*I+C;return B};e.rotate=function(y,E,D){var x=E[0],w=E[1],v=E[2],H=E[3],G=E[4],F=E[5],B=E[6],A=E[7],z=E[8],I=Math.sin(D),C=Math.cos(D);y[0]=C*x+I*H;y[1]=C*w+I*G;y[2]=C*v+I*F;y[3]=C*H-I*x;y[4]=C*G-I*w;
y[5]=C*F-I*v;y[6]=B;y[7]=A;y[8]=z;return y};e.scale=function(B,z,A){var w=A[0],C=A[1];B[0]=w*z[0];B[1]=w*z[1];B[2]=w*z[2];B[3]=C*z[3];B[4]=C*z[4];B[5]=C*z[5];B[6]=z[6];B[7]=z[7];B[8]=z[8];return B};e.fromMat2d=function(w,v){w[0]=v[0];w[1]=v[1];w[2]=0;w[3]=v[2];w[4]=v[3];w[5]=0;w[6]=v[4];w[7]=v[5];w[8]=1;return w};e.fromQuat=function(J,G){var D=G[0],C=G[1],B=G[2],E=G[3],K=D+D,v=C+C,F=B+B,A=D*K,I=C*K,H=C*v,R=B*K,Q=B*v,O=B*F,P=E*K,M=E*v,L=E*F;J[0]=1-H-O;J[3]=I-L;J[6]=R+M;J[1]=I+L;J[4]=1-A-O;J[7]=Q-P;
J[2]=R-M;J[5]=Q+P;J[8]=1-A-H;return J};e.normalFromMat4=function(P,U){var Y=U[0],W=U[1],V=U[2],S=U[3],z=U[4],y=U[5],x=U[6],w=U[7],O=U[8],M=U[9],L=U[10],K=U[11],aa=U[12],Z=U[13],X=U[14],T=U[15],J=Y*y-W*z,I=Y*x-V*z,H=Y*w-S*z,G=W*x-V*y,F=W*w-S*y,E=V*w-S*x,D=O*Z-M*aa,C=O*X-L*aa,B=O*T-K*aa,A=M*X-L*Z,R=M*T-K*Z,Q=L*T-K*X,v=J*Q-I*R+H*A+G*B-F*C+E*D;if(!v){return null}v=1/v;P[0]=(y*Q-x*R+w*A)*v;P[1]=(x*B-z*Q-w*C)*v;P[2]=(z*R-y*B+w*D)*v;P[3]=(V*R-W*Q-S*A)*v;P[4]=(Y*Q-V*B+S*C)*v;P[5]=(W*B-Y*R-S*D)*v;P[6]=(Z*E-X*F+T*G)*v;
P[7]=(X*H-aa*E-T*I)*v;P[8]=(aa*F-Z*H+T*J)*v;return P};e.str=function(v){return"mat3("+v[0]+", "+v[1]+", "+v[2]+", "+v[3]+", "+v[4]+", "+v[5]+", "+v[6]+", "+v[7]+", "+v[8]+")"};e.frob=function(v){return(Math.sqrt(Math.pow(v[0],2)+Math.pow(v[1],2)+Math.pow(v[2],2)+Math.pow(v[3],2)+Math.pow(v[4],2)+Math.pow(v[5],2)+Math.pow(v[6],2)+Math.pow(v[7],2)+Math.pow(v[8],2)))};if(typeof(n)!=="undefined"){n.mat3=e}var d={};d.create=function(){var v=new f(16);v[0]=1;v[1]=0;v[2]=0;v[3]=0;v[4]=0;v[5]=1;v[6]=0;v[7]=0;
v[8]=0;v[9]=0;v[10]=1;v[11]=0;v[12]=0;v[13]=0;v[14]=0;v[15]=1;return v};d.clone=function(v){var w=new f(16);w[0]=v[0];w[1]=v[1];w[2]=v[2];w[3]=v[3];w[4]=v[4];w[5]=v[5];w[6]=v[6];w[7]=v[7];w[8]=v[8];w[9]=v[9];w[10]=v[10];w[11]=v[11];w[12]=v[12];w[13]=v[13];w[14]=v[14];w[15]=v[15];return w};d.copy=function(w,v){w[0]=v[0];w[1]=v[1];w[2]=v[2];w[3]=v[3];w[4]=v[4];w[5]=v[5];w[6]=v[6];w[7]=v[7];w[8]=v[8];w[9]=v[9];w[10]=v[10];w[11]=v[11];w[12]=v[12];w[13]=v[13];w[14]=v[14];w[15]=v[15];return w};d.identity=function(v){v[0]=1;
v[1]=0;v[2]=0;v[3]=0;v[4]=0;v[5]=1;v[6]=0;v[7]=0;v[8]=0;v[9]=0;v[10]=1;v[11]=0;v[12]=0;v[13]=0;v[14]=0;v[15]=1;return v};d.transpose=function(y,x){if(y===x){var C=x[1],A=x[2],z=x[3],v=x[6],B=x[7],w=x[11];y[1]=x[4];y[2]=x[8];y[3]=x[12];y[4]=C;y[6]=x[9];y[7]=x[13];y[8]=A;y[9]=v;y[11]=x[14];y[12]=z;y[13]=B;y[14]=w}else{y[0]=x[0];y[1]=x[4];y[2]=x[8];y[3]=x[12];y[4]=x[1];y[5]=x[5];y[6]=x[9];y[7]=x[13];y[8]=x[2];y[9]=x[6];y[10]=x[10];y[11]=x[14];y[12]=x[3];y[13]=x[7];y[14]=x[11];y[15]=x[15]}return y};d.invert=function(P,U){var Y=U[0],W=U[1],V=U[2],S=U[3],z=U[4],y=U[5],x=U[6],w=U[7],O=U[8],M=U[9],L=U[10],K=U[11],aa=U[12],Z=U[13],X=U[14],T=U[15],J=Y*y-W*z,I=Y*x-V*z,H=Y*w-S*z,G=W*x-V*y,F=W*w-S*y,E=V*w-S*x,D=O*Z-M*aa,C=O*X-L*aa,B=O*T-K*aa,A=M*X-L*Z,R=M*T-K*Z,Q=L*T-K*X,v=J*Q-I*R+H*A+G*B-F*C+E*D;
if(!v){return null}v=1/v;P[0]=(y*Q-x*R+w*A)*v;P[1]=(V*R-W*Q-S*A)*v;P[2]=(Z*E-X*F+T*G)*v;P[3]=(L*F-M*E-K*G)*v;P[4]=(x*B-z*Q-w*C)*v;P[5]=(Y*Q-V*B+S*C)*v;P[6]=(X*H-aa*E-T*I)*v;P[7]=(O*E-L*H+K*I)*v;P[8]=(z*R-y*B+w*D)*v;P[9]=(W*B-Y*R-S*D)*v;P[10]=(aa*F-Z*H+T*J)*v;P[11]=(M*H-O*F-K*J)*v;P[12]=(y*C-z*A-x*D)*v;P[13]=(Y*A-W*C+V*D)*v;P[14]=(Z*I-aa*G-X*J)*v;P[15]=(O*G-M*I+L*J)*v;return P};d.adjoint=function(D,G){var K=G[0],I=G[1],H=G[2],E=G[3],y=G[4],x=G[5],w=G[6],v=G[7],C=G[8],B=G[9],A=G[10],z=G[11],M=G[12],L=G[13],J=G[14],F=G[15];
D[0]=(x*(A*F-z*J)-B*(w*F-v*J)+L*(w*z-v*A));D[1]=-(I*(A*F-z*J)-B*(H*F-E*J)+L*(H*z-E*A));D[2]=(I*(w*F-v*J)-x*(H*F-E*J)+L*(H*v-E*w));D[3]=-(I*(w*z-v*A)-x*(H*z-E*A)+B*(H*v-E*w));D[4]=-(y*(A*F-z*J)-C*(w*F-v*J)+M*(w*z-v*A));D[5]=(K*(A*F-z*J)-C*(H*F-E*J)+M*(H*z-E*A));D[6]=-(K*(w*F-v*J)-y*(H*F-E*J)+M*(H*v-E*w));D[7]=(K*(w*z-v*A)-y*(H*z-E*A)+C*(H*v-E*w));D[8]=(y*(B*F-z*L)-C*(x*F-v*L)+M*(x*z-v*B));D[9]=-(K*(B*F-z*L)-C*(I*F-E*L)+M*(I*z-E*B));D[10]=(K*(x*F-v*L)-y*(I*F-E*L)+M*(I*v-E*x));D[11]=-(K*(x*z-v*B)-y*(I*z-E*B)+C*(I*v-E*x));
D[12]=-(y*(B*J-A*L)-C*(x*J-w*L)+M*(x*A-w*B));D[13]=(K*(B*J-A*L)-C*(I*J-H*L)+M*(I*A-H*B));D[14]=-(K*(x*J-w*L)-y*(I*J-H*L)+M*(I*w-H*x));D[15]=(K*(x*A-w*B)-y*(I*A-H*B)+C*(I*w-H*x));return D};d.determinant=function(R){var W=R[0],U=R[1],S=R[2],Q=R[3],y=R[4],x=R[5],w=R[6],v=R[7],M=R[8],L=R[9],K=R[10],J=R[11],Y=R[12],X=R[13],V=R[14],T=R[15],I=W*x-U*y,H=W*w-S*y,G=W*v-Q*y,F=U*w-S*x,E=U*v-Q*x,D=S*v-Q*w,C=M*X-L*Y,B=M*V-K*Y,A=M*T-J*Y,z=L*V-K*X,P=L*T-J*X,O=K*T-J*V;return I*O-H*P+G*z+F*A-E*B+D*C};d.multiply=function(H,L,I){var Q=L[0],P=L[1],M=L[2],J=L[3],B=L[4],z=L[5],x=L[6],v=L[7],G=L[8],F=L[9],E=L[10],D=L[11],S=L[12],R=L[13],O=L[14],K=L[15];
var C=I[0],A=I[1],y=I[2],w=I[3];H[0]=C*Q+A*B+y*G+w*S;H[1]=C*P+A*z+y*F+w*R;H[2]=C*M+A*x+y*E+w*O;H[3]=C*J+A*v+y*D+w*K;C=I[4];A=I[5];y=I[6];w=I[7];H[4]=C*Q+A*B+y*G+w*S;H[5]=C*P+A*z+y*F+w*R;H[6]=C*M+A*x+y*E+w*O;H[7]=C*J+A*v+y*D+w*K;C=I[8];A=I[9];y=I[10];w=I[11];H[8]=C*Q+A*B+y*G+w*S;H[9]=C*P+A*z+y*F+w*R;H[10]=C*M+A*x+y*E+w*O;H[11]=C*J+A*v+y*D+w*K;C=I[12];A=I[13];y=I[14];w=I[15];H[12]=C*Q+A*B+y*G+w*S;H[13]=C*P+A*z+y*F+w*R;H[14]=C*M+A*x+y*E+w*O;H[15]=C*J+A*v+y*D+w*K;return H};d.mul=d.multiply;d.translate=function(L,O,G){var F=G[0],E=G[1],D=G[2],R,Q,P,M,C,B,A,w,K,J,I,H;
if(O===L){L[12]=O[0]*F+O[4]*E+O[8]*D+O[12];L[13]=O[1]*F+O[5]*E+O[9]*D+O[13];L[14]=O[2]*F+O[6]*E+O[10]*D+O[14];L[15]=O[3]*F+O[7]*E+O[11]*D+O[15]}else{R=O[0];Q=O[1];P=O[2];M=O[3];C=O[4];B=O[5];A=O[6];w=O[7];K=O[8];J=O[9];I=O[10];H=O[11];L[0]=R;L[1]=Q;L[2]=P;L[3]=M;L[4]=C;L[5]=B;L[6]=A;L[7]=w;L[8]=K;L[9]=J;L[10]=I;L[11]=H;L[12]=R*F+C*E+K*D+O[12];L[13]=Q*F+B*E+J*D+O[13];L[14]=P*F+A*E+I*D+O[14];L[15]=M*F+w*E+H*D+O[15]}return L};d.scale=function(C,A,B){var w=B[0],E=B[1],D=B[2];C[0]=A[0]*w;C[1]=A[1]*w;C[2]=A[2]*w;
C[3]=A[3]*w;C[4]=A[4]*E;C[5]=A[5]*E;C[6]=A[6]*E;C[7]=A[7]*E;C[8]=A[8]*D;C[9]=A[9]*D;C[10]=A[10]*D;C[11]=A[11]*D;C[12]=A[12];C[13]=A[13];C[14]=A[14];C[15]=A[15];return C};d.rotate=function(T,aa,ac,v){var I=v[0],H=v[1],G=v[2],U=Math.sqrt(I*I+H*H+G*G),O,Y,M,ae,ad,ab,Z,F,E,D,C,S,R,Q,P,L,K,J,X,W,V,B,A,w;if(Math.abs(U)<u){return null}U=1/U;I*=U;H*=U;G*=U;O=Math.sin(ac);Y=Math.cos(ac);M=1-Y;ae=aa[0];ad=aa[1];ab=aa[2];Z=aa[3];F=aa[4];E=aa[5];D=aa[6];C=aa[7];S=aa[8];R=aa[9];Q=aa[10];P=aa[11];L=I*I*M+Y;K=H*I*M+G*O;
J=G*I*M-H*O;X=I*H*M-G*O;W=H*H*M+Y;V=G*H*M+I*O;B=I*G*M+H*O;A=H*G*M-I*O;w=G*G*M+Y;T[0]=ae*L+F*K+S*J;T[1]=ad*L+E*K+R*J;T[2]=ab*L+D*K+Q*J;T[3]=Z*L+C*K+P*J;T[4]=ae*X+F*W+S*V;T[5]=ad*X+E*W+R*V;T[6]=ab*X+D*W+Q*V;T[7]=Z*X+C*W+P*V;T[8]=ae*B+F*A+S*w;T[9]=ad*B+E*A+R*w;T[10]=ab*B+D*A+Q*w;T[11]=Z*B+C*A+P*w;if(aa!==T){T[12]=aa[12];T[13]=aa[13];T[14]=aa[14];T[15]=aa[15]}return T};d.rotateX=function(v,C,B){var H=Math.sin(B),A=Math.cos(B),G=C[4],F=C[5],E=C[6],D=C[7],z=C[8],y=C[9],x=C[10],w=C[11];if(C!==v){v[0]=C[0];
v[1]=C[1];v[2]=C[2];v[3]=C[3];v[12]=C[12];v[13]=C[13];v[14]=C[14];v[15]=C[15]}v[4]=G*A+z*H;v[5]=F*A+y*H;v[6]=E*A+x*H;v[7]=D*A+w*H;v[8]=z*A-G*H;v[9]=y*A-F*H;v[10]=x*A-E*H;v[11]=w*A-D*H;return v};d.rotateY=function(z,G,F){var H=Math.sin(F),E=Math.cos(F),y=G[0],x=G[1],w=G[2],v=G[3],D=G[8],C=G[9],B=G[10],A=G[11];if(G!==z){z[4]=G[4];z[5]=G[5];z[6]=G[6];z[7]=G[7];z[12]=G[12];z[13]=G[13];z[14]=G[14];z[15]=G[15]}z[0]=y*E-D*H;z[1]=x*E-C*H;z[2]=w*E-B*H;z[3]=v*E-A*H;z[8]=y*H+D*E;z[9]=x*H+C*E;z[10]=w*H+B*E;z[11]=v*H+A*E;
return z};d.rotateZ=function(z,C,B){var H=Math.sin(B),A=Math.cos(B),y=C[0],x=C[1],w=C[2],v=C[3],G=C[4],F=C[5],E=C[6],D=C[7];if(C!==z){z[8]=C[8];z[9]=C[9];z[10]=C[10];z[11]=C[11];z[12]=C[12];z[13]=C[13];z[14]=C[14];z[15]=C[15]}z[0]=y*A+G*H;z[1]=x*A+F*H;z[2]=w*A+E*H;z[3]=v*A+D*H;z[4]=G*A-y*H;z[5]=F*A-x*H;z[6]=E*A-w*H;z[7]=D*A-v*H;return z};d.fromRotationTranslation=function(O,L,J){var G=L[0],F=L[1],E=L[2],H=L[3],P=G+G,A=F+F,I=E+E,D=G*P,C=G*A,B=G*I,M=F*A,K=F*I,S=E*I,T=H*P,R=H*A,Q=H*I;O[0]=1-(M+S);O[1]=C+Q;
O[2]=B-R;O[3]=0;O[4]=C-Q;O[5]=1-(D+S);O[6]=K+T;O[7]=0;O[8]=B+R;O[9]=K-T;O[10]=1-(D+M);O[11]=0;O[12]=J[0];O[13]=J[1];O[14]=J[2];O[15]=1;return O};d.fromQuat=function(J,G){var D=G[0],C=G[1],B=G[2],E=G[3],K=D+D,v=C+C,F=B+B,A=D*K,I=C*K,H=C*v,R=B*K,Q=B*v,O=B*F,P=E*K,M=E*v,L=E*F;J[0]=1-H-O;J[1]=I+L;J[2]=R-M;J[3]=0;J[4]=I-L;J[5]=1-A-O;J[6]=Q+P;J[7]=0;J[8]=R+M;J[9]=Q-P;J[10]=1-A-H;J[11]=0;J[12]=0;J[13]=0;J[14]=0;J[15]=1;return J};d.frustum=function(z,w,E,v,D,B,A){var C=1/(E-w),y=1/(D-v),x=1/(B-A);z[0]=(B*2)*C;
z[1]=0;z[2]=0;z[3]=0;z[4]=0;z[5]=(B*2)*y;z[6]=0;z[7]=0;z[8]=(E+w)*C;z[9]=(D+v)*y;z[10]=(A+B)*x;z[11]=-1;z[12]=0;z[13]=0;z[14]=(A*B*2)*x;z[15]=0;return z};d.perspective=function(y,x,w,z,v){var B=1/Math.tan(x/2),A=1/(z-v);y[0]=B/w;y[1]=0;y[2]=0;y[3]=0;y[4]=0;y[5]=B;y[6]=0;y[7]=0;y[8]=0;y[9]=0;y[10]=(v+z)*A;y[11]=-1;y[12]=0;y[13]=0;y[14]=(2*v*z)*A;y[15]=0;return y};d.ortho=function(y,w,E,v,C,B,A){var z=1/(w-E),D=1/(v-C),x=1/(B-A);y[0]=-2*z;y[1]=0;y[2]=0;y[3]=0;y[4]=0;y[5]=-2*D;y[6]=0;y[7]=0;y[8]=0;y[9]=0;
y[10]=2*x;y[11]=0;y[12]=(w+E)*z;y[13]=(C+v)*D;y[14]=(A+B)*x;y[15]=1;return y};d.lookAt=function(J,R,S,B){var Q,P,M,x,w,v,E,D,C,K,O=R[0],L=R[1],I=R[2],A=B[0],z=B[1],y=B[2],H=S[0],G=S[1],F=S[2];if(Math.abs(O-H)<u&&Math.abs(L-G)<u&&Math.abs(I-F)<u){return d.identity(J)}E=O-H;D=L-G;C=I-F;K=1/Math.sqrt(E*E+D*D+C*C);E*=K;D*=K;C*=K;Q=z*C-y*D;P=y*E-A*C;M=A*D-z*E;K=Math.sqrt(Q*Q+P*P+M*M);if(!K){Q=0;P=0;M=0}else{K=1/K;Q*=K;P*=K;M*=K}x=D*M-C*P;w=C*Q-E*M;v=E*P-D*Q;K=Math.sqrt(x*x+w*w+v*v);if(!K){x=0;w=0;v=0}else{K=1/K;
x*=K;w*=K;v*=K}J[0]=Q;J[1]=x;J[2]=E;J[3]=0;J[4]=P;J[5]=w;J[6]=D;J[7]=0;J[8]=M;J[9]=v;J[10]=C;J[11]=0;J[12]=-(Q*O+P*L+M*I);J[13]=-(x*O+w*L+v*I);J[14]=-(E*O+D*L+C*I);J[15]=1;return J};d.str=function(v){return"mat4("+v[0]+", "+v[1]+", "+v[2]+", "+v[3]+", "+v[4]+", "+v[5]+", "+v[6]+", "+v[7]+", "+v[8]+", "+v[9]+", "+v[10]+", "+v[11]+", "+v[12]+", "+v[13]+", "+v[14]+", "+v[15]+")"};d.frob=function(v){return(Math.sqrt(Math.pow(v[0],2)+Math.pow(v[1],2)+Math.pow(v[2],2)+Math.pow(v[3],2)+Math.pow(v[4],2)+Math.pow(v[5],2)+Math.pow(v[6],2)+Math.pow(v[6],2)+Math.pow(v[7],2)+Math.pow(v[8],2)+Math.pow(v[9],2)+Math.pow(v[10],2)+Math.pow(v[11],2)+Math.pow(v[12],2)+Math.pow(v[13],2)+Math.pow(v[14],2)+Math.pow(v[15],2)))
};if(typeof(n)!=="undefined"){n.mat4=d}var k={};k.create=function(){var v=new f(4);v[0]=0;v[1]=0;v[2]=0;v[3]=1;return v};k.rotationTo=(function(){var v=q.create();var w=q.fromValues(1,0,0);var x=q.fromValues(0,1,0);return function(B,z,y){var A=q.dot(z,y);if(A<-0.999999){q.cross(v,w,z);if(q.length(v)<0.000001){q.cross(v,x,z)}q.normalize(v,v);k.setAxisAngle(B,v,Math.PI);return B}else{if(A>0.999999){B[0]=0;B[1]=0;B[2]=0;B[3]=1;return B}else{q.cross(v,z,y);B[0]=v[0];B[1]=v[1];B[2]=v[2];B[3]=1+A;return k.normalize(B,B)
}}}})();k.setAxes=(function(){var v=e.create();return function(y,x,z,w){v[0]=z[0];v[3]=z[1];v[6]=z[2];v[1]=w[0];v[4]=w[1];v[7]=w[2];v[2]=-x[0];v[5]=-x[1];v[8]=-x[2];return k.normalize(y,k.fromMat3(y,v))}})();k.clone=o.clone;k.fromValues=o.fromValues;k.copy=o.copy;k.set=o.set;k.identity=function(v){v[0]=0;v[1]=0;v[2]=0;v[3]=1;return v};k.setAxisAngle=function(w,y,v){v=v*0.5;var x=Math.sin(v);w[0]=x*y[0];w[1]=x*y[1];w[2]=x*y[2];w[3]=Math.cos(v);return w};k.add=o.add;k.multiply=function(x,D,C){var v=D[0],F=D[1],E=D[2],w=D[3],A=C[0],z=C[1],y=C[2],B=C[3];
x[0]=v*B+w*A+F*y-E*z;x[1]=F*B+w*z+E*A-v*y;x[2]=E*B+w*y+v*z-F*A;x[3]=w*B-v*A-F*z-E*y;return x};k.mul=k.multiply;k.scale=o.scale;k.rotateX=function(x,B,z){z*=0.5;var v=B[0],D=B[1],C=B[2],w=B[3],y=Math.sin(z),A=Math.cos(z);x[0]=v*A+w*y;x[1]=D*A+C*y;x[2]=C*A-D*y;x[3]=w*A-v*y;return x};k.rotateY=function(x,B,z){z*=0.5;var v=B[0],D=B[1],C=B[2],w=B[3],y=Math.sin(z),A=Math.cos(z);x[0]=v*A-C*y;x[1]=D*A+w*y;x[2]=C*A+v*y;x[3]=w*A-D*y;return x};k.rotateZ=function(x,B,z){z*=0.5;var v=B[0],D=B[1],C=B[2],w=B[3],y=Math.sin(z),A=Math.cos(z);
x[0]=v*A+D*y;x[1]=D*A-v*y;x[2]=C*A+w*y;x[3]=w*A-C*y;return x};k.calculateW=function(A,w){var v=w[0],C=w[1],B=w[2];A[0]=v;A[1]=C;A[2]=B;A[3]=-Math.sqrt(Math.abs(1-v*v-C*C-B*B));return A};k.dot=o.dot;k.lerp=o.lerp;k.slerp=function(z,H,G,K){var v=H[0],L=H[1],J=H[2],x=H[3],E=G[0],D=G[1],C=G[2],F=G[3];var I,w,y,B,A;w=v*E+L*D+J*C+x*F;if(w<0){w=-w;E=-E;D=-D;C=-C;F=-F}if((1-w)>0.000001){I=Math.acos(w);y=Math.sin(I);B=Math.sin((1-K)*I)/y;A=Math.sin(K*I)/y}else{B=1-K;A=K}z[0]=B*v+A*E;z[1]=B*L+A*D;z[2]=B*J+A*C;
z[3]=B*x+A*F;return z};k.invert=function(B,x){var z=x[0],w=x[1],v=x[2],C=x[3],y=z*z+w*w+v*v+C*C,A=y?1/y:0;B[0]=-z*A;B[1]=-w*A;B[2]=-v*A;B[3]=C*A;return B};k.conjugate=function(w,v){w[0]=-v[0];w[1]=-v[1];w[2]=-v[2];w[3]=v[3];return w};k.length=o.length;k.len=k.length;k.squaredLength=o.squaredLength;k.sqrLen=k.squaredLength;k.normalize=o.normalize;k.fromMat3=function(z,v){var w=v[0]+v[4]+v[8];var B;if(w>0){B=Math.sqrt(w+1);z[3]=0.5*B;B=0.5/B;z[0]=(v[7]-v[5])*B;z[1]=(v[2]-v[6])*B;z[2]=(v[3]-v[1])*B}else{var A=0;
if(v[4]>v[0]){A=1}if(v[8]>v[A*3+A]){A=2}var y=(A+1)%3;var x=(A+2)%3;B=Math.sqrt(v[A*3+A]-v[y*3+y]-v[x*3+x]+1);z[A]=0.5*B;B=0.5/B;z[3]=(v[x*3+y]-v[y*3+x])*B;z[y]=(v[y*3+A]+v[A*3+y])*B;z[x]=(v[x*3+A]+v[A*3+x])*B}return z};k.str=function(v){return"quat("+v[0]+", "+v[1]+", "+v[2]+", "+v[3]+")"};if(typeof(n)!=="undefined"){n.quat=k}})(a.exports)})(this);nucleo.Landmark=function Landmark(a,d){if(!(d instanceof nucleo.Camera)){alert("Landmark needs a Camera as argument");return null}this.name=a;var e=d;
this._matrix=mat4.clone(e._matrix);this._right=vec3.clone(e._right);this._up=vec3.clone(e._up);this._forward=vec3.clone(e._forward);this._position=vec3.clone(e._position);this._focalPoint=vec3.clone(e._focalPoint);this._distanceVector=vec3.clone(e._distanceVector);this._azimuth=e._azimuth;this._elevation=e._elevation;this._roll=e._roll;this._relAzimuth=e._relAzimuth;this._relElevation=e._relElevation;this._relRoll=e._relRoll;this._dollyingStep=e._dollyngStep;this._distance=e._distance};nucleo.Landmark.prototype.retrieve=function(a){var d=a;
d._matrix=mat4.copy(d._matrix,this._matrix);d._right=vec3.copy(d._right,this._right);d._up=vec3.copy(d._up,this._up);d._forward=vec3.copy(d._forward,this._forward);d._position=vec3.copy(d._position,this._position);d._focalPoint=vec3.copy(d._focalPoint,this._focalPoint);d._distanceVector=vec3.copy(d._distanceVector,this._distanceVector);d._azimuth=this._azimuth;d._elevation=this._elevation;d._roll=this._roll;d._relAzimuth=this._relAzimuth;d._relElevation=this._relElevation;d._relRoll=this._relRoll;
d._dollyingStep=this._dollyngStep;d._distance=this._distance;d.refresh()};nucleo.Camera=function Camera(c,a){this.UID=nucleo.util.generateUID();this.view=c;this._matrix=mat4.create();this._right=vec3.fromValues(1,0,0);this._up=vec3.fromValues(0,1,0);this._forward=vec3.fromValues(0,0,1);this._position=vec3.fromValues(0,0,1);this._focalPoint=vec3.fromValues(0,0,0);this._distanceVector=vec3.fromValues(0,0,0);this._azimuth=0;this._elevation=0;this._roll=0;this._relAzimuth=0;this._relElevation=0;this._relRoll=0;
this._dollyingStep=0;this._distance=1;this._rotate_world=false;this._fov=nucleo.define.Camera.FRUSTUM.FOV;this._near=nucleo.define.Camera.FRUSTUM.NEAR;this._far=nucleo.define.Camera.FRUSTUM.FAR;this._aspect=undefined;this._perspective=mat4.create();this.updatePerspective();this._following=undefined;this._trackingMode=nucleo.define.Camera.TRACKING.DEFAULT;this.landmarks=[];this._lmarkAnimationID=undefined;if(a!=undefined){this.setType(a,undefined)}else{this.setType(nucleo.Camera.TYPE.EXPLORING,undefined)
}};nucleo.Camera.TYPE=nucleo.define.Camera.TYPE;nucleo.Camera.TRACKING=nucleo.define.Camera.TRACKING;nucleo.Camera.FRUSTUM=nucleo.define.Camera.FRUSTUM;nucleo.Camera.AXIS=nucleo.define.Camera.AXIS;nucleo.Camera.prototype.setWorldRotation=function(a){this._rotate_world=a;this._getAngles();return this};nucleo.Camera.prototype.setType=function(c,a){var d=nucleo.Camera.TYPE;if(c!=d.ORBITING&&c!=d.TRACKING&&c!=d.EXPLORING){console.warn("Camera.setType WARNING type ["+c+"] unknown. Setting camera to EXPLORING type.");
this.type=d.EXPLORING;this.setWorldRotation(true)}else{this.type=c;if(this.type==d.EXPLORING){this.setWorldRotation(true)}else{this.setWorldRotation(false)}this._getAngles()}if(this.type==nucleo.Camera.TYPE.TRACKING&&a!=undefined){this.setTrackingMode(a)}return this};nucleo.Camera.prototype.setTrackingMode=function(a){if(this.type!=nucleo.Camera.TYPE.TRACKING){alert("Impossible to set a tracking mode if the camera is not of tracking type");throw ("Impossible to set a tracking mode if the camera is not of tracking type")
}if(a==undefined){return}this._trackingMode=a};nucleo.Camera.prototype.follow=function(c,d){var a;this.setType(nucleo.Camera.TYPE.TRACKING,d);if(c instanceof nucleo.Actor){a=c}else{if(typeof(c)=="string"){a=this.view.scene.getActorByName(c)}}if(a==undefined){console.error("Camera.follow ERROR: The actor "+c+" does not exist")}else{this._following=a;a.addTrackingCamera(this)}return this};nucleo.Camera.prototype.unfollow=function(){this._following.removeTrackingCamera(this);this._following=undefined;
return this};nucleo.Camera.prototype.updateWithActor=function(c){if(this._following!=c){return}var a=nucleo.Camera;switch(this._trackingMode){case a.TRACKING.DEFAULT:break;case a.TRACKING.ROTATIONAL:case a.TRACKING.CINEMATIC:this.setFocalPoint(c._position);break;case a.TRACKING.TRANSLATIONAL:this.translate(c._translation);this.setFocalPoint(c._position);break}};nucleo.Camera.prototype.setPosition=function(a,d,c){this._setPosition(a,d,c);this.setFocalPoint(this._focalPoint);return this};nucleo.Camera.prototype.setFocalPoint=function(l,k,j){var f=vec3.fromValues(0,1,0);
this._focalPoint=nucleo.util.createVec3(l,k,j);if(this._trackingMode==nucleo.Camera.TRACKING.CINEMATIC){var h=vec3.subtract(vec3.create(),this._focalPoint,this._position);var l=h[0],k=h[1],j=h[2],a=vec3.length(h);var c=Math.asin(k/a)*nucleo.define.RAD_2_DEG;var n=90+Math.atan2(j,l)*nucleo.define.RAD_2_DEG;var e=mat4.create();mat4.rotateY(e,e,n*nucleo.define.DEG_2_RAD);mat4.rotateX(e,e,c*nucleo.define.DEG_2_RAD);f=vec3.transformMat4(vec3.create(),[0,1,0],e)}mat4.invert(this._matrix,mat4.lookAt(mat4.create(),this._position,this._focalPoint,f));
this._getAxes();this._getDistance();this._getAngles();return this};nucleo.Camera.prototype.setDistance=function(c){if(this._distance==c||c<0){return}this._distance=c;if(this._distance<0.0002){this._distance=0.0002;console.warn("Camera.setDistance WARN: Distance is set to minimum (0.0002)")}this._dollyingStep=this._distance/100;var h=vec3.create();c=this._distance;var e=this._forward;var a=this._focalPoint;h[0]=c*e[0]+a[0];h[1]=c*e[1]+a[1];h[2]=c*e[2]+a[2];this._setPosition(h);return this};nucleo.Camera.prototype.changeAzimuth=function(a){this.setAzimuth(this._azimuth+a);
return this};nucleo.Camera.prototype.changeElevation=function(a){this.setElevation(this._elevation+a);return this};nucleo.Camera.prototype.changeRoll=function(a){this.setRoll(this._roll+a);return this};nucleo.Camera.prototype.setAzimuth=function(a){this._azimuth=this._getAngle(a);this._computeMatrix();this._getAxes();if(this.type==nucleo.Camera.TYPE.ORBITING||this.type==nucleo.Camera.TYPE.EXPLORING){this._getPosition()}else{if(this.type==nucleo.Camera.TYPE.TRACKING){this._getFocalPoint()}}return this
};nucleo.Camera.prototype.setElevation=function(a){this._elevation=this._getAngle(a);this._computeMatrix();this._getAxes();if(this.type==nucleo.Camera.TYPE.ORBITING||this.type==nucleo.Camera.TYPE.EXPLORING){this._getPosition()}else{if(this.type==nucleo.Camera.TYPE.TRACKING){this._getFocalPoint()}}return this};nucleo.Camera.prototype.setRoll=function(c){var a=nucleo.Camera;this._roll=this._getAngle(c);this._computeMatrix();this._getAxes();if(this.type==a.TYPE.ORBITING||this.type==a.TYPE.EXPLORING){this._getPosition()
}else{if(this.type==a.TYPE.TRACKING){this._getFocalPoint()}}return this};nucleo.Camera.prototype.rotate=function(l,k,c){var j=nucleo.Camera;if(this.type==j.TYPE.EXPLORING){l=this._getAngle(l);k=this._getAngle(k);c=this._getAngle(c);var e=quat.setAxisAngle(quat.create(),[1,0,0],-k*nucleo.define.DEG_2_RAD);var d=quat.setAxisAngle(quat.create(),[0,1,0],-l*nucleo.define.DEG_2_RAD);if(this._rotate_world){e=quat.setAxisAngle(quat.create(),[1,0,0],k*nucleo.define.DEG_2_RAD);d=quat.setAxisAngle(quat.create(),[0,1,0],l*nucleo.define.DEG_2_RAD)
}var a=quat.setAxisAngle(quat.create(),[0,0,1],c*nucleo.define.DEG_2_RAD);var h=quat.multiply(quat.create(),d,e);h=quat.multiply(quat.create(),h,a);var f=mat4.fromQuat(mat4.create(),h);mat4.translate(this._matrix,this._matrix,[0,0,-this._distance]);mat4.multiply(this._matrix,this._matrix,f);mat4.translate(this._matrix,this._matrix,[0,0,this._distance])}else{if(Math.abs(this._elevation+k)>90){return}this._relElevation=this._getAngle(k);this._relAzimuth=this._getAngle(l);this._relRoll=this._getAngle(c);
this._elevation+=this._relElevation;this._azimuth+=this._relAzimuth;this._roll+=this._relRoll;this._computeMatrix()}this._getAxes();if(this.type==j.TYPE.ORBITING||this.type==j.TYPE.EXPLORING){this._getPosition()}else{if(this.type==j.TYPE.TRACKING){this._getFocalPoint()}}this._update();return this};nucleo.Camera.prototype.dolly=function(d){var a=nucleo.Camera;var f=this._forward;var e=vec3.clone(this._position);var c=d*this._dollyingStep;e[0]+=c*f[0];e[1]+=c*f[1];e[2]+=c*f[2];this._setPosition(e);
if(this.type==a.TYPE.ORBITING||this.type==a.TYPE.EXPLORING){this._getDistance()}else{if(this.type==a.TYPE.TRACKING){vec3.add(this._focalPoint,e,this._distanceVector)}}return this};nucleo.Camera.prototype.pan=function(c,a){var d=nucleo.util.createVec3(c,a,0);var e=vec3.clone(this._position);vec3.add(e,e,vec3.scale(vec3.create(),this._right,d[0]));vec3.add(e,e,vec3.scale(vec3.create(),this._up,d[1]));this._setPosition(e);return this};nucleo.Camera.prototype.translate=function(a,f,d){var c=nucleo.util.createVec3(a,f,d);
var e=vec3.clone(this._position);vec3.add(e,e,c);this._setPosition(e);return this};nucleo.Camera.prototype.refresh=function(){this.view.refresh();return this};nucleo.Camera.prototype.lookAt=function(a){if(a instanceof nucleo.Actor){this.setFocalPoint(a._position)}else{if(typeof(a)=="string"){var a=this.view.scene.getActorByName(a);if(a==undefined){throw"Camera.lookAt ERROR: The actor "+actorName+" does not exist"}else{this.setFocalPoint(a._position)}}}return this};nucleo.Camera.prototype.closeUp=function(a){if(a instanceof nucleo.Actor){this._shot(a._bb)
}else{if(typeof(a)=="string"){var a=this.view.scene.getActorByName(a);if(a==undefined){throw"Camera.lookAt ERROR: The actor "+actorName+" does not exist"}else{this._shot(a._bb)}}}return this};nucleo.Camera.prototype.longShot=function(){this.view.scene.computeBoundingBox();this._shot(this.view.scene.bb);return this};nucleo.Camera.prototype.setFieldOfView=function(a){this._fov=a;return this};nucleo.Camera.prototype.createLandmark=function(h,a,e,f){var j=new Camera(this.view,this.type);j.setPosition(a);
j.setFocalPoint(e);if(f!=undefined){j.setRoll(f)}var d=new Landmark(h,j);this.landmarks.push(d);return this};nucleo.Camera.prototype.setLandmark=function(c){var a=new Landmark(c,this);this.landmarks.push(a);return this};nucleo.Camera.prototype.gotoLandmark=function(a,e,f){var l=undefined;var j=this.landmarks.length;while(j--){if(this.landmarks[j].name==a){l=this.landmarks[j];break}}if(l==undefined){console.warn("Camera.goTo: landmark with name: "+a+", was not found");return}if(e==undefined||e==0){l.retrieve(this);
return}if(this._lmarkAnimationID!=undefined){window.clearTimeout(this._lmarkAnimationID)}var m=this;var n=l._position;var h=l._focalPoint;var k=l._roll;if(e==undefined){e=1000}if(f==undefined){f==20}var d=this.view.interactor;d.disconnectFromView();function c(u,q){var o=(u/100)*(q/10),v=u/o,t=0,w=new Date().getTime();function s(){var x=vec3.create();var z=vec3.create();var B=0;if(t++!=o){percent=t/o;percent2=(1-Math.cos(percent*Math.PI))/2;x=vec3.lerp(x,m._focalPoint,h,percent2);z=vec3.lerp(z,m._position,n,percent2);
B=m._roll*(1-percent2)+k*(percent2);m.setFocalPoint(x);m.setPosition(z);m.setRoll(B);m.refresh();var A=vec3.dist(x,h)+vec3.dist(z,n);if(A>0.01){var y=(new Date().getTime()-w)-(t*v);m._lmarkAnimationID=window.setTimeout(s,(v-y))}else{m.setFocalPoint(h);m.setPosition(n);m.setRoll(k);m.refresh();d.connectView(this.view)}return}}m._lmarkAnimationID=window.setTimeout(s,v)}c(e,f);return this};nucleo.Camera.prototype.doLandmarkAnimation=function(a){var d=a.slice(0);var c=this;function e(){if(d.length==0){return
}if(c._stop_lmark_animation){c._stop_lmark_animation=false;nucleo.util.console("Landmark Animation Stopped",true);return}step=d.splice(0,1)[0];lmark=step[0];duration=step[1];fps=step[2];c.gotoLandmark(lmark,duration,fps);window.setTimeout(e,duration)}e();return this};nucleo.Camera.prototype.stopLandmarkAnimation=function(){this._stop_lmark_animation=true};nucleo.Camera.prototype.getLandmarks=function(){var c=[];var a=this.landmarks.length;while(a--){c.push(this.landmarks[a].name)}return c};nucleo.Camera.prototype._shot=function(e){this.setElevation(0);
this.setAzimuth(0);this.setRoll(0);var c=Math.max(e[3]-e[0],e[4]-e[1]);cc=[0,0,0];cc[0]=(e[3]+e[0])/2;cc[1]=(e[4]+e[1])/2;cc[2]=(e[5]+e[2])/2;cc[0]=Math.round(cc[0]*1000)/1000;cc[1]=Math.round(cc[1]*1000)/1000;cc[2]=Math.round(cc[2]*1000)/1000;if(c!=0){var a=1.5*c/(Math.tan(this._fov*Math.PI/180));this.setPosition([cc[0],cc[1],cc[2]+a])}this.setFocalPoint(cc);this.refresh()};nucleo.Camera.prototype.setAspectRatio=function(a){this._aspect=a};nucleo.Camera.prototype.setPerspective=function(f,e,c,h){var a=this.view;
this._fov=c;this._near=f;this._far=e;this._aspect=h;var d=nucleo.util.deg2rad(c);if(this._aspect==undefined){mat4.perspective(this._perspective,d,a.width/a.height,this._near,this._far)}else{mat4.perspective(this._perspective,d,this._aspect,this._near,this._far)}};nucleo.Camera.prototype.updatePerspective=function(){var a=this.view;var c=nucleo.util.deg2rad(this._fov);if(this._aspect==undefined){mat4.perspective(this._perspective,c,a.width/a.height,this._near,this._far)}else{mat4.perspective(this._perspective,c,this._aspect,this._near,this._far)
}};nucleo.Camera.prototype.status=function(){console.info("------------- Camera Status -------------");console.info("       type: "+this.type);console.info("      right: "+nucleo.util.format(this._right,2));console.info("         up: "+nucleo.util.format(this._up,2));console.info("    forward: "+nucleo.util.format(this._forward,2));console.info("   position: "+nucleo.util.format(this._position,2));console.info("focal point: "+nucleo.util.format(this._focalPoint,2));console.info("    azimuth: "+nucleo.util.format(this._azimuth,2));
console.info("  elevation: "+nucleo.util.format(this._elevation,2));console.info("       roll: "+nucleo.util.format(this._roll,2));console.info("   distance: "+nucleo.util.format(this._distance,2));console.info("   d vector: "+nucleo.util.format(this._distanceVector,2))};nucleo.Camera.prototype.getViewTransform=function(){return mat4.invert(mat4.create(),this._matrix)};nucleo.Camera.prototype.setMatrix=function(a){this._matrix=a;this._update()};nucleo.Camera.prototype._computeMatrix=function(){var f,e,d=quat.setAxisAngle(quat.create(),[0,0,1],this._roll*nucleo.define.DEG_2_RAD);
mat4.identity(this._matrix);if(this.type==nucleo.Camera.TYPE.TRACKING){f=quat.setAxisAngle(quat.create(),[1,0,0],this._elevation*nucleo.define.DEG_2_RAD);e=quat.setAxisAngle(quat.create(),[0,1,0],this._azimuth*nucleo.define.DEG_2_RAD)}else{if(this._rotate_world){f=quat.setAxisAngle(quat.create(),[1,0,0],this._elevation*nucleo.define.DEG_2_RAD);e=quat.setAxisAngle(quat.create(),[0,1,0],this._azimuth*nucleo.define.DEG_2_RAD)}else{f=quat.setAxisAngle(quat.create(),[1,0,0],-this._elevation*nucleo.define.DEG_2_RAD);
e=quat.setAxisAngle(quat.create(),[0,1,0],-this._azimuth*nucleo.define.DEG_2_RAD)}}var c=quat.multiply(quat.create(),e,f);c=quat.multiply(quat.create(),c,d);var a=mat4.fromQuat(mat4.create(),c);if(this.type==nucleo.Camera.TYPE.ORBITING||this.type==nucleo.Camera.TYPE.EXPLORING){mat4.translate(this._matrix,this._matrix,this._focalPoint);mat4.multiply(this._matrix,this._matrix,a);mat4.translate(this._matrix,this._matrix,[0,0,this._distance])}else{if(this.type==nucleo.Camera.TYPE.TRACKING){mat4.translate(this._matrix,this._matrix,this._position);
mat4.multiply(this._matrix,this._matrix,a)}}};nucleo.Camera.prototype._setPosition=function(c,e,d){this._position=nucleo.util.createVec3(c,e,d);var a=this._matrix;a[12]=this._position[0];a[13]=this._position[1];a[14]=this._position[2];a[15]=1};nucleo.Camera.prototype._getAxes=function(){var a=this._matrix;vec3.copy(this._right,vec4.transformMat4(vec4.create(),[1,0,0,0],a));vec3.copy(this._up,vec4.transformMat4(vec4.create(),[0,1,0,0],a));vec3.copy(this._forward,vec4.transformMat4(vec4.create(),[0,0,1,0],a));
vec3.normalize(this._right,this._right);vec3.normalize(this._up,this._up);vec3.normalize(this._forward,this._forward)};nucleo.Camera.prototype._getPosition=function(){var a=this._matrix;vec3.copy(this._position,vec4.transformMat4(vec4.create(),[0,0,0,1],a));this._getDistance()};nucleo.Camera.prototype._getFocalPoint=function(){vec3.transformMat3(this._distanceVector,[0,0,-this._distance],mat3.fromMat4(mat3.create(),this._matrix));vec3.add(this._focalPoint,this._position,this._distanceVector);this._getDistance()
};nucleo.Camera.prototype._getDistance=function(){this._distanceVector=vec3.subtract(vec3.create(),this._focalPoint,this._position);this._distance=vec3.length(this._distanceVector);this._dollyingStep=this._distance/100};nucleo.Camera.prototype._getAngles=function(){var a=this._distanceVector[0],e=this._distanceVector[1],d=this._distanceVector[2];var c=vec3.length(this._distanceVector);if(c==0){this._elevation=0;this._azimuth=0;return}if(this.type==nucleo.Camera.TYPE.TRACKING){this._elevation=Math.asin(e/c)*nucleo.define.RAD_2_DEG;
this._azimuth=Math.atan2(-a,-d)*nucleo.define.RAD_2_DEG}else{if(this._rotate_world){this._elevation=Math.asin(e/c)*nucleo.define.RAD_2_DEG;this._azimuth=Math.atan2(-a,-d)*nucleo.define.RAD_2_DEG}else{this._elevation=-1*Math.asin(e/c)*nucleo.define.RAD_2_DEG;this._azimuth=-1*Math.atan2(-a,-d)*nucleo.define.RAD_2_DEG}}};nucleo.Camera.prototype._update=function(){this._getAxes();this._getPosition();this._getDistance();this._getAngles()};nucleo.Camera.prototype._calculateAngles=function(){var h=mat4.toMat3(this._matrix);
var e=mat3.toQuat4(h);var k=e[0],j=e[1],f=e[2],l=e[3];var c=Math.atan2(2*(l*k+j*f),1-2*(k*k+j*j))*nucleo.define.RAD_2_DEG;var a=Math.asin(2*(l*j-f*j))*nucleo.define.RAD_2_DEG;var d=Math.atan2(2*(l*f+k*j),1-2*(j*j+f*f))*nucleo.define.RAD_2_DEG;console.info(" roll :"+nucleo.util.format(c,2));console.info("pitch :"+nucleo.util.format(a,2));console.info("  yaw :"+nucleo.util.format(d,2))};nucleo.Camera.prototype._getAngle=function(a){if(a==undefined){return 0}else{if(a>360||a<-360){return a%360}else{return a
}}};nucleo.CameraManager=function CameraManager(a){this.view=a;this.cameras=[];this.active=this.create(nucleo.Camera.TYPE.EXPLORING)};nucleo.CameraManager.prototype.reset=function(a){this.cameras=[];this.interactors=[];this.active=this.create(a)};nucleo.CameraManager.prototype.create=function(c){var a=new nucleo.Camera(this.view,c);this.cameras.push(a);return a};nucleo.CameraManager.prototype.remove=function(a){if(this.cameras.length==1){throw ("CameraManager.remove ERROR: the camera manager must not eliminate the last camera standing. Operation cancelled")
}else{this.cameras.splice(a,1)}};nucleo.CameraManager.prototype.get=function(a){this._checkBoundary(a);return this.cameras[a]};nucleo.CameraManager.prototype.switchTo=function(a){var c=this.view;this._checkBoundary(a);this.active=this.cameras[a];if(c.interactor!=undefined){c.interactor.connectCamera(this.active)}else{throw ("CameraManager.switchTo ERROR: switching to camera ["+a+"] while the view "+c.name+" does not have an interactor set")}return this.active};nucleo.CameraManager.prototype._checkBoundary=function(a){if(a<0||a>=this.cameras.length){throw ("The camera "+a+" does not exist")
}};nucleo.ViewInteractor=function ViewInteractor(){this.view=undefined;this.camera=undefined;this.UID=nucleo.util.generateUID();this.keymap={};this.keysEnabled=true};nucleo.ViewInteractor.TASK=nucleo.define.ViewInteractor.TASK;nucleo.ViewInteractor.prototype.getType=function(){return"ViewInteractor"};nucleo.ViewInteractor.prototype.disconnectFromView=function(){var a=this.view.canvas;a.onmousedown=null;a.onmouseup=null;a.onmousemove=null;a.ondragover=null;a.ondragleave=null;a.ondrop=null;window.onkeydown=null;
window.onkeyup=null;a.ondblclick=null};nucleo.ViewInteractor.prototype.connectView=function(a){if(!(a instanceof nucleo.View)){throw"ViewInteractor.connectView: the parameter is not a View"}var d=this;var c=a.canvas;this.view=a;this.camera=a.cameraman.active;c.onmousedown=function(e){d.onMouseDown(e)};c.onmouseup=function(e){d.onMouseUp(e)};c.onmousemove=function(e){d.onMouseMove(e)};c.ondragover=function(e){d.onDragOver(e)};c.ondragleave=function(e){d.onDragLeave(e)};c.ondrop=function(e){d.onDrop(e)
};window.onkeydown=function(e){d.onKeyDown(e)};window.onkeyup=function(e){d.onKeyUp(e)};c.ondblclick=function(e){d.onDoubleClick(e)}};nucleo.ViewInteractor.prototype.connectCamera=function(a){if(a instanceof nucleo.Camera){this.camera=a;this.camera.interactor=this}else{throw ("ViewInteractor.connectCamera: The object "+a+" is not a valid camera")}};nucleo.ViewInteractor.prototype.addKeyAction=function(c,d){var a=c.charCodeAt(0);this.keymap[a]=d};nucleo.ViewInteractor.prototype.removeKeyAction=function(c){var a=c.charCodeAt(0);
delete this.keymap[a]};nucleo.ViewInteractor.prototype.fireKeyAction=function(a){if(!this.keysEnabled){return}if(this.keymap[a]){this.keymap[a](this.view,this.camera)}};nucleo.ViewInteractor.prototype.enableKeyActions=function(a){this.keysEnabled=a};nucleo.TrackerInteractor=function TrackerInteractor(){nucleo.ViewInteractor.call(this);this.MOTION_FACTOR=10;this.task=nucleo.ViewInteractor.TASK.NONE;this._x=0;this._y=0;this._lastX=0;this._lastY=0;this._lastClickedX=0;this._lastClickedY=0;this._ctrl_key=false;
this._alt_key=false;this._shift_key=false;this._key=0;this._button=-1;this._dragging=false;this._dragndrop=false;this._is_mac=nucleo.util.isMac();this.addKeyAction("F",function(a,c){a.fullscreen(true)});this.addKeyAction("X",function(a,c){a.fullscreen(false)})};nucleo.TrackerInteractor.prototype=new nucleo.ViewInteractor();nucleo.TrackerInteractor.prototype.constructor=nucleo.TrackerInteractor;nucleo.TrackerInteractor.prototype.getType=function(){return"TrackerInteractor"};nucleo.TrackerInteractor.prototype.onKeyDown=function(e){this._key=e.keyCode;
this._alt_key=e.altKey;this._shift_key=e.shiftKey;var d=this.camera;if(!this._alt_key&&!this._shift_key){switch(this._key){case 38:d.changeElevation(10);break;case 40:d.changeElevation(-10);break;case 37:d.changeAzimuth(-10);break;case 39:d.changeAzimuth(10);break;default:this.fireKeyAction(this._key)}}else{if(this._shift_key&&this._key!=17){var c=0;var a=0;switch(this._key){case 38:a=10;break;case 40:a=-10;break;case 37:c=-10;break;case 39:c=10;break;default:this.fireKeyAction(this._key)}if(c!=0||a!=0){this.pan(c,a)
}}}this.camera.refresh()};nucleo.TrackerInteractor.prototype.onKeyUp=function(a){if(a.keyCode==17){this._ctrl_key=false}};nucleo.TrackerInteractor.prototype.onMouseUp=function(a){task=nucleo.ViewInteractor.TASK.NONE;this._dragging=false};nucleo.TrackerInteractor.prototype.onMouseDown=function(a){this._x=a.clientX;this._y=a.clientY;this._lastClickedX=this._x;this._lastClickedY=this._y;this._button=a.button;this._dragging=true};nucleo.TrackerInteractor.prototype.onMouseMove=function(a){this._lastX=this._x;
this._lastY=this._y;this._x=a.clientX;this._y=a.clientY;if(!this._dragging){return}if(this._button!=0){return}this._ctrl_key=a.ctrlKey;if(this._is_mac&&a.metaKey){this._ctrl_key=true}this._alt_key=a.altKey;this._shift_key=a.shiftKey;var d=this._x-this._lastX;var c=this._y-this._lastY;if(this._ctrl_key&&!this._shift_key){this.dolly(c)}else{if(this._shift_key&&!this._ctrl_key){this.pan(d,c)}else{if(this._ctrl_key&&this._shift_key){this.roll(c)}else{this.rotate(d,c)}}}this.camera.refresh()};nucleo.TrackerInteractor.prototype.onDragOver=function(a){a.stopPropagation();
a.preventDefault();if(this.view._dragndrop){if(!this._dragndrop){this.bgcolor=this.view.backgroundColor.slice(0);this._dragndrop=true}a.dataTransfer.dropEffect="copy";this.view.setBackgroundColor(0,0.514,0.678)}};nucleo.TrackerInteractor.prototype.onDragLeave=function(a){a.stopPropagation();a.preventDefault();if(this.view._dragndrop){a.dataTransfer.dropEffect="copy";this.view.setBackgroundColor(this.bgcolor);this._dragndrop=false}};nucleo.TrackerInteractor.prototype.onDrop=function(d){d.stopPropagation();
d.preventDefault();if(!this.view._dragndrop){return}this._dragndrop=false;this.view.setBackgroundColor(this.bgcolor);var c=d.dataTransfer.files;var a=new VTKReader(this.view.scene);if(a.isSupported()){a.readFile(c[0])}else{throw"TrackerInteractor.drop: File API is not supported on this browser"}};nucleo.TrackerInteractor.prototype.onDoubleClick=function(a){this.camera.longShot()};nucleo.TrackerInteractor.prototype.dolly=function(a){this.task=nucleo.ViewInteractor.TASK.DOLLY;this.camera.dolly(a)};
nucleo.TrackerInteractor.prototype.roll=function(e){this.task=nucleo.ViewInteractor.TASK.ROLL;var c=this.camera.view.canvas;var a=-20/c.width;var d=e*a*this.MOTION_FACTOR;this.camera.rotate(0,0,d)};nucleo.TrackerInteractor.prototype.rotate=function(d,a){this.task=nucleo.ViewInteractor.TASK.ROTATE;var h=this.camera.view.canvas;var l=-20/h.height;var k=-20/h.width;var e=this.MOTION_FACTOR;var c=this.MOTION_FACTOR;if(d*d>2*a*a){c*=0.5}else{if(a*a>2*d*d){e*=0.5}}var j=d*l*e;var f=a*k*c;this.camera.rotate(j,f)
};nucleo.TrackerInteractor.prototype.pan=function(n,m){this.task=nucleo.ViewInteractor.TASK.PAN;var f=this.camera;var a=f.view.canvas;var e=f.view.scene;this._dragndrop=false;var l=Math.max(a.width,a.height);var d=1/l;var c=1/l;var h=e.bb.max();var k=n*d*this.MOTION_FACTOR*h/2;var j=-m*c*this.MOTION_FACTOR*h/2;f.pan(k,j)};nucleo.PickerInteractor=function PickerInteractor(){nucleo.TrackerInteractor.call(this);this.timerID=-1;this.list=[];this.rate=50;this._actors=[];this._picking_list=[];this._picking_mode=false;
this._cellpicking=false};nucleo.PickerInteractor.prototype=new nucleo.TrackerInteractor();nucleo.PickerInteractor.prototype.constructor=nucleo.PickerInteractor;nucleo.PickerInteractor.prototype.setCellPicking=function(a){this._cellpicking=a};nucleo.PickerInteractor.prototype.getType=function(){return"PickerInteractor"};nucleo.PickerInteractor.prototype._getCoords=function(d){var a,j,h=0,f=0,e=this.view.canvas;var c=e.getBoundingClientRect();a=d.clientX-c.left;j=this.view.canvas.height-(d.clientY-c.top);
return[a,j]};nucleo.PickerInteractor.prototype._getActorAt=function(a,h){var e,d,c;var f=this.view.scene;c=this.view.renderer.readOffscreenPixel(a,h);if(c[0]==0&&c[1]==0&&c[2]==0&&c[3]==0){return null}d=nucleo.Picker.instance.query(c);if(d==null){return null}e=f.getActorByCellUID(d.uid);if(e==null){e=f.getActorByUID(d.uid)}if(e!=null&&e.isPickable()){return e}return null};nucleo.PickerInteractor.prototype.onMouseDown=function(d){nucleo.TrackerInteractor.prototype.onMouseDown.call(this,d);d.preventDefault();
this.view.canvas.style.cursor="crosshair";coords=this._getCoords(d);var c=this._getActorAt(coords[0],coords[1]);if(c==null){this._endPicking();return}var a=this._picking_list.indexOf(c.UID);if(a==-1){if(c._pick_callback!=undefined){c._pick_callback(c,c.UID)}this._picking_list.push(c.UID);this._actors.push(c)}else{this._picking_list.splice(a,1);this._actors.splice(a,1);if(c._unpick_callback){c._unpick_callback(c,c.UID)}}};nucleo.PickerInteractor.prototype.onMouseUp=function(a){nucleo.TrackerInteractor.prototype.onMouseUp.call(this,a);
if(!a.shiftKey){this.view.canvas.style.cursor="default";this._endPicking()}};nucleo.PickerInteractor.prototype.onMouseMove=function(a){a.preventDefault();nucleo.TrackerInteractor.prototype.onMouseMove.call(this,a)};nucleo.PickerInteractor.prototype.setCallback=function(a){this.callback=a};nucleo.PickerInteractor.prototype._endPicking=function(){if(this.callback){this.callback(this._actors)}var a=this._actors.length;while(a--){if(this._actors[a]._unpick_callback){this._actors[a]._unpick_callback(this._actors[a],this._actors[a].UID)
}}this._actors=[];this._picking_list=[]};nucleo.CellPickerInteractor=function CellPickerInteractor(){nucleo.TrackerInteractor.call(this);this.timerID=-1;this.list=[];this.rate=5};nucleo.CellPickerInteractor.prototype=new nucleo.TrackerInteractor();nucleo.CellPickerInteractor.prototype.constructor=nucleo.CellPickerInteractor;nucleo.CellPickerInteractor.prototype.getType=function(){return"CellPickerInteractor"};nucleo.CellPickerInteractor.prototype.get2DCoords=function(d){var a,j,h=0,f=0,e=this.view.canvas;
var c=e.getBoundingClientRect();a=d.clientX-c.left;j=this.view.canvas.height-(d.clientY-c.top);return[a,j]};nucleo.CellPickerInteractor.prototype.onMouseUp=function(a){nucleo.TrackerInteractor.prototype.onMouseUp.call(this,a);this.view.canvas.style.cursor="default";if(this.timerID!=-1){clearInterval(this.timerID)}};nucleo.CellPickerInteractor.prototype.onMouseDown=function(a){nucleo.TrackerInteractor.prototype.onMouseDown.call(this,a);a.preventDefault();this.view.canvas.style.cursor="crosshair";this.list.push(this.get2DCoords(a));
this._doWork();if(this.timerID!=-1){clearInterval(this.timerID)}this.timerID=setInterval((function(c){return function(){c._doWork()}})(this),this.rate)};nucleo.CellPickerInteractor.prototype.onMouseMove=function(a){a.preventDefault();if(this._dragging){this.list.push(this.get2DCoords(a))}};nucleo.CellPickerInteractor.prototype._doWork=function(){var d=this.list.length;var h=this.view.renderer;var j=this.view.scene;while(d--){var f=this.list.pop();var a=h.readOffscreenPixel(f[0],f[1]);if(a[0]==0&&a[1]==0&&a[2]==0&&a[3]==0){continue
}var c=nucleo.Picker.instance.query(a);if(c==null){continue}var e=j.getActorByCellUID(c.uid);if(e==null){e=j.getActorByUID(c.uid)}if(e!=null&&e.isPickable()&&e._pick_callback!=undefined){e._pick_callback(e,c.uid)}}};nucleo.CellPickerInteractor.prototype.onKeyDown=function(a){};nucleo.CellPickerInteractor.prototype.onKeyUp=function(a){};nucleo.CellPickerInteractor.prototype.onDragOver=function(a){};nucleo.CellPickerInteractor.prototype.onDragLeave=function(a){};nucleo.CellPickerInteractor.prototype.onDrop=function(a){};
nucleo.CellPickerInteractor.prototype.onDoubleClick=function(a){};nucleo.Transforms=function Transforms(a){this._stack=[];this.view=a;this.model_view=mat4.create();this.projection=mat4.create();this.camera=mat4.create();this.normal=mat4.create();this.projection_model_view=mat4.create()};nucleo.Transforms.prototype.calculateModelView=function(){this.model_view=mat4.copy(this.model_view,this.view.cameraman.active.getViewTransform())};nucleo.Transforms.prototype.calculateCamera=function(){this.camera=mat4.inverse(this.camera,this.model_view)
};nucleo.Transforms.prototype.calculateNormal=function(){this.normal=mat4.clone(this.model_view);this.normal=mat4.invert(mat4.create(),this.normal);this.normal=mat4.transpose(this.normal,this.normal)};nucleo.Transforms.prototype.calculateProjection=function(){var a=this.view.cameraman.active;a.updatePerspective();this.projection=a._perspective};nucleo.Transforms.prototype.calculateProjectionModelView=function(){mat4.multiply(this.projection_model_view,this.projection,this.model_view)};nucleo.Transforms.prototype.update=function(){this.calculateModelView();
this.calculateProjection();this.calculateNormal();this.calculateProjectionModelView()};nucleo.Transforms.prototype.push=function(){var a=mat4.create();mat4.copy(a,this.model_view);this._stack.push(a)};nucleo.Transforms.prototype.pop=function(){if(this._stack.length==0){return}this.model_view=this._stack.pop();this.calculatePerspective();this.calculateNormal();this.calculateProjectionModelView()};nucleo.Program=function Program(){this.ID=undefined;this.ATTRIBUTES=[];this.UNIFORMS=[];this.VERTEX_SHADER="";
this.FRAGMENT_SHADER="";this.DEFAULTS={}};nucleo.Program.prototype.copy=function(a){this.ID=a.ID;this.ATTRIBUTES=a.ATTRIBUTES;this.UNIFORMS=a.UNIFORMS;this.VERTEX_SHADER=a.VERTEX_SHADER;this.FRAGMENT_SHADER=a.FRAGMENT_SHADER;this.DEFAULTS=a.DEFAULTS};nucleo.Program.prototype.introspect=function(){this.ATTRIBUTES=[];this.UNIFORMS=[];var e=this.VERTEX_SHADER.concat(this.FRAGMENT_SHADER);e=e.replace(/(\r\n|\n\r|\n)/gm,"");var a=e.match(/(uniform)\s*\w*\s*\w*/g);var c=e.match(/(attribute)\s*\w*\s*\w*/g);
if(a.length==0){throw new nucleoProgramException("The code for the program "+this.ID+" does not contain any valid uniforms")}if(c.length==0){throw new nucleoProgramException("The code for the program "+this.ID+" does not contain any valid attributes")}for(var d=0,f=a.length;d<f;d+=1){this.UNIFORMS.push(a[d].substr(a[d].lastIndexOf(" ")+1,a[d].length))}for(var d=0,f=c.length;d<f;d+=1){this.ATTRIBUTES.push(c[d].substr(c[d].lastIndexOf(" ")+1,c[d].length))}};nucleo.Program.createFromDOM=function(h,c,a){var d=new Program();
d.ID=h;var f=document.getElementById(c);var e=document.getElementById(a);if(f==null||e==null){throw new nucleoProgramException("shaders don't exist")}d.VERTEX_SHADER=f.innerHTML;d.FRAGMENT_SHADER=e.innerHTML;d.introspect();return d};nucleo.Program.createFromJSON=function(a){var c=new nucleo.Program();if(a.ID){c.ID=a.ID}c.VERTEX_SHADER=a.VERTEX_SHADER;c.FRAGMENT_SHADER=a.FRAGMENT_SHADER;c.DEFAULTS=a.DEFAULTS;c.introspect();return c};nucleo.Program.createFromTextURL=function(d,c,a){};function nucleoProgramException(a){this.message="nucleoProgramException:"+a
}nucleo.LambertProgram=function LambertProgram(){this.copy(nucleo.Program.createFromJSON({ID:"lambert",VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec2 aVertexTextureCoords;","uniform float uPointSize;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mNormal;","uniform vec3 uLightDirection;","uniform vec4 uLightAmbient;","uniform vec4 uLightDiffuse;","uniform vec4 uMaterialDiffuse;","uniform bool uUseShading;","uniform bool uUseVertexColors;","uniform bool uUseLightTranslation;","uniform bool uUseTextures;","varying vec4 vFinalColor;","varying vec2 vTextureCoords;","void main(void) {","   gl_Position = mPerspective * mModelView * vec4(aVertexPosition, 1.0);","   gl_PointSize = uPointSize;","   if (uUseVertexColors) {","       vFinalColor = vec4(aVertexColor,uMaterialDiffuse.a);","   }","   else {","       vFinalColor = uMaterialDiffuse;","   }","   if (uUseShading){","       vec3 N = normalize(vec3(mNormal * vec4(aVertexNormal, 1.0)));","       vec3 L = normalize(uLightDirection);","       if (uUseLightTranslation){ L = vec3(mNormal * vec4(L,1.0));}","       float lambertTerm = max(dot(N,-L),0.4);","       vec4 Ia = uLightAmbient;","       vec4 Id = vFinalColor * uLightDiffuse * lambertTerm;","       vFinalColor = Ia + Id;","       vFinalColor.a = uMaterialDiffuse.a;","   }","   if (uUseTextures){","       vTextureCoords = aVertexTextureCoords;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","varying vec4      vFinalColor;","varying vec2      vTextureCoords;","uniform bool      uUseTextures;","uniform sampler2D uSampler;","void main(void)  {","   if (uUseTextures){","       gl_FragColor = texture2D(uSampler, vTextureCoords);","   }","   else{","       gl_FragColor = vFinalColor;","   }","}"].join("\n"),DEFAULTS:{uLightDirection:[0,0,-1],uLightAmbient:[0,0,0,1],uLightDiffuse:[1,1,1,1],uMaterialDiffuse:[0.9,0.9,0.9,1],uPointSize:1,uUseLightTranslation:false}}))
};nucleo.LambertProgram.prototype=new nucleo.Program();nucleo.LambertProgram.prototype.constructor=nucleo.LambertProgram;nucleo.ESSL.LAMBERT_PROGRAM=new nucleo.LambertProgram();nucleo.PhongProgram=function PhongProgram(){this.copy(nucleo.Program.createFromJSON({ID:"phong",VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec2 aVertexTextureCoords;","uniform float uPointSize;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mModelViewPerspective;","uniform mat4 mNormal;","uniform bool uUseVertexColors;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2 vTextureCoords;","uniform bool uUseTextures;","void main(void) {","  gl_Position = mPerspective * mModelView * vec4(aVertexPosition, 1.0);","  gl_PointSize = uPointSize;","   if(uUseVertexColors) {","       vFinalColor = vec4(aVertexColor,1.0);","       return;","   }","   vec4 vertex = mModelView * vec4(aVertexPosition, 1.0);","   vNormal = vec3(mNormal * vec4(aVertexNormal, 1.0));","   vEyeVec = -vec3(vertex.xyz);","   if (uUseTextures){","       vTextureCoords = aVertexTextureCoords;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","uniform bool uUseShading;","uniform bool uUseVertexColors;","uniform float uShininess;      ","uniform vec3 uLightDirection;  ","uniform vec4 uLightAmbient;    ","uniform vec4 uLightDiffuse;    ","uniform vec4 uLightSpecular;   ","uniform vec4 uMaterialAmbient; ","uniform vec4 uMaterialDiffuse; ","uniform vec4 uMaterialSpecular;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2      vTextureCoords;","uniform bool      uUseTextures;","uniform sampler2D uSampler;","void main(void)","{","  vec4 finalColor = vec4(0.0);","  vec3 L = normalize(uLightDirection);","  vec3 N = normalize(vNormal);","  float lambertTerm = dot(N,-L);","  vec4 Ia = uLightAmbient * uMaterialAmbient;","  vec4 Id = vec4(0.0,0.0,0.0,1.0);","  vec4 Is = vec4(0.0,0.0,0.0,1.0);","  vec4 varMaterialDiffuse = uMaterialDiffuse;","  if(uUseVertexColors) {","        varMaterialDiffuse = vFinalColor;","   }","  if(uUseShading){  ","      if(lambertTerm > 0.0)","      {","          Id = uLightDiffuse * varMaterialDiffuse * lambertTerm;","          vec3 E = normalize(vEyeVec);","          vec3 R = reflect(L, N);","          float specular = pow( max(dot(R, E), 0.0), uShininess);","          Is = uLightSpecular * uMaterialSpecular * specular;","      }","      finalColor = Ia + Id + Is;","      finalColor.a = uMaterialDiffuse.a;","  } ","  else {","      finalColor = varMaterialDiffuse; ","  }","   if (uUseTextures){","       finalColor =  texture2D(uSampler, vec2(vTextureCoords.s, vTextureCoords.t));","   }","   gl_FragColor = finalColor;","}"].join("\n"),DEFAULTS:{uShininess:230,uLightDirection:[0,-1,-1],uLightAmbient:[0.03,0.03,0.03,1],uLightDiffuse:[1,1,1,1],uLightSpecular:[1,1,1,1],uMaterialAmbient:[1,1,1,1],uMaterialDiffuse:[0.8,0.8,0.8,1],uMaterialSpecular:[1,1,1,1]}}))
};nucleo.PhongProgram.prototype=new nucleo.Program();nucleo.PhongProgram.prototype.constructor=nucleo.PhongProgram;nucleo.ESSL.PHONG_PROGRAM=new nucleo.PhongProgram();nucleo.BakeProgram=function BakeProgram(){this.copy(nucleo.Program.createFromJSON({ID:"bake",VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec3 aPosition;","attribute vec3 aScale;","attribute float aShading;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mNormal;","uniform mat4 mModelViewPerspective;","uniform vec3 uLightDirection;","uniform vec4 uLightAmbient;","uniform vec4 uLightDiffuse;","uniform bool uUseLightTranslation;","varying vec4 vFinalColor;","void main(void) {","   vec3 position = (aVertexPosition * aScale) + aPosition;","   gl_Position = mModelViewPerspective * vec4(position, 1.0);","   vFinalColor = vec4(aVertexColor,1.0);","   if (aShading == 1.0){","      vec3 N = vec3(mNormal * vec4(aVertexNormal, 1.0));","      vec3 L = normalize(uLightDirection);","      if (uUseLightTranslation) { L = vec3(mNormal * vec4(L,1.0));}","      float lambertTerm = max(dot(N,-L),0.4);","      vec4 Ia = uLightAmbient;","      vec4 Id = vFinalColor * uLightDiffuse * lambertTerm;","      vFinalColor = Ia + Id;","      vFinalColor.a = 1.0;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","varying vec4  vFinalColor;","void main(void)  {","       gl_FragColor = vFinalColor;","}"].join("\n"),DEFAULTS:{uLightDirection:[0,0,-1],uLightAmbient:[0,0,0,1],uLightDiffuse:[1,1,1,1],uUseLightTranslation:false}}))
};nucleo.BakeProgram.prototype=new nucleo.Program();nucleo.BakeProgram.prototype.constructor=nucleo.BakeProgram;nucleo.ESSL.BAKE_PROGRAM=new nucleo.BakeProgram();nucleo.DashProgram=function DashProgram(){this.copy(nucleo.Program.createFromJSON({ID:"dash",VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec2 aVertexTextureCoords;","attribute mat4 aActorMatrix;","uniform float uPointSize;","uniform bool uUseTextures;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mModelViewPerspective;","uniform mat4 mNormal;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2 vTextureCoords;","void main(void) {","  mat4 matrix = aActorMatrix; ","  gl_Position =  mPerspective * mModelView * matrix * vec4(aVertexPosition, 1.0);","  gl_PointSize = uPointSize;","  vFinalColor = vec4(aVertexColor,1.0);","  vec4 vertex = mModelView * vec4(aVertexPosition, 1.0);","  vNormal = vec3(mNormal * vec4(aVertexNormal, 1.0));","  vEyeVec = -vec3(vertex.xyz);","  if (uUseTextures){","       vTextureCoords = aVertexTextureCoords;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","uniform bool uUseShading;","uniform float uShininess;      ","uniform vec3 uLightDirection;  ","uniform vec4 uLightAmbient;    ","uniform vec4 uLightDiffuse;    ","uniform vec4 uLightSpecular;   ","uniform vec4 uMaterialAmbient; ","uniform vec4 uMaterialDiffuse; ","uniform vec4 uMaterialSpecular;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2      vTextureCoords;","uniform bool      uUseTextures;","uniform sampler2D uSampler;","void main(void)","{","  vec4 finalColor = vec4(0.0);","  vec3 L = normalize(uLightDirection);","  vec3 N = normalize(vNormal);","  float lambertTerm = dot(N,-L);","  vec4 Ia = uLightAmbient * uMaterialAmbient;","  vec4 Id = vec4(0.0,0.0,0.0,1.0);","  vec4 Is = vec4(0.0,0.0,0.0,1.0);","  vec4 varMaterialDiffuse = vFinalColor;","  if(uUseShading){  ","      if(lambertTerm > 0.0)","      {","          Id = uLightDiffuse * varMaterialDiffuse * lambertTerm;","          vec3 E = normalize(vEyeVec);","          vec3 R = reflect(L, N);","          float specular = pow( max(dot(R, E), 0.0), uShininess);","          Is = uLightSpecular * uMaterialSpecular * specular;","      }","      finalColor = Ia + Id + Is;","      finalColor.a = uMaterialDiffuse.a;","  } ","  else {","      finalColor = varMaterialDiffuse; ","  }","   if (uUseTextures){","       finalColor =  texture2D(uSampler, vec2(vTextureCoords.s, vTextureCoords.t));","   }","   gl_FragColor = finalColor;","}"].join("\n"),DEFAULTS:{uUseTextures:false,uShininess:230,uLightDirection:[0,-1,-1],uLightAmbient:[0.03,0.03,0.03,1],uLightDiffuse:[1,1,1,1],uLightSpecular:[1,1,1,1],uMaterialAmbient:[1,1,1,1],uMaterialDiffuse:[0.8,0.8,0.8,1],uMaterialSpecular:[1,1,1,1]}}))
};nucleo.DashProgram.prototype=new nucleo.Program();nucleo.DashProgram.prototype.constructor=nucleo.DashProgram;nucleo.ESSL.DASH_PROGRAM=new nucleo.DashProgram();nucleo.ProgramManager=function ProgramManager(a){this._gl=a;this._registered_programs={};this._programs={};this._uniform_map={};this._uniform_types={};this._current_program_object=null;this._current_program_ID=undefined;this._curr_uniform_loc_map={};this._curr_uniform_cache={};this._curr_attribute_loc_map={};this._enabled_attribute_list=[];
this._defaults=[];this._one_time_warning=false;this._program_enforced=false};nucleo.ProgramManager.prototype._isProgramRegistered=function(a){return(this._registered_programs[a]!=undefined)};nucleo.ProgramManager.prototype._registerProgram=function(a){nucleo.util.console("Registering program "+a.ID);this._registered_programs[a.ID]=a};nucleo.ProgramManager.prototype._isProgramCreated=function(a){return(this._programs[a]!=undefined)};nucleo.ProgramManager.prototype._createProgramObject=function(c){if(this._isProgramCreated(c)){return
}var f=this._registered_programs[c];if(f==undefined){var e="ProgramManager.loadProgram ERROR:  The program "+c+" must be registered first!";console.error(e);return}var j=this._gl;var d=j.createProgram();var h=nucleo.ESSL;if(f.VERTEX_SHADER){var k=this._createShader(h.VERTEX_SHADER,f.VERTEX_SHADER);j.attachShader(d,k)}if(f.FRAGMENT_SHADER){var a=this._createShader(h.FRAGMENT_SHADER,f.FRAGMENT_SHADER);j.attachShader(d,a)}j.bindAttribLocation(d,0,h.VERTEX_ATTRIBUTE);j.linkProgram(d);if(!j.getProgramParameter(d,j.LINK_STATUS)){alert(c+":\n\n "+j.getProgramInfoLog(d));
throw ("Error linking program "+c+":\n\n "+j.getProgramInfoLog(d))}this._programs[c]=d};nucleo.ProgramManager.prototype.useProgram=function(a){var d=this._gl;var c=this._programs[a];if(c!=undefined&&c!=null){if(c==this._current_program_object){return}d.useProgram(c);this._current_program_object=c;this._current_program_ID=a;this._parseUniforms();this._one_time_warning=false}else{alert("Program: the program "+a+" has NOT been loaded")}};nucleo.ProgramManager.prototype.releaseProgram=function(){this._enforce=false
};nucleo.ProgramManager.prototype.setProgram=function(c,e){var a=undefined;if(typeof c=="function"){a=new c()}else{if(typeof c=="object"){a=c}else{console.error("ProgramManager.setProgram ERROR: "+c+" is not an engine");return}}if(this._enforce&&a.ID!=this._current_program_id){var d="ProgramManager.setProgram WARN: Unable to set the program "+a.ID+".\nThe current program ["+a.ID+"] is being enforced\nPlease use releaseProgram first.";console.warn(d);return}this._program_enforced=(e!=undefined&&e==true);
if(!this._isProgramRegistered(a.ID)){this._registerProgram(a)}if(!this._isProgramCreated(a.ID)){this._createProgramObject(a.ID)}this.useProgram(a.ID);this.clearCache();this.loadDefaults()};nucleo.ProgramManager.prototype.clearCache=function(){this._curr_uniform_cache={};this._curr_uniform_loc_map={};this._curr_attribute_loc_map={}};nucleo.ProgramManager.prototype.loadDefaults=function(){var c=this._registered_programs[this._current_program_ID];if("DEFAULTS" in c){var d=c.DEFAULTS;for(var a in d){this.setUniform(a,d[a])
}}var d=this._defaults[this._current_program_ID];if(d!=undefined){for(var a in d){this.setUniform(a,d[a])}}};nucleo.ProgramManager.prototype.setDefault=function(c,a,d){if(this._defaults[c]==undefined){this._defaults[c]={}}this._defaults[c][a]=d;if(c==this._current_program_ID){this.setUniform(a,d)}};nucleo.ProgramManager.prototype.getDefault=function(c,a){if(this._defaults[c]==undefined){return undefined}return this._defaults[c][a]};nucleo.ProgramManager.prototype.setUniforms=function(a){for(key in a){this.setUniform(key,a[key])
}};nucleo.ProgramManager.prototype.setUniform=function(n,l,e){var f=this._gl;var c=this._current_program_object;var m=this._uniform_map[this._current_program_ID];var a=this._curr_uniform_loc_map;var d=this._curr_uniform_cache;var o=this._uniform_types[this._current_program_ID];var j=undefined;var h=false;if(m.indexOf(n)==-1){console.warn("ProgramManager.setUniform: the uniform "+n+" is not defined for the program "+this._current_program_ID);return}j=a[n];if(j==undefined){j=f.getUniformLocation(c,n);
a[n]=j}var q=d[n];var k=o[n];if(q==undefined){h=true}else{switch(k){case"sampler2D":case"float":case"int":case"bool":h=(q!==l);break;case"mat4":h=((l[0]!==q[0])||(l[1]!==q[1])||(l[2]!==q[2])||(l[3]!==q[3])||(l[4]!==q[4])||(l[5]!==q[5])||(l[6]!==q[6])||(l[7]!==q[7])||(l[8]!==q[8])||(l[9]!==q[9])||(l[10]!==q[10])||(l[11]!==q[11])||(l[12]!==q[12])||(l[13]!==q[13])||(l[14]!==q[14])||(l[15]!==q[15]));break;case"vec3":h=((l[0]!==q[0])||(l[1]!==q[1])||(l[2]!==q[2]));break;case"vec4":h=((l[0]!==q[0])||(l[1]!==q[1])||(l[2]!==q[2])||(l[3]!==q[3]));
break;default:h=true}}if(h){switch(k){case"float":case"int":case"bool":d[n]=l;break;case"mat4":d[n]=mat4.clone(l);break;case"mat3":d[n]=mat3.clone(l);break;case"vec4":d[n]=vec4.clone(l);break;case"vec3":d[n]=vec3.clone(l);break;case"vec2":d[n]=vec2.clone(l);break;case"sampler2D":d[n]=l;break;default:alert("error: type unknown cannot update uniform cache")}this._setPolymorphicUniform(n,j,l,e)}};nucleo.ProgramManager.prototype.getUniform=function(a){return this._curr_uniform_cache[a]};nucleo.ProgramManager.prototype.setAttributePointer=function(e,c,h,f,j,k){var d=this._getAttributeLocation(e);
this._gl.vertexAttribPointer(d,c,h,f,j,k)};nucleo.ProgramManager.prototype.enableAttribute=function(d){if(this._enabled_attribute_list.indexOf(d)!=-1){return}var c=this._getAttributeLocation(d);this._gl.enableVertexAttribArray(c);this._enabled_attribute_list.push(d)};nucleo.ProgramManager.prototype.disableAttribute=function(c){if(c==undefined){return}var a=this._enabled_attribute_list.indexOf(c);if(a>=0){var d=this._getAttributeLocation(c);this._gl.disableVertexAttribArray(d);this._enabled_attribute_list.splice(a,1)
}};nucleo.ProgramManager.prototype._createShader=function(a,d){var e=this._gl;var c=null;if(a==nucleo.ESSL.VERTEX_SHADER){c=e.createShader(e.VERTEX_SHADER)}else{if(a==nucleo.ESSL.FRAGMENT_SHADER){c=e.createShader(e.FRAGMENT_SHADER)}}if(d==undefined||d==null){alert("Error getting the code for shader of type "+a)}e.shaderSource(c,d);e.compileShader(c);if(!e.getShaderParameter(c,e.COMPILE_STATUS)){alert(a+":\n\n "+e.getShaderInfoLog(c));throw ("Error compiling shader "+a+":\n\n "+e.getShaderInfoLog(c))
}return c};nucleo.ProgramManager.prototype._parseUniforms=function(e){vs=this._registered_programs[this._current_program_ID].VERTEX_SHADER;fs=this._registered_programs[this._current_program_ID].FRAGMENT_SHADER;uNames=this._registered_programs[this._current_program_ID].UNIFORMS;uTypes={};for(var a=0;a<uNames.length;a++){var c=uNames[a];var d=new RegExp("uniform\\s+\\w+\\s"+c,"g");if(vs.search(d)!=-1){uTypes[c]=vs.substring(vs.search(d),vs.length).substring(0,vs.indexOf(";")).split(" ")[1]}else{if(fs.search(d)!=1){uTypes[c]=fs.substring(fs.search(d),fs.length).substring(0,fs.indexOf(";")).split(" ")[1]
}else{alert("Program: In the program "+this._current_program_ID+" the uniform "+c+" is listed but not used")}}}this._uniform_map[this._current_program_ID]=uNames;this._uniform_types[this._current_program_ID]=uTypes};nucleo.ProgramManager.prototype._getAttributeLocation=function(a){var c=this._curr_attribute_loc_map[a];if(c!=undefined){return c}c=this._gl.getAttribLocation(this._current_program_object,a);if(c==-1){console.error("ProgramManager._getAttributeLocation ERROR: the attribute "+a+"could not be located");
c=undefined}else{this._curr_attribute_loc_map[a]=c}return c};nucleo.ProgramManager.prototype._setPolymorphicUniform=function(e,c,d,h){var f=this._gl;var a=this._uniform_types[this._current_program_ID][e];if(a=="bool"){f.uniform1i(c,d);return}else{if(a=="float"){f.uniform1f(c,d);return}else{if(a=="int"||a=="sampler2D"){f.uniform1i(c,d);return}else{if(a=="mat4"){f.uniformMatrix4fv(c,false,d);return}else{if(d instanceof Array||d instanceof Float32Array){if(d.length==3&&a=="vec4"){d[3]=1;if(!this._one_time_warning){alert("The uniform "+e+" has only 3 components but Nucleo needs 4. This is a one time warning");
this._one_time_warning=true}}if(h=="int"){switch(d.length){case 1:f.uniform1iv(c,d);break;case 2:f.uniform2iv(c,d);break;case 3:f.uniform3iv(c,d);break;case 4:f.uniform4iv(c,d);break;default:alert("ERROR")}}else{switch(d.length){case 1:f.uniform1fv(c,d);break;case 2:f.uniform2fv(c,d);break;case 3:f.uniform3fv(c,d);break;case 4:f.uniform4fv(c,d);break;default:alert("ERROR")}}}else{alert("Program: ERROR. The uniform  "+e+" could not be mapped")}}}}}};nucleo.Renderer=function Renderer(a){this.view=a;
this.renderRate=nucleo.Renderer.RATE.NORMAL;this.mode=nucleo.Renderer.MODE.TIMER;this.fps=0;this.engine=undefined;this._time=0;this._startDate=0;this._running=false;this.setEngine(nucleo.RenderEngine);this.setProgram(nucleo.ESSL.LAMBERT_PROGRAM)};nucleo.Renderer.MODE=nucleo.define.Renderer.MODE;nucleo.Renderer.RATE=nucleo.define.Renderer.RATE;nucleo.Renderer.prototype.setEngine=function(c){var a=undefined;if(typeof c=="function"){a=new c()}else{if(typeof c=="object"){a=c}else{console.warn("Renderer.setEngine WARN: "+c+" is not an engine");
console.warn("Renderer.setEngine WARN: using RenderEngine by default");a=new RenderEngine()}}a.init(this);this.engine=a};nucleo.Renderer.prototype.setProgram=function(a,c){this.engine.setProgram(a,c)};nucleo.Renderer.prototype.releaseProgram=function(){this.engine.releaseProgram()};nucleo.Renderer.prototype.clear=function(){this.engine.clear()};nucleo.Renderer.prototype.clearColor=function(d,c,a){this.engine.clearColor(d,c,a)};nucleo.Renderer.prototype.clearDepth=function(a){this.engine.clearDepth(a)
};nucleo.Renderer.prototype.reallocate=function(){this.engine.allocate(this.view.scene)};nucleo.Renderer.prototype.disableOffscreen=function(){this.engine.disableOffscreen()};nucleo.Renderer.prototype.enableOffscreen=function(){this.engine.enableOffscreen()};nucleo.Renderer.prototype.isOffscreenEnabled=function(){return this.engine.isOffscreenEnabled()};nucleo.Renderer.prototype.readOffscreenPixel=function(a,c){return this.engine.readOffscreenPixel(a,c)};nucleo.Renderer.prototype.setMode=function(a){if(this._running){this.stop();
this.mode=a;this.start()}else{this.mode=a}};nucleo.Renderer.prototype.start=function(){this._running=true;this._startDate=new Date().getTime();this._time=0;switch(this.mode){case nucleo.Renderer.MODE.TIMER:nucleo.util.console("Renderer [TIMER]: starting rendering for view ["+this.view.name+"] at "+this.renderRate+"ms");this._timeUp();break;case nucleo.Renderer.MODE.ANIMFRAME:nucleo.util.console("Renderer [ANIMFRAME]: starting request animation frame procedure",true);var a=this;function c(){this.render();
window.requestAnimFrame(c.bind(a))}c.bind(this)();break;case nucleo.Renderer.MODE.ON_DEMAND:nucleo.util.console("Renderer [ON_DEMAND]: waiting for rendering requests",true);this.clear();break}};nucleo.Renderer.prototype.doBeforeRendering=function(a){this._do_before_rendering=a};nucleo.Renderer.prototype.doAfterRendering=function(a){this._do_after_rendering=a};nucleo.Renderer.prototype._timeUp=function(){if(!this._running||this.mode==nucleo.Renderer.MODE.ANIMFRAME){return}this.render();if(this._time==this.renderRate*100){this._time=0;
this._startDate=new Date().getTime()}this._time+=this.renderRate;var a=(new Date().getTime()-this._startDate)-this._time;if(a>this.renderRate){a=0}setTimeout((function(c){return function(){c._timeUp()}})(this),this.renderRate-a)};nucleo.Renderer.prototype.stop=function(){if(this.mode==nucleo.Renderer.MODE.TIMER){this._running=false}else{if(this.mode==nucleo.Renderer.MODE.ANIMFRAME){nucleo.go.renderman.cancel()}}};nucleo.Renderer.prototype.setRenderRate=function(a){if(a==undefined||a<=0){throw"Renderer.setRenderRate: the rate cannot be zero or undefined"
}if(this.mode==nucleo.Renderer.MODE.ANIMFRAME){throw"Renderer.setRenderRate: if the mode is ANIMFRAME render rate is irrelevant"}this.stop();this.renderRate=a;this.start();nucleo.util.console("Renderer: view["+this.view.name+"], render rate = "+a,true)};nucleo.Renderer.prototype.render=function(){var c=this.engine,d=this.view.scene,e=undefined,a=undefined;if(this._do_before_rendering){this._do_before_rendering()}this.clear();c.allocate(d);e=new Date().getTime();c.render(d);a=new Date().getTime()-e;
c.deallocate(d);if(a>0){this.fps=Math.round((this.fps*0.8+(1000/a)*0.2)*100)/100}if(this._do_after_rendering){this._do_after_rendering()}};function vxlRendererException(a){this.message=a}nucleo.RenderTarget=function RenderTarget(a){this.canvas=a._view.canvas;this.texture=null;this.framebuffer=null;this.renderbuffer=null;this.gl=a.gl;this.configure()};nucleo.RenderTarget.prototype.configure=function(){var c=this.canvas.width;var a=this.canvas.height;var d=this.gl;this.texture=d.createTexture();d.bindTexture(d.TEXTURE_2D,this.texture);
d.texImage2D(d.TEXTURE_2D,0,d.RGBA,c,a,0,d.RGBA,d.UNSIGNED_BYTE,null);this.renderbuffer=d.createRenderbuffer();d.bindRenderbuffer(d.RENDERBUFFER,this.renderbuffer);d.renderbufferStorage(d.RENDERBUFFER,d.DEPTH_COMPONENT16,c,a);this.framebuffer=d.createFramebuffer();d.bindFramebuffer(d.FRAMEBUFFER,this.framebuffer);d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,this.texture,0);d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_ATTACHMENT,d.RENDERBUFFER,this.renderbuffer);d.bindTexture(d.TEXTURE_2D,null);
d.bindRenderbuffer(d.RENDERBUFFER,null);d.bindFramebuffer(d.FRAMEBUFFER,null)};nucleo.RenderTarget.prototype.update=function(){var d=this.gl;var c=this.canvas.width;var a=this.canvas.height;d.bindTexture(d.TEXTURE_2D,this.texture);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,c,a,0,d.RGBA,d.UNSIGNED_BYTE,null);d.bindRenderbuffer(d.RENDERBUFFER,this.renderbuffer);d.renderbufferStorage(d.RENDERBUFFER,d.DEPTH_COMPONENT16,c,a)};nucleo.RenderTarget.prototype.readPixel=function(a,e){var d=this.gl;var c=new Uint8Array(1*1*4);
d.bindFramebuffer(d.FRAMEBUFFER,this.framebuffer);d.readPixels(a,e,1,1,d.RGBA,d.UNSIGNED_BYTE,c);d.bindFramebuffer(d.FRAMEBUFFER,null);return c};nucleo.Model=function Model(a,c){this.UID=nucleo.util.generateUID();this.name=a;this.indices=[];this.vertices=[];this.scalars=undefined;this.diffuse=undefined;this.ambient=undefined;this.specular=undefined;this.shininness=undefined;this.normals=undefined;this.wireframe=undefined;this.bb=[0,0,0,0,0,0];this.centre=[0,0,0,0,0,0];this.mode=nucleo.Actor.MODE.SOLID;
this.image=undefined;this.uri=undefined;this.colors=undefined;this.type=nucleo.Model.TYPE.SIMPLE;this.renderable=undefined;if(c!=undefined){this.load(this.name,c)}this.setType(this.type)};nucleo.Model.LOADING_MODE=nucleo.define.Model.LOADING_MODE;nucleo.Model.MAX_NUM_INDICES=nucleo.define.Model.MAX_NUM_INDICES;nucleo.Model.TYPE=nucleo.define.Model.TYPE;nucleo.Model.BB_INDICES=[0,1,1,2,2,3,3,0,0,4,4,5,5,6,6,7,7,4,1,5,2,6,3,7];nucleo.Model.prototype.setType=function(a){if(this.indices.max()<nucleo.Model.MAX_NUM_INDICES&&a==nucleo.Model.TYPE.BIG_DATA){throw ("The model is not big enough to be of BIG_DATA type. Max index found: "+this.indices.max())
}this.type=a};nucleo.Model.prototype.load=function(a,c){if(a==undefined){throw"Model.load ERROR: the object must have a name"}this.name=a.replace(/\.[^/.]+$/,"");if(c.name!=null){this.name=c.name}for(i in c){this[i]=c[i]}this.update()};nucleo.Model.prototype.update=function(){if(this.vertices==undefined){alert("The model "+this.name+" does not have vertices. Impossible to render!")}if(this.normals==undefined&&this.indices!=undefined&&this.mode!=nucleo.Actor.MODE.LINES){this.computeNormals()}if(this.wireframe==undefined){this.computeWireframeIndices()
}if(this.mode==undefined){this.mode=nucleo.Actor.MODE.SOLID}if(this.texture!=undefined){this.mode=nucleo.Actor.MODE.TEXTURED}this.computeBoundingBox();if(this.type==nucleo.Model.TYPE.SIMPLE&&this.indices.max()>nucleo.Model.MAX_NUM_INDICES){this.setType(nucleo.Model.TYPE.BIG_DATA);console.info("the model "+this.name+" type is BIG_DATA")}};nucleo.Model.prototype.computeNormals=function(){var s=this.vertices,a=this.indices,n=0,k=1,h=2;var l=[];for(var d=0;d<s.length;d=d+3){l[d+n]=0;l[d+k]=0;l[d+h]=0
}for(var d=0;d<a.length;d=d+3){var o=[];var m=[];var f=[];o[n]=s[3*a[d+2]+n]-s[3*a[d+1]+n];o[k]=s[3*a[d+2]+k]-s[3*a[d+1]+k];o[h]=s[3*a[d+2]+h]-s[3*a[d+1]+h];m[n]=s[3*a[d]+n]-s[3*a[d+1]+n];m[k]=s[3*a[d]+k]-s[3*a[d+1]+k];m[h]=s[3*a[d]+h]-s[3*a[d+1]+h];f[n]=o[k]*m[h]-o[h]*m[k];f[k]=o[h]*m[n]-o[n]*m[h];f[h]=o[n]*m[k]-o[k]*m[n];for(var c=0;c<3;c++){l[3*a[d+c]+n]=l[3*a[d+c]+n]+f[n];l[3*a[d+c]+k]=l[3*a[d+c]+k]+f[k];l[3*a[d+c]+h]=l[3*a[d+c]+h]+f[h]}}for(var d=0;d<s.length;d=d+3){var q=[];q[n]=l[d+n];q[k]=l[d+k];
q[h]=l[d+h];var e=Math.sqrt((q[n]*q[n])+(q[k]*q[k])+(q[h]*q[h]));if(e==0){e=1}q[n]=q[n]/e;q[k]=q[k]/e;q[h]=q[h]/e;l[d+n]=q[n];l[d+k]=q[k];l[d+h]=q[h]}this.normals=l};nucleo.Model.prototype.flipNormals=function(){var c=this.normals;if(c==undefined){return}for(var a=0;a<c.length;a+=1){c[a]=-c[a]}};nucleo.Model.prototype.computeWireframeIndices=function(){var e=this.indices;var d=[];var a=0;for(var c=0;c<e.length;c=c+3){d[a]=e[c];d[a+1]=e[c+1];d[a+2]=e[c+1];d[a+3]=e[c+2];d[a+4]=e[c+2];d[a+5]=e[c];a=a+6
}this.wireframe=d};nucleo.Model.prototype.computeBoundingBox=function(){if(this.vertices.length==0){this.bb=[0,0,0,0,0,0];this.centre=[0,0,0,0,0,0];return}var f=this.vertices;var a=[f[0],f[1],f[2],f[0],f[1],f[2]];var d=f.length;for(d=0,N=f.length;d<N;d=d+3){a[0]=Math.min(a[0],f[d]);a[1]=Math.min(a[1],f[d+1]);a[2]=Math.min(a[2],f[d+2]);a[3]=Math.max(a[3],f[d]);a[4]=Math.max(a[4],f[d+1]);a[5]=Math.max(a[5],f[d+2])}var e=[0,0,0];e[0]=(a[3]+a[0])/2;e[1]=(a[4]+a[1])/2;e[2]=(a[5]+a[2])/2;this.bb=a;this.centre=e
};nucleo.Model.prototype.getBoundingBoxVertices=function(){var a=this.bb;return[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5],a[3],a[1],a[5]]};nucleo.Cell=function Cell(e,d,c,a){this.UID=nucleo.util.generateUID();this.mesh=e;this.index=d;this.vertices=c;this.color=a==undefined?[0.8,0.8,0.8]:a;this.normal=[0,0,0];this.position=[0,0,0];this._calculatePosition();this._calculateNormal();this._pickingColor=nucleo.Picker.instance.getColorFor(this)
};nucleo.Cell.prototype._calculatePosition=function(){this.position[0]=(this.vertices[0][0]+this.vertices[1][0]+this.vertices[2][0])/3;this.position[1]=(this.vertices[0][1]+this.vertices[1][1]+this.vertices[2][1])/3;this.position[2]=(this.vertices[0][2]+this.vertices[1][2]+this.vertices[2][2])/3};nucleo.Cell.prototype._calculateNormal=function(){var c=vec3.subtract(vec3.create(),this.vertices[1],this.vertices[0]);var a=vec3.subtract(vec3.create(),this.vertices[2],this.vertices[0]);this.normal=vec3.normalize(this.normal,vec3.cross(this.normal,c,a))
};nucleo.Cell.prototype.getFlattenVertices=function(){var a=this.vertices;return[a[0][0],a[0][1],a[0][2],a[1][0],a[1][1],a[1][2],a[2][0],a[2][1],a[2][2]]};nucleo.Cell.prototype.setColor=function(d,c,a){this.color=nucleo.util.createArr3(d,c,a);this.mesh._updateCellColor(this.index)};nucleo.Mesh=function Mesh(a){if(a==undefined){throw ("Mesh: the model passed as parameter cannot be undefined")}this.name=a.name+"-mesh";this.cells=[];this.color=[0.8,0.8,0.8];this.actor=a;this.model=undefined;this._createMesh(a)
};nucleo.Mesh.prototype.setColor=function(a){this.color=a;this._setModelColor(this.color)};nucleo.Mesh.prototype.scalarsToCellColors=function(a,c){};nucleo.Mesh.prototype.updateColor=function(){var c=this.model;c.colors=[];c.pickingColors=[];for(var d=0,e=this.cells.length;d<e;d+=1){for(var a=0;a<3;a+=1){c.colors.push.apply(c.colors,this.cells[d].color);c.pickingColors.push.apply(c.pickingColors,this.cells[d]._pickingColor)}}this.actor.updateRenderable()};nucleo.Mesh.prototype.hasCell=function(a){var c=this.cells.length;
while(c--){if(this.cells[c].UID==a){return true}}return false};nucleo.Mesh.prototype.getCell=function(a){var c=this.cells.length;while(c--){if(this.cells[c].UID==a){return this.cells[c]}}return null};nucleo.Mesh.prototype.removeCell=function(c){var a=-1;var d=this.cells.length;while(d--){if(this.cells[d].UID==c){a=d;break}}if(a!=-1){this.cells.splice(a,1);this._createModel()}};nucleo.Mesh.prototype.intersect=function(c,d){var a=c._forward;selection=[];return selection};nucleo.Mesh.prototype._createMesh=function(d){var e=d.model;
var a=e.vertices;var f=e.indices;var c=this;this.cells=[];function h(){var j=new Date().getTime();var o=0;var m=[c.color[0],c.color[1],c.color[2]];for(var k=0,q=f.length;k<q;k+=3){u=f[k];var l=[],t,s,n,u;t=a[u*3];s=a[u*3+1];n=a[u*3+2];l.push([t,s,n]);u=f[k+1];t=a[u*3];s=a[u*3+1];n=a[u*3+2];l.push([t,s,n]);u=f[k+2];t=a[u*3];s=a[u*3+1];n=a[u*3+2];l.push([t,s,n]);c.cells.push(new Cell(c,o,l,m));o+=1}c._createModel();var v=new Date().getTime()-j;console.info("Mesh ["+c.name+"] generated in "+v+" ms")
}setTimeout(function(){h()},0)};nucleo.Mesh.prototype._createModel=function(){var c=new Model(this.name+"-model");c.colors=[];c.pickingColors=[];for(var d=0,e=this.cells.length;d<e;d+=1){c.indices.push.apply(c.indices,[d*3,d*3+1,d*3+2]);c.vertices.push.apply(c.vertices,this.cells[d].getFlattenVertices());for(var a=0;a<3;a+=1){c.colors.push.apply(c.colors,this.cells[d].color);c.pickingColors.push.apply(c.pickingColors,this.cells[d]._pickingColor)}}c.computeNormals();c.setType(define.Model.TYPE.MESH);
this.model=c;this.actor.updateRenderable(Renderable.TASK.CREATE)};nucleo.Mesh.prototype._setModelColor=function(a){if(this.model==undefined){return}var d=this.model;d.colors=[];for(var e=0,f=this.cells.length;e<f;e+=1){this.cells[e].color=[a[0],a[1],a[2]];for(var c=0;c<3;c+=1){d.colors.push.apply(d.colors,this.cells[e].color)}}this.actor.updateRenderable(Renderable.TASK.CREATE)};nucleo.Mesh.prototype._updateCellColor=function(c){var a=this.cells[c].color;for(var d=c*9,e=c*9+9;d<e;d+=3){this.model.colors[d]=a[0];
this.model.colors[d+1]=a[1];this.model.colors[d+2]=a[2]}this.actor.updateRenderable(Renderable.TASK.UPDATE_COLORS)};nucleo.Actor=function(a){this._bb=[0,0,0,0,0,0];this._position=vec3.fromValues(0,0,0);this._translation=vec3.fromValues(0,0,0);this._centre=vec3.fromValues(0,0,0);this._scale=vec3.fromValues(1,1,1);this._rotation=vec3.fromValues(0,0,0);this._matrix=mat4.create();this._matrix_world=mat4.create();this._matrix_normal=mat4.create();this._matrix_pmv=mat4.create();this._dirty=false;this._picking=nucleo.Actor.PICKING.DISABLED;
this._pickCallback=undefined;this._unpickCallback=undefined;this._pickingColor=undefined;this._trackingCameras=[];this.UID=nucleo.util.generateUID();this.scene=undefined;this.clones=0;this.mode=nucleo.Actor.MODE.SOLID;this.cull=nucleo.Actor.CULL.NONE;this.visible=true;this.mesh=undefined;this.renderable=undefined;this._bb_disabled=false;if(a){this.model=a;this.name=a.name;this.mode=a.mode;this._bb=a.bb.slice(0);this._centre=vec3.clone(a.centre);if(a.type==nucleo.Model.TYPE.BIG_DATA){this.renderable=new Renderable(this)
}var c=new nucleo.Material();this.setMaterial(c.getFrom(a))}else{this.model=undefined;this.material=undefined}var d=nucleo.EVENTS;nucleo.Notifier.instance.publish([d.ACTOR_MOVED,d.ACTOR_SCALED,d.ACTOR_ROTATED,d.ACTOR_CHANGED_COLOR,d.ACTOR_CHANGED_SHADING,],this)};nucleo.Actor.MODE=nucleo.define.Actor.MODE;nucleo.Actor.CULL=nucleo.define.Actor.CULL;nucleo.Actor.PICKING=nucleo.define.Actor.PICKING;nucleo.Actor.prototype.setScene=function(a){this.scene=a};nucleo.Actor.prototype.setPosition=function(c,f,e){var d=nucleo.util.createVec3(c,f,e);
vec3.subtract(this._translation,d,this._position);this._position=d;var a=this._matrix;a[12]=this._position[0];a[13]=this._position[1];a[14]=this._position[2];a[15]=1;if(!this._bb_disabled){this._computeBoundingBox()}this._notifyTrackingCameras();nucleo.Notifier.instance.fire(nucleo.EVENTS.ACTOR_MOVED,this);return this};nucleo.Actor.prototype.translate=function(c,e,d){this._translation=nucleo.util.createVec3(c,e,d);var a=this._matrix;mat4.translate(a,a,this._translation);this._position=vec3.fromValues(a[12],a[13],a[14]);
if(!this._bb_disabled){this._computeBoundingBox()}this._notifyTrackingCameras();nucleo.Notifier.instance.fire(nucleo.EVENTS.ACTOR_MOVED,this);return this};nucleo.Actor.prototype.rotateX=function(e){var c=this._matrix;var d=nucleo.util.deg2rad(nucleo.util.getAngle(e));mat4.rotateX(c,c,d);if(!this._bb_disabled){this._computeBoundingBox()}nucleo.Notifier.instance.fire(nucleo.EVENTS.ACTOR_ROTATED,this);return this};nucleo.Actor.prototype.rotateY=function(e){var c=this._matrix;var d=nucleo.util.deg2rad(nucleo.util.getAngle(e));
mat4.rotateY(c,c,d);if(!this._bb_disabled){this._computeBoundingBox()}nucleo.Notifier.instance.fire(nucleo.EVENTS.ACTOR_ROTATED,this);return this};nucleo.Actor.prototype.rotateZ=function(e){var c=this._matrix;var d=nucleo.util.deg2rad(nucleo.util.getAngle(e));mat4.rotateZ(c,c,d);if(!this._bb_disabled){this._computeBoundingBox()}nucleo.Notifier.instance.fire(nucleo.EVENTS.ACTOR_ROTATED,this);return this};nucleo.Actor.prototype.setScale=function(f,e,d){if(f==0&&e==undefined&&d==undefined){return}if(typeof(f)=="number"&&e==undefined&&d==undefined){this._scale=nucleo.util.createVec3(f,f,f)
}else{this._scale=nucleo.util.createVec3(f,e,d)}var c=this._matrix;mat4.scale(c,c,this._scale);if(!this._bb_disabled){this._computeBoundingBox()}nucleo.Notifier.instance.fire(nucleo.EVENTS.ACTOR_SCALED,this);return this};nucleo.Actor.prototype.addTrackingCamera=function(a){if(a instanceof nucleo.Camera&&a.type!=nucleo.Camera.TYPE.TRACKING){throw"Actor._addTrackingCamera ERROR: the selected camera is not set to tracking"}else{if(a instanceof nucleo.Camera){this._trackingCameras.push(a)}else{throw"Actor._addTrackingCamera ERROR: the object passed as a parameter is not a Camera"
}}};nucleo.Actor.prototype.removeTrackingCamera=function(c){var a=this._trackingCameras.indexOf(c);this._trackingCameras.splice(a,1)};nucleo.Actor.prototype._notifyTrackingCameras=function(){for(var a=0,c=this._trackingCameras.length;a<c;a+=1){this._trackingCameras[a].updateWithActor(this)}};nucleo.Actor.prototype._computeBoundingBox=function(){var h=this.model.vertices;var e=[];var d=this._matrix;for(var f=0;f<h.length;f=f+3){var a=nucleo.util.createVec3(h[f],h[f+1],h[f+2]);vec3.transformMat4(a,a,d);
e.push(a[0],a[1],a[2])}var c=[e[0],e[1],e[2],e[0],e[1],e[2]];for(var f=0;f<e.length;f=f+3){c[0]=Math.min(c[0],e[f]);c[1]=Math.min(c[1],e[f+1]);c[2]=Math.min(c[2],e[f+2]);c[3]=Math.max(c[3],e[f]);c[4]=Math.max(c[4],e[f+1]);c[5]=Math.max(c[5],e[f+2])}this._bb=c};nucleo.Actor.prototype.getBoundingBoxVertices=function(){var a=this._bb;return[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5],a[3],a[1],a[5]]};nucleo.Actor.prototype.getBoundingBox=function(){return this._bb.slice[0]
};nucleo.Actor.prototype.getHeight=function(){var a=this._bb;return a[4]-a[1]};nucleo.Actor.prototype.setMaterial=function(a){this.material=a;if(this.material.texture){this._new_texture=true}};nucleo.Actor.prototype.setColor=function(d,c,a){this.material.diffuse=nucleo.util.createVec3(d,c,a);if(this.mesh){this.mesh.setColor(this.material.diffuse)}nucleo.Notifier.instance.fire(nucleo.EVENTS.ACTOR_CHANGED_COLOR,this);return this};nucleo.Actor.prototype.setOpacity=function(a){if(a>=0&&a<=1){this.material.opacity=a
}else{throw"The opacity value is not valid"}return this};nucleo.Actor.prototype.setShininess=function(a){this.material.shininess=a;return this};nucleo.Actor.prototype.setTexture=function(c){var a=undefined;if(typeof(c)=="string"){a=new Texture(c)}else{a=c}this.material.texture=a;this._new_texture=true;return this};nucleo.Actor.prototype.setProperty=function(d,c,a){if(a==nucleo.def.actor||a==undefined||a==null){switch(d){case"position":this.setPosition(c);break;case"scale":this.setScale(c);break;case"color":this.setColor(c);
break;case"shading":this.setShading(c);break;case"texture":this.setTexture(c);break;case"opacity":this.setOpacity(c);break;case"shininess":this.setShininess(c);break;default:this[d]=c;break}nucleo.util.console("Actor: The actor "+this.name+" has been updated. ["+d+" = "+c+"]")}else{if(a==nucleo.def.model){this.model[d]=c;nucleo.util.console("Actor: The model "+this.model.namname+" has been updated. ["+d+" = "+c+"]")}else{throw ("Actor.setProperty. Scope:"+a+" is not valid")}}return this};nucleo.Actor.prototype.setShading=function(a){this.material.shading=a;
nucleo.Notifier.instance.fire(nucleo.EVENTS.ACTOR_CHANGED_SHADING,this);return this};nucleo.Actor.prototype.getProperty=function(a){if(a=="color"){return this.materia.diffuse}else{if(this.hasOwnProperty(a)){return this[a]}else{if(this.material.hasOwnProperty(a)){return this.material[a]}else{if(this.model.hasOwnProperty(a)){return this.model[a]}else{return undefined}}}}};nucleo.Actor.prototype.computePosition=function(){bb=this._bb;var a=vec3.create();a[0]=(bb[3]+bb[0])/2;a[1]=(bb[4]+bb[1])/2;a[2]=(bb[5]+bb[2])/2;
a[0]=Math.round(a[0]*1000)/1000;a[1]=Math.round(a[1]*1000)/1000;a[2]=Math.round(a[2]*1000)/1000;return vec3.clone(a)};nucleo.Actor.prototype.setVisualizationMode=function(a){this.mode=a;this._dirty=true;return this};nucleo.Actor.prototype.cullFace=function(a){this.cull=a;return this};nucleo.Actor.prototype.setLookupTable=function(f,d,a){if(this.model.scalars==undefined){return}var c=this;function e(h){var j=nucleo.LookupTableManager.instance.get(f);c.material.colors=j.getColors(c.model.scalars,d,a);
if(c.model.type==define.Model.TYPE.BIG_DATA){c.renderable.update()}}setTimeout(function(){e()},0);return this};nucleo.Actor.prototype.flipNormals=function(){this.model.flipNormals();return this};nucleo.Actor.prototype.setVisible=function(a){this.visible=a;return this};nucleo.Actor.prototype.isVisible=function(){return this.visible};nucleo.Actor.prototype.clone=function(){this.clones++;var a=new Actor(this.model);a.name+="-"+this.clones;a.material=this.material.clone();return a};nucleo.Actor.prototype.setPicking=function(e,d,a){this._picking=e;
switch(e){case define.Actor.PICKING.DISABLED:this._pick_callback=undefined;this._unpick_callback=undefined;this.mesh=undefined;this.renderable=undefined;this.setVisualizationMode(nucleo.Actor.MODE.SOLID);break;case define.Actor.PICKING.CELL:if(this.mesh==undefined){this.mesh=new Mesh(this);this.mesh.setColor(this.material.diffuse);this.renderable=new Renderable(this);this.setVisualizationMode(nucleo.Actor.MODE.FLAT)}this._pick_callback=d;this._unpick_callback=a;break;case define.Actor.PICKING.OBJECT:this._pickingColor=nucleo.Picker.instance.getColorFor(this);
this._pick_callback=d;this._unpick_callback=a;break}if(this._picking!=nucleo.define.Actor.PICKING.DISABLED){var c=this.scene.views.length;while(c--){var f=this.scene.views[c].renderer;if(!f.isOffscreenEnabled()){f.enableOffscreen()}}}return this};nucleo.Actor.prototype.isPickable=function(){return(this._picking!=nucleo.define.Actor.PICKING.DISABLED)};nucleo.Actor.prototype.getPickingType=function(){return this._picking};nucleo.Actor.prototype.updateRenderable=function(a){this.renderable.update(a)
};nucleo.Actor.prototype.reallocate=function(){this._dirty=true};nucleo.Picker=function Picker(){this._objects={};this._colors={}};nucleo.Picker.RESOLUTION=1/255;nucleo.Picker.prototype._hex2rgb=function(d){var c=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;hex=d.replace(c,function(f,j,h,e){return j+j+h+h+e+e});var a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return a?[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]:null};nucleo.Picker.prototype._rgb2hex=function(e,d,a){var f=nucleo.util.createArr3(e,d,a);
return"#"+((1<<24)+(f[0]<<16)+(f[1]<<8)+f[2]).toString(16).slice(1)};nucleo.Picker.prototype._getColor=function(){function a(){var c=Math.floor(Math.random()*255);if(c==0){return a()}else{return c}}return[a(),a(),a()]};nucleo.Picker.prototype.color2decimal=function(a){r=a[0]*nucleo.Picker.RESOLUTION;g=a[1]*nucleo.Picker.RESOLUTION;b=a[2]*nucleo.Picker.RESOLUTION;return[r,g,b]};nucleo.Picker.prototype.getColorFor=function(e){var d=e.UID;if(d==null||d==undefined){alert("Picker.getColor: invalid object");
return}var a,c;if(!this._objects[d]){do{a=this._getColor();c=this._rgb2hex(a)}while(c in this._colors);this._objects[d]=a;this._colors[c]=d}a=this._objects[d];return this.color2decimal(a)};nucleo.Picker.prototype.query=function(e){var h=100;var f=undefined;var d={};var a=e.slice(0,3);var c=this._rgb2hex(a);if(this._colors[c]){d.uid=this._colors[c];d.color=a;return d}return null};nucleo.Picker.instance=new nucleo.Picker();nucleo.Engine=function Engine(){this.gl=undefined;this.pm=undefined;this._view=undefined;
this._clear_color=undefined;this._transforms=undefined};nucleo.Engine.prototype.allocate=function(a){};nucleo.Engine.prototype.render=function(a){};nucleo.Engine.prototype.deallocate=function(a){};nucleo.Engine.prototype.reallocate=function(a){};nucleo.Engine.prototype.disableOffscreen=function(){};nucleo.Engine.prototype.enableOffscreen=function(){};nucleo.Engine.prototype.isOffscreenEnabled=function(){};nucleo.Engine.prototype.readOffscreenPixel=function(a,c){};nucleo.Engine.prototype.init=function(a){this._getGL(a);
this.pm=new nucleo.ProgramManager(this.gl);this._view=a.view;this._clear_color=this._view.backgroundColor;this._transforms=new nucleo.Transforms(a.view);this.configure()};nucleo.Engine.prototype._getGL=function(c){var a=undefined;var d=c.view.canvas;var j=["webgl","experimental-webgl","webkit-3d","moz-webgl"];this.gl=undefined;for(var f=0;f<j.length;++f){try{a=d.getContext(j[f])}catch(h){}if(a){break}}if(a==null){alert("Sorry: WebGL is not available on this browser. Have you tried the newest version of Firefox, Chrome or Safari?");
return undefined}else{this.gl=a}};nucleo.Engine.prototype.configure=function(){var a=this.gl;a.enable(a.DEPTH_TEST);a.enable(a.BLEND);a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);a.depthFunc(a.LESS);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,true)};nucleo.Engine.prototype.clear=function(){var e=this.gl;var c=this._view.canvas;var d=c.width;var a=c.height;var f=this._clear_color;e.clearColor(f[0],f[1],f[2],1);e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);e.viewport(0,0,d,a);this._transforms.calculateProjection()
};nucleo.Engine.prototype.clearColor=function(d,c,a){var e=nucleo.util.createArr3(d,c,a);this._clear_color=e;this.gl.clearColor(e[0],e[1],e[2],1)};nucleo.Engine.prototype.clearDepth=function(a){this.gl.clearDepth(a)};nucleo.Engine.prototype.releaseProgram=function(){this.pm.releaseProgram()};nucleo.Engine.prototype.setProgram=function(a,c){this.pm.setProgram(a,c)};nucleo.ExternalEngine=function ExternalEngine(d,e,c,a){nucleo.Engine.call(this);this.renderer=d;this.allocateCallback=e;this.renderCallback=c;
this.deallocateCallback=a};nucleo.ExternalEngine.prototype=new nucleo.Engine();nucleo.ExternalEngine.prototype.constructor=nucleo.ExternalEngine;nucleo.ExternalEngine.prototype.allocate=function(a){this.allocateCallback(this.renderer,a)};nucleo.ExternalEngine.prototype.render=function(a){this.renderCallback(this.renderer,a)};nucleo.ExternalEngine.prototype.deallocate=function(a){this.deallocateCallback(this.renderer,a)};nucleo.RenderEngine=function RenderEngine(){nucleo.Engine.call(this);this._gl_buffers={};
this._gl_textures={};this._offscreen=false;this._target=undefined;this._onPickingBuffer=false;this._debug_picking_flag=false};nucleo.RenderEngine.prototype=new nucleo.Engine();nucleo.RenderEngine.prototype.constructor=nucleo.RenderEngine;nucleo.RenderEngine.prototype.configure=function(){nucleo.Engine.prototype.configure.call(this);var a=this.gl;a.clearDepth(1);a.disable(a.CULL_FACE)};nucleo.RenderEngine.prototype.allocate=function(d){var c=d._actors.concat(d.toys.list);var a=c.length;while(a--){this._allocateActor(c[a])
}};nucleo.RenderEngine.prototype.deallocate=function(a){};nucleo.RenderEngine.prototype._allocateActor=function(d){var e=this.gl;var c=d.model;var a={};if(!(c.UID in this._gl_buffers)||d._dirty){this._reallocateActor(d);d._dirty=false}};nucleo.RenderEngine.prototype._reallocateActor=function(e){var j=this.gl;var d=e.model;var a=this._gl_buffers[d.UID]||{};var f=nucleo.Actor.MODE;if(a.vertex==undefined){a.vertex=j.createBuffer()}var c=undefined;switch(e.mode){case f.BOUNDING_BOX:c=e.getBoundingBoxVertices();
break;default:c=d.vertices}j.bindBuffer(j.ARRAY_BUFFER,a.vertex);j.bufferData(j.ARRAY_BUFFER,new Float32Array(c),j.STATIC_DRAW);if(d.normals){if(a.normal==undefined){a.normal=j.createBuffer()}j.bindBuffer(j.ARRAY_BUFFER,a.normal);j.bufferData(j.ARRAY_BUFFER,new Float32Array(d.normals),j.STATIC_DRAW)}if(d.scalars!=undefined||d.colors!=undefined){if(a.color==undefined){a.color=j.createBuffer()}}if(d.indices!=undefined){if(a.index==undefined){a.index=j.createBuffer()}var h=undefined;switch(e.mode){case f.SOLID:h=d.indices;
break;case f.WIREFRAME:h=d.wireframe;break;case f.POINTS:h=d.indices;break;case f.LINES:h=d.indices;break;case f.BOUNDING_BOX:h=Model.BB_INDICES;break;case f.BB_AND_SOLID:h=d.indices;break;case f.WIRED_AND_SOLID:h=d.indices;break;case f.FLAT:h=d.indices;break;case f.TEXTURED:h=d.indices;break;default:throw ("There was a problem while rendering the actor ["+e.name+"].The visualization mode: "+e.mode+" is not valid.")}j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,a.index);j.bufferData(j.ELEMENT_ARRAY_BUFFER,new Uint16Array(h),j.STATIC_DRAW)
}if(e.mode==f.FLAT||e.model.type==nucleo.Model.TYPE.BIG_DATA){if(a.vertex_parts==undefined){a.vertex_parts=j.createBuffer()}if(a.normal_parts==undefined){a.normal_parts=j.createBuffer()}if(a.color_parts==undefined){a.color_parts=j.createBuffer()}if(a.index_parts==undefined){a.index_parts=j.createBuffer()}}else{if(a.vertex_parts!=undefined){j.deleteBuffer(a.vertex_parts);a.vertex_parts=null;delete a.vertex_parts}if(a.normal_parts!=undefined){j.deleteBuffer(a.normal_parts);a.normal_parts=null;delete a.normal_parts
}if(a.color_parts!=undefined){j.deleteBuffer(a.color_parts);a.color_parts=null;delete a.color_parts}if(a.index_parts!=undefined){j.deleteBuffer(a.index_parts);a.index_parts=null;delete a.index_parts}}if(e.mode==f.WIRED_AND_SOLID){a.index_ws=j.createBuffer();j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,a.index_ws);j.bufferData(j.ELEMENT_ARRAY_BUFFER,new Uint16Array(d.wireframe),j.STATIC_DRAW);j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,null)}else{if(a.index_ws!=undefined){j.deleteBuffer(a.index_ws);a.index_ws=null;
delete a.index_ws}}if(e.mode==f.BB_AND_SOLID){a.vertex_bs=j.createBuffer();j.bindBuffer(j.ARRAY_BUFFER,a.vertex_bs);j.bufferData(j.ARRAY_BUFFER,new Float32Array(e.getBoundingBoxVertices()),j.STATIC_DRAW);j.bindBuffer(j.ARRAY_BUFFER,null);a.index_bs=j.createBuffer();j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,a.index_bs);j.bufferData(j.ELEMENT_ARRAY_BUFFER,new Uint16Array(Model.BB_INDICES),j.STATIC_DRAW);j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,null)}else{if(a.vertex_bs!=undefined){j.deleteBuffer(a.vertex_bs);
a.vertex_bs=null;delete a.vertex_bs}if(a.index_bs!=undefined){j.deleteBuffer(a.index_bs);a.index_bs=null;delete a.index_bs}}if(d.texcoords&&e.material.texture){a.texcoords=j.createBuffer();j.bindBuffer(j.ARRAY_BUFFER,a.texcoords);j.bufferData(j.ARRAY_BUFFER,new Float32Array(d.texcoords),j.STATIC_DRAW);this._gl_textures[e.UID]=j.createTexture();j.bindTexture(j.TEXTURE_2D,this._gl_textures[e.UID]);j.texImage2D(j.TEXTURE_2D,0,j.RGBA,j.RGBA,j.UNSIGNED_BYTE,e.material.texture.image);j.generateMipmap(j.TEXTURE_2D);
j.bindTexture(j.TEXTURE_2D,null)}j.bindBuffer(j.ARRAY_BUFFER,null);j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,null);this._gl_buffers[d.UID]=a};nucleo.RenderEngine.prototype._setNormals=function(e){var c=e.model;var h=this.gl;var d=this.pm;var a=this._gl_buffers[c.UID];var f=nucleo.ESSL;if(c.normals&&e.material.shading){h.bindBuffer(h.ARRAY_BUFFER,a.normal);d.enableAttribute(f.NORMAL_ATTRIBUTE);d.setAttributePointer(f.NORMAL_ATTRIBUTE,3,h.FLOAT,false,0,0)}};nucleo.RenderEngine.prototype._setColors=function(e){var c=e.model;
var h=this.gl;var d=this.pm;var a=this._gl_buffers[c.UID];var f=nucleo.ESSL;if(e.material.colors&&e.material.colors.length==e.model.vertices.length){d.setUniform("uUseVertexColors",true);h.bindBuffer(h.ARRAY_BUFFER,a.color);h.bufferData(h.ARRAY_BUFFER,new Float32Array(e.material.colors),h.STATIC_DRAW);d.enableAttribute(f.COLOR_ATTRIBUTE);d.setAttributePointer(f.COLOR_ATTRIBUTE,3,h.FLOAT,false,0,0)}};nucleo.RenderEngine.prototype._setRenderableVertices=function(e,c){var h=this.gl;var d=this.pm;var a=this._gl_buffers[e.model.UID];
var f=nucleo.ESSL;h.bindBuffer(h.ARRAY_BUFFER,a.vertex_parts);h.bufferData(h.ARRAY_BUFFER,new Float32Array(c.vertices),h.STATIC_DRAW);d.setAttributePointer(f.VERTEX_ATTRIBUTE,3,h.FLOAT,false,0,0)};nucleo.RenderEngine.prototype._setRenderableNormals=function(e,c){var h=this.gl;var d=this.pm;var a=this._gl_buffers[e.model.UID];var f=nucleo.ESSL;if(c.normals!=undefined&&c.normals.length>0){h.bindBuffer(h.ARRAY_BUFFER,a.normal_parts);h.bufferData(h.ARRAY_BUFFER,new Float32Array(c.normals),h.STATIC_DRAW);
d.enableAttribute(f.NORMAL_ATTRIBUTE);d.setAttributePointer(f.NORMAL_ATTRIBUTE,3,h.FLOAT,false,0,0)}};nucleo.RenderEngine.prototype._setRenderableColors=function(e,c){var h=this.gl;var d=this.pm;var a=this._gl_buffers[e.model.UID];var f=nucleo.ESSL;if(c.colors!=undefined&&c.colors.length>0){d.setUniform("uUseVertexColors",true);h.bindBuffer(h.ARRAY_BUFFER,a.color_parts);h.bufferData(h.ARRAY_BUFFER,new Float32Array(c.colors),h.STATIC_DRAW);d.enableAttribute(f.COLOR_ATTRIBUTE);d.setAttributePointer(f.COLOR_ATTRIBUTE,3,h.FLOAT,false,0,0)
}};nucleo.RenderEngine.prototype._updateActorTransforms=function(f){var d=this._transforms;var e=f._actors.concat(f.toys.list);var h=e.length;var c=undefined;d.calculateModelView();for(var a=0;a<h;a+=1){c=e[a];if(c.visible==false&&f.frameAnimation==undefined){continue}c._matrix_world=mat4.multiply(c._matrix_world,d.model_view,c._matrix);c._matrix_normal=mat4.copy(c._matrix_normal,c._matrix_world);c._matrix_normal=mat4.invert(mat4.create(),c._matrix_normal);c._matrix_normal=mat4.transpose(c._matrix_normal,c._matrix_normal)
}};nucleo.RenderEngine.prototype.render=function(h){var d=this._transforms,c=this.pm,j=this.gl,f=nucleo.ESSL;this._updateActorTransforms(h);c.setUniform(f.PERSPECTIVE_MATRIX,d.projection);if(h.frameAnimation!=undefined){h.frameAnimation.update()}this._renderPicking(h._actors);var e=h._actors.concat(h.toys.list);var a=e.length;while(a--){this._renderActor(e[a])}};nucleo.RenderEngine.prototype._renderPicking=function(c){if(this._target==undefined){return}if(this._offscreen){var d=this.gl;this._onPickingBuffer=true;
d.bindFramebuffer(d.FRAMEBUFFER,this._target.framebuffer);d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT);var a=c.length;while(a--){if(c[a].isPickable()){this._renderActor(c[a])}}this._onPickingBuffer=false;d.bindFramebuffer(d.FRAMEBUFFER,null)}if(this._debug_picking_flag){d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT)}};nucleo.RenderEngine.prototype._renderActor=function(d){if(!d.visible){return}var f=d.model;var m=this._gl_buffers[f.UID];var j=this._gl_textures[d.UID];
var e=this.gl;var a=this.pm;var l=nucleo.ESSL;var c=this._transforms;var k=[d.material.diffuse[0],d.material.diffuse[1],d.material.diffuse[2],d.material.opacity];if(d.mode==nucleo.Actor.MODE.FLAT){this.setProgram(nucleo.go.essl.lambert)}else{}a.disableAttribute(l.TEXCOORD_ATTRIBUTE);a.disableAttribute(l.COLOR_ATTRIBUTE);a.disableAttribute(l.NORMAL_ATTRIBUTE);a.disableAttribute(l.PICKING_COLOR_ATTRIBUTE);a.enableAttribute(l.VERTEX_ATTRIBUTE);a.setUniform("uUseVertexColors",false);a.setUniform("uUseTextures",false);
a.setUniform("uUseShading",d.material.shading);a.setUniform("uMaterialDiffuse",k);a.setUniform(l.MODEL_VIEW_MATRIX,d._matrix_world);a.setUniform(l.NORMAL_MATRIX,d._matrix_normal);this._handleCulling(d);if(this._onPickingBuffer||this._debug_picking_flag){this._renderPickingBuffer(d);return}e.bindBuffer(e.ARRAY_BUFFER,m.vertex);a.setAttributePointer(l.VERTEX_ATTRIBUTE,3,e.FLOAT,false,0,0);var h=nucleo.Actor.MODE;switch(d.mode){case h.SOLID:this._renderSolid(d);break;case h.WIREFRAME:this._renderWireframe(d);
break;case h.POINTS:this._renderPoints(d);break;case h.LINES:this._renderLines(d);break;case h.BOUNDING_BOX:this._renderBoundingBox(d);break;case h.BB_AND_SOLID:this._renderBoundingBoxAndSolid(d);break;case h.WIRED_AND_SOLID:this._renderWiredAndSolid(d);break;case h.FLAT:this._renderFlat(d);break;case h.TEXTURED:this._renderTextured(d);break;default:throw ("There was a problem while rendering the actor ["+d.name+"]. The visualization mode: "+d.mode+" is not valid.")}e.bindBuffer(e.ARRAY_BUFFER,null);
e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)};nucleo.RenderEngine.prototype._renderSolid=function(f){var a=this._gl_buffers[f.model.UID];var j=this.gl;var e=this.pm;var h=nucleo.ESSL;if(f.model.type!=nucleo.Model.TYPE.SIMPLE){if(f.renderable==undefined){alert("the actor does not have a renderable object");throw"the actor does not have a renderable object"}parts=f.renderable.parts;var d=parts.length;while(d--){var c=parts[d];this._setRenderableVertices(f,c);this._setRenderableNormals(f,c);this._setRenderableColors(f,c);
j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,a.index_parts);j.bufferData(j.ELEMENT_ARRAY_BUFFER,new Uint16Array(c.indices),j.STATIC_DRAW);j.drawElements(j.TRIANGLES,c.indices.length,j.UNSIGNED_SHORT,0)}}else{this._setNormals(f);this._setColors(f);j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,a.index);j.drawElements(j.TRIANGLES,f.model.indices.length,j.UNSIGNED_SHORT,0)}};nucleo.RenderEngine.prototype._renderWireframe=function(d){var a=this._gl_buffers[d.model.UID];var f=this.gl;var c=this.pm;var e=nucleo.ESSL;if(!d.toy){this._setNormals(d)
}this._setColors(d);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,a.index);f.drawElements(f.LINES,d.model.wireframe.length,f.UNSIGNED_SHORT,0)};nucleo.RenderEngine.prototype._renderPoints=function(d){var a=d.model;var e=this.gl;var c=this.pm;c.setUniform("uUseShading",false);c.setUniform("uPointSize",5);this._setColors(d);e.drawArrays(e.POINTS,0,a.vertices.length/3)};nucleo.RenderEngine.prototype._renderLines=function(h){var a=this._gl_buffers[h.model.UID];var l=this.gl;var f=this.pm;var k=nucleo.ESSL;f.setUniform("uUseShading",false);
if(h.model.type==nucleo.Model.TYPE.BIG_DATA){if(h.renderable==undefined){alert("the actor does not have a renderable object");throw"the actor does not have a renderable object"}parts=h.renderable.parts;var e=parts.length;for(var d=0;d<e;d++){var c=parts[d];this._setRenderableVertices(h,c);this._setRenderableColors(h,c);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,a.index_parts);l.bufferData(l.ELEMENT_ARRAY_BUFFER,new Uint16Array(c.indices),l.STATIC_DRAW);l.drawElements(l.LINES,c.indices.length,l.UNSIGNED_SHORT,0)
}}else{this._setColors(h);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,a.index);l.drawElements(l.LINES,h.model.indices.length,l.UNSIGNED_SHORT,0)}};nucleo.RenderEngine.prototype._renderBoundingBox=function(d){var a=this._gl_buffers[d.model.UID];var f=this.gl;var c=this.pm;var e=nucleo.ESSL;c.disableAttribute(e.NORMAL_ATTRIBUTE);c.setUniform("uUseShading",false);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,a.index);f.drawElements(f.LINES,Model.BB_INDICES.length,f.UNSIGNED_SHORT,0)};nucleo.RenderEngine.prototype._renderBoundingBoxAndSolid=function(e){var c=e.model;
var a=this._gl_buffers[c.UID];var j=this.gl;var d=this.pm;var h=nucleo.ESSL;var f=this._transforms;this._renderSolid(e);f.calculateModelView();f.calculateNormal();d.setUniform(h.MODEL_VIEW_MATRIX,f.model_view);d.setUniform(h.NORMAL_MATRIX,f.normal);d.disableAttribute(h.NORMAL_ATTRIBUTE);d.setUniform("uUseShading",false);j.bindBuffer(j.ARRAY_BUFFER,a.vertex_bs);d.setAttributePointer(h.VERTEX_ATTRIBUTE,3,j.FLOAT,false,0,0);j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,a.index_bs);j.drawElements(j.LINES,Model.BB_INDICES.length,j.UNSIGNED_SHORT,0)
};nucleo.RenderEngine.prototype._renderWiredAndSolid=function(e){var c=e.model;var a=this._gl_buffers[c.UID];var h=this.gl;var d=this.pm;var f=nucleo.ESSL;this._renderSolid(e);d.setUniform("uUseShading",false);d.setUniform("uMaterialDiffuse",[0.9,0.9,0.9,1]);d.disableAttribute(f.NORMAL_ATTRIBUTE);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,a.index_ws);h.drawElements(h.LINES,c.wireframe.length,h.UNSIGNED_SHORT,0)};nucleo.RenderEngine.prototype._renderFlat=function(e){var j=e.model;var m=this._gl_buffers[j.UID];
var k=this._gl_textures[e.UID];var h=this.gl;var c=this.pm;var l=nucleo.ESSL;if(e.mesh==undefined){e.mesh=new Mesh(e);e.renderable=new Renderable(e)}if(e.mesh.model==undefined){var j=e.model;h.bindBuffer(h.ARRAY_BUFFER,m.vertex);c.setAttributePointer(l.VERTEX_ATTRIBUTE,3,h.FLOAT,false,0,0);h.bindBuffer(h.ARRAY_BUFFER,m.normal);c.setAttributePointer(l.NORMAL_ATTRIBUTE,3,h.FLOAT,false,0,0);h.bindBuffer(h.ARRAY_BUFFER,null);c.enableAttribute(l.NORMAL_ATTRIBUTE);c.setUniform("uUseShading",e.material.shading);
h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,m.index);h.bufferData(h.ELEMENT_ARRAY_BUFFER,new Uint16Array(j.wireframe),h.STATIC_DRAW);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);this._renderWireframe(e);return}c.setUniform("uUseShading",true);c.enableAttribute(l.NORMAL_ATTRIBUTE);var d=e.renderable.parts;var f=d.length;while(f--){var a=d[f];h.bindBuffer(h.ARRAY_BUFFER,m.vertex_parts);h.bufferData(h.ARRAY_BUFFER,new Float32Array(a.vertices),h.STATIC_DRAW);c.setAttributePointer(l.VERTEX_ATTRIBUTE,3,h.FLOAT,false,0,0);
h.bindBuffer(h.ARRAY_BUFFER,m.normal_parts);h.bufferData(h.ARRAY_BUFFER,new Float32Array(a.normals),h.STATIC_DRAW);c.setAttributePointer(l.NORMAL_ATTRIBUTE,3,h.FLOAT,false,0,0);if(a.colors&&a.colors.length>0){c.enableAttribute(l.COLOR_ATTRIBUTE);c.setUniform("uUseVertexColors",true);h.bindBuffer(h.ARRAY_BUFFER,m.color_parts);h.bufferData(h.ARRAY_BUFFER,new Float32Array(a.colors),h.STATIC_DRAW);c.setAttributePointer(l.COLOR_ATTRIBUTE,3,h.FLOAT,false,0,0)}h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,m.index_parts);
h.bufferData(h.ELEMENT_ARRAY_BUFFER,new Uint16Array(a.indices),h.STATIC_DRAW);h.drawElements(h.TRIANGLES,a.indices.length,h.UNSIGNED_SHORT,0)}};nucleo.RenderEngine.prototype._renderPickingBuffer=function(e){var j=e.model;var l=this._gl_buffers[j.UID];var h=this.gl;var c=this.pm;var k=nucleo.ESSL;if(e._picking==nucleo.Actor.PICKING.DISABLED){return}c.setUniform("uUseShading",false);if(e._picking==nucleo.Actor.PICKING.CELL){if(e.mesh==undefined||e.mesh.model==undefined){return}if(l.picking_parts==undefined){l.picking_parts=h.createBuffer();
l.picking_colors=h.createBuffer();l.picking_index=h.createBuffer()}c.setUniform("uUseVertexColors",true);c.enableAttribute(k.COLOR_ATTRIBUTE);var d=e.renderable.parts;var f=d.length;while(f--){var a=d[f];h.bindBuffer(h.ARRAY_BUFFER,l.picking_parts);h.bufferData(h.ARRAY_BUFFER,new Float32Array(a.vertices),h.STATIC_DRAW);c.setAttributePointer(k.VERTEX_ATTRIBUTE,3,h.FLOAT,false,0,0);if(a.pickingColors&&a.pickingColors.length==a.vertices.length){h.bindBuffer(h.ARRAY_BUFFER,l.picking_colors);h.bufferData(h.ARRAY_BUFFER,new Float32Array(a.pickingColors),h.STATIC_DRAW);
c.setAttributePointer(k.COLOR_ATTRIBUTE,3,h.FLOAT,false,0,0)}else{alert("The object "+a.name+" does not have picking colors assigned.");throw ("The object "+a.name+" does not have picking colors assigned.")}h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,l.picking_index);h.bufferData(h.ELEMENT_ARRAY_BUFFER,new Uint16Array(a.indices),h.STATIC_DRAW);h.drawElements(h.TRIANGLES,a.indices.length,h.UNSIGNED_SHORT,0)}}else{if(e._picking==nucleo.Actor.PICKING.OBJECT){c.setUniform("uMaterialDiffuse",e._pickingColor.concat(1));
h.bindBuffer(h.ARRAY_BUFFER,l.vertex);c.setAttributePointer(k.VERTEX_ATTRIBUTE,3,h.FLOAT,false,0,0);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,l.index);h.drawElements(h.TRIANGLES,j.indices.length,h.UNSIGNED_SHORT,0)}}h.bindBuffer(h.ARRAY_BUFFER,null);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null)};nucleo.RenderEngine.prototype._renderTextured=function(e){var c=e.model;var a=this._gl_buffers[c.UID];var f=this._gl_textures[e.UID];var j=this.gl;var d=this.pm;var h=nucleo.ESSL;if(!e.material.texture.loaded){this._renderSolid(e);
return}if(e._new_texture){e.reallocate();e._new_texture=false;return}if(c.texcoords){d.setUniform("uUseTextures",true);j.bindBuffer(j.ARRAY_BUFFER,a.texcoords);d.setAttributePointer(h.TEXCOORD_ATTRIBUTE,2,j.FLOAT,false,0,0);d.enableAttribute(h.TEXCOORD_ATTRIBUTE)}else{throw ("error")}j.activeTexture(j.TEXTURE0);j.bindTexture(j.TEXTURE_2D,f);j.texParameteri(j.TEXTURE_2D,j.TEXTURE_WRAP_S,j.CLAMP_TO_EDGE);j.texParameteri(j.TEXTURE_2D,j.TEXTURE_WRAP_T,j.CLAMP_TO_EDGE);j.texParameteri(j.TEXTURE_2D,j.TEXTURE_MAG_FILTER,e.material.texture.getMagFilter(j));
j.texParameteri(j.TEXTURE_2D,j.TEXTURE_MIN_FILTER,e.material.texture.getMinFilter(j));d.setUniform("uSampler",0);j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,a.index);j.drawElements(j.TRIANGLES,c.indices.length,j.UNSIGNED_SHORT,0)};nucleo.RenderEngine.prototype._handleCulling=function(a){var c=this.gl;c.disable(c.CULL_FACE);if(a.cull!=nucleo.Actor.CULL.NONE){c.enable(c.CULL_FACE);switch(a.cull){case nucleo.Actor.CULL.BACK:c.cullFace(c.BACK);break;case nucleo.Actor.CULL.FRONT:c.cullFace(c.FRONT);break}}};nucleo.RenderEngine.prototype.enableOffscreen=function(){this._offscreen=true;
this._target=new RenderTarget(this)};nucleo.RenderEngine.prototype.disableOffscreen=function(){this._offscreen=false;delete this._target;this._target=undefined};nucleo.RenderEngine.prototype.isOffscreenEnabled=function(){return(this._target!=undefined)};nucleo.RenderEngine.prototype.readOffscreenPixel=function(a,d){var c=this._target.readPixel(a,d);value=Array.apply([],c);value.constructor===Array;return value};nucleo.BakeEngine=function BakeEngine(a){this.renderer=a;var c=a.gl;this._calls={};this._gl_buffers={index:c.createBuffer(),baked:c.createBuffer(),position:c.createBuffer(),scale:c.createBuffer(),shading:c.createBuffer()};
this._data={index:[],baked:[],position:[],scale:[],shading:[]};this._allocated=[];this._offsets={position:{},scale:{},shading:{},baked:{}};this.glsl=nucleo.util.extend(nucleo.ESSL,{POSITION:"aPosition",SCALE:"aScale",SHADING:"aShading"})};nucleo.BakeEngine.prototype._populate=function(h,f){var c=[];for(var e=0;e<f;e+=1){if(h instanceof Array||h instanceof Float32Array){for(var d=0;d<h.length;d+=1){c.push(h[d])}}else{c.push(h)}}return c};nucleo.BakeEngine.prototype._computeRequiredCalls=function(h){var f=h._actors;
var a=f.length;var c=0;var e=1;for(var d=0;d<a;d+=1){c+=f[d].model.indices.length;if(c>65000){c=0;e++}}return e};nucleo.BakeEngine.prototype._allocateActor=function(h){if(this._allocated.indexOf(h.UID)!=-1){return}var k=this._data;var e=this._offsets;var l=this.renderer.gl;var m=h.model;var a=m.vertices.length;var f=[],n=[];if(h.material.diffuse){f=this._populate(h.material.diffuse,a/3)}else{f=this._populate([0.7,0.7,0.7],a/3)}if(m.normals){n=m.normals}else{n=this._populate(0,a)}e.baked[h.UID]=k.baked.length;
for(var j=0;j<a;j+=3){k.baked.push(m.vertices[j]);k.baked.push(m.vertices[j+1]);k.baked.push(m.vertices[j+2]);k.baked.push(n[j]);k.baked.push(n[j+1]);k.baked.push(n[j+2]);k.baked.push(f[j]);k.baked.push(f[j+1]);k.baked.push(f[j+2])}e.position[h.UID]=k.position.length;e.scale[h.UID]=k.scale.length;e.shading[h.UID]=k.shading.length;k.position=k.position.concat(this._populate(h._position,a/3));k.scale=k.scale.concat(this._populate(h._scale,a/3));k.shading=k.shading.concat(this._populate(h.material.opacity,a/3));
var c=m.indices.slice(0);if(k.index.length>0){var o=k.index.max()+1;var d=m.indices.length;for(var j=0;j<d;j+=1){c[j]+=o}k.index=k.index.concat(c)}else{k.index=c}this._allocated.push(h.UID)};nucleo.BakeEngine.prototype._updateActorPosition=function(c){var d=this._data;var f=this._offsets.position[c.UID];if(f==undefined){return}var e=c.model.vertices.length+f;for(var a=f;a<e;a+=3){d.position[a]=c._position[0];d.position[a+1]=c._position[1];d.position[a+2]=c._position[2]}};nucleo.BakeEngine.prototype._updateActorScale=function(c){var d=this._data;
var f=this._offsets.scale[c.UID];if(f==undefined){return}var e=c.model.vertices.length+f;for(var a=f;a<e;a+=3){d.scale[a]=c._scale[0];d.scale[a+1]=c._scale[1];d.scale[a+2]=c._scale[2]}};nucleo.BakeEngine.prototype._updateActorColor=function(c){var d=this._data;var f=this._offsets.baked[c.UID];if(f==undefined){return}var e=(c.model.vertices.length*3)+f;for(var a=f;a<e;a+=9){d.baked[a+6]=c.material.diffuse[0];d.baked[a+7]=c.material.diffuse[1];d.baked[a+8]=c.material.diffuse[2]}};nucleo.BakeEngine.prototype._updateActorShading=function(c){var d=this._data;
var h=this._offsets.shading[c.UID];if(h==undefined){return}var e=(c.model.vertices.length/3)+h;var f=0;if(c.material.opacity){f=1}for(var a=h;a<e;a+=1){d.shading[a]=f}};nucleo.BakeEngine.prototype.deallocate=function(a){};nucleo.BakeEngine.prototype.allocate=function(k){if(this._computeRequiredCalls(k)>1){throw"Not renderable yet. Working on it. The number of indices exceeds the 65K limit"}var a=k._actors;var d=a.length;var c=this.renderer;var n=this._gl_buffers;var h=this._data;var e=c.pm;var j=c.gl;
var m=this.glsl;var l=j.STATIC_DRAW;for(var f=0;f<d;f+=1){this._allocateActor(a[f])}e.enableAttribute(m.VERTEX_ATTRIBUTE);e.enableAttribute(m.NORMAL_ATTRIBUTE);e.enableAttribute(m.COLOR_ATTRIBUTE);e.enableAttribute(m.POSITION);e.enableAttribute(m.SCALE);e.enableAttribute(m.SHADING);j.bindBuffer(j.ARRAY_BUFFER,n.baked);j.bufferData(j.ARRAY_BUFFER,new Float32Array(h.baked),l);e.setAttributePointer(m.VERTEX_ATTRIBUTE,3,j.FLOAT,false,36,0);e.setAttributePointer(m.NORMAL_ATTRIBUTE,3,j.FLOAT,false,36,12);
e.setAttributePointer(m.COLOR_ATTRIBUTE,3,j.FLOAT,false,36,24);j.bindBuffer(j.ARRAY_BUFFER,n.position);j.bufferData(j.ARRAY_BUFFER,new Float32Array(h.position),l);e.setAttributePointer(m.POSITION,3,j.FLOAT,false,12,0);j.bindBuffer(j.ARRAY_BUFFER,n.scale);j.bufferData(j.ARRAY_BUFFER,new Float32Array(h.scale),l);e.setAttributePointer(m.SCALE,3,j.FLOAT,false,12,0);j.bindBuffer(j.ARRAY_BUFFER,n.shading);j.bufferData(j.ARRAY_BUFFER,new Float32Array(h.shading),l);e.setAttributePointer(m.SHADING,1,j.FLOAT,false,4,0);
j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,n.index);j.bufferData(j.ELEMENT_ARRAY_BUFFER,new Uint16Array(h.index),l)};nucleo.BakeEngine.prototype.render=function(k){var a=this.renderer;var d=a.transforms;var c=a.pm;var j=a.gl;var m=nucleo.ESSL;var f=this._data;d.update();c.setUniform(m.PERSPECTIVE_MATRIX,d.pMatrix);c.setUniform(m.MODEL_VIEW_MATRIX,d.mvMatrix);c.setUniform(m.NORMAL_MATRIX,d.nMatrix);c.setUniform(m.MVP_MATRIX,d.mvpMatrix);for(var h=0,l=k._actors.length;h<l;h+=1){var e=k._actors[h];this._updateActorPosition(e);
this._updateActorScale(e);this._updateActorShading(e);this._updateActorColor(e)}j.drawElements(j.TRIANGLES,f.index.length,j.UNSIGNED_SHORT,0);j.bindBuffer(j.ARRAY_BUFFER,null);j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,null)};nucleo.Scene=function Scene(){this.UID=nucleo.util.generateUID();this.views=[];this._actors=[];this._groups=[];this.toys=new nucleo.SceneToys(this);this.loadingMode=nucleo.Model.LOADING_MODE.LIVE;this.normalsFlipped=false;this.lutID=null;this.timerID=null;this.scalarMIN=Number.MAX_VALUE;
this.scalarMAX=Number.MIN_VALUE;this.bb=[0,0,0,0,0,0];this.centre=[0,0,0];this.frameAnimation=null;var c=nucleo.Notifier.instance;var a=nucleo.EVENTS;c.publish([a.SCENE_NEW,a.SCENE_UPDATED],this);c.subscribe([a.MODELS_LOADED,a.DEFAULT_LUT_LOADED],this);c.fire(a.SCENE_NEW,this)};nucleo.Scene.prototype.handleEvent=function(a,c){if(a==nucleo.EVENTS.MODELS_LOADED){this.updateScalarRange();if(this.lutID!=null){this.setLookupTable(this.lutID)}}else{if(a==nucleo.EVENTS.DEFAULT_LUT_LOADED){this.lutID="default";
this.setLookupTable(this.lutID)}}};nucleo.Scene.prototype.setLoadingMode=function(c){var a=Model.loadingMode;if(c==undefined||c==null||(c!=a.LIVE&&c!=a.LATER&&c!=a.DETACHED)){throw ("the mode "+c+"is not a valid loading mode")}this.loadingMode=c};nucleo.Scene.prototype._updateBoundingBoxWith=function(c){var a=c._bb;nucleo.util.console("Scene: updating metrics with ("+a[0]+","+a[1]+","+a[2]+") - ("+a[3]+","+a[4]+","+a[5]+")");if(this._actors.length==1){this.bb=this._actors[0]._bb.slice(0);this.toys.update();
return}var d=this.bb;var e=this.centre;d[0]=Math.min(d[0],a[0]);d[1]=Math.min(d[1],a[1]);d[2]=Math.min(d[2],a[2]);d[3]=Math.max(d[3],a[3]);d[4]=Math.max(d[4],a[4]);d[5]=Math.max(d[5],a[5]);e[0]=(d[3]+d[0])/2;e[1]=(d[4]+d[1])/2;e[2]=(d[5]+d[2])/2;e[0]=Math.round(e[0]*1000)/1000;e[1]=Math.round(e[1]*1000)/1000;e[2]=Math.round(e[2]*1000)/1000;this.toys.update()};nucleo.Scene.prototype.computeBoundingBox=function(){if(this._actors.length>0){this.bb=this._actors[0]._bb.slice(0)}else{this.bb=[0,0,0,0,0,0]
}this.centre=[0,0,0];var a=this._actors.length;while(a--){this._updateBoundingBoxWith(this._actors[a])}};nucleo.Scene.prototype.createActor=function(a){var c=new nucleo.Actor(a);this.addActor(c);return c};nucleo.Scene.prototype.createActors=function(c){var a=c.length;while(a--){this.createActor(c[a])}};nucleo.Scene.prototype.addActor=function(a){a.setScene(this);if(this.normalsFlipped){a.flipNormals(true)}if(this.lutID!=null){a.setLookupTable(this.lutID,this.scalarMIN,this.scalarMAX)}this._actors.push(a);
this._updateBoundingBoxWith(a);nucleo.util.console("Scene: Actor for model "+a.model.name+" added");nucleo.Notifier.instance.fire(nucleo.EVENTS.SCENE_UPDATED,this)};nucleo.Scene.prototype.updateActor=function(c){if(!this.hasActor(c)){return}c.dirty=true;var a=this.views.length;while(a--){this.views[a].renderer.reallocate()}c.dirty=false};nucleo.Scene.prototype.removeActor=function(d){var c=this._actors.indexOf(d);var a=this._actors.splice(c,1);a=null;this.computeBoundingBox()};nucleo.Scene.prototype.hasActor=function(c){if(c instanceof nucleo.Actor){return(this._actors.indexOf(c)!=-1)
}else{if(typeof(c)=="string"){var a=this.getActorByName(c);return(a!=undefined)}else{return false}}};nucleo.Scene.prototype.setPropertyForAll=function(d,c){var a=this._actors.length;while(a--){this._actors[a].setProperty(d,c)}};nucleo.Scene.prototype.setPropertyFor=function(f,e,d){var a=f.length;while(a--){if(this.hasActor(f[a])){var c=undefined;if(typeof(f[a])=="string"){c=this.getActorByName(f[a])}else{if(f[a] instanceof nucleo.Actor){f[a].setProperty(e,d)}else{throw"Scene.setPropertyFor: ERROR, the list of actors is invalid"
}}}}};nucleo.Scene.prototype.updateScalarRange=function(){var a=this._actors.length;while(a--){var c=this._actors[a];if(c.model.scalars&&c.model.scalars.max()>this.scalarMAX){this.scalarMAX=c.model.scalars.max()}if(c.model.scalars&&c.model.scalars.min()<this.scalarMIN){this.scalarMIN=c.model.scalars.min()}}};nucleo.Scene.prototype.setLookupTable=function(c){this.lutID=c;var a=this._actors.length;while(a--){this._actors[a].setLookupTable(c,this.scalarMIN,this.scalarMAX)}};nucleo.Scene.prototype.reset=function(){var a=this._actors.length;
while(a--){this._actors[a]=null}this._actors=[];nucleo.c.actor=null;this.computeBoundingBox()};nucleo.Scene.prototype.getActorByName=function(a){a=a.replace(/\.[^/.]+$/,"");var c=this._actors.length;while(c--){if(this._actors[c].name==a){return this._actors[c]}}return null};nucleo.Scene.prototype.getActorByUID=function(a){var c=this._actors.length;while(c--){if(this._actors[c].UID==a){return this._actors[c]}}return null};nucleo.Scene.prototype.getActor=function(c){var a=this.getActorByName(c);if(a==null){a=this.getActorByUID(c)
}return a};nucleo.Scene.prototype.getActorsThat=function(f){var a=[];var e=this._actors.length;while(e--){if(f(this._actors[e])){a.push(e)}}var d=[];var c=a.length;while(c--){d.push(this._actors[a[c]])}return d};nucleo.Scene.prototype.setOpacity=function(e,a){if(a==null){var c=this._actors.length;while(c--){this._actors[c].setOpacity(e)}}else{var d=this.getActorByName(a);d.setOpacity(e)}};nucleo.Scene.prototype.flipNormals=function(){var a=this._actors.length;while(a--){this._actors[a].flipNormals()
}};nucleo.Scene.prototype.setVisualizationMode=function(c){if(c==null||c==undefined){return}var a=this._actors.length;while(a--){this._actors[a].setVisualizationMode(c)}};nucleo.Scene.prototype.setAnimation=function(c){if(c instanceof nucleo.FrameAnimation){this.frameAnimation=c;this.frameAnimation.scene=this;var a=this.views.length;while(a--){this.views[a].renderer.setMode(nucleo.Renderer.MODE.ANIMFRAME)}nucleo.util.console("Scene: animation added")}};nucleo.Scene.prototype.clearAnimation=function(){if(this.frameAnimation){this.frameAnimation.scene=null;
this.frameAnimation=null}};nucleo.Scene.prototype.getActorNames=function(){var c=[];var a=this._actors.length;while(a--){c.push(this._actors[a].name)}return c};nucleo.Scene.prototype.getPickableActors=function(){function a(c){return c.isPickable()}return this.getActorsThat(a)};nucleo.Scene.prototype.getActorByCellUID=function(a){var e=[];var c=this._actors.length;while(c--){var d=this._actors[c];if(d.mesh!=undefined&&d.mesh.hasCell(a)){return d}}return null};nucleo.Scene.prototype.createActorGroup=function(a,d){var e=undefined;
if(this.getActorGroup(a)!=undefined){alert("Scene.createActorGroup: an actor group with the name "+a+" already exists");throw ("Scene.createActorGroup: an actor group with the name "+a+" already exists")}try{e=new ActorGroup(this,a,d);this._groups.push(e)}catch(c){if(c instanceof vxlActorGroupException){alert(c.messages)}}finally{return e}};nucleo.Scene.prototype.getActorGroup=function(a){var c=this._groups.length;while(c--){if(this._groups[c].name==a){return this._groups[c]}}return undefined};nucleo.SceneToys=function SceneToys(a){this.scene=a;
this.list=[];this.axis=new nucleo.Axis();this.boundingbox=new nucleo.BoundingBox();this.floor=new nucleo.Floor();this.list.push(this.axis);this.list.push(this.boundingbox);this.list.push(this.floor)};nucleo.SceneToys.prototype.update=function(){this.axis.setCentre(this.scene.centre);this.boundingbox.setBoundingBox(this.scene.bb)};nucleo.LookupTable=function LookupTable(){this.ID=null;this.map=null;this.max=Number.MIN_VALUE;this.min=Number.MAX_VALUE};nucleo.LookupTable.prototype.load=function(a,d){this.ID=a;
this.map=d;for(var c in this.map){var e=Number(c);if(e<this.min){this.min=e}else{if(e>=this.max){this.max=e}}}};nucleo.LookupTable.prototype._scale=function(d,c,a){return d*this.max/a};nucleo.LookupTable.prototype.getColor=function(j,f,a){var h=this._scale(j,f,a);var d=this;var e=Math.round(h);if(e>=d.min&&e<=d.max){var k=[d.map[e][0],d.map[e][1],d.map[e][2]];return k}else{if(e<d.min){return[d.map[d.min][0],d.map[d.min][1],d.map[d.min][2]]}else{if(e>d.max){return[d.map[d.max][0],d.map[d.max][1],d.map[d.max][2]]
}else{alert("assertion error in getColor routine");return[d.map[d.min][0],d.map[d.min][1],d.map[d.min][2]]}}}};nucleo.LookupTable.prototype.getColors=function(f,e,a){var j=[];for(var d=0;d<f.length;d++){var h=this.getColor(f[d],e,a);j.push(h[0]);j.push(h[1]);j.push(h[2])}return j};nucleo.LookupTableManager=function LookupTableManager(){this._hashmap={};this._location="";nucleo.Notifier.instance.publish(nucleo.EVENTS.DEFAULT_LUT_LOADED,this)};nucleo.LookupTableManager.prototype.setLocation=function(a){this._location=a
};nucleo.LookupTableManager.prototype.load=function(d){if(this.isLoaded(d)){return}var e=this;var h=this._location+"/"+d+".lut";var j=h+"?nocache="+(new Date()).getTime();var c=function(l,k){return function(m,n){l._handle(k,m)}};var a=function(k){return function(n,l,m){if(m.code=1012){alert("The file "+k+" could not be accessed. \n\nPlease make sure that the path is correct and that you have the right pemissions")}else{alert("There was a problem loading the file "+k+". HTTP error code:"+n.status)
}}};var f=$.ajax({url:j,type:"GET",dataType:"json",mimeType:"text/plain",success:c(e,d),error:a(h)})};nucleo.LookupTableManager.prototype._handle=function(a,d){var c=new nucleo.LookupTable();c.load(a,d);this._hashmap[a]=c;if(c.ID==nucleo.def.lut.main){nucleo.Notifier.instance.fire(nucleo.EVENTS.DEFAULT_LUT_LOADED,this)}};nucleo.LookupTableManager.prototype.isLoaded=function(a){return this._hashmap[a]!=undefined};nucleo.LookupTableManager.prototype.get=function(a){return this._hashmap[a]};nucleo.LookupTableManager.prototype.getAllLoaded=function(){var a=[];
for(lut in this._hashmap){a.push(this._hashmap[lut].ID)}return a};nucleo.LookupTableManager.prototype.allLoaded=function(){var c=0;for(var a in this._hashmap){c++}return(nucleo.define.LookupTable.list.length==c)};nucleo.LookupTableManager.prototype.loadAll=function(){for(var a=0;a<nucleo.define.LookupTable.list.length;a++){this.load(nucleo.define.LookupTable.list[a])}};nucleo.LookupTableManager.instance=new nucleo.LookupTableManager();nucleo.BoundingBox=function BoundingBox(){var a=new nucleo.Model();
a.load("bounding box",nucleo.define.Model.BoundingBox);nucleo.Actor.call(this,a);this.bb=this.setBoundingBox([-1,-1,-1,1,1,1]);this.mode=nucleo.Actor.MODE.WIREFRAME;this.visible=false;this.toy=true};nucleo.BoundingBox.prototype=new nucleo.Actor();nucleo.BoundingBox.prototype.constructor=nucleo.BoundingBox;nucleo.BoundingBox.prototype.setBoundingBox=function(a){this.bb=[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5],a[3],a[1],a[5]];this.model.vertices=this.bb;
this.reallocate()};nucleo.Axis=function Axis(){var a=new nucleo.Model();a.load("axis",nucleo.define.Model.Axis);nucleo.Actor.call(this,a);this.centre=[0,0,0];this.mode=nucleo.Actor.MODE.WIREFRAME;this.visible=false;this.toy=true};nucleo.Axis.prototype=new nucleo.Actor();nucleo.Axis.prototype.constructor=nucleo.Axis;nucleo.Axis.prototype.setCentre=function(d){var c=d[0];var f=d[1];var e=d[2];this.centre[0]=c;this.centre[1]=f;this.centre[2]=e;var a=this.model.vertices;a[0]=c-1;a[1]=f;a[2]=e;a[3]=c+1;
a[4]=f;a[5]=e;a[6]=c;a[7]=f-2;a[8]=e;a[9]=c;a[10]=f+2;a[11]=e;a[12]=c;a[13]=f;a[14]=e-1;a[15]=c;a[16]=f;a[17]=e+1};nucleo.Floor=function Floor(){var a=new nucleo.Model();a.load("floor",nucleo.define.Model.Floor);nucleo.Actor.call(this,a);this.mode=nucleo.Actor.MODE.WIREFRAME;this.visible=false;this.toy=true};nucleo.Floor.prototype=new nucleo.Actor();nucleo.Floor.prototype.constructor=nucleo.Floor;nucleo.Floor.prototype.setGrid=function(j,k){var h=j;var c=2*h/k;var f=2*h/c;var d=[];var e=[];for(var a=0;
a<=c;a++){d[6*a]=-h;d[6*a+1]=0;d[6*a+2]=-h+(a*f);d[6*a+3]=h;d[6*a+4]=0;d[6*a+5]=-h+(a*f);d[6*(c+1)+6*a]=-h+(a*f);d[6*(c+1)+6*a+1]=0;d[6*(c+1)+6*a+2]=-h;d[6*(c+1)+6*a+3]=-h+(a*f);d[6*(c+1)+6*a+4]=0;d[6*(c+1)+6*a+5]=h;e[2*a]=2*a;e[2*a+1]=2*a+1;e[2*(c+1)+2*a]=2*(c+1)+2*a;e[2*(c+1)+2*a+1]=2*(c+1)+2*a+1}this.model.vertices=d.slice(0);this.model.wireframe=e.slice(0);this.visible=true;this.reallocate()};nucleo.View=function View(f,d,h){this.UID=nucleo.util.generateUID();this.canvas=document.getElementById(f);
if(this.canvas==null||this.canvas==undefined){alert("View: the canvas "+f+" does not exist.");throw ("View: the canvas "+f+" does not exist.")}this.name=f;this.width=this.canvas.width;this.height=this.canvas.height;this.clearDepth=1;this.backgroundColor=nucleo.View.BACKGROUND.slice(0);this._dragndrop=false;this.renderer=new nucleo.Renderer(this);this.cameraman=new nucleo.CameraManager(this);this.interactor=new nucleo.TrackerInteractor();this._fullscreenFlag=true;if(d!=null&&d instanceof nucleo.Scene){this.scene=d
}else{this.scene=new nucleo.Scene()}this.scene.views.push(this);if(h==undefined){h=true}this.setAutoResize(h);this.setBackgroundColor(this.backgroundColor);this.setClearDepth(this.clearDepth);this.interactor.connectView(this);var c=nucleo.Notifier.instance;var a=nucleo.EVENTS;c.publish(a.VIEW_NEW,this);c.subscribe(a.DEFAULT_LUT_LOADED,this);c.fire(a.VIEW_NEW,this);nucleo.util.console("View: the view "+this.name+" has been created")};nucleo.View.BACKGROUND=nucleo.define.View.BACKGROUND;nucleo.View.prototype.handleEvent=function(a,c){nucleo.util.console("View ["+this.name+"]: receiving event "+a);
if(a==nucleo.EVENTS.DEFAULT_LUT_LOADED){this.scene.setLookupTable(nucleo.def.lut.main)}};nucleo.View.prototype.clear=function(){this.renderer.clear()};nucleo.View.prototype.resize=function(){var a=this.canvas,c=a.parentElement,d=c.getBoundingClientRect();this.width=d.width;if(c==document.body){this.height=window.innerHeight-(d.bottom-d.height+d.top)}else{this.height=d.height}this.canvas.width=this.width;this.canvas.height=this.height};nucleo.View.prototype.setAutoResize=function(a){if(a){this.resize()
}if(nucleo.jquery){if(a){$(window).resize((function(c){return function(){c.resize()}})(this))}else{$(window).unbind("resize")}}else{if(a){window.onresize=(function(c){return function(d){c.resize()}})(this)}else{}}};nucleo.View.prototype._runPrefixMethod=function(e,h){var f=["webkit","moz","ms","o",""];var d=0,a,c;while(d<f.length&&!e[a]){a=h;if(f[d]==""){a=a.substr(0,1).toLowerCase()+a.substr(1)}a=f[d]+a;c=typeof e[a];if(c!="undefined"){f=[f[d]];return(c=="function"?e[a]():e[a])}d++}};nucleo.View.prototype.fullscreen=function(a){if(!this._fullscreenFlag){return
}if(a==true){var c=navigator.userAgent.toLowerCase().indexOf("chrome")>-1;if(c){this._runPrefixMethod(this.canvas,"RequestFullscreen")}else{this._runPrefixMethod(this.canvas,"RequestFullScreen")}}else{if(document.cancelFullScreen){document.cancelFullScreen()}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else{if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}}}}};nucleo.View.prototype.disableFullScreen=function(){this._fullscreenFlag=false};nucleo.View.prototype.enableFullScreen=function(){this._fullscreenFlag=true
};nucleo.View.prototype.start=function(){this.renderer.start();this.refresh()};nucleo.View.prototype.stop=function(){this.renderer.stop()};nucleo.View.prototype.reset=function(){this.stop();this.scene.reset();this.cameraman.reset();this.start()};nucleo.View.prototype.setBackgroundColor=function(d,c,a){this.backgroundColor=nucleo.util.createColor(d,c,a);this.renderer.clearColor(this.backgroundColor)};nucleo.View.prototype.setClearDepth=function(a){this.renderer.clearDepth(a)};nucleo.View.prototype.refresh=function(){if(this.renderer.mode!=nucleo.Renderer.MODE.ANIMFRAME){this.renderer.render()
}};nucleo.View.prototype.setInteractor=function(a){this.interactor=a;this.interactor.connectView(this)};nucleo.View.prototype.setDragAndDrop=function(a){this._dragndrop=a};nucleo.View.prototype.getFPS=function(){return this.renderer.fps};nucleo.View.prototype.getCurrentCamera=function(){return this.cameraman.active};nucleo.View.prototype.load=function(d,f,h){var c=[];var e=nucleo.util.getPath(f);if(typeof(d)=="string"||d instanceof String){c.push(e+d)}else{if((d instanceof Array)){for(var a=0;a<d.length;
a++){c.push(e+d[a])}}else{throw Exception("not a valid argument")}}if(h!=undefined&&h!=null){this.scene.setLoadingMode(h)}nucleo.ModelManager.instance.loadList(c,this.scene)};nucleo.ModelManager=function ModelManager(){this.toLoad=[];this.models=[];var a=nucleo.EVENTS;nucleo.Notifier.instance.publish([a.MODELS_LOADING,a.MODEL_NEW,a.MODELS_LOADED],this);nucleo.Notifier.instance.subscribe(a.READER_DONE,this)};nucleo.ModelManager.prototype.handleEvent=function(d,e){var a=e;var c=a.getModel();this.add(c,a.scene)
};nucleo.ModelManager.prototype.load=function(d,j){var f=this;var a=d.replace(/^.*[\\\/]/,"");var e=a.split(".")[0];var m=a.split(".")[1];var n="json";var c="application/json";if(f.isModelLoaded(e)){return}if(m=="vtk"){n="text";c="text/plain"}else{if(m=="json"){n="json"}else{alert("vxlManager.load ERROR: Unknown filetype ["+m+"]");throw ("vxlManager.load ERROR: Unknown filetype ["+m+"]")}}nocacheuri=d+"?nocache="+(new Date()).getTime();nucleo.util.console("ModelManager.load: Requesting "+d+"...");
nucleo.Notifier.instance.fire(nucleo.EVENTS.MODELS_LOADING,this);var l=function(q,o,s){switch(m){case"json":return function(t,u){t.uri=a;t.path=nucleo.util.getPath(d);t.name=o;q.add(t,s)};break;case"vtk":return function(u){var t=new VTKReader(s);t.readText(o,u)}}};var k=function(o){return function(t,q,s){if(s.code=1012){alert("The file "+o+" could not be accessed. \n\nPlease make sure that the path is correct and that you have the right pemissions")}else{alert("There was a problem loading the file "+o+". HTTP error code:"+t.status)
}}};var h=$.ajax({url:nocacheuri,type:"GET",dataType:n,mimeType:c,success:l(f,e,j),error:k(d)})};nucleo.ModelManager.prototype.loadList=function(c,d){this.toLoad=c.slice(0);nucleo.util.console("ModelManager.loadList: models to load ->"+this.toLoad.length);for(var a=0;a<this.toLoad.length;a++){this.load(this.toLoad[a],d)}};nucleo.ModelManager.prototype.add=function(f,a){var d=this,e;if(f instanceof nucleo.Model){e=f}else{e=new nucleo.Model(f.name,f)}function c(){e.loaded=true;d.models.push(e);d.toLoad.splice(name,1);
nucleo.util.console("ModelManager: model "+e.name+" created.");if(a!=undefined&&a instanceof nucleo.Scene){nucleo.util.console("ModelManager: notifying the scene...");if(a.loadingMode==nucleo.Model.LOADING_MODE.LIVE){a.createActor(e)}else{if(a.loadingMode==nucleo.Model.LOADING_MODE.LATER){if(d.allLoaded()){a.createActors(d.models)}}else{if(a.loadingMode==nucleo.Model.LOADING_MODE.DETACHED){}}}}if(d.allLoaded()){nucleo.Notifier.instance.fire(nucleo.EVENTS.MODELS_LOADED,d)}else{nucleo.Notifier.instance.fire(nucleo.EVENTS.MODEL_NEW,d)
}}setTimeout(function(){c()},0)};nucleo.ModelManager.prototype.reset=function(){this.firstLoadedModel=false;for(var a=0;a<this.models.length;a++){this.models[a]=null}this.models=[];this.toLoad=[]};nucleo.ModelManager.prototype.isModelLoaded=function(a){for(var c=0;c<this.models.length;c++){if(this.models[c].name==a){return true}}return false};nucleo.ModelManager.prototype.allLoaded=function(){return(this.toLoad.length==0)};nucleo.ModelManager.prototype.getModelByName=function(c){for(var d=0,a=this.models.length;
d<a;d+=1){if(this.models[d].name==c){return this.models[d]}}return null};nucleo.ModelManager.instance=new nucleo.ModelManager();var nucleo=nucleo||{};nucleo.FrameAnimation=function FrameAnimation(a){this.scene=null;this.actorByFrameMap=[];this.activeFrame=1;this.mark=1;this._running=false;this.frameCount=0;this.renderRate=500;this._startDate=undefined;this._time=0;this._setup(a)};nucleo.FrameAnimation.prototype.addActorToFrame=function(c,a){if(typeof(this.actorByFrameMap[c])=="undefined"){this.actorByFrameMap[c]=new Array()
}if(this.actorByFrameMap[c].indexOf(a)==-1){this.actorByFrameMap[c].push(a)}if(c>this.frameCount){this.frameCount=c}};nucleo.FrameAnimation.prototype._setup=function(h){this.activeFrame=1;for(var e in h){var c=h[e];var j=parseInt(e.substr(5,e.length));for(var d=0,a=c.length;d<a;d+=1){this.addActorToFrame(j,c[d])}}nucleo.util.console("FrameAnimation: Setup finished.")};nucleo.FrameAnimation.prototype.start=function(){if(this.scene==null){throw"FrameAnimation: the animation is not associated with any scene. Please use scene.setFrameAnimation method"
}this._startDate=new Date().getTime();this._time=0;this._running=true;if(rate!=undefined&&rate>=0){this.renderRate=rate}this._timeUp()};nucleo.FrameAnimation.prototype._timeUp=function(){if(!this._running){return}this.nextFrame();if(this._time==this.renderRate*100){this._time=0;this._startDate=new Date().getTime()}this._time+=this.renderRate;var a=(new Date().getTime()-this._startDate)-this._time;if(a>this.renderRate){a=0}setTimeout((function(c){return function(){c._timeUp()}})(this),this.renderRate-a)
};nucleo.FrameAnimation.prototype.stop=function(){this._running=false};nucleo.FrameAnimation.prototype.setFrameRate=function(a){if(a<=0){return}this.stop();this.renderRate=a;this.start()};nucleo.FrameAnimation.prototype.update=function(){if(this.scene==null){throw"FrameAnimation: the animation is not associated with any scene. Please use scene.setFrameAnimation method"}this.scene.setPropertyForAll("visible",false);var d=this.actorByFrameMap[this.activeFrame];var a=d.length;for(var c=0;c<a;c++){var e=this.scene.getActorByName(d[c]);
if(e!=null){e.setVisible(true)}}};nucleo.FrameAnimation.prototype.isValidFrame=function(a){return(a>=1&&a<=this.frameCount)};nucleo.FrameAnimation.prototype.nextFrame=function(){if(this.activeFrame<this.frameCount){this.activeFrame++}else{this.activeFrame=1}};nucleo.FrameAnimation.prototype.getNextFrames=function(h){var e=[];var f=this.activeFrame;if(h>this.frameCount){h=this.frameCount}for(var a=1;a<=h;a++){var d=f+a;if(this.isValidFrame(d)){e.push(d)}else{e.push(d-this.frameCount)}}nucleo.util.console("Animation: next frames: "+e);
return e};nucleo.FrameAnimation.prototype.getPreviousFrames=function(h){var e=[];var f=this.activeFrame;if(h>this.frameCount){h=this.frameCount}for(var a=1;a<=h;a++){var d=f-a;if(this.isValidFrame(d)){e.push(d)}else{e.push(this.frameCount+d)}}nucleo.util.console("Animation: previous frames: "+e);return e};nucleo.FrameAnimation.prototype.setFrame=function(a){if(a>=1&&a<=this.frameCount){this.activeFrame=a;this.render()}};nucleo.VTKReader=function VTKReader(a){this.scene=a;nucleo.Notifier.instance.publish(nucleo.EVENTS.READER_DONE,this)
};nucleo.VTKReader.prototype.isSupported=function(){return(window.File&&window.FileReader&&window.FileList&&window.Blob)};nucleo.VTKReader.prototype.readFile=function(e){var a=this;var d=e.name;if(d.length-4!==d.indexOf(".vtk")){throw"VTKReader.read: the file "+e+" is not a VTK file"}modelname=d.replace(/\.[^/.]+$/,"");var c=new FileReader();c.onload=function(j){document.body.style.cursor="default";var h=j.target.result.trim();var f=h.split(/\r\n|\r|\n/);a._parse(modelname,f);nucleo.Notifier.instance.fire(nucleo.EVENTS.READER_DONE,a)
};document.body.style.cursor="wait";c.readAsText(e)};nucleo.VTKReader.prototype.readText=function(c,d){document.body.style.cursor="wait";var a=d.split(/\r\n|\r|\n/);this._parse(c,a);nucleo.Notifier.instance.fire(nucleo.EVENTS.READER_DONE,this);document.body.style.cursor="default"};nucleo.VTKReader.prototype._parse=function(C,d){var f=65536*3;var z="";var e=0;var c="NOWHERE";var j=0;var m=[];var l=[];var x=[];var h=[];var q=[];var u="SOLID";var w={NOWHERE:0,POINTS:1,LINES:2,POLYGONS:3,POINT_DATA:4,NORMALS:5,CELL_DATA:6,TEXTURE_COORDINATES:7,SCALARS:8,LOOKUP_TABLE:9,COLOR_SCALARS:10};
this.json={name:C};function o(n){var E=n.length-1;if(E!=n[0]){throw"Assertion Error. Inconsistent line"}var v=n.splice(1,E);for(var D=0;D<E-1;D+=1){l.push(parseInt(v[D]));l.push(parseInt(v[D+1]))}}for(var j=0;j<d.length;j++){try{if(d[j].indexOf("POINTS")==0){console.log(d[j]);c=w.POINTS;continue}else{if(d[j].indexOf("LINES")==0){console.log(d[j]);c=w.LINES;u="LINES";continue}else{if(d[j].indexOf("TRIANGLE_STRIPS")==0){console.log(d[j]);alert("vxlVTKParser ERROR: \nTriangle Strips Not Supported. Please triangulate first");
throw ("Triangle Strips Not Supported. Please triangulate first")}else{if(d[j].indexOf("POLYGONS")==0){console.log(d[j]);c=w.POLYGONS;continue}else{if(d[j].indexOf("POINT_DATA")==0){c=w.POINT_DATA;continue}else{if(d[j].indexOf("NORMALS")==0){console.log(d[j]);c=w.NORMALS;continue}else{if(d[j].indexOf("CELL_DATA")==0){console.log(d[j]);c=w.CELL_DATA;continue}else{if(d[j].indexOf("TEXTURE_COORDINATES")==0){console.log(d[j]);c=w.TEXTURE_COORDINATES;continue}else{if(d[j].indexOf("SCALARS")==0){console.log(d[j]);
c=w.SCALARS;continue}else{if(d[j].indexOf("LOOKUP_TABLE")==0){console.log(d[j]);c=w.LOOKUP_TABLE;continue}else{if(d[j].indexOf("COLOR_SCALARS")==0){console.log(d[j]);c=w.COLOR_SCALARS;continue}else{if(c==w.POINTS){var s=d[j].trim().split(" ");if(s==""){continue}for(var A=0;A<s.length;A++){m.push(parseFloat(s[A]))}}else{if(c==w.LINES){var t=d[j].trim().split(" ");if(t==""){continue}o(t)}else{if(c==w.POLYGONS){var a=d[j].trim().split(" ");if(a==""){continue}if(a.length>0&&a[0]!="3"){throw"Error: please make sure your vtk file contains triangles instead of polygons (triangulate first)"
}for(var A=1;A<a.length;A++){l.push(parseInt(a[A]))}}else{if(c==w.LOOKUP_TABLE){if(d[j].indexOf("LOOKUP_TABLE")==0){continue}else{var B=d[j].trim().split(" ");if(B==""){continue}for(var A=0;A<B.length;A++){h.push(parseFloat(B[A]))}}}else{if(c==w.COLOR_SCALARS){var y=d[j].trim().split(" ");if(y==""){continue}for(var A=0;A<y.length;A++){q.push(parseFloat(y[A]))}}else{if(c==w.NORMALS){var y=d[j].trim().split(" ");if(y==""){continue}for(var A=0;A<y.length;A++){x.push(parseFloat(y[A]))}}}}}}}}}}}}}}}}}}}catch(k){console.log("Error while processing line "+j.toString());
throw k}}this.json.vertices=m;this.json.mode=u;if(l.length>0){this.json.indices=l}if(x.length>0){this.json.normals=x}if(q.length>0){this.json.colors=q}if(h.length>0){this.json.scalars=h}};nucleo.VTKReader.prototype.getModel=function(){var a=new Model(this.json.name,this.json);this.json=null;delete this.json;return a};nucleo.Texture=function Texture(c){var a=this;this.image=new Image();this.image.onload=function(){a._onLoad()};this.image.onError=function(){a._onError()};this.uri=c;if(this.uri!=undefined){this.load(this.uri)
}this.mag=nucleo.Texture.FILTER.LINEAR;this.min=nucleo.Texture.FILTER.LINEAR_MIPMAP_LINEAR;this.loaded=false};nucleo.Texture.FILTER=nucleo.define.Texture.FILTER;nucleo.Texture.prototype.setMagFilter=function(a){this.mag=a};nucleo.Texture.prototype.setMinFilter=function(a){this.min=a};nucleo.Texture.prototype.load=function(a){this.image.src=a};nucleo.Texture.prototype._onError=function(){console.info("Texture: the texture "+this.uri+" could not be found.");this.loaded=false};nucleo.Texture.prototype._onLoad=function(){this.loaded=true
};nucleo.Texture.prototype.getMagFilter=function(c){var a=nucleo.def.texture.filter;switch(this.mag){case a.LINEAR:return c.LINEAR;break;case a.NEAREST:return c.NEAREST;break;default:return c.NEAREST}};nucleo.Texture.prototype.getMinFilter=function(c){var a=nucleo.Texture.FILTER;switch(this.min){case a.LINEAR:return c.LINEAR;break;case a.NEAREST:return c.NEAREST;break;case a.LINEAR_MIPMAP_LINEAR:return c.LINEAR_MIPMAP_LINEAR;break;case a.LINEAR_MIPMAP_NEAREST:return c.LINEAR_MIPMAP_NEAREST;break;
case a.NEAREST_MIPMAP_LINEAR:return c.NEAREST_MIPMAP_LINEAR;break;case a.NEAREST_MIPMAP_NEAREST:return c.NEAREST_MIPMAP_NEAREST;break;default:return c.NEAREST}};nucleo.Material=function Material(a){this.ambient=nucleo.Material.AMBIENT;this.diffuse=nucleo.Material.DIFFUSE;this.specular=nucleo.Material.SPECULAR;this.shininess=nucleo.Material.SHININESS;this.opacity=nucleo.Material.OPACITY;this.shading=nucleo.Material.SHADING;this.texture=undefined;this.colors=undefined;if(a){this.getFrom(a)}};nucleo.Material.AMBIENT=nucleo.define.Material.AMBIENT;
nucleo.Material.DIFFUSE=nucleo.define.Material.DIFFUSE;nucleo.Material.SPECULAR=nucleo.define.Material.SPECULAR;nucleo.Material.SHININESS=nucleo.define.Material.SHININESS;nucleo.Material.OPACITY=nucleo.define.Material.OPACITY;nucleo.Material.SHADING=nucleo.define.Material.SHADING;nucleo.Material.prototype.getFrom=function(a){if(a.ambient!=undefined){this.ambient=a.ambient.slice(0)}if(a.diffuse!=undefined){this.diffuse=a.diffuse.slice(0)}if(a.specular!=undefined){this.specular=a.specular.slice(0)}if(a.color!=undefined){this.diffuse=a.color.slice(0)
}if(a.shininess!=undefined){this.shininess=a.shininess}if(a.opacity!=undefined){this.opacity=a.opacity}if(a.shading!=undefined){this.shading=a.shading}if(a.texture!=undefined){this.texture=new Texture(a.path+a.texture)}if(a.colors!=undefined){this.colors=a.colors}return this};nucleo.Material.prototype.clone=function(){var d=new Material();var a=this;for(var c in a){if(a.hasOwnProperty(c)){if(a[c] instanceof Array){d[c]=a[c].slice(0)}else{d[c]=a[c]}}}return d};nucleo.Renderable=function Renderable(a){if(a==undefined){throw ("Renderable: the actor can not be undefined")
}this.actor=a;this.parts=[];this.update(nucleo.Renderable.TASK.CREATE)};nucleo.Renderable.prototype.update=function(a){if(a==undefined){throw ("Renderable.update: Please specify a task")}var c=this._getModel();if(c==undefined){return}switch(c.type){case nucleo.Model.TYPE.MESH:this._processMesh(c,a);break;case nucleo.Model.TYPE.BIG_DATA:this._processBigData(c,a);break}};nucleo.Renderable.prototype._getModel=function(){var a=this.actor;if(a.mesh&&a.mesh.model){return a.mesh.model}else{if(a.model.type==nucleo.Model.TYPE.BIG_DATA){return a.model
}else{return undefined}}};nucleo.Renderable.prototype._processMesh=function(k,d){var n=Model.MAX_NUM_INDICES;var l=Math.floor(k.indices.length/n),f=k.indices.length%n;if(d==Renderable.TASK.CREATE){this.parts=[];for(var h=0;h<=l;h+=1){var c=new Model(k.name+"-renderable-part-"+h);var m=h*n;var j=m+n;var a=h*n*3;var e=a+n*3;if(h==l){m=l*n;j=m+f;a=l*n*3;e=a+f*3;if(f==0){break}}c.indices=this._reindex(k.indices.slice(m,j));c.vertices=k.vertices.slice(a,e);if(k.normals&&k.normals.length>0){c.normals=k.normals.slice(a,e)
}if(k.colors&&k.colors.length>0){c.colors=k.colors.slice(a,e)}if(k.pickingColors){c.pickingColors=k.pickingColors.slice(a,e)}c.update();this.parts.push(c)}}else{if(d==Renderable.TASK.UPDATE_COLORS){for(var h=0;h<=l;h+=1){var c=this.parts[h];var a=h*n*3;var e=a+n*3;if(h==l){a=l*n*3;e=a+f*3;if(f==0){break}}if(k.colors&&k.colors.length>0){c.colors=k.colors.slice(a,e)}}}}};nucleo.Renderable.prototype._reindex=function(d){var c=d.min();var a=d.length;while(a--){d[a]=d[a]-c}return d};nucleo.Renderable.prototype._processBigData=function(h,n){var o=h.indices,v=Model.MAX_NUM_INDICES;
if(h.mode==nucleo.Actor.MODE.LINES){v=v-1}var q=o.length,f=o.max(),m=this.actor.material,k=(m.colors&&m.colors.length>0),d=(h.normals&&h.normals.length>0),u=(h.scalars&&h.scalars.length>0),j=h.mode;data={vertices:[],indices:[],mode:j};if(k){data.colors=[]}if(d){data.normals=[]}if(u){data.scalars=[]}var s={},t=1,l=0,a=0;for(var e=0;e<q;e+=1){index=o[e];if(s[index]==undefined){s[index]=l;vertex=this._getVertexData(index);data.vertices.push.apply(data.vertices,vertex.coords);if(d){data.normals.push.apply(data.normals,vertex.normal)
}if(k){data.colors.push.apply(data.colors,vertex.color)}if(u){data.scalars.push(vertex.scalar)}l+=1}data.indices.push(s[index]);if((l==v+1)||(e==q-1)){var c=new Model(h.name+"-renderable-part-"+t,data);c.update();nucleo.util.console("Creating part "+c.name+" ["+t+"]",true);this.parts.push(c);l=0;t+=1;c={vertices:[],indices:[],mode:j};s={};data={vertices:[],indices:[],mode:j};if(k){data.colors=[]}if(d){data.normals=[]}if(u){data.scalars=[]}}}};nucleo.Renderable.prototype._getVertexData=function(c){var d=this.actor.material;
var a=this.actor.model;var e={};e.coords=a.vertices.slice(c*3,c*3+3);if(a.normals){e.normal=a.normals.slice(c*3,c*3+3)}if(d.colors){e.color=d.colors.slice(c*3,c*3+3)}if(a.scalars){e.scalar=a.scalars[c]}return e};nucleo.ActorGroup=function ActorGroup(d,a,c){this.scene=d;this.name=a;this.list=[];this.addList(c)};nucleo.ActorGroup.prototype.addList=function(f){var e=[];for(var c=0,h=f.length;c<h;c+=1){var d=f[c];if(d instanceof nucleo.Actor&&d.scene==this.scene){this.list.push(d)}else{if(typeof(d)=="string"){var a=this.scene.getActor(d);
if(a!=null){this.list.push(a)}else{e.push("Could not find actor: "+d)}}else{e.push("The object "+d+" is not of the expected type (Actor, string)")}}}if(e.length!=0){this.list=[];throw new vxlActorGroupException(e)}};nucleo.ActorGroup.prototype.add=function(c){var d=[];if(c instanceof nucleo.Actor&&c.scene==this.scene){this.list.push(c)}else{if(typeof(c)=="string"){var a=this.scene.getActor(c);if(a!=null){this.list.push(a)}else{d.push("Could not find actor: "+c)}}else{d.push("The object "+c+" is not of the expected type (Actor, string)")
}}if(d.length!=0){this.list=[];throw new vxlActorGroupException(d)}};nucleo.ActorGroup.prototype.hasActor=function(c){if(c instanceof nucleo.Actor){return(this.list.indexOf(c)!=-1)}else{if(typeof(c)=="string"){var a=this.scene.getActor(c);return(a!=null)}else{return false}}};nucleo.ActorGroup.prototype.remove=function(c){var a=-1;if(c instanceof nucleo.Actor){a=this.list.indexOf(c)}else{if(typeof(c)=="string"){actorObject=this.scene.getActor(c);a=this.list.indexOf(actorObject)}}if(a!=1){this.list.splice(a,1)
}else{throw new vxlActorGroupException(["the actor "+c+" was not found in the group "+this.name])}};nucleo.ActorGroup.prototype.reset=function(a){this.list=[];if(a!=undefined&&a instanceof Array){this.addList(a)}};nucleo.ActorGroup.prototype.size=function(){return this.list.length};nucleo.ActorGroup.prototype.setProperty=function(d,c){for(var a=0,e=this.list.length;a<e;a+=1){this.list[a].setProperty(d,c,nucleo.def.actor)}return this};nucleo.ActorGroup.prototype._apply=function(a,d){for(var c=0,e=this.list.length;
c<e;c+=1){a.apply(this.list[c],d)}return this};nucleo.ActorGroup.prototype.flipNormals=function(){return this._apply(Actor.prototype.flipNormals)};nucleo.ActorGroup.prototype.rotateX=function(a){return this._apply(Actor.prototype.rotateX,[a])};nucleo.ActorGroup.prototype.rotateY=function(a){return this._apply(Actor.prototype.rotateY,[a])};nucleo.ActorGroup.prototype.rotateZ=function(a){return this._apply(Actor.prototype.rotateZ,[a])};nucleo.ActorGroup.prototype.translate=function(a,d,c){return this._apply(Actor.prototype.translate,[a,d,c])
};nucleo.ActorGroup.prototype.setColor=function(a){return this.setProperty("color",a)};nucleo.ActorGroup.prototype.setLookupTable=function(d,c,a){return this._apply(Actor.prototype.setLookupTable,[d,c,a])};nucleo.ActorGroup.prototype.setOpacity=function(a){return this.setProperty("opacity",a)};nucleo.ActorGroup.prototype.setPicker=function(a,c){return this._apply(Actor.prototype.setPicker,[a,c])};nucleo.ActorGroup.prototype.setPosition=function(a,d,c){return this._apply(Actor.prototype.setPosition,[a,d,c])
};nucleo.ActorGroup.prototype.setScale=function(a,d,c){return this._apply(Actor.prototype.setScale,[a,d,c])};nucleo.ActorGroup.prototype.setShininess=function(a){return this.setProperty("shininess",a)};nucleo.ActorGroup.prototype.setVisible=function(a){return this.setProperty("visible",a)};nucleo.ActorGroup.prototype.setShading=function(a){return this.setProperty("shading",a)};nucleo.ActorGroup.prototype.setVisualizationMode=function(a){return this._apply(Actor.prototype.setVisualizationMode,[a])
};function vxlActorGroupException(a){this.messages=a}nucleo.Silo=function Silo(a){this._mode=a;this._actors=[];this.data={};this.cached={};this.added={};this.prepare()};nucleo.Silo.prototype.populate=function(d){var e=d.length;for(var a=0;a<e;a+=1){var c=d[a];if(this.cached[c.UID]==undefined&&c.mode==this._mode){this._actors.push(c);this.cached[c.UID]=c}}};nucleo.Silo.prototype.prepare=function(){var a={mixin:[],index:[],matrix:[[],[],[],[]]};this.data=a};nucleo.Silo.prototype.process=function(){var d=this._actors.length;
for(var a=0;a<d;a+=1){var c=this._actors[a];if(this.added[c.UID]==undefined){this.processActor(this._actors[a]);this.added[c.UID]=c}}};nucleo.Silo.prototype.processActor=function(f){var j=f.model;var m=f.material;var o=this.data.mixin;var l=this.data.index;var n=this.data.matrix;var a=j.vertices.length;var e=j.indices.length;var k=Array.prototype.slice.call(f._matrix);if(m.colors!=undefined){}else{for(var h=0;h<a;h+=3){o=o.concat([j.vertices[h],j.vertices[h+1],j.vertices[h+2],j.normals[h],j.normals[h+1],j.normals[h+2],m.diffuse[0],m.diffuse[1],m.diffuse[2]]);
n[0]=n[0].concat(k.slice(0,4));n[1]=n[1].concat(k.slice(4,8));n[2]=n[2].concat(k.slice(8,12));n[3]=n[3].concat(k.slice(12,16))}}var c=j.indices.slice(0);if(l.length>0){var d=l.max()+1;for(var h=0;h<e;h+=1){c[h]+=d}l=l.concat(c)}else{l=c}this.data.mixin=o;this.data.index=l;this.data.matrix=n};nucleo.DashEngine=function DashEngine(a){nucleo.Engine.call(this);this.silos={};this._createSilos();this._gl_buffers={};this._createGLBuffers();this.essl=nucleo.util.extend(nucleo.define.ESSL,{ACTOR_MATRIX:"aActorMatrix"})
};nucleo.DashEngine.prototype=new nucleo.Engine();nucleo.DashEngine.prototype.constructor=nucleo.DashEngine;nucleo.DashEngine.prototype.configure=function(){nucleo.Engine.prototype.configure.call(this);var a=this.gl;a.clearDepth(1);a.disable(a.CULL_FACE)};nucleo.DashEngine.prototype._createSilos=function(){for(key in nucleo.Actor.MODE){this.silos[key]={};this.silos[key]=new Silo(key)}};nucleo.DashEngine.prototype._createGLBuffers=function(){var a=this.renderer.gl;for(key in nucleo.Actor.MODE){this._gl_buffers[key]={};
this._gl_buffers[key].mixin=a.createBuffer();this._gl_buffers[key].index=a.createBuffer();this._gl_buffers[key].matrix=a.createBuffer()}};nucleo.DashEngine.prototype.allocate=function(c){var a=c._actors;for(key in this.silos){this.silos[key].populate(a);this.silos[key].process()}};nucleo.DashEngine.prototype.render=function(f){var d=this.renderer;var c=d.transforms;var a=d.pm;var h=d.gl;var e=this.essl;if(f._actors.length==0){return}c.update();a.setUniform(e.PERSPECTIVE_MATRIX,c.pMatrix);a.setUniform(e.MODEL_VIEW_MATRIX,c.mvMatrix);
a.setUniform(e.NORMAL_MATRIX,c.nMatrix);a.setUniform(e.MVP_MATRIX,c.mvpMatrix);this._renderSolid()};nucleo.DashEngine.prototype.deallocate=function(a){};nucleo.DashEngine.prototype.enableMatrixAttribute=function(c){var a=this.renderer;var l=a.gl;var d=a.pm._essl;var e=nucleo.Actor.MODE;var j=this.silos[e.SOLID];var k=j.data;var o=l.getAttribLocation(d,c);l.enableVertexAttribArray(o);l.enableVertexAttribArray(o+1);l.enableVertexAttribArray(o+2);l.enableVertexAttribArray(o+3);var q=l.createBuffer();
var n=l.createBuffer();var h=l.createBuffer();var f=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,q);l.bufferData(l.ARRAY_BUFFER,new Float32Array(k.matrix[0]),l.STATIC_DRAW);l.vertexAttribPointer(o,4,l.FLOAT,false,0,0);l.bindBuffer(l.ARRAY_BUFFER,n);l.bufferData(l.ARRAY_BUFFER,new Float32Array(k.matrix[1]),l.STATIC_DRAW);l.vertexAttribPointer(o+1,4,l.FLOAT,false,0,0);l.bindBuffer(l.ARRAY_BUFFER,h);l.bufferData(l.ARRAY_BUFFER,new Float32Array(k.matrix[2]),l.STATIC_DRAW);l.vertexAttribPointer(o+2,4,l.FLOAT,false,0,0);
l.bindBuffer(l.ARRAY_BUFFER,f);l.bufferData(l.ARRAY_BUFFER,new Float32Array(k.matrix[3]),l.STATIC_DRAW);l.vertexAttribPointer(o+3,4,l.FLOAT,false,0,0)};nucleo.DashEngine.prototype._renderSolid=function(){var c=nucleo.Actor.MODE;var f=this.silos[c.SOLID];var h=f.data;var a=this.renderer;var e=a.transforms;var d=a.pm;var j=a.gl;var n=this.essl;d.setUniform("uUseShading",true);d.enableAttribute(n.VERTEX_ATTRIBUTE);d.enableAttribute(n.NORMAL_ATTRIBUTE);d.enableAttribute(n.COLOR_ATTRIBUTE);this.enableMatrixAttribute(n.ACTOR_MATRIX);
var l=this._gl_buffers[c.SOLID].mixin;j.bindBuffer(j.ARRAY_BUFFER,l);j.bufferData(j.ARRAY_BUFFER,new Float32Array(h.mixin),j.STATIC_DRAW);d.setAttributePointer(n.VERTEX_ATTRIBUTE,3,j.FLOAT,false,36,0);d.setAttributePointer(n.NORMAL_ATTRIBUTE,3,j.FLOAT,false,36,12);d.setAttributePointer(n.COLOR_ATTRIBUTE,3,j.FLOAT,false,36,24);var k=this._gl_buffers[c.SOLID].index;j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,k);j.bufferData(j.ELEMENT_ARRAY_BUFFER,new Uint16Array(h.index),j.STATIC_DRAW);j.drawElements(j.TRIANGLES,h.index.length,j.UNSIGNED_SHORT,0)
};